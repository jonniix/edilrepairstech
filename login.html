<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://cvmniyociytwlagyfwed.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2bW5peW9jaXl0d2xhZ3lmd2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDg4NjMsImV4cCI6MjA3ODM4NDg2M30.gy90vkwY2UV3QYpk1OL9s_9XumfLW1nSTqKiglpc9UA";

  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accesso · Gestione Cantieri</title>
  <link id="dynamic-favicon" rel="icon" href="">
  <style>
    :root{
      --bg:#0b1320; --panel:#0f1a2c; --card:#111d31; --muted:#a8b8cc; --text:#e8eef6;
      --border:#1e2b45; --accent:#4da3ff; --success:#22c55e; --danger:#ef4444; --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.35); --input-bg:#0f1a2c; --input-border:#223353; --input-focus:#4da3ff33;
    }
    html[data-theme="light"]{
      --bg:#f3f6fb; --panel:#fff; --card:#fff; --text:#0b1220; --muted:#475569;
      --border:#c7d2e2; --accent:#1d4ed8; --success:#15803d; --danger:#dc2626; --shadow:0 10px 28px rgba(2,6,23,.08);
      --input-bg:#fff; --input-border:#c7d2e2; --input-focus:#1d4ed822;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{width:min(920px,100%);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .row{display:grid;gap:1rem}
    @media(min-width:860px){.row{grid-template-columns:1.1fr .9fr}}
    .pane{padding:1.2rem}
    .brand{display:flex;align-items:center;gap:1rem}
    .logo{width:96px;height:96px;border-radius:16px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-size:1.35rem;font-weight:900;margin:0}
    .muted{color:var(--muted)}
    label{font-size:.9rem;color:var(--muted);font-weight:700;display:block;margin:.35rem 0}
    input,select{width:100%;padding:.9rem 1rem;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;transition:.15s}
    input:focus,select:focus{box-shadow:0 0 0 4px var(--input-focus);border-color:var(--accent)}
    .btn{border:none;cursor:pointer;font-weight:800;padding:.85rem 1rem;border-radius:12px}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#3b82d2);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#e14242);color:#fff}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .hr{height:1px;background:var(--border);margin:1rem 0}
    .pill{display:inline-flex;gap:.35rem;align-items:center;border:1px solid var(--border);background:var(--panel);border-radius:999px;padding:.25rem .6rem;font-weight:700}
    .list{display:grid;gap:.5rem;max-height:280px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:.5rem;background:var(--panel)}
    .userrow{display:grid;grid-template-columns:1fr 110px 120px auto;gap:.5rem;align-items:center}
    .toast{position:fixed;right:16px;bottom:16px;padding:.8rem 1rem;border:1px solid var(--border);background:var(--panel);border-radius:12px;opacity:0;transform:translateY(8px);transition:.2s;z-index:9999}
    .toast.show{opacity:1;transform:none}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
    .switch{width:52px;height:28px;border-radius:999px;background:var(--panel);border:1px solid var(--border);position:relative;cursor:pointer}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:var(--card);border:1px solid var(--border);transition:left .2s}
    html[data-theme="light"] .switch::after{left:27px}
    .hint{font-size:.9rem;margin-top:.35rem}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:.5rem .4rem;text-align:left}
    .table th{font-size:.85rem;color:var(--muted);font-weight:800}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="pane row">
      <!-- Colonna sinistra: Brand + Login -->
      <section class="pane">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><img id="logo" alt="Logo"></div>
            <div>
              <h1 class="title">Edil Repairs Software&Technology</h1>
              <div class="muted">Accesso</div>
            </div>
          </div>
          <div title="Tema" id="theme-switch" class="switch" aria-label="Cambia tema"></div>
        </div>

        <form id="login-form" autocomplete="off">
          <label>Utente</label>
          <input id="lg-user" required />
          <label>Password</label>
          <input id="lg-pass" type="password" required />
          <div class="actions" style="margin-top:.75rem">
            <button class="btn btn-primary" type="submit">Accedi</button>
            <button class="btn btn-ghost" type="button" id="btn-go-app" style="display:none">Apri l’app</button>
          </div>
        </form>

        <!-- NESSUNA gestione logo qui -->
      </section>

      <!-- Colonna destra: Impostazioni Admin + Audit -->
      <section class="pane" id="admin-panel" style="display:none">
        <h2 class="title" style="font-size:1.2rem">Impostazioni admin</h2>
        <div class="muted" style="margin-bottom:.75rem">Crea/gestisci utenti e consulta il registro operazioni.</div>

        <form id="user-form" class="row" style="grid-template-columns:1fr 1fr 1fr auto;align-items:end">
          <div><label>Username</label><input id="u-name" required placeholder="nuovo utente"></div>
          <div><label>Password</label><input id="u-pass" required placeholder="password iniziale"></div>
          <div>
            <label>Ruolo</label>
            <select id="u-role">
              <option value="user">user</option>
              <option value="admin">admin</option>
              <option value="collaboratore">collaboratore</option>
            </select>
          </div>
          <div><button class="btn btn-primary" type="submit">Aggiungi</button></div>
        </form>

        <div class="hr"></div>

        <h3 class="title" style="font-size:1.05rem;margin:.2rem 0 .5rem">Utenti</h3>
        <div class="list" id="users-list" aria-live="polite"></div>

        <div class="hr"></div>

        <h3 class="title" style="font-size:1.05rem;margin:.2rem 0 .5rem">Registro operazioni</h3>
        <div class="actions" style="margin-bottom:.5rem">
          <select id="filter-user"></select>
          <select id="filter-type">
            <option value="">tutte le azioni</option>
            <option value="login">login</option>
            <option value="logout">logout</option>
            <option value="create">creazione</option>
            <option value="update">modifica</option>
            <option value="delete">eliminazione</option>
            <option value="other">altro</option>
          </select>
          <button class="btn btn-ghost" type="button" id="btn-clear-audit">Svuota registro</button>
        </div>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table class="table" id="audit-table">
            <thead><tr><th>Data/Ora</th><th>Utente</th><th>Azione</th><th>Dettagli</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== chiavi/nomi allineati con la tua app ===== */
const IDB_DB = 'gc_store';
const IDB_STORE = 'state';
const IDB_KEY = 'gestione-cantieri';
const USERS_KEY = 'gc_users_v1';
const AUTH_KEY  = 'gc_auth_user';
const AUDIT_KEY = 'gc_audit_v1';     // registro operazioni
const $ = (id)=> document.getElementById(id);
const showToast=(m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };

/* ===== Tema ===== */
(function theme(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  $('theme-switch')?.addEventListener('click', ()=>{
    const t = document.documentElement.getAttribute('data-theme');
    const next = t==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });
})();

/* ===== IndexedDB helpers ===== */
function idbOpen(){
  return new Promise((res,rej)=>{
    if(!('indexedDB' in window)) return rej(new Error('IDB not available'));
    const rq = indexedDB.open(IDB_DB, 1);
    rq.onupgradeneeded = ()=>{ const db = rq.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE); };
    rq.onsuccess = ()=> res(rq.result);
    rq.onerror = ()=> rej(rq.error);
  });
}
async function idbGet(key){
  try{
    const db = await idbOpen();
    return await new Promise((res,rej)=>{
      const tx = db.transaction(IDB_STORE,'readonly');
      const rq = tx.objectStore(IDB_STORE).get(key);
      rq.onsuccess = ()=> res(rq.result ?? null);
      rq.onerror = ()=> rej(rq.error);
    });
  }catch{ return null; }
}

/* ===== Logo: SOLO da settings.logoDataUrl ===== */
async function loadLogo(){
  const state = await idbGet(IDB_KEY);
  const dataUrl = state?.settings?.logoDataUrl || '';
  if(dataUrl){ $('logo').src = dataUrl; $('dynamic-favicon').href = dataUrl; }
}

/* ===== Password: SHA-256 ===== */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
const SALT = 'gc::salt::v1';

/* ===== Utenti ===== */
function getUsers(){
  try{ return JSON.parse(localStorage.getItem(USERS_KEY)||'[]'); }catch{ return []; }
}
function setUsers(list){ localStorage.setItem(USERS_KEY, JSON.stringify(list)); }
async function ensureDefaultAdmin(){
  const users = getUsers();
  if(!users.length){
    const hash = await sha256(SALT+'admin');
    users.push({ username:'admin', role:'admin', passHash:hash, createdAt:new Date().toISOString() });
    setUsers(users);
  }
}
function renderUsers(){
  const box = $('users-list');
  const users = getUsers();
  if(!users.length){ box.innerHTML = '<div class="muted">Nessun utente</div>'; return; }
  box.innerHTML = users.map(u => `
    <div class="userrow" data-u="${u.username}">
      <div><b>${u.username}</b> <span class="muted">(${u.role})</span></div>
      <div><button class="btn btn-ghost" data-act="reset">Reset PW</button></div>
      <div>
        <select data-act="role">
          <option value="user" ${u.role==='user'?'selected':''}>user</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
          <option value="collaboratore" ${u.role==='collaboratore'?'selected':''}>collaboratore</option>
        </select>
      </div>
      <div class="actions" style="justify-content:flex-end">
        <button class="btn btn-danger" data-act="del">Elimina</button>
      </div>
    </div>
  `).join('');
  box.querySelectorAll('[data-act="reset"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const row = btn.closest('.userrow'); const uname = row.dataset.u;
      const pw = prompt('Nuova password per '+uname+':'); if(!pw) return;
      const users = getUsers(); const u = users.find(x=>x.username===uname);
      if(!u) return;
      u.passHash = await sha256(SALT+pw); setUsers(users); showToast('Password aggiornata');
      audit('update', 'reset password utente '+uname);
    });
  });
  box.querySelectorAll('[data-act="role"]').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const row = sel.closest('.userrow'); const uname = row.dataset.u;
      const users = getUsers(); const u = users.find(x=>x.username===uname);
      if(!u) return;
      u.role = sel.value; setUsers(users); showToast('Ruolo aggiornato');
      audit('update', 'cambiato ruolo '+uname+' -> '+sel.value);
    });
  });
  box.querySelectorAll('[data-act="del"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const row = btn.closest('.userrow'); const uname = row.dataset.u;
      if(!confirm('Eliminare utente '+uname+'?')) return;
      setUsers(getUsers().filter(x=> x.username!==uname));
      renderUsers();
      showToast('Utente eliminato');
      audit('delete', 'eliminato utente '+uname);
    });
  });
}

/* ===== Audit log (contatore operazioni) ===== */
function getAudit(){ try{ return JSON.parse(localStorage.getItem(AUDIT_KEY)||'[]'); }catch{ return []; } }
function setAudit(list){ localStorage.setItem(AUDIT_KEY, JSON.stringify(list)); }
function audit(type, detail, actor){
  const sess = getSession();
  const entry = {
    ts: new Date().toISOString(),
    user: actor || sess?.username || 'sconosciuto',
    type: type || 'other',
    detail: detail || ''
  };
  const list = getAudit(); list.unshift(entry); setAudit(list);
  if(document.body.contains($('audit-table'))) renderAudit();
}
function renderAudit(){
  const tbody = document.querySelector('#audit-table tbody');
  const list = getAudit();
  const u = $('filter-user').value || '';
  const t = $('filter-type').value || '';
  const filtered = list.filter(x => (u? x.user===u : true) && (t? x.type===t : true));
  tbody.innerHTML = filtered.map(x => `
    <tr><td>${new Date(x.ts).toLocaleString()}</td><td>${x.user}</td><td>${x.type}</td><td>${x.detail||''}</td></tr>
  `).join('') || '<tr><td colspan="4" class="muted">Nessuna voce</td></tr>';
  // aggiorna select utenti
  const users = [...new Set(getAudit().map(x=>x.user))].sort();
  const sel = $('filter-user');
  const cur = sel.value;
  sel.innerHTML = '<option value="">tutti gli utenti</option>' + users.map(u=>`<option value="${u}">${u}</option>`).join('');
  sel.value = cur || '';
}
$('filter-user')?.addEventListener('change', renderAudit);
$('filter-type')?.addEventListener('change', renderAudit);
$('btn-clear-audit')?.addEventListener('click', ()=>{
  if(!confirm('Svuotare l’intero registro operazioni?')) return;
  setAudit([]); renderAudit(); showToast('Registro svuotato');
});

/* ===== Sessione ===== */
function getSession(){ try{return JSON.parse(localStorage.getItem(AUTH_KEY)||'null')}catch{return null} }

/* ===== Login ===== */
$('login-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = $('lg-user').value.trim();
  const pass = $('lg-pass').value;
  const users = getUsers();
  const u = users.find(x=> x.username===username);
  if(!u){ showToast('Utente non trovato'); return; }
  const hash = await sha256(SALT+pass);
  if(hash !== u.passHash){ showToast('Password errata'); return; }

  // salva sessione
  localStorage.setItem(AUTH_KEY, JSON.stringify({ username:u.username, role:u.role, loginAt:new Date().toISOString() }));
  audit('login', 'accesso effettuato', u.username);
  showToast('Accesso effettuato');

  if(u.role === 'collaboratore'){
    setTimeout(()=> location.href = 'collaboratori.html', 500);
    return;
  }

  // regola #4: se credenziali predefinite admin/admin -> resta qui e apri impostazioni admin
  const defaultAdmin = (u.username==='admin' && pass==='admin');

  if(u.role==='admin'){
    $('admin-panel').style.display = '';
    renderUsers(); renderAudit();
    $('btn-go-app').style.display = defaultAdmin ? 'none' : 'inline-block';
    if(!defaultAdmin){
      // admin NON-default può entrare nell’app se vuole
      setTimeout(()=> location.href = 'index.html', 600);
    }
  }else{
    // utenti normali vanno direttamente all’app
    $('btn-go-app').style.display = 'inline-block';
    setTimeout(()=> location.href = 'index.html', 600);
  }
});

/* ===== Aggiungi utente ===== */
$('user-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const uname = $('u-name').value.trim();
  const pw = $('u-pass').value;
  const role = $('u-role').value;
  if(!uname || !pw) return;
  const users = getUsers();
  if(users.some(x=> x.username===uname)){ showToast('Utente già esistente'); return; }
  const passHash = await sha256(SALT+pw);
  users.push({ username:uname, role, passHash, createdAt:new Date().toISOString() });
  setUsers(users);
  $('u-name').value=''; $('u-pass').value='';
  renderUsers();
  audit('create', 'creato utente '+uname);
  showToast('Utente creato');
});

/* ===== Pulsante “Apri l’app” ===== */
$('btn-go-app')?.addEventListener('click', ()=>{
  const sess = getSession();
  const target = sess?.role === 'collaboratore' ? 'collaboratori.html' : 'index.html';
  location.href = target;
});

/* ===== Boot ===== */
(function boot(){
  ensureDefaultAdmin();
  loadLogo();
  const sess = getSession();
  if(sess?.role==='admin'){ $('admin-panel').style.display=''; renderUsers(); renderAudit(); $('btn-go-app').style.display='inline-block'; }
  else if(sess?.role==='collaboratore'){ $('btn-go-app').style.display='inline-block'; }
})();
</script>
</body>
</html>
