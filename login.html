<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://cvmniyociytwlagyfwed.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2bW5peW9jaXl0d2xhZ3lmd2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDg4NjMsImV4cCI6MjA3ODM4NDg2M30.gy90vkwY2UV3QYpk1OL9s_9XumfLW1nSTqKiglpc9UA";

  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Accesso · Gestione Cantieri</title>
  <link id="dynamic-favicon" rel="icon" href="">
  <style>
    :root{
      --bg:#0b1320; --panel:#0f1a2c; --card:#111d31; --muted:#a8b8cc; --text:#e8eef6;
      --border:#1e2b45; --accent:#4da3ff; --success:#22c55e; --danger:#ef4444; --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.35); --input-bg:#0f1a2c; --input-border:#223353; --input-focus:#4da3ff33;
    }
    html[data-theme="light"]{
      --bg:#f3f6fb; --panel:#fff; --card:#fff; --text:#0b1220; --muted:#475569;
      --border:#c7d2e2; --accent:#1d4ed8; --success:#15803d; --danger:#dc2626; --shadow:0 10px 28px rgba(2,6,23,.08);
      --input-bg:#fff; --input-border:#c7d2e2; --input-focus:#1d4ed822;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{width:min(920px,100%);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .row{display:grid;gap:1rem}
    @media(min-width:860px){.row{grid-template-columns:1.1fr .9fr}}
    .pane{padding:1.2rem}
    .brand{display:flex;align-items:center;gap:1rem}
    .logo{width:96px;height:96px;border-radius:16px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-size:1.35rem;font-weight:900;margin:0}
    .muted{color:var(--muted)}
    label{font-size:.9rem;color:var(--muted);font-weight:700;display:block;margin:.35rem 0}
    input,select{width:100%;padding:.9rem 1rem;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;transition:.15s}
    input:focus,select:focus{box-shadow:0 0 0 4px var(--input-focus);border-color:var(--accent)}
    .btn{border:none;cursor:pointer;font-weight:800;padding:.85rem 1rem;border-radius:12px}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#3b82d2);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#e14242);color:#fff}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}
    .hr{height:1px;background:var(--border);margin:1rem 0}
    .pill{display:inline-flex;gap:.35rem;align-items:center;border:1px solid var(--border);background:var(--panel);border-radius:999px;padding:.25rem .6rem;font-weight:700}
    .list{display:grid;gap:.5rem;max-height:280px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:.5rem;background:var(--panel)}
    .userrow{display:grid;grid-template-columns:1fr 110px 120px auto;gap:.5rem;align-items:center}
    .toast{position:fixed;right:16px;bottom:16px;padding:.8rem 1rem;border:1px solid var(--border);background:var(--panel);border-radius:12px;opacity:0;transform:translateY(8px);transition:.2s;z-index:9999}
    .toast.show{opacity:1;transform:none}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
    .switch{width:52px;height:28px;border-radius:999px;background:var(--panel);border:1px solid var(--border);position:relative;cursor:pointer}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:var(--card);border:1px solid var(--border);transition:left .2s}
    html[data-theme="light"] .switch::after{left:27px}
    .hint{font-size:.9rem;margin-top:.35rem}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:.5rem .4rem;text-align:left}
    .table th{font-size:.85rem;color:var(--muted);font-weight:800}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="pane row">
      <!-- Colonna sinistra: Brand + Login -->
      <section class="pane">
        <div class="topbar">
          <div class="brand">
            <div class="logo"><img id="logo" alt="Logo"></div>
            <div>
              <h1 class="title">Edil Repairs Software&Technology</h1>
              <div class="muted">Accesso</div>
            </div>
          </div>
          <div title="Tema" id="theme-switch" class="switch" aria-label="Cambia tema"></div>
        </div>

        <form id="login-form" autocomplete="off">
          <label>Utente</label>
          <input id="lg-user" required />
          <label>Password</label>
          <input id="lg-pass" type="password" required />
          <div class="actions" style="margin-top:.75rem">
            <button class="btn btn-primary" type="submit">Accedi</button>
            <button class="btn btn-ghost" type="button" id="btn-go-app" style="display:none">Apri l’app</button>
          </div>
        </form>

        <!-- NESSUNA gestione logo qui -->
      </section>

      <!-- Colonna destra: Impostazioni Admin + Audit -->
      <section class="pane" id="admin-panel" style="display:none">
        <h2 class="title" style="font-size:1.2rem">Impostazioni admin</h2>
        <div class="muted" style="margin-bottom:.75rem">Crea/gestisci utenti e consulta il registro operazioni.</div>

        <form id="user-form" class="row" style="grid-template-columns:1fr 1fr 1fr auto;align-items:end">
          <div><label>Username</label><input id="u-name" required placeholder="nuovo utente"></div>
          <div><label>Password</label><input id="u-pass" required placeholder="password iniziale"></div>
          <div>
            <label>Ruolo</label>
            <select id="u-role">
              <option value="user">user</option>
              <option value="admin">admin</option>
              <option value="collaboratore">collaboratore</option>
            </select>
          </div>
          <div><button class="btn btn-primary" type="submit">Aggiungi</button></div>
        </form>

        <div class="hr"></div>

        <h3 class="title" style="font-size:1.05rem;margin:.2rem 0 .5rem">Utenti</h3>
        <div class="list" id="users-list" aria-live="polite"></div>

        <div class="hr"></div>

        <h3 class="title" style="font-size:1.05rem;margin:.2rem 0 .5rem">Registro operazioni</h3>
        <div class="actions" style="margin-bottom:.5rem">
          <select id="filter-user"></select>
          <select id="filter-type">
            <option value="">tutte le azioni</option>
            <option value="login">login</option>
            <option value="logout">logout</option>
            <option value="create">creazione</option>
            <option value="update">modifica</option>
            <option value="delete">eliminazione</option>
            <option value="other">altro</option>
          </select>
          <button class="btn btn-ghost" type="button" id="btn-clear-audit">Svuota registro</button>
        </div>
        <div style="max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table class="table" id="audit-table">
            <thead><tr><th>Data/Ora</th><th>Utente</th><th>Azione</th><th>Dettagli</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const PROFILES_TABLE = 'profiles';
const AUDIT_TABLE = 'audit_log';
const $ = (id)=> document.getElementById(id);
const showToast = (m)=>{ const t=$('toast'); if(!t) return; t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };
let manualRedirect = false;
let redirectInProgress = false;

/* ===== Tema ===== */
(function theme(){
  try{
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    $('theme-switch')?.addEventListener('click', ()=>{
      const t = document.documentElement.getAttribute('data-theme');
      const next = t==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
  }catch(_){ }
})();

/* ===== IndexedDB helpers (logo) ===== */
const IDB_DB = 'gc_store';
const IDB_STORE = 'state';
const IDB_KEY = 'gestione-cantieri';

function idbOpen(){
  return new Promise((res,rej)=>{
    if(!('indexedDB' in window)) return rej(new Error('IDB not available'));
    const rq = indexedDB.open(IDB_DB, 1);
    rq.onupgradeneeded = ()=>{ const db = rq.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE); };
    rq.onsuccess = ()=> res(rq.result);
    rq.onerror = ()=> rej(rq.error);
  });
}
async function idbGet(key){
  try{
    const db = await idbOpen();
    return await new Promise((res,rej)=>{
      const tx = db.transaction(IDB_STORE,'readonly');
      const rq = tx.objectStore(IDB_STORE).get(key);
      rq.onsuccess = ()=> res(rq.result ?? null);
      rq.onerror = ()=> rej(rq.error);
    });
  }catch{ return null; }
}

async function loadLogo(){
  try{
    const state = await idbGet(IDB_KEY);
    const dataUrl = state?.settings?.logoDataUrl || '';
    if(dataUrl){ $('logo').src = dataUrl; $('dynamic-favicon').href = dataUrl; }
  }catch(_){ }
}

/* ===== Supabase helpers ===== */
let currentProfile = null;
let auditCache = [];

async function gcAudit(type, detail, actorOverride){
  try{
    const { data:{ session } } = await supabase.auth.getSession();
    const payload = {
      type: type || 'other',
      detail: detail || '',
      user: actorOverride || session?.user?.user_metadata?.username || session?.user?.email || 'sconosciuto',
      user_id: session?.user?.id || null,
      created_at: new Date().toISOString()
    };
    await supabase.from(AUDIT_TABLE).insert(payload);
  }catch(err){ console.warn('gcAudit error', err); }
}

async function fetchProfile(userId){
  if(!userId) return null;
  try{
    const { data, error } = await supabase
      .from(PROFILES_TABLE)
      .select('id,user_id,username,email,role')
      .eq('user_id', userId)
      .maybeSingle();
    if(error){ console.warn('fetchProfile', error); return null; }
    return data || null;
  }catch(err){ console.warn('fetchProfile', err); return null; }
}

function resolveDisplayName(profile, fallback){
  return profile?.username || profile?.email || fallback || 'utente';
}

function persistSession(profile, session){
  try{
    const payload = {
      uid: session?.user?.id || profile?.user_id || profile?.id || '',
      username: resolveDisplayName(profile, session?.user?.email || ''),
      role: profile?.role || 'user',
      loginAt: new Date().toISOString()
    };
    localStorage.setItem('gc_auth_user', JSON.stringify(payload));
  }catch(_){ }
}

function redirectByRole(role){
  if(role === 'admin'){ return; }
  redirectInProgress = true;
  if(role === 'collaboratore'){
    location.href = 'collaboratori.html';
    return;
  }
  location.href = 'index.html';
}

function bindGoToApp(){
  $('btn-go-app')?.addEventListener('click', ()=>{
    const role = currentProfile?.role || 'user';
    const target = role==='collaboratore' ? 'collaboratori.html' : 'index.html';
    location.href = target;
  });
}

async function handleLoginSuccess(profile, session, { silent = false } = {}){
  currentProfile = profile;
  persistSession(profile, session);
  $('btn-go-app').style.display = 'inline-block';
  manualRedirect = false;
  const role = profile?.role || 'user';
  if(role === 'admin'){
    $('admin-panel').style.display = '';
    await Promise.all([loadUsers(), refreshAudit()]);
    if(!silent) showToast('Accesso admin effettuato');
    redirectInProgress = false;
    return;
  }
  redirectByRole(role);
}

async function resumeSession(){
  try{
    const { data:{ session } } = await supabase.auth.getSession();
    if(!session?.user) return;
    const profile = await fetchProfile(session.user.id);
    if(!profile) return;
    await handleLoginSuccess(profile, session, { silent: true });
  }catch(err){ console.warn('resumeSession', err); }
}

async function loadUsers(){
  const box = $('users-list');
  if(!box) return;
  try{
    const { data, error } = await supabase
      .from(PROFILES_TABLE)
      .select('id,user_id,username,email,role,created_at')
      .order('created_at',{ ascending:false });
    if(error){ console.error('loadUsers', error); box.innerHTML = '<div class="muted">Errore caricamento utenti</div>'; return; }
    if(!data?.length){ box.innerHTML = '<div class="muted">Nessun utente</div>'; return; }
    box.innerHTML = data.map(u=>`
      <div class="userrow" data-id="${u.id}" data-user-id="${u.user_id}" data-email="${u.email||''}">
        <div><b>${resolveDisplayName(u)}</b> <span class="muted">(${u.role||'user'})</span></div>
        <div><button class="btn btn-ghost" data-act="reset">Invia reset</button></div>
        <div>
          <select data-act="role">
            <option value="user" ${u.role==='user'?'selected':''}>user</option>
            <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
            <option value="collaboratore" ${u.role==='collaboratore'?'selected':''}>collaboratore</option>
          </select>
        </div>
        <div class="actions" style="justify-content:flex-end">
          <button class="btn btn-danger" data-act="del" disabled title="Eliminazione richiede chiave service role">Elimina</button>
        </div>
      </div>
    `).join('');

    box.querySelectorAll('[data-act="reset"]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const row = btn.closest('.userrow');
        const email = row?.dataset.email;
        if(!email){ showToast('Email non disponibile'); return; }
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: location.origin + '/login.html' });
        if(error){ showToast('Errore invio reset'); console.warn('reset', error); return; }
        showToast('Email reset inviata');
        await gcAudit('update', 'reset password inviato a '+email);
      });
    });

    box.querySelectorAll('[data-act="role"]').forEach(sel=>{
      sel.addEventListener('change', async ()=>{
        const row = sel.closest('.userrow');
        const id = row?.dataset.id;
        const email = row?.dataset.email || resolveDisplayName({ username:'' });
        const nextRole = sel.value;
        const { error } = await supabase.from(PROFILES_TABLE).update({ role: nextRole }).eq('id', id);
        if(error){ showToast('Errore aggiornamento ruolo'); console.warn('role update', error); return; }
        showToast('Ruolo aggiornato');
        await gcAudit('update', 'cambiato ruolo '+email+' -> '+nextRole);
        loadUsers();
      });
    });
  }catch(err){
    console.error('loadUsers', err);
  }
}

function renderAuditRows(){
  const tbody = document.querySelector('#audit-table tbody');
  if(!tbody){ return; }
  const userFilter = $('filter-user')?.value || '';
  const typeFilter = $('filter-type')?.value || '';
  const filtered = auditCache.filter(row =>{
    const okUser = userFilter ? row.user === userFilter : true;
    const okType = typeFilter ? row.type === typeFilter : true;
    return okUser && okType;
  });
  tbody.innerHTML = filtered.map(x=>`
    <tr><td>${new Date(x.created_at || x.ts).toLocaleString()}</td><td>${x.user||'—'}</td><td>${x.type||'other'}</td><td>${x.detail||''}</td></tr>
  `).join('') || '<tr><td colspan="4" class="muted">Nessuna voce</td></tr>';
}

function populateAuditFilters(){
  const users = [...new Set(auditCache.map(x=>x.user).filter(Boolean))].sort();
  const sel = $('filter-user');
  if(sel){
    const cur = sel.value;
    sel.innerHTML = '<option value="">tutti gli utenti</option>' + users.map(u=>`<option value="${u}">${u}</option>`).join('');
    if(users.includes(cur)) sel.value = cur;
  }
}

async function refreshAudit(){
  const tbody = document.querySelector('#audit-table tbody');
  if(tbody){ tbody.innerHTML = '<tr><td colspan="4" class="muted">Caricamento…</td></tr>'; }
  try{
    const { data, error } = await supabase
      .from(AUDIT_TABLE)
      .select('id,created_at,user,user_id,type,detail')
      .order('created_at',{ ascending:false })
      .limit(200);
    if(error){ console.warn('refreshAudit', error); auditCache = []; renderAuditRows(); return; }
    auditCache = data || [];
    populateAuditFilters();
    renderAuditRows();
  }catch(err){ console.warn('refreshAudit', err); }
}

function bindAuditControls(){
  $('filter-user')?.addEventListener('change', renderAuditRows);
  $('filter-type')?.addEventListener('change', renderAuditRows);
  $('btn-clear-audit')?.addEventListener('click', async ()=>{
    if(!confirm('Svuotare l’intero registro operazioni?')) return;
    try{
      const { error } = await supabase.from(AUDIT_TABLE).delete().neq('id', 0);
      if(error){ showToast('Errore svuotamento registro'); console.warn('clear audit', error); return; }
      auditCache = [];
      renderAuditRows();
      showToast('Registro svuotato');
      await gcAudit('delete', 'registro audit svuotato', resolveDisplayName(currentProfile));
    }catch(err){ console.warn('clear audit', err); }
  });
}

function bindForms(){
  $('login-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = $('lg-user').value.trim();
    const password = $('lg-pass').value;
    if(!email || !password){ showToast('Inserisci email e password'); return; }
    const submitBtn = e.submitter || $('login-form').querySelector('button[type="submit"]');
    submitBtn?.setAttribute('disabled','disabled');
    try{
      manualRedirect = true;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error || !data?.user){ showToast('Credenziali non valide'); console.warn('login error', error); manualRedirect = false; return; }
      const profile = await fetchProfile(data.user.id);
      if(!profile){ showToast('Profilo non trovato'); manualRedirect = false; return; }
      await gcAudit('login', 'accesso effettuato', resolveDisplayName(profile, email));
      await handleLoginSuccess(profile, data.session);
    }catch(err){
      console.error('login', err);
      showToast('Errore di accesso');
      manualRedirect = false;
    }finally{
      submitBtn?.removeAttribute('disabled');
    }
  });

  $('user-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(currentProfile?.role !== 'admin'){ showToast('Non autorizzato'); return; }
    const email = $('u-name').value.trim();
    const password = $('u-pass').value;
    const role = $('u-role').value;
    if(!email || !password){ showToast('Compila tutti i campi'); return; }
    const submitBtn = $('user-form').querySelector('button[type="submit"]');
    submitBtn?.setAttribute('disabled','disabled');
    try{
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options:{ data:{ role, username: email } }
      });
      if(error){ showToast('Errore creazione utente'); console.warn('signUp error', error); return; }
      const userId = data?.user?.id;
      if(userId){
        await supabase.from(PROFILES_TABLE).upsert({ user_id:userId, username: email, email, role });
        await gcAudit('create', 'creato utente '+email, resolveDisplayName(currentProfile));
      }
      $('u-name').value=''; $('u-pass').value='';
      showToast('Utente creato');
      await loadUsers();
    }catch(err){
      console.error('create user', err);
      showToast('Errore creazione utente');
    }finally{
      submitBtn?.removeAttribute('disabled');
    }
  });
}

function initAuthListener(){
  try{
    supabase.auth.onAuthStateChange(async (event, session)=>{
      if(event === 'SIGNED_IN'){
        if(redirectInProgress){ return; }
        if(manualRedirect){ manualRedirect = false; return; }
        const userId = session?.user?.id;
        if(!userId){ return; }
        const profile = await fetchProfile(userId);
        if(!profile){ return; }
        await handleLoginSuccess(profile, session, { silent: true });
        return;
      }
      if(event === 'SIGNED_OUT'){
        localStorage.removeItem('gc_auth_user');
        currentProfile = null;
        manualRedirect = false;
        if(!redirectInProgress && !location.pathname.toLowerCase().endsWith('login.html')){
          redirectInProgress = true;
          location.href = 'login.html';
        }
      }
    });
  }catch(err){ console.warn('initAuthListener', err); }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  loadLogo();
  bindGoToApp();
  bindForms();
  bindAuditControls();
  initAuthListener();
  await resumeSession();
});
</script>
<div id="sb-selfcheck" style="position:fixed;right:10px;bottom:10px;font:12px system-ui;background:#0f1a2c;color:#e8eef6;border:1px solid #1e2b45;border-radius:10px;padding:6px 10px;opacity:.85;z-index:9999"></div>
<script>
  (async()=>{
    const el=document.getElementById('sb-selfcheck');
    if(!el) return;
    try{
      if(typeof supabase==='undefined'){ el.textContent='Supabase ❌'; return; }
      const { error } = await supabase.from('profiles').select('id').limit(1);
      el.textContent = error ? 'Supabase ❌ connessione' : 'Supabase ✅ connesso';
    }catch(_){
      el.textContent='Supabase ❌ connessione';
    }
  })();
</script>
</body>
</html>
