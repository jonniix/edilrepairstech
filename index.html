<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://cvmniyociytwlagyfwed.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2bW5peW9jaXl0d2xhZ3lmd2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDg4NjMsImV4cCI6MjA3ODM4NDg2M30.gy90vkwY2UV3QYpk1OL9s_9XumfLW1nSTqKiglpc9UA";

  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script>
  (function(){
    try{
      const u = JSON.parse(localStorage.getItem('gc_auth_user')||'null');
      if(!u || !u.username){
        if(!/login\.html$/i.test(location.pathname)) location.replace('login.html');
      }
    }catch(_){
      if(!/login\.html$/i.test(location.pathname)) location.replace('login.html');
    }
  })();
</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Cantieri</title>
  <link id="dynamic-favicon" rel="icon" href="">
  <script>
  // hard mute di specifici warning "A listener indicated an asynchronous response"
  (function(){
    const PATTERN = 'A listener indicated an asynchronous response';
    const swallow = (e)=>{
      try{
        const msg = String(e?.reason?.message || e?.message || e?.reason || '');
        if(msg.includes(PATTERN)){
          e.preventDefault?.();
          e.stopImmediatePropagation?.();
          return false;
        }
      }catch(_){ }
      return undefined;
    };
    window.addEventListener('unhandledrejection', swallow, true);
    window.addEventListener('error', swallow, true);
    const wrap = (key)=>{
      const orig = console[key];
      console[key] = function(...args){
        try{ if(args.join(' ').includes(PATTERN)) return; }catch(_){ }
        return orig.apply(this, args);
      };
    };
    wrap('error');
    wrap('warn');
  })();
  </script>
  <script>
  /* Filter console noise from browser extensions:
     "A listener indicated an asynchronous response ..."
     We only suppress that specific pattern, nothing else. */
  (function(){
    const PATTERN = 'A listener indicated an asynchronous response by returning true, but the message channel closed';

    function shouldSwallow(msg){
      try{ return typeof msg === 'string' && msg.includes(PATTERN); }
      catch(_){ return false; }
    }

    function handleRejection(e){
      try{
        const msg = String(e?.reason?.message || e?.reason || '');
        if(shouldSwallow(msg)){
          e.preventDefault?.();
          e.stopImmediatePropagation?.();
          return false;
        }
      }catch(_){ }
      return undefined;
    }

    // 1) Mute unhandled promise rejections with that exact message
    window.addEventListener('unhandledrejection', handleRejection, true);
    window.onunhandledrejection = handleRejection;

    // 2) Mute normal error events that bubble with that message
    window.addEventListener('error', (e) => {
      try{
        const msg = String(e?.message || '');
        if (shouldSwallow(msg)) {
          e.preventDefault?.();
          e.stopImmediatePropagation?.();
        }
      }catch(_){ }
    }, true);

    // 3) Soft-wrap console.error / warn to hide just that line, keep everything else
    const wrapConsole = (method)=>{
      const original = console[method];
      console[method] = function(...args){
        try{
          const msg = args.map(a=> String(a)).join(' ');
          if(shouldSwallow(msg)) return;
        }catch(_){ }
        return original.apply(this, args);
      };
    };

    wrapConsole('error');
    wrapConsole('warn');
  })();
  </script>
  <!-- CSS principale -->
  <style>
    /* =========================
       DESIGN SYSTEM (v2) - IMPROVED
       ========================= */
    :root{
      --bg: #0b1320;
      --panel:#0f1a2c;
      --card:#111d31;
      --muted:#a8b8cc;
      --text:#e8eef6;
      --border:#1e2b45;
      --accent:#4da3ff;
      --accent-2:#7bc8ff;
      --success:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
  --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.35);
      --input-bg:#0f1a2c; --input-border:#223353; --input-focus:#4da3ff33;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    html[data-theme="light"]{
      --bg:#f3f6fb;
      --panel:#ffffff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#475569;
      --border:#c7d2e2;
      --accent:#1d4ed8;
      --accent-2:#60a5fa;
      --success:#15803d;
      --danger:#dc2626;
      --warn:#d97706;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --input-bg:#ffffff;
      --input-border:#c7d2e2;
      --input-focus:#1d4ed822;
    }
    html[data-theme="light"] .card{
      background:linear-gradient(155deg,#ffffff,#f3f7ff);
      border:1px solid rgba(29,78,216,.12);
      box-shadow:0 18px 38px rgba(15,23,42,.14);
    }
    html[data-theme="light"] .card:hover{
      border-color:rgba(29,78,216,.28);
      box-shadow:0 22px 44px rgba(15,23,42,.18);
      background:linear-gradient(155deg,#ffffff,#eef4ff);
    }
    html[data-theme="light"] .card.kpi{
      background:linear-gradient(160deg, rgba(96,165,250,.18), rgba(255,255,255,.95));
      border-color:rgba(59,130,246,.24);
      box-shadow:0 24px 48px rgba(15,23,42,.18);
    }
    html[data-theme="light"] .card.kpi:hover{
      border-color:rgba(59,130,246,.38);
      box-shadow:0 28px 56px rgba(15,23,42,.2);
    }
    html[data-theme="light"] .card.kpi.accent{
      background:linear-gradient(160deg, rgba(167,139,250,.35), rgba(96,165,250,.28));
      border-color:rgba(79,70,229,.35);
    }
    html[data-theme="light"] .kpi-chip{background:rgba(240,244,255,.8);border-color:rgba(148,163,184,.45)}
    html[data-theme="light"] .nav button:hover{ box-shadow:var(--shadow); border-color:var(--accent) }
    html[data-theme="light"] thead{ background:#f8fafc }
    html[data-theme="light"] tbody tr:hover{ background:#eef4ff }
    html[data-theme="light"] .pill{ background:#f3f6fb }
    html[data-theme="light"] .progress{ background:#eef2f7 }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
      background:var(--bg); color:var(--text); line-height:1.45; overflow:hidden;
    }
    a{color:inherit; text-decoration:none}
    .app{display:grid; grid-template-columns:300px 1fr; height:100vh; min-height:100vh}
    /* BRAND / LOGO */
    .brand{display:flex;align-items:center;gap:.8rem;padding:.25rem .5rem;font-weight:800}
    .brand span{white-space:nowrap;font-weight:800;letter-spacing:.2px}
    .logo{
      width:44px;height:44px;border-radius:10px;display:grid;place-items:center;
      background:var(--panel); border:1px solid var(--border); overflow:hidden;
    }
    .logo img{
      width:100%;height:100%;object-fit:contain; /* mai crop */
      padding:6px; background:transparent; display:none;
    }
    .logo.has-img img{display:block}
    .nav{display:grid; gap:.5rem}
    .nav button{
      display:flex; align-items:center; gap:.75rem; padding:.8rem 1rem; width:100%;
      background:var(--card); color:var(--text); border:1px solid var(--border);
      border-radius:var(--radius); cursor:pointer; font-weight:700; transition:transform .15s var(--ease), box-shadow .15s var(--ease), border-color .15s;
    }
    .nav button:hover{transform:translateY(-2px); box-shadow:var(--shadow); border-color:var(--accent)}
    .nav button.active{background:linear-gradient(135deg,var(--accent),#3b82d2); color:#fff; border-color:transparent}
    .controls{display:grid; gap:.5rem}
    .sidebar-meta{margin-top:auto; border-top:1px dashed var(--border); padding-top:.75rem; font-size:.85rem; color:var(--muted)}
    .btn{border:none; cursor:pointer; font-weight:700; padding:.7rem 1rem; border-radius:var(--radius); transition:transform .12s var(--ease), box-shadow .12s var(--ease), background .12s}
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
    .btn-ghost{background:transparent; border:1px solid var(--border); color:var(--text)}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#3b82d2); color:#fff}
    .btn-success{background:linear-gradient(135deg,var(--success),#1fa85b); color:#fff}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#e14242); color:#fff}
    main{overflow:auto; padding:1.25rem}
  .topbar{display:flex; align-items:center; justify-content:center; gap:1rem; padding-bottom:1rem; border-bottom:1px solid var(--border); color:var(--muted)}
    .theme-toggle{display:flex; align-items:center; gap:.75rem}
    .switch{position:relative; width:52px; height:28px; background:var(--panel); border:1px solid var(--border); border-radius:999px; cursor:pointer}
    .switch::after{content:""; position:absolute; inset:3px auto 3px 3px; width:22px; background:var(--card); border:1px solid var(--border); border-radius:999px; transition:left .2s var(--ease)}
    html[data-theme="light"] .switch::after{left:25px}
    .grid{display:grid; gap:1rem}
    .cols-2{grid-template-columns:1fr}
    .cols-3{grid-template-columns:1fr}
    @media (min-width:980px){.cols-2{grid-template-columns:1.08fr 1fr} .cols-3{grid-template-columns:repeat(3,1fr)}}
    .card{
      position:relative;
      background:linear-gradient(155deg, rgba(17,29,49,.96), rgba(17,29,49,.82));
      border:1px solid rgba(77,163,255,.12);
      border-radius:var(--radius);
      box-shadow:0 18px 40px rgba(6,11,25,.35);
      overflow:hidden;
      backdrop-filter:blur(12px);
      transition:transform .2s var(--ease), box-shadow .2s var(--ease), border-color .2s var(--ease), background .2s var(--ease);
    }
    .card:hover{
      transform:translateY(-4px);
      border-color:rgba(77,163,255,.35);
      box-shadow:0 22px 44px rgba(6,11,25,.45);
      background:linear-gradient(155deg, rgba(17,29,49,1), rgba(17,29,49,.9));
    }
  .card-header{padding:1rem 1.25rem; border-bottom:1px solid rgba(77,163,255,.12); display:flex; align-items:center; justify-content:space-between; min-height:52px}
    .card-header h2{margin:0; font-size:1.1rem}
  .card-content{padding:1.1rem}
    .muted{color:var(--muted)}
    .pill{display:inline-flex; gap:.5rem; align-items:center; padding:.4rem .7rem; border-radius:999px; border:1px solid var(--border); background:var(--panel); font-size:.9rem}
    .kpi{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:1rem}
    .kpi .label{font-size:.85rem; color:var(--muted)}
    .kpi .value{font-size:1.5rem; font-weight:800}
    .kpi-sub{font-size:.8rem; color:var(--muted); margin-top:.25rem}
    .progress{height:10px; border-radius:999px; border:1px solid var(--border); background:rgba(0,0,0,.18); overflow:hidden}
    .progress>span{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead{position:sticky; top:0; background:var(--panel); z-index:1}
    thead th{padding:.7rem .6rem; text-align:left; font-size:.9rem; border-bottom:1px solid var(--border)}
    tbody td{padding:.7rem .6rem; border-bottom:1px dashed var(--border); vertical-align:top}
    tbody tr:hover{background:rgba(77,163,255,.08)}
  td.right, th.right, .right{text-align:right} .nowrap{white-space:nowrap}
  .tbl th, .tbl td{padding:.55rem; border-bottom:1px solid var(--border)}
  .tbl tr:hover{background:rgba(77,163,255,.08)}
  .as-link{color:var(--accent); cursor:pointer; text-decoration:underline}
  .row-2col{display:grid; grid-template-columns:1fr 1fr; gap:1rem}
  @media (max-width:860px){ .row-2col{grid-template-columns:1fr} }
    .row{display:grid; grid-template-columns:1fr; gap:.75rem; margin-bottom:.75rem}
    @media(min-width:760px){.row.two{grid-template-columns:1fr 1fr} .row.three{grid-template-columns:1fr 1fr 1fr}}
    label{font-size:.85rem; color:var(--muted); font-weight:700; display:block; margin-bottom:.25rem}
    input,select,textarea{
      width:100%; padding:.8rem 1rem; border-radius:10px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text); outline:none;
      transition: box-shadow .12s var(--ease), transform .12s var(--ease), border-color .12s var(--ease);
    }
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--input-focus); border-color:var(--accent)}
    input:hover,select:hover,textarea:hover{transform:translateY(-1px)}
    .tag{display:inline-block; padding:.2rem .6rem; border-radius:999px; border:1px solid var(--border); background:var(--panel); font-size:.8rem}
    .status{display:inline-block; padding:.25rem .6rem; border-radius:999px; font-weight:700; font-size:.75rem}
    .st-draft{background:rgba(107,114,128,.18); color:#9aa5b1}
    .st-issued{background:rgba(59,130,246,.18); color:#3b82f6}
    .st-paid{background:rgba(34,197,94,.18); color:#22c55e}
    .st-partial{background:rgba(245,158,11,.18); color:#f59e0b}
    .st-overdue{background:rgba(239,68,68,.18); color:#ef4444}
    .site-badge{padding:.25rem .5rem; border-radius:999px; font-size:.75rem; font-weight:700}
    .sb-active{background:rgba(34,197,94,.18); color:#22c55e}
    .sb-ended{background:rgba(107,114,128,.18); color:#9aa5b1}
  .list-scroll{max-height:520px; overflow:auto}
    .empty{text-align:center; color:var(--muted); padding:1.25rem}
    .toast{position:fixed; right:16px; bottom:16px; padding:.85rem 1rem; border:1px solid var(--border); background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition:.2s var(--ease); z-index:9999}
    .toast.show{opacity:1; transform:none}
    .suggest{position:absolute; left:0; right:0; top:calc(100% + 4px); z-index:6; border:1px solid var(--border); border-radius:10px; background:var(--panel); box-shadow:var(--shadow); max-height:200px; overflow:auto}
    .suggest div{padding:.6rem .8rem; cursor:pointer}
    .suggest div:hover{background:rgba(77,163,255,.08)}
    .material-row,.fase-row{display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:.5rem; align-items:center; margin-bottom:.5rem}
    .remove-btn{width:32px; height:32px; display:grid; place-items:center; border:none; border-radius:8px; background:var(--danger); color:#fff; cursor:pointer}
    .chart {
      display: block !important;
      width: 100% !important;
      height: 220px !important;
      background: var(--panel) !important;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: 10px;
    }
    .dashboard-grid{display:grid; gap:1rem}
    @media(min-width:640px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:980px){.dashboard-grid{grid-template-columns:repeat(3,1fr)}}
    /* Forecast v2 */
    .chips{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{padding:.25rem .6rem;border:1px solid var(--border);border-radius:999px;background:var(--panel);cursor:pointer;font-weight:700;font-size:.85rem}
    .chip.active{background:var(--accent);color:#fff;border-color:transparent}
    .fx-toolbar{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;margin-bottom:.6rem}
    .fx-totals{display:flex;gap:.5rem;flex-wrap:wrap}
    .badge{padding:.25rem .5rem;border:1px solid var(--border);border-radius:8px;background:var(--panel);font-size:.85rem}
    .fx-list .fx-row{display:grid;grid-template-columns:120px 1fr 1fr 110px 92px auto;gap:.5rem;align-items:center;
      padding:.5rem;border-bottom:1px dashed var(--border)}
    .fx-row .status-pill{font-size:.75rem;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border)}
    .fx-row .status-paid{background:rgba(34,197,94,.15);color:#22c55e;border-color:transparent}
    .fx-row .status-plan{background:rgba(59,130,246,.12);color:#60a5fa;border-color:transparent}
    .btn-icon{border:1px solid var(--border);background:var(--panel);border-radius:8px;padding:.35rem .5rem;cursor:pointer}
    .btn-icon:hover{box-shadow:var(--shadow)}
  /* === Agenda: vista matrice settimanale === */
  .ag-matrix-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel)}
  .ag-matrix-toolbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;margin-bottom:.5rem}
  .ag-matrix{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
  .ag-matrix thead th{position:sticky;top:0;background:var(--panel);z-index:1;border-bottom:1px solid var(--border)}
  .ag-matrix th,.ag-matrix td{border-right:1px dashed var(--border);border-bottom:1px dashed var(--border);padding:.5rem;vertical-align:top}
  .ag-matrix th:first-child,.ag-matrix td:first-child{border-left:1px dashed var(--border)}
  .ag-matrix .daycell{min-height:100px}
  .ag-pill{display:block;border:1px solid var(--border);border-radius:999px;padding:.35rem .6rem;margin:.25rem 0;background:rgba(77,163,255,.08);font-size:.86rem;line-height:1.2;cursor:pointer}
  .ag-pill .time{font-weight:800;margin-right:.4rem}
  .ag-pill .site{font-weight:700}
  .ag-pill .muted{display:block}
  .ag-collab-head{white-space:nowrap}
  .ag-matrix-stickycol{position:sticky;left:0;background:var(--panel);z-index:1}
  @media (max-width:980px){ .ag-matrix{min-width:680px} }
  /* Nasconde la vecchia vista mensile e il toggle inutilizzato */
  .ag-cal{ display:none !important; }
  #mx-switch{ display:none !important; }
  .slots-table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px}
  #sl-table{width:100%;border-collapse:separate;border-spacing:0}
  #sl-table th,#sl-table td{padding:.55rem;border-bottom:1px solid var(--border);text-align:center;white-space:nowrap}
  #sl-table th:first-child,#sl-table td:first-child{text-align:left}
    /* Command Palette */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:flex-start; justify-content:center; padding:10vh 1rem; z-index:10000}
    .overlay.show{display:flex}
    .palette{width:min(760px,100%); background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); overflow:hidden}
    .palette header{display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid var(--border)}
    .palette input{border:none; background:transparent; padding:.6rem .2rem; font-size:1.05rem}
    .palette .results{max-height:50vh; overflow:auto}
    .palette .results div{padding:.7rem .9rem; cursor:pointer; display:flex; justify-content:space-between; gap:.75rem}
    .palette .results div.active, .palette .results div:hover{background:rgba(77,163,255,.12)}

    /* --- Spazio e respiro lato sinistro (sidebar) --- */
    .app{
      /* aggiungi gap tra sidebar e main */
      column-gap: 16px; /* prima non c’era o era minimo */
    }
    /* un po’ di padding interno alla colonna sinistra */
    aside{
      padding-left: 8px;
    }
    /* allinea meglio brand e pulsanti in sidebar */
    .brand{
      padding-left: .25rem; /* prima .25rem .5rem, lasciamo tutto ma aggiungiamo un pizzico a sx */
    }
    .nav button{
      margin-inline: 4px;          /* rientro visivo dai bordi */
    }
    /* --- TOPBAR LAYOUT STABILE --- */
    .topbar{
      position:relative;
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* sinistra | centro | destra */
      align-items:center;
      gap:1rem;
      padding-bottom:1rem;
      border-bottom:1px solid var(--border);
      color:var(--muted);
    }
    .topbar-left{display:flex;align-items:center;gap:1rem;min-width:0;}
    .topbar-right{display:flex;align-items:center;justify-content:flex-end;gap:.5rem;min-width:0;}
    .topbar-center{display:flex;align-items:center;justify-content:center;min-width:140px;pointer-events:none;}

    .topbar-center img{
      height:40px; width:auto; object-fit:contain; display:block; opacity:.95;
    }
    @media (max-width:980px){ .topbar-center img{ height:32px; } }
    .pill input{min-width:220px}
    /* (Opzionale) sidebar più stretta su schermi larghi */
    @media (min-width: 1400px){
      .app{ grid-template-columns: 280px 1fr; }
    }
    /* Shortcuts modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10001; background:rgba(0,0,0,.45); padding:1rem}
    .modal .box{background:var(--card); border:1px solid var(--border); border-radius:14px; width:min(720px,100%); max-height:85vh; overflow:auto; box-shadow:var(--shadow); padding:1rem}
    .modal.show{display:flex}
    .kbd{display:inline-block; padding:.1rem .4rem; border:1px solid var(--border); border-bottom-width:2px; border-radius:6px; font-weight:700; font-size:.85rem; background:var(--panel)}
    /* Drag & Drop overlay */
    .drop{position:fixed; inset:0; border:4px dashed var(--accent); display:none; place-items:center; z-index:9998; background:rgba(77,163,255,.06)}
    .drop.show{display:grid}
    
    /* Offerte */
    .offer-badge{padding:.25rem .5rem; border-radius:999px; font-size:.75rem; font-weight:700}
    .ob-high{background:rgba(34,197,94,.18); color:#22c55e}
    .ob-medium{background:rgba(245,158,11,.18); color:#f59e0b}
    .ob-low{background:rgba(239,68,68,.18); color:#ef4444}
    .ob-unknown{background:rgba(107,114,128,.18); color:#9aa5b1}
    
    /* NEW STYLES FOR IMPROVEMENTS */
    
    /* Expandable dashboard cards */
    .dashboard-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: all 0.3s var(--ease);
      margin-bottom: 1rem;
    }
    
    .dashboard-card-header{
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
      }
      
      aside {
        display: none;
      }
      
      .mobile-menu-toggle {
        display: block;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1000;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: var(--radius);
        width: 44px;
        height: 44px;
        display: grid;
        place-items: center;
        box-shadow: var(--shadow);
      }
      
      .mobile-menu-open aside {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        z-index: 999;
      }
    }
    
    /* >>> CARD-FILTER: controlli finestra compatti */
    .kpi-controls{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;margin-top:.35rem}
    .kpi-controls .btn{padding:.3rem .6rem;font-size:.8rem;line-height:1;border-radius:8px}
    .kpi-controls input[type="date"]{min-width:10ch}

    /* >>> HEAD-FILTER: chip nel titolo dei KPI */
    .kpi-title{display:flex;align-items:center;justify-content:space-between;gap:.6rem;margin-bottom:.35rem}
    .kpi-label{font-size:.85rem;color:var(--muted);font-weight:700;letter-spacing:.02em;text-transform:uppercase}
    .kpi-chips{display:flex;gap:.3rem;flex-wrap:wrap}
    .kpi-chip{padding:.18rem .5rem;border:1px solid rgba(77,163,255,.32);border-radius:999px;background:rgba(17,29,49,.65);font-size:.75rem;cursor:pointer;transition:transform .15s var(--ease), box-shadow .15s var(--ease), border-color .15s}
    .kpi-chip.active{background:var(--accent);color:#fff;border-color:transparent}
    .kpi-chip:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(7,12,26,.45)}

    .kpi-grid{
      display:grid;
      gap:1.2rem;
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
      align-items:stretch;
    }
    .kpi-grid .card.kpi{min-height:190px}

    .card.kpi{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:190px;
      padding:1.2rem;
      gap:.35rem;
      background:linear-gradient(160deg, rgba(77,163,255,.18), rgba(17,29,49,.92));
      border:1px solid rgba(77,163,255,.24);
      box-shadow:0 22px 48px rgba(7,12,26,.45);
      transition:transform .22s var(--ease), box-shadow .22s var(--ease), border-color .22s var(--ease);
    }
    .card.kpi .kpi-label .muted{display:inline-block;padding:.1rem .45rem;margin-left:.4rem;border-radius:999px;border:1px solid rgba(77,163,255,.3);background:rgba(77,163,255,.12)}
    .card.kpi .value{font-size:1.9rem;font-weight:800;line-height:1.2}
    .card.kpi .kpi-sub{font-size:.78rem;color:var(--muted);letter-spacing:.045em;text-transform:uppercase}
    .card.kpi:hover{transform:translateY(-6px);box-shadow:0 28px 54px rgba(6,11,25,.55);border-color:rgba(77,163,255,.38)}
    .card.kpi.accent{background:linear-gradient(160deg, rgba(99,102,241,.38), rgba(59,130,246,.22));border-color:rgba(129,140,248,.45)}
    .card.kpi.kpi-clickable{cursor:pointer}
    .card.kpi.kpi-clickable::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:radial-gradient(120% 140% at 50% 0%, rgba(77,163,255,.35), transparent 60%);
      opacity:0;
      transition:opacity .22s var(--ease);
      pointer-events:none;
    }
    .card.kpi.kpi-clickable:hover::after{opacity:1}

    .kpi-title .kpi-chips{margin-left:auto}
    .kpi-positive{color:var(--success);font-weight:700}
    .kpi-negative{color:var(--danger);font-weight:700}

    .dashboard-main-grid,
    .dashboard-tertiary-grid{
      display:grid;
      gap:1.2rem;
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
      margin-top:1rem;
      align-items:stretch;
    }

    /* Dashboard card expand/collapse with transition */
    .dashboard-card-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.3s var(--ease), opacity 0.2s var(--ease);
      padding: 0 1rem; /* collapsed default padding compensated */
    }
    .dashboard-card.expanded .dashboard-card-content {
      opacity: 1;
      padding: 1rem; /* restore padding when expanded */
    }
    .dashboard-card-header:hover { background: var(--input-focus); }
    .dashboard-card .expand-icon { transition: transform 0.2s var(--ease); display:none; }
    .dashboard-card.expanded .expand-icon { transform: rotate(180deg); }

    /* Riassunto Finanziario: riga orizzontale compatta e larga */
    .kpi-inline {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      align-items: stretch;
    }
    @media (max-width: 980px) { .kpi-inline { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .kpi-inline { grid-template-columns: 1fr; } }
    /* Fai estendere il riassunto su tutta la riga della griglia terziaria */
    #card-summary { grid-column: 1 / -1; }
    #card-summary .dashboard-card-header { padding: .75rem 1rem; }
    #card-summary .dashboard-card-content { padding: .75rem 1rem; }
    #card-summary .kpi { padding: .75rem; }

    /* Avanzamento Cantieri in fondo e con spazio superiore */
    .dashboard-card#card-phases { margin-top: 2rem; }

    /* Espansione card: aumenta massima altezza in stato expanded (JS regola comunque inline) */
    .dashboard-card.expanded .dashboard-card-content { max-height: 800px; }

    /* --- Picker collaboratori --- */
    .collab-picker{position:relative;border:1px solid var(--input-border);border-radius:10px;background:var(--input-bg);padding:.45rem;min-height:44px;display:flex;gap:.35rem;flex-wrap:wrap}
  .collab-chip{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .45rem;border-radius:999px;background:var(--panel);border:1px solid var(--border);font-size:.85rem;line-height:1}
    .collab-chip button{border:none;background:transparent;color:var(--muted);cursor:pointer}
    .collab-input{border:none;outline:none;background:transparent;min-width:120px;padding:.25rem}
    .collab-dropdown{position:absolute;left:0;right:0;top:100%;z-index:10;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);max-height:240px;overflow:auto;display:none}
    .collab-row{display:flex;align-items:center;gap:.5rem;padding:.5rem .6rem;cursor:pointer}
  .collab-row span.muted{max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .collab-row:hover{background:rgba(77,163,255,.08)}
    .collab-row input{pointer-events:none}

  /* --- Ticket day overlay --- */
  .kpi-mini{padding:.45rem .6rem;border:1px solid var(--border);background:var(--panel);border-radius:10px;font-size:.9rem}
  .grid-2{display:grid;gap:1rem;grid-template-columns:1fr}
  @media(min-width:980px){.grid-2{grid-template-columns:1.1fr .9fr}}
  .bar-row{margin:.35rem 0}
  .bar-row .hdr{display:flex;justify-content:space-between}
  .bar-row .hdr .lbl{color:var(--muted)}
  .bar-row .hdr .val{color:var(--muted)}
  .bar-row .progress{margin-top:.25rem}
  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl th,.tbl td{padding:.55rem;border-bottom:1px solid var(--border);text-align:left}
  .tbl td.right{text-align:right}

    /* --- Agenda --- */
    .agenda-wrap{display:grid;grid-template-columns:360px 1fr;gap:1rem}
    @media(max-width:980px){.agenda-wrap{grid-template-columns:1fr}}
    .ag-form{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:1rem}
    .ag-form .row{margin-bottom:.5rem}
    .ag-form .conflict{background:rgba(239,68,68,.12);border:1px solid var(--danger);color:#fff;border-radius:8px;padding:.5rem;margin-top:.5rem;display:none}

    .ag-toolbar{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem}
    .ag-cal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:.5rem}
    .ag-monthbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
    .ag-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem}
    .ag-day{border:1px dashed var(--border);border-radius:10px;min-height:110px;padding:.35rem;display:flex;flex-direction:column;gap:.35rem}
    .ag-day .head{display:flex;align-items:center;justify-content:space-between;font-size:.85rem;color:var(--muted)}
    .ag-ev{font-size:.85rem;border-radius:8px;padding:.25rem .35rem;line-height:1.2;border:1px solid var(--border);background:rgba(77,163,255,.08)}
    .ag-ev.overlap{outline:2px solid var(--danger)}
    .ag-filters{display:flex;gap:.35rem;flex-wrap:wrap;margin:.35rem 0}
    .ag-tag{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:.25rem;vertical-align:middle}

    /* === Contrast micro-fixes (dark & light) === */
    .btn-ghost{ border-color: var(--border); }
    .btn-ghost:hover{ border-color: var(--accent); }

    .card{ background: var(--card); border-color: var(--border); }
    .kpi{ background: var(--panel); }

    html[data-theme="light"] .muted{ color:#334155; }
    html[data-theme="light"] .kpi .label{ color:#334155; }

    html[data-theme="light"] tbody tr:hover{ background:#e8f0ff; }
    html[data-theme="dark"]  tbody tr:hover{ background:rgba(77,163,255,.12); }

    .progress{ background: color-mix(in srgb, var(--muted) 18%, transparent); border-color: var(--border); }

    html[data-theme="light"] input:focus,
    html[data-theme="light"] select:focus,
    html[data-theme="light"] textarea:focus{
      box-shadow: 0 0 0 4px var(--input-focus);
      border-color: var(--accent);
    }

    .st-draft{ background:rgba(107,114,128,.15); color:#475569 }
    .st-issued{ background:rgba(59,130,246,.15); color:#1d4ed8 }
    .st-paid{ background:rgba(34,197,94,.15);  color:#15803d }
    .st-partial{ background:rgba(245,158,11,.15); color:#b45309 }
    .st-overdue{ background:rgba(239,68,68,.15); color:#b91c1c }

    html[data-theme="light"] .card .value{ color:#0b1220 }
    /* --- Market card + micro-animazioni --- */
    .card-market { overflow: hidden; position: relative; }
    .card-market::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(1200px 280px at 10% -10%, color-mix(in srgb, var(--accent) 14%, transparent), transparent);
      opacity:.18;
    }
    .card { transition: transform .18s var(--ease), box-shadow .18s var(--ease), border-color .18s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 16px 36px rgba(0,0,0,.28); border-color: color-mix(in srgb, var(--accent) 26%, var(--border)); }
    .card .value { transition: filter .2s; }
    .card:hover .value { filter: brightness(1.04); }

    .kpi .value { animation: countPop .35s ease-out; }
    @keyframes countPop { from { transform: translateY(2px); opacity:.7 } to { transform:none; opacity:1 } }

    /* chip attivi con glow leggero */
    .kpi-chip.active { box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 22%, transparent); }

    /* Effetto gradiente su KPI principali */
    .card.kpi.accent {
      border-color: color-mix(in srgb, var(--accent) 40%, var(--border));
      background: linear-gradient(180deg,
        color-mix(in srgb, var(--accent) 10%, transparent),
        transparent 80%);
    }

    /* --- Market: linee + tracer live --- */
    .card-market { overflow:hidden; position:relative; }
    .card-market .legend{display:flex; gap:.75rem; align-items:center}
    .legend .dot{width:10px;height:10px;border-radius:999px}
    .legend .rev{background:var(--accent)}
    .legend .cost{background:var(--danger)}
    .legend .profit{background:var(--success)}
    .market-badge{
      position:absolute; right:12px; top:12px; font-size:.85rem;
      background:rgba(0,0,0,.18); border:1px solid var(--border);
      padding:.25rem .5rem; border-radius:8px; color:var(--text)
    }

    /* tracer animato */
    .market-tracer{
      position:absolute; top:56px; bottom:22px; width:2px;
      background: color-mix(in srgb, var(--accent) 40%, transparent);
      box-shadow:0 0 0 1px color-mix(in srgb, var(--accent) 25%, transparent);
      pointer-events:none; opacity:.7
    }

    /* --- Recap card comune --- */
    .recap{display:grid; grid-template-columns:repeat(4,minmax(160px,1fr)); gap:.75rem}
    .recap-item{
      background:var(--panel); border:1px solid var(--border);
      border-radius:12px; padding:.8rem 1rem; box-shadow:var(--shadow)
    }
    .recap .buttonlike{cursor:pointer; transition:transform .12s ease, box-shadow .12s ease}
    .recap .buttonlike:hover{transform:translateY(-2px); box-shadow:var(--shadow)}
    .recap .buttonlike:active{transform:translateY(0)}
  .buttonlike{cursor:pointer}
  .kpi.buttonlike{transition:transform .12s ease, box-shadow .12s ease}
  .kpi.buttonlike:hover{transform:translateY(-2px); box-shadow:var(--shadow)}
  .kpi.buttonlike:active{transform:translateY(0)}
    .recap-item.interactive{cursor:pointer;transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;position:relative;overflow:hidden}
    .recap-item.interactive::after{content:'';position:absolute;inset:0;pointer-events:none;background:linear-gradient(135deg,rgba(148,163,184,.14),transparent 55%);opacity:0;transition:opacity .2s ease}
    .recap-item.interactive:hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(15,23,42,.32);border-color:color-mix(in srgb,var(--accent) 32%,var(--border))}
    .recap-item.interactive:hover::after{opacity:1}
    .recap-item.interactive:focus-visible{outline:2px solid color-mix(in srgb,var(--accent) 55%,transparent);outline-offset:3px}
    .recap-item .k{font-size:.82rem; color:var(--muted); font-weight:700}
    .recap-item .v{font-weight:900; font-size:1.25rem}
    @media(max-width:980px){ .recap{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:640px){ .recap{grid-template-columns:1fr} }

    /* ===== CHROME-SAFE PATCH: TOPBAR + SIDEBAR + MARGINI ===== */

    /* Gutter unificati */
    :root{ --gutter-x:16px; --gutter-y:16px; }

    /* 1) Niente padding extra sulla sidebar (evita spostamenti) */
    aside{ padding-left:0 !important; }
    .nav button{ margin-inline:0 !important; }

    /* 2) Contenitore scroll principale: padding standard */
    main{
      padding: var(--gutter-y) var(--gutter-x) var(--gutter-y) !important;
      scroll-padding-top: 72px; /* quando salti a un anchor */
    }

    /* 3) Topbar sticky senza margini negativi (Chrome safe) */
    main > .topbar{
      position: sticky !important;
      top: 0 !important;
      left: 0; right: 0;
      z-index: 100 !important;
      background: var(--bg) !important;
      border-bottom: 1px solid var(--border) !important;

      /* layout semplice, niente grid tricky */
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;

      margin: 0 !important;
      padding: .75rem 0 1rem !important;
      isolation: isolate; /* evita clipping sotto overflow antenati */
    }

    /* padding orizzontale interno alla topbar */
    main > .topbar > *{ padding: 0 var(--gutter-x); }
    .topbar-left, .topbar-right{ display:flex !important; align-items:center !important; gap:.75rem !important; }
    .topbar-center{ display:flex !important; align-items:center !important; justify-content:center !important; min-width:140px !important; pointer-events:none !important; }

    /* 4) Head delle tabelle sticky solo dentro la card (non “sopra” la topbar) */
    .card-content thead{ top: 0; }

    /* 5) Mobile: forza il toggle menu a comparire (override inline) */
    @media (max-width:768px){
      #mobile-menu-toggle{ display:block !important; left: var(--gutter-x) !important; }
      body.mobile-menu-open aside{
        display:flex !important;
        position: fixed !important; inset: 0 auto 0 0 !important;
        width:300px !important; height:100% !important; z-index:999 !important;
      }
    }

  /* --- Modal generico per editor (riuso di #edit-modal) --- */
  .edit-action{ cursor:pointer; }
  .edit-modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.5); z-index:10002;
    }
    .edit-modal.show,
    .edit-modal.open{ display:flex; }
    .edit-modal .edit-modal-content{
      width:min(1000px, 95%);
      max-height:85vh;
      overflow:auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
    }
    .edit-modal .edit-modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:.8rem 1rem; border-bottom:1px solid var(--border);
    }
    .edit-modal .edit-modal-header h2{ margin:0; }
    .edit-modal .edit-modal-content #edit-modal-body{ padding:1rem; }

    /* Griglia “ariosità” */
    .detail-grid{
      display:grid; grid-template-columns: repeat(2, minmax(240px,1fr));
      gap:.9rem 1.2rem;
    }
    @media (max-width: 900px){ .detail-grid{ grid-template-columns: 1fr; } }

    /* Tabella scrollabile / azioni */
  .table-scroll-lg{ max-height:440px; overflow:auto; border:1px solid var(--border); border-radius:10px; margin-top:.75rem; }
    .table-actions{ text-align:right; white-space:nowrap; }
    #ex-forecast-monthly{display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0}
    #ex-forecast-monthly .pill,
    #ex-foreground-clicks .pill,
    .clickable-pill{cursor:pointer; user-select:none}
    #ex-forecast-card .kpi-inline .value{cursor:default}

    /* Rendi la topbar sempre visibile e staccata dal contenuto */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: .75rem 0 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
  </style>
  <!-- ICONS -->
  <script>
const ICONS = {
  google:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#4285F4" d="M21.35 11.1h-9.17v2.98h5.26c-.23 1.33-1.57 3.9-5.26 3.9a6.07 6.07 0 1 1 0-12.14 5.3 5.3 0 0 1 3.74 1.47l2.55-2.46A9.08 9.08 0 0 0 12.18 2C6.93 2 2.67 6.26 2.67 11.5S6.93 21 12.18 21c5.6 0 9.3-3.93 9.3-9.43 0-.62-.07-1.07-.13-1.47z"/></svg>',
  gmail:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#EA4335" d="M22 18V6l-10 7L2 6v12h4V9l6 4 6-4v9z"/></svg>',
  youtube:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#FF0000" d="M23 12c0-3-.6-4.7-1.3-5.4C20.9 5 18 5 12 5s-8.9 0-9.7 1.6C1.6 8.1 1 9.8 1 12s.6 3.9 1.3 4.6C3.1 18.9 6 19 12 19s8.9-.1 9.7-1.4c.7-.7 1.3-2.4 1.3-5.6z"/><path fill="#fff" d="M10 15l5-3-5-3v6z"/></svg>',
  maps:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#10b981" d="M12 2a7 7 0 0 0-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 0 0-7-7zm0 9.5A2.5 2.5 0 1 1 12 6a2.5 2.5 0 0 1 0 5z"/></svg>',
  drive:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#0ea5e9" d="M8 4h8l4 7-4 7H8L4 11 8 4z"/></svg>',
  calendar:'<svg viewBox="0 0 24 24" width="36" height="36"><rect x="3" y="4" width="18" height="16" rx="2" fill="#6366f1"/><path fill="#fff" d="M3 8h18v2H3z"/></svg>',
  whatsapp:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#22c55e" d="M20 3.9A10 10 0 0 0 3.2 17.5L2 22l4.6-1.2A10 10 0 0 0 12 22a10 10 0 0 0 8-18.1z"/><path fill="#fff" d="M16.6 13.7c-.2-.1-1.3-.6-1.4-.6s-.3-.1-.5.1-.6.6-.7.7-.3.2-.5.1a7.8 7.8 0 0 1-2.3-1.4 8.6 8.6 0 0 1-1.6-2c-.2-.4 0-.5.1-.6l.3-.3c.1-.1.1-.2.2-.3s.1-.2 0-.3-.5-1.2-.7-1.6c-.2-.5-.4-.4-.5-.4h-.4a.8.8 0 0 0-.6.3c-.2.2-.8.8-.8 2s.8 2.3.9 2.5 1.6 2.6 3.9 3.6c.5.2.9.4 1.2.5.5.2.9.2 1.2.1.4-.1 1.3-.5 1.5-1s.2-.9.1-1-.2-.1-.4-.2z"/></svg>',
  teams:'<svg viewBox="0 0 24 24" width="36" height="36"><circle cx="8" cy="8" r="3" fill="#6366f1"/><circle cx="16" cy="7" r="2.5" fill="#7c3aed"/><rect x="2" y="12" width="20" height="8" rx="4" fill="#6366f1"/></svg>',
  slack:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#10b981" d="M7 15h2v6H7zM3 13a2 2 0 1 0 0 4h4v-2H3zM15 7h6v2h-6zM13 3a2 2 0 1 0-4 0v4h2V3z"/><path fill="#f59e0b" d="M17 7h2v6h-2zM13 17v4a2 2 0 1 0 4 0v-4h-2zM7 5H3a2 2 0 1 0 0 4h4V7zM11 13H7v2h4z"/></svg>',
  trello:'<svg viewBox="0 0 24 24" width="36" height="36"><rect x="3" y="4" width="18" height="16" rx="2" fill="#0ea5e9"/><rect x="6" y="6" width="6" height="12" rx="1" fill="#fff"/><rect x="13" y="6" width="5" height="8" rx="1" fill="#fff"/></svg>',
  github:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#111827" d="M12 .5a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.5-4-1.5-.6-1.3-1.3-1.6-1.3-1.6-1-.7.1-.7.1-.7 1.1.1 1.7 1.2 1.7 1.2 1 .1 2.7-.6 3.3-1"/></svg>',
  notion:'<svg viewBox="0 0 24 24" width="36" height="36"><rect x="3" y="3" width="18" height="18" rx="3" fill="#111827"/><path fill="#fff" d="M8 6h8v12h-2.2l-3.6-6.6V18H8z"/></svg>',
  outlook:'<svg viewBox="0 0 24 24" width="36" height="36"><rect x="3" y="5" width="12" height="14" rx="2" fill="#2563eb"/><circle cx="15" cy="12" r="6" fill="#60a5fa"/></svg>',
  dropbox:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#2563eb" d="M8 3l4 3-4 3-4-3 4-3zm8 0l4 3-4 3-4-3 4-3zM4 12l4 3-4 3-4-3 4-3zm12 0l4 3-4 3-4-3 4-3z"/></svg>',
  linkedin:'<svg viewBox="0 0 24 24" width="36" height="36"><rect x="3" y="8" width="4" height="12" fill="#2563eb"/><rect x="9" y="11" width="12" height="9" fill="#2563eb"/><circle cx="5" cy="5" r="2" fill="#2563eb"/></svg>',
  paypal:'<svg viewBox="0 0 24 24" width="36" height="36"><path fill="#2563eb" d="M7 20l1.2-6.5h6.6c3.2 0 4.9-1.4 4.9-4.2 0-2-1.6-3.8-4.6-3.8H6.1L4 20h3z"/></svg>',
  stripe:'<svg viewBox="0 0 24 24" width="36" height="36"><rect x="3" y="5" width="18" height="14" rx="3" fill="#7c3aed"/><path fill="#fff" d="M7 15h3.5c1.4 0 2.5-.7 2.5-2s-1.1-2-2.5-2H9V8h2.5C14 8 16 9.3 16 13s-2 4-4.5 4H7z"/></svg>'
  };
</script>
</head>
<body>
<div class="app" role="application">
  <!-- SIDEBAR -->
  <aside>
    <div class="brand">
      <div class="logo" id="brand-logo" aria-hidden="true"><img alt="Logo" id="brand-logo-img"></div>
      <span>Edil Repairs Software&amp;Technology</span>
    </div>

    <nav class="nav" aria-label="Sezioni">
      <button type="button" data-route="home"      aria-controls="page-home" aria-current="page">Dashboard</button>
      <button type="button" data-route="offers"    aria-controls="page-offers">Offerte</button>
      <button type="button" data-route="cantieri"  aria-controls="page-cantieri">Cantieri</button>
      <button type="button" data-route="collab"    aria-controls="page-collab">Collaboratori</button>
      <button type="button" data-route="ticket"    aria-controls="page-ticket">Nuovo Ticket</button>
      <button type="button" data-route="invoices"  aria-controls="page-invoices">Fatture</button>
      <button type="button" data-route="overdue"   aria-controls="page-overdue">Scadute</button>
      <button type="button" data-route="agenda"    aria-controls="page-agenda">Programma Lavori</button>
      <button type="button" data-route="payments"  aria-controls="page-payments">Incassi</button>
      <button type="button" data-route="expenses"  aria-controls="page-expenses">Spese</button>
      <button type="button" data-route="bilanci"   aria-controls="page-bilanci">Bilanci</button>
  <button type="button" data-route="forecast"  aria-controls="page-forecast">Previsioni</button>
      <button type="button" data-route="apps"      aria-controls="page-apps">Applicazioni</button>
      <button type="button" data-route="reports"   aria-controls="page-reports">Report</button>
  <button type="button" data-route="archive"   aria-controls="page-archive">Archivio</button>
      <button type="button" data-route="settings"  aria-controls="page-settings">Impostazioni</button>
    </nav>

    <div class="sidebar-meta">
      <div>File: <span id="file-version-side">—</span></div>
      <div>Ultimo salvataggio: <span id="last-save-side">—</span></div>
    </div>
  </aside>

  <!-- MOBILE MENU TOGGLE -->
  <button class="mobile-menu-toggle" id="mobile-menu-toggle" style="display:none">☰</button>

  <!-- MAIN -->
  <main>
    <div class="topbar">
      <div class="topbar-left">
        <div class="theme-toggle">
          <span class="muted">Tema</span>
          <div id="theme-switch" class="switch" role="button" aria-label="Cambia tema"></div>
        </div>
        <div class="pill"><span class="muted">Ricerca</span>
          <input id="global-search" placeholder="Cerca in tutto (Ctrl/Cmd+K per Command Palette)" style="border:none;background:transparent;padding:0 .25rem;outline:none"/>
        </div>
      </div>

      <div class="topbar-center" aria-hidden="true"><img id="app-logo-topbar" alt="Logo"></div>

      <div class="topbar-right">
        <span>© <span id="anno"></span> · Dati nel browser</span>
        <span id="file-version" class="muted"></span>
        <button id="btn-logout" class="btn btn-ghost" type="button">Logout</button>
      </div>
    </div>

    <!-- HOME - IMPROVED DASHBOARD -->
    <section id="page-home" class="page" style="display:block">
      <!-- TOP LINE CHART (stock-like) -->
      <section class="card card-market" id="card-market" style="margin-bottom:1rem; position:relative">
        <div class="card-header" style="justify-content:space-between">
          <div>
            <h2>Andamento (ultimi 12 mesi)</h2>
            <div class="legend muted">
              <span class="dot rev"></span><span>Ricavi</span>
              <span class="dot cost"></span><span>Costi</span>
              <span class="dot profit"></span><span>Utile</span>
          </div>
          </div>
          <div class="market-badge" id="mk-sub">—</div>
        </div>
        <div class="card-content" style="padding:0; position:relative">
          <div id="market-tracer" class="market-tracer" aria-hidden="true"></div>
          <canvas id="market-chart" class="chart" style="height:260px"></canvas>
        </div>
      </section>

      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-home"></div></div>
      </div>

      <!-- Sezione 1: KPI Live (3 colonne) -->
      <div class="kpi-grid">
        <!-- 1. Guadagni -->
        <div class="card kpi" data-detail="revenue-live">
          <div class="kpi-label">Guadagni live (anno)</div>
          <div id="h-live-revenue" class="value">—</div>
          <div class="kpi-sub"><span id="h-live-revenue-base">—</span> · <span id="h-live-revenue-extra">—</span></div>
        </div>

        <!-- 2. Spese -->
        <div class="card kpi" data-detail="costs-live">
          <div class="kpi-label">Spese live (anno)</div>
          <div id="h-live-costs" class="value">—</div>
          <div class="kpi-sub"><span id="h-live-costs-base">—</span> · <span id="h-live-costs-extra">—</span></div>
        </div>

        <!-- 3. Utile -->
  <div class="card kpi accent" data-detail="profit-live">
          <div class="kpi-label">Utile live (anno)</div>
          <div id="h-live-profit" class="value">—</div>
          <div class="kpi-sub"><span id="h-live-profit-margin">—%</span></div>
        </div>
      </div>

      <!-- Sezione 2: Incassi/Spese (4 colonne) -->
      <div class="dashboard-main-grid">
        <!-- Incassi avvenuti -->
        <div class="card kpi" data-detail="cash-actual">
          <div class="kpi-title">
            <div class="kpi-label">Incassi <span class="muted">(avvenuti)</span></div>
            <span id="hf-cash7" class="kpi-chips"></span>
          </div>
          <div id="h-cash-7d" class="value">—</div>
        </div>

        <!-- Spese effettuate -->
        <div class="card kpi" id="kpi-spese-range" data-detail="expenses-actual">
          <div class="kpi-title">
            <div class="kpi-label">Spese <span class="muted">(effettuate)</span></div>
            <span id="hf-spese" class="kpi-chips"></span>
          </div>
          <div id="h-expenses-range" class="value">—</div>
        </div>

        <!-- Incassi programmati -->
        <div class="card kpi" data-detail="cash-planned">
          <div class="kpi-title">
            <div class="kpi-label">Incassi <span class="muted">(programmati)</span></div>
            <span id="hf-cash" class="kpi-chips"></span>
          </div>
          <div class="value"><span id="h-cash-next15-sum">—</span></div>
          <div class="kpi-sub"><span id="h-cash-next15-count">0</span> mov.</div>
        </div>

        <!-- Spese programmate -->
        <div class="card kpi" data-detail="expenses-planned">
          <div class="kpi-title">
            <div class="kpi-label">Spese <span class="muted">(programmate)</span></div>
            <span id="hf-exp" class="kpi-chips"></span>
          </div>
          <div class="value"><span id="h-exp-next15-sum">—</span></div>
          <div class="kpi-sub"><span id="h-exp-next15-count">0</span> mov.</div>
        </div>
      </div>

      <!-- Sezione 3: Progetti/Scadute/Budget/Riassunto (4 colonne) -->
      <div class="dashboard-tertiary-grid">
        <!-- Progetti in offerta -->
        <div class="card kpi" data-detail="offers-active">
          <div class="label">Progetti in offerta</div>
          <div class="value"><span id="h-offers-active-count">—</span></div>
          <div class="kpi-sub" id="h-offers-active-sum">—</div>
        </div>

        <!-- Progetti attivi · ore rimanenti -->
        <div class="card kpi" data-detail="sites-active">
          <div class="label">Progetti attivi · ore rimanenti</div>
          <div class="value"><span id="h-sites-active-count">—</span></div>
          <div class="kpi-sub" id="h-sites-remaining-hours">—</div>
        </div>

        <!-- Fatture scadute (KPI statico) -->
        <div class="card kpi" data-detail="invoices-overdue">
          <div class="label">Fatture scadute</div>
          <div id="h-overdue-invoices-count" class="value">—</div>
          <div class="kpi-sub"><span id="h-overdue-invoices-amount">—</span></div>
        </div>

        <!-- Budget residuo cantieri -->
        <div class="card kpi" data-detail="budget-remaining">
          <div class="label">Budget residuo cantieri</div>
          <div class="value"><span id="h-budrem-sum">—</span></div>
          <div class="kpi-sub"><span id="h-budrem-count">0</span> cantieri</div>
        </div>

        <!-- Riassunto Finanziario (statico) -->
        <div class="dashboard-card" id="card-summary" data-expand="no">
          <div class="dashboard-card-header" style="cursor:default">
            <h3>Riassunto Finanziario</h3>
          </div>
          <div class="dashboard-card-content" style="max-height:none; opacity:1; padding:1rem">
            <div class="kpi-inline">
              <div class="kpi"><div class="label">Ore a regia (mese)</div><div id="h-regia-month" class="value">—</div><div class="muted" id="h-regia-value"></div></div>
              <div class="kpi"><div class="label">Ore collaboratori (mese)</div><div id="h-collab-hours-month" class="value">—</div><div class="muted" id="h-collab-cost-month"></div></div>
              <div class="kpi"><div class="label">Spese YTD</div><div id="h-cost-year" class="value">—</div><div class="muted" id="h-break-year"></div></div>
              <div class="kpi"><div class="label">Spese totali</div><div id="h-cost-all" class="value">—</div><div class="muted" id="h-break-all"></div></div>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.75rem">
              <div class="pill"><span class="muted">Cantieri attivi</span><strong id="h-cant-attivi" style="margin-left:.4rem">0</strong></div>
              <div class="pill"><span class="muted">Cantieri terminati</span><strong id="h-cant-term" style="margin-left:.4rem">0</strong></div>
              <div class="pill"><span class="muted">Collaboratori</span><strong id="h-total-collab" style="margin-left:.4rem">0</strong></div>
              <div class="pill"><span class="muted">Ticket mese</span><strong id="h-tickets-month" style="margin-left:.4rem">0</strong></div>
              <div class="pill"><span class="muted">Offerte attive</span><strong id="h-offers-active" style="margin-left:.4rem">0</strong></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card espandibile condizionale: Avanzamento Fasi (spostata in fondo) -->

      <div class="grid cols-2" style="margin-top:1rem">
        <section class="card">
          <div class="card-header"><h2>Collaboratori - Riepilogo</h2></div>
          <div class="card-content">
            <div class="kpi" style="margin-bottom:1rem">
              <div class="label">Spesa totale ore collaboratori (mese)</div>
              <div id="h-collab-total-cost" class="value">—</div>
            </div>
            <div id="home-collab" class="list-scroll" style="display:grid; gap:.6rem"></div>
          </div>
        </section>
        <section class="card">
          <div class="card-header"><h2>Top Cantieri per Ore</h2></div>
          <div class="card-content"><div id="home-top-sites"></div></div>
        </section>
      </div>

      <div class="grid cols-2" style="margin-top:1rem">
        <section class="card">
          <div class="card-header"><h2>Offerte in Corso</h2></div>
          <div class="card-content"><div id="home-active-offers"></div></div>
        </section>
        <section class="card">
          <div class="card-header"><h2>Andamento ultimi 12 mesi</h2></div>
          <div class="card-content">
            <canvas id="home-chart" class="chart" aria-label="Grafico fatturato e costi"></canvas>
          </div>
        </section>
      </div>
      
      <!-- Sempre in fondo: Avanzamento Fasi Cantieri Attivi -->
      <div class="dashboard-card" id="card-phases" data-expand="auto" style="margin-top:1rem">
        <div class="dashboard-card-header">
          <h3>Avanzamento Fasi Cantieri Attivi</h3>
          <span class="expand-icon">▼</span>
        </div>
        <div class="dashboard-card-content">
          <div id="h-cantieri-fasi-box" style="font-size:.95rem"></div>
        </div>
      </div>
    </section>

    <!-- SCADUTE: Fatture + Spese -->
    <section id="page-overdue" class="page" style="display:none">
      <div class="grid cols-2">
        <!-- Fatture scadute -->
        <section class="card">
          <div class="card-header"><h2>Fatture Scadute</h2></div>
          <div class="card-content">
            <div class="kpi" style="margin-bottom:1rem">
              <div class="label">Totale scaduto</div>
              <div class="value" id="ovd-total">—</div>
              <div class="kpi-sub"><span id="ovd-count">0</span> fatture</div>
            </div>
            <div style="margin-bottom:.75rem; display:flex; gap:.5rem; flex-wrap:wrap">
              <button id="btn-ovd-reminders" class="btn btn-danger" type="button">Invia richiami</button>
              <button id="btn-ovd-copy" class="btn btn-ghost" type="button">Copia elenco</button>
            </div>
            <div id="ovd-list" class="list-scroll"></div>
          </div>
        </section>

        <!-- Spese scadute -->
        <section class="card">
          <div class="card-header"><h2>Spese Scadute</h2></div>
          <div class="card-content">
            <div class="kpi" style="margin-bottom:1rem">
              <div class="label">Totale scaduto</div>
              <div class="value" id="ovd-exp-total">—</div>
              <div class="kpi-sub"><span id="ovd-exp-count">0</span> spese</div>
            </div>
            <div id="ovd-exp-list" class="list-scroll"></div>
          </div>
        </section>
      </div>
    </section>

    <!-- OFFERTE -->
    <section id="page-offers" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-offers"></div></div>
      </div>
 <div class="grid cols-2"> <section class="card"> <div class="card-header"><h2>Offerte</h2></div> <div class="card-content"> <div class="row two" style="margin-bottom:.5rem"> <input id="of-search" placeholder="Cerca nome/cliente…"> <select id="of-filter"> <option value="">Tutte</option> <option value="in_corso">In Corso</option> <option value="vinta">Vinte</option> <option value="persa">Perse</option> <option value="annullata">Annullate</option> </select> </div> <div id="of-list" class="list-scroll"></div> </div> </section> <section class="card"> <div class="card-header"><h2>Dettaglio/Modifica Offerta</h2></div> <div class="card-content"> <form id="offer-form" class="row two" autocomplete="off" style="margin-bottom:1rem"> <div><label>Nome</label><input id="of-nome" required></div> <div><label>Cliente</label><input id="of-cliente"></div> <div><label>Importo</label><input id="of-importo" type="number" step="0.01"></div> <div><label>Probabilità %</label><input id="of-probabilita" type="number" min="0" max="100" step="1"></div> <div><label>Scadenza</label><input id="of-scadenza" type="date"></div> <div><label>Stato</label> <select id="of-stato"> <option value="in_corso">In Corso</option> <option value="vinta">Vinta</option> <option value="persa">Persa</option> <option value="annullata">Annullata</option> </select> </div> <div><label>Progetto</label>
  <select id="of-cat">
    <option value="fv">Fotovoltaico</option>
    <option value="ele">Elettrico</option>
  </select>
</div>
<div><label>Ore preventivate (opz.)</label>
  <input id="of-ore" type="number" step="0.1" min="0" placeholder="0.0">
</div>
 <div style="grid-column:1/-1"><label>Note</label><input id="of-note"></div>
 <div style="grid-column:1/-1">
  <label>Fasi (100% totale)</label>
  <div id="of-fasi"></div>
  <button type="button" id="btn-of-add-fase" class="btn btn-ghost" style="margin-top:.5rem">+ Aggiungi Fase</button>
</div>
 <div style="grid-column:1/-1"><button class="btn btn-primary" type="submit">Salva</button></div> </form> <div id="offer-detail" class="muted">Seleziona un’offerta.</div> </div> </section> </div>
<section class="card" style="margin-top:1rem">
  <div class="card-header"><h2>Statistiche Offerte</h2></div>
  <div class="card-content" id="of-stats"></div>
</section>

<div class="grid cols-2" style="margin-top:1rem">
  <section class="card">
    <div class="card-header"><h2>Progetti Fotovoltaici</h2></div>
    <div class="card-content"><div id="of-list-fv" class="list-scroll"></div></div>
  </section>
  <section class="card">
    <div class="card-header"><h2>Progetti Elettrici</h2></div>
    <div class="card-content"><div id="of-list-ele" class="list-scroll"></div></div>
  </section>
</div>
    </section>

    <!-- CANTIERI -->
    <section id="page-cantieri" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-cantieri"></div></div>
      </div>
      <div class="grid cols-2">
    <section class="card">
      <div class="card-header"><h2>Cantieri</h2></div>
      <div class="card-content">
        <div class="row two" style="margin-bottom:.5rem">
          <input id="si-search" placeholder="Cerca cantiere…">
          <select id="si-filter">
            <option value="">Tutti</option>
            <option value="attivo">Attivi</option>
            <option value="terminato">Terminati</option>
          </select>
        </div>
        <div id="si-list" class="list-scroll"></div>
      </div>
    </section>
    <section class="card">
      <div class="card-header"><h2>Nuovo/Modifica Cantiere</h2></div>
      <div class="card-content">
        <form id="site-form" class="row two" autocomplete="off">
          <input type="hidden" id="si-edit-id">
          <div><label>Nome</label><input id="si-nome" required></div>
          <div><label>Ore preventivate</label><input id="si-est" type="number" step="0.01"></div>
          <div><label>Importo offerta</label><input id="si-offer" type="number" step="0.01"></div>
          <div><label>Progetto</label>
  <select id="si-cat">
    <option value="fv">Fotovoltaico</option>
    <option value="ele">Elettrico</option>
  </select>
</div>
          <div><label>Budget materiali</label><input id="si-mat-budget" type="number" step="0.01"></div>
          <div style="grid-column:1/-1"><label>Note</label><input id="si-note"></div>
          <div style="grid-column:1/-1">
            <label>Fasi (100% totale)</label>
            <div id="si-fasi"></div>
            <button type="button" id="btn-add-fase" class="btn btn-ghost" style="margin-top:.5rem">+ Aggiungi Fase</button>
          </div>
          <div style="grid-column:1/-1;display:flex;gap:.5rem">
            <button class="btn btn-primary" type="submit">Salva Cantiere</button>
            <button class="btn btn-ghost" type="reset">Pulisci</button>
          </div>
        </form>
        <div id="site-detail" class="muted" style="margin-top:1rem">Seleziona un cantiere.</div>
      </div>
    </section>
  </div>
  <section class="card" style="margin-top:1rem">
    <div class="card-header"><h2>Statistiche Cantieri</h2></div>
    <div class="card-content" id="si-stats"></div>
  </section>

  <div class="grid cols-2" style="margin-top:1rem">
    <section class="card">
      <div class="card-header"><h2>Fotovoltaico</h2></div>
      <div class="card-content"><div id="si-list-fv" class="list-scroll"></div></div>
    </section>
    <section class="card">
      <div class="card-header"><h2>Elettrico</h2></div>
      <div class="card-content"><div id="si-list-ele" class="list-scroll"></div></div>
    </section>
  </div>
    </section>

    <!-- COLLABORATORI -->
    <section id="page-collab" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-collab"></div></div>
      </div>
  <div class="grid cols-2">
    <section class="card">
      <div class="card-header"><h2>Collaboratori</h2></div>
      <div class="card-content">
        <input id="co-search" placeholder="Cerca nome/ruolo…" style="margin-bottom:.5rem">
        <div id="co-list" class="list-scroll"></div>
      </div>
    </section>
    <section class="card">
      <div class="card-header"><h2>Nuovo/Modifica Collaboratore</h2></div>
      <div class="card-content">
        <form id="collab-form" class="row two" autocomplete="off">
          <input type="hidden" id="co-edit-id">
          <div><label>Nome</label><input id="co-nome" required></div>
          <div><label>Ruolo</label><input id="co-ruolo"></div>
          <div><label>Tariffa oraria</label><input id="co-rate" type="number" step="0.01"></div>
          <div><label>Data assunzione</label><input id="co-hire" type="date"></div>
          <!-- >>> PATCH: stipendio netto mensile -->
          <div><label>Stipendio netto (mensile)</label>
            <input id="co-salary" type="number" step="0.01" placeholder="0">
          </div>
          <div><label>Ore mensili previste</label>
            <input id="co-monthly-hours" type="number" step="0.1" min="0" placeholder="0">
          </div>
          <div style="grid-column:1/-1"><label>Note</label><input id="co-note"></div>
          <div style="grid-column:1/-1"><button class="btn btn-primary" type="submit">Salva</button></div>
        </form>
        <div id="collab-detail" class="muted">Seleziona un collaboratore.</div>
      </div>
    </section>
  </div>
    </section>

    <!-- TICKET - CON MODIFICA -->
    <section id="page-ticket" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-ticket"></div></div>
      </div>
      <div class="grid cols-2">
        <section class="card">
          <div class="card-header"><h2>Nuovo/Modifica Ticket</h2></div>
          <div class="card-content">
            <form id="ticket-form" autocomplete="off">
              <input type="hidden" id="ti-edit-id">
              <input type="hidden" id="ti-ore">
              <div class="row three">
                <div><label>Data</label><input id="ti-data" type="date" required></div>
                <div>
                  <label>Collaboratori</label>
                  <div id="ti-collab-picker" class="collab-picker">
                    <input id="ti-collab-search" class="collab-input" placeholder="Cerca e seleziona…">
                    <div id="ti-collab-dd" class="collab-dropdown"></div>
                  </div>
                  <small class="muted">Digita per filtrare, clicca per aggiungere/rimuovere</small>
                  <div id="ti-collab-hrs" class="card" style="margin-top:.5rem;display:none;padding:.6rem">
                    <div class="muted" style="margin-bottom:.35rem">Ore per collaboratore</div>
                    <div id="ti-collab-hrs-list" style="display:grid;gap:.4rem;grid-template-columns:1fr 140px"></div>
                  </div>
                </div>
                <div>
                  <label>Cantiere</label>
                  <div class="field" style="position:relative">
                    <input id="ti-site-search" placeholder="Cerca cantiere… (digita)" autocomplete="off">
                    <div id="ti-site-suggest" class="suggest" style="display:none"></div>
                  </div>
                  <select id="ti-site" required style="margin-top:.5rem"></select>
                  <label style="display:flex; align-items:center; gap:.5rem; margin-top:.5rem">
                    <input type="checkbox" id="ti-site-manual-toggle"> Inserimento manuale
                  </label>
                  <input id="ti-site-manual" placeholder="Nome cantiere manuale" style="display:none; margin-top:.5rem">
                </div>
              </div>
              <div class="row two">
                <div style="grid-column:1/-1"><label>Fase (opz.)</label><select id="ti-phase"></select></div>
              </div>
              <div class="row two">
                <div style="grid-column:1/-1"><label>Note</label><input id="ti-note" placeholder="attività svolte…"></div>
              </div>
              <!-- >>> PATCH: flag ore a regia -->
              <div style="grid-column:1/-1">
                <label style="display:flex; align-items:center; gap:.5rem">
                  <input type="checkbox" id="ti-regia"> Ore a regia (non attribuite a un cantiere)
                </label>
              </div>
              <div style="grid-column:1/-1">
                <label>Materiali</label>
                <div id="ti-mats"></div>
                <button id="btn-add-mat" type="button" class="btn btn-ghost" style="margin-top:.5rem">+ Aggiungi Materiale</button>
              </div>
              <div style="grid-column:1/-1; margin-top:.5rem">
                <label>Foto (opz.)</label>
                <input id="ti-photos" type="file" accept="image/*" multiple>
                <div id="ti-photos-prev" style="display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.35rem"></div>
              </div>
              <div style="grid-column:1/-1; display:flex; gap:.5rem; margin-top:.5rem">
                <button class="btn btn-primary" type="submit">Salva Ticket</button>
                <button class="btn btn-ghost" type="reset" id="btn-ticket-reset">Pulisci</button>
              </div>
            </form>
          </div>
        </section>
        <section class="card">
          <div class="card-header"><h2>Ultimi Ticket Inseriti</h2></div>
          <div class="card-content" style="overflow:auto; max-height:480px; border:1px solid var(--border); border-radius:var(--radius)">
            <table>
              <thead><tr><th>Data</th><th>Collab</th><th>Cantiere</th><th>Fase</th><th class="right">Ore</th><th>Materiali</th><th>Utile</th><th>Azioni</th></tr></thead>
              <tbody id="ti-last"></tbody>
            </table>
          </div>
        </section>
      </div>

      <section class="card" id="ti-cal-card" style="margin-top:1rem">
        <div class="card-header">
          <h2>Calendario Ticket (mese)</h2>
          <div style="display:flex; gap:.5rem">
            <button id="ti-cal-prev" class="btn btn-ghost" type="button">◀</button>
            <div id="ti-cal-title" style="font-weight:800"></div>
            <button id="ti-cal-next" class="btn btn-ghost" type="button">▶</button>
          </div>
        </div>
        <div class="card-content">
          <div id="ti-cal-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem"></div>
        </div>
      </section>
    </section>

    <!-- INVOICES - CON MODIFICA -->
    <section id="page-invoices" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-invoices"></div></div>
      </div>
      <div class="grid cols-2">
        <section class="card">
          <div class="card-header"><h2>Fatture</h2></div>
          <div class="card-content">
            <div class="row two" style="margin-bottom:.5rem">
              <input id="inv-search" placeholder="Cerca numero/cliente/oggetto…">
              <select id="inv-status">
                <option value="">Tutti</option>
                <option value="draft">Bozza</option>
                <option value="issued">Emesse</option>
                <option value="partial">Parziali</option>
                <option value="paid">Pagate</option>
                <option value="overdue">Scadute</option>
                <option value="canceled">Annullate</option>
              </select>
            </div>
            <div class="row two" style="margin-bottom:.5rem">
              <input id="inv-date-from" type="date" placeholder="Da">
              <input id="inv-date-to" type="date" placeholder="A">
            </div>
            <div style="margin-bottom:.75rem; display:flex; gap:.5rem">
              <button id="btn-new-invoice" type="button" class="btn btn-primary">Nuova Fattura</button>
              <button id="btn-recalc-inv" type="button" class="btn btn-ghost" title="Ricalcola stati fatture dagli incassi">Ricalcola Stati</button>
            </div>
            <div id="inv-list" class="list-scroll"></div>
          </div>
        </section>
        <section class="card">
          <div class="card-header"><h2>Dettaglio Fattura</h2></div>
          <div class="card-content"><div id="inv-detail" class="muted">Seleziona una fattura o creane una nuova.</div></div>
        </section>
      </div>
    </section>

    <!-- PAYMENTS -->
  <section id="page-payments" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-payments"></div></div>
      </div>
      <div class="grid cols-2">
        <section class="card">
          <div class="card-header"><h2>Incassi</h2></div>
          <div class="card-content">
            <div class="row two" style="margin-bottom:.5rem">
              <input id="pay-search" placeholder="Cerca riferimento…">
              <select id="pay-method">
                <option value="">Tutti</option>
                <option value="bank">Bonifico</option>
                <option value="cash">Contanti</option>
                <option value="card">Carta</option>
                <option value="other">Altro</option>
              </select>
            </div>
            <div class="row two" style="margin-bottom:.5rem">
              <input id="pay-date-from" type="date" placeholder="Da">
              <input id="pay-date-to" type="date" placeholder="A">
            </div>
            <div style="margin-bottom:.75rem;display:flex;gap:.5rem">
              <button id="btn-new-payment" class="btn btn-primary" type="button">Nuovo Incasso</button>
              <button id="btn-match" class="btn btn-ghost" type="button">Abbina automaticamente</button>
            </div>
            <div id="pay-list" class="list-scroll"></div>
          </div>
        </section>

  <!-- Dettaglio incasso nella seconda colonna -->
        <section class="card">
          <div class="card-header"><h2>Dettaglio Incasso</h2></div>
          <div class="card-content"><div id="pay-detail" class="muted">Seleziona un incasso o creane uno nuovo.</div></div>
        </section>
      </div>
    </section>

    <!-- EXPENSES (pagina separata, sorella di payments) -->
    <section id="page-expenses" class="page" style="display:none">
      <section class="card" id="ex-summary-card" style="margin-bottom:1rem"></section>
      <section class="card" id="ex-paid-registered-card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Spese pagate &amp; registrate</h2></div>
        <div class="card-content"><div id="ex-paid-registered"></div></div>
      </section>
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-expenses"></div></div>
      </div>
      <div class="grid cols-2">
        <section class="card">
          <div class="card-header"><h2>Spese</h2></div>
          <div class="card-content">
            <div class="row two" style="margin-bottom:.5rem">
              <input id="ex-search" placeholder="Cerca descrizione/categoria…">
              <select id="ex-rec">
                <option value="">Tutte</option>
                <option value="none">Una tantum</option>
                <option value="weekly">Settimanali</option>
                <option value="monthly">Mensili</option>
                <option value="yearly">Annuali</option>
              </select>
            </div>
            <div class="row two" style="margin-bottom:.5rem">
              <input id="ex-date-from" type="date" placeholder="Da">
              <input id="ex-date-to" type="date" placeholder="A">
            </div>
            <div style="margin-bottom:.75rem;display:flex;gap:.5rem">
              <button id="btn-new-expense" class="btn btn-primary" type="button">Nuova Spesa</button>
            </div>
            <div id="ex-list" class="list-scroll"></div>
          </div>
        </section>

        <section class="card">
          <div class="card-header"><h2>Dettaglio Spesa</h2></div>
          <div class="card-content"><div id="ex-detail" class="muted">Seleziona o crea una spesa.</div></div>
        </section>
      </div>

      <!-- Proiezione future -->
      <section class="card" id="ex-forecast-card" style="margin-top:1rem">
        <div class="card-header"><h2>Proiezione future</h2></div>
        <div class="card-content">
          <div id="ex-forecast-list" class="list-scroll"></div>
        </div>
      </section>

          <section class="card" id="ex-timeline-card" style="margin-top:1rem">
            <div class="card-header"><h2>Cronologia spese</h2></div>
            <div class="card-content">
              <div id="ex-timeline" class="list-scroll"></div>
            </div>
          </section>
    </section>

    <!-- Template form spesa (mantieni il contenuto esistente) -->
    <template id="tpl-expense-form">
      <div class="card" id="expense-form-card" style="margin-bottom:1rem; padding:1rem">
        <form id="expense-form" class="row two" autocomplete="off">
          <div><label>Data</label><input id="ex-date" type="date" required></div>
          <div><label>Importo</label><input id="ex-amount" type="number" min="0" step="0.01" required></div>
          <div><label>Categoria</label><input id="ex-category" placeholder="es. Affitto, Bolletta, Leasing"></div>
          <div><label>Stato</label>
            <select id="ex-status"><option value="planned">Programmato</option><option value="paid">Pagato</option><option value="canceled">Annullato</option></select>
          </div>
          <div style="grid-column:1/-1"><label>Descrizione</label><input id="ex-desc" placeholder="note/descrizione…"></div>
          <div><label>Ricorrenza</label>
            <select id="ex-recurring"><option value="none">Nessuna</option><option value="weekly">Settimanale</option><option value="monthly">Mensile</option><option value="yearly">Annuale</option></select>
          </div>
          <div><label>Fine ricorrenza (opz.)</label><input id="ex-rec-end" type="date"></div>
          <!-- >>> PATCH: campi ricorrenza avanzati -->
          <div><label>Ancora (data di ancoraggio)</label><input id="ex-anchor" type="date"></div>
          <div id="ex-dom-wrap"><label>Giorno del mese</label><input id="ex-day-of-month" type="number" min="1" max="31" step="1" placeholder="1-31"></div>
          <input id="ex-instance-date" type="hidden">
          <div id="ex-occ-paid-wrap" style="grid-column:1/-1; display:none"><label style="display:flex; align-items:center; gap:.5rem"><input id="ex-occ-paid" type="checkbox"> Segna questa occorrenza come pagata</label></div>
          <div style="grid-column:1/-1;display:flex;gap:.5rem">
            <button id="btn-ex-submit" class="btn btn-primary" type="submit">Salva Spesa</button>
            <button id="btn-ex-cancel" class="btn btn-ghost" type="button">Annulla</button>
          </div>
        </form>
      </div>
    </template>

    <!-- BILANCI -->
    <section id="page-bilanci" class="page" style="display:none">
      <section class="card">
        <div class="card-header"><h2>Bilanci (ultimi 12 mesi)</h2></div>
        <div class="card-content">
          <canvas id="bilanci-chart" class="chart" aria-label="Grafico bilanci"></canvas>
          <div id="bilanci-table" style="margin-top:1rem"></div>
        </div>
      </section>
    </section>

    <!-- PREVISIONI -->
    <section id="page-forecast" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Previsioni · Nuova voce</h2></div>
        <div class="card-content">
          <form id="fc-form" class="row two" autocomplete="off">
            <div>
              <label>Tipo</label>
              <select id="fc-type">
                <option value="income">Incasso (previsto)</option>
                <option value="expense">Spesa (prevista)</option>
              </select>
            </div>
            <div>
              <label>Data</label>
              <input id="fc-date" type="date" required>
            </div>
            <div>
              <label>Importo</label>
              <input id="fc-amount" type="number" step="0.01" min="0" required>
            </div>
            <div>
              <label>Etichetta</label>
              <input id="fc-label" placeholder="es. Acconto cliente / F24 / Canone...">
            </div>
            <div style="grid-column:1/-1">
              <label>Note</label>
              <input id="fc-note" placeholder="annotazioni (opz.)">
            </div>
            <div style="grid-column:1/-1; display:flex; gap:.5rem">
              <button class="btn btn-primary" type="submit">Aggiungi</button>
              <button class="btn btn-ghost" type="reset">Pulisci</button>
            </div>
          </form>
        </div>
      </div>

      <!-- RIEPILOGO PREVISIONI -->
      <section class="card" id="fc-summary-card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo Previsioni (anno corrente)</h2></div>
        <div class="card-content">
          <div class="kpi-grid">
            <div class="card kpi">
              <div class="kpi-label">Incassi previsti</div>
              <div class="value" id="fc-sum-inc-planned">—</div>
              <div class="kpi-sub">Da incassare</div>
            </div>
            <div class="card kpi">
              <div class="kpi-label">Incassi incassati</div>
              <div class="value" id="fc-sum-inc-done">—</div>
              <div class="kpi-sub">Segnati come incassati</div>
            </div>
            <div class="card kpi">
              <div class="kpi-label">Spese previste</div>
              <div class="value" id="fc-sum-exp-planned">—</div>
              <div class="kpi-sub">Da pagare</div>
            </div>
            <div class="card kpi">
              <div class="kpi-label">Spese pagate</div>
              <div class="value" id="fc-sum-exp-done">—</div>
              <div class="kpi-sub">Segnate come pagate</div>
            </div>
            <div class="card kpi accent">
              <div class="kpi-label">Netto previsto</div>
              <div class="value" id="fc-sum-net-forecast">—</div>
              <div class="kpi-sub">Incassi previsti – Spese previste</div>
            </div>
            <div class="card kpi accent">
              <div class="kpi-label">Netto incassato</div>
              <div class="value" id="fc-sum-net-done">—</div>
              <div class="kpi-sub">Incassi incassati – Spese pagate</div>
            </div>
          </div>
        </div>
      </section>

      <div class="grid cols-2">
        <section class="card">
          <div class="card-header"><h2>Incassi previsti</h2></div>
          <div class="card-content"><div id="fc-list-in" class="list-scroll"></div></div>
        </section>
        <section class="card">
          <div class="card-header"><h2>Spese previste</h2></div>
          <div class="card-content"><div id="fc-list-ex" class="list-scroll"></div></div>
        </section>
      </div>

      <section class="card" style="margin-top:1rem">
        <div class="card-header">
          <h2>Grafico previsioni (anno corrente)</h2>
          <div class="muted">Barre: Ricavi previsti vs Costi previsti · ✓ = segnate come fatte</div>
        </div>
        <div class="card-content">
          <canvas id="fc-chart" class="chart" aria-label="Grafico previsioni"></canvas>
        </div>
      </section>
    </section>

    <!-- APPLICAZIONI -->
    <section id="page-apps" class="page" style="display:none">
      <section class="card">
        <div class="card-header"><h2>Applicazioni rapide</h2></div>
        <div class="card-content">
          <div id="apps-grid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px"></div>
        </div>
      </section>
    </section>

    <!-- REPORT -->
    <section id="page-reports" class="page" style="display:none">
      <div class="grid cols-2">
        <section class="card">
          <div class="card-header"><h2>Report Collaboratore</h2></div>
          <div class="card-content">
            <div class="row two" style="margin-bottom:.5rem">
              <select id="rep-collab"></select>
              <select id="rep-range">
                <option value="week">Ultimi 7 giorni</option>
                <option value="month">Ultimi 30 giorni</option>
                <option value="custom">Intervallo personalizzato…</option>
              </select>
            </div>
            <div id="rep-custom" style="display:none; gap:.5rem" class="row two">
              <input id="rep-from" type="date"><input id="rep-to" type="date">
            </div>
            <div id="rep-collab-cards" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.75rem"></div>
          </div>
        </section>
        <section class="card">
          <div class="card-header"><h2>Report Cantieri</h2></div>
          <div class="card-content"><div id="rep-sites-cards"></div></div>
        </section>
      </div>
      <section class="card" style="margin-top:1rem">
        <div class="card-header"><h2>Report Finanziario</h2></div>
        <div class="card-content"><div id="rep-finance-cards"></div></div>
      </section>
    </section>

    <!-- SETTINGS -->
    <section id="page-settings" class="page" style="display:none">
  <!-- ... (resto del codice impostazioni rimane invariato) ... -->
  <form id="set-form" class="row two" autocomplete="off" style="margin-bottom:1rem">
    <div><label>Costo orario</label><input id="st-cost-h" type="number" step="0.01"></div>
    <div><label>Markup %</label><input id="st-markup" type="number" step="0.1"></div>
    <div><label>Valuta</label>
      <select id="st-currency"><option>CHF</option><option>EUR</option><option>USD</option></select>
    </div>
    <div><label>IVA %</label><input id="st-vat" type="number" step="0.1"></div>
    <div><label>Metodo contabile</label>
      <select id="st-accounting-method">
        <option value="cash">Cassa (pagamenti)</option>
        <option value="accrual">Competenza (fatture)</option>
      </select>
    </div>
    <div><label>Costi fissi/mese</label><input id="st-fixed-month" type="number" step="1"></div>
    <div><label>Tariffa regia</label><input id="st-regia-rate" type="number" step="0.01"></div>
    <div><label>Fatturato stimato Y</label><input id="set-est-revenue" type="number" step="1"></div>
    <div><label>Costi stimati Y</label><input id="set-est-costs" type="number" step="1"></div>
    <div style="grid-column:1/-1;display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" type="submit">Salva impostazioni</button>
      <button id="btn-add-role" class="btn btn-ghost" type="button">+ Aggiungi ruolo</button>
      <button id="btn-backup-2" class="btn btn-ghost" type="button">Backup JSON</button>
      <button id="btn-restore-2" class="btn btn-ghost" type="button">Importa JSON</button>
      <button id="btn-share-json" class="btn btn-ghost" type="button">Condividi JSON</button>
    </div>
  </form>
  <section class="card" style="margin-top:1rem">
    <div class="card-header"><h2>Dati &amp; Backup</h2></div>
    <div class="card-content" style="display:flex; gap:.5rem; flex-wrap:wrap">
      <button id="btn-export"  class="btn btn-ghost"  type="button">Esporta CSV</button>
      <button id="btn-backup"  class="btn btn-ghost"  type="button">Backup JSON</button>
      <button id="btn-restore" class="btn btn-ghost"  type="button">Importa JSON</button>
      <button id="btn-reset"   class="btn btn-danger" type="button">Azzera Dati</button>
    </div>
    <div class="muted" style="margin-top:.5rem">Trascina qui un file <b>.json</b> per importare (solo in questa pagina).</div>
    <label style="display:flex;align-items:center;gap:.5rem;margin-top:.5rem">
      <input id="st-dnd-only-settings" type="checkbox"> Limita l’import Drag&amp;Drop a questa pagina
    </label>
  </section>
  <section class="card" style="margin-top:1rem">
    <div class="card-header"><h2>Link utili (1–20)</h2></div>
    <div class="card-content">
      <div id="apps-links-list" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:.5rem"></div>
      <div style="margin-top:.5rem; display:flex; gap:.5rem">
        <input id="apps-new-label"  placeholder="Etichetta (es. Google)">
        <input id="apps-new-url"    placeholder="https://...">
        <button id="apps-add" class="btn btn-primary" type="button">Aggiungi</button>
      </div>
    </div>
  </section>
  <div class="settings-logo" style="margin-bottom:1.5rem">
    <label for="settings-logo-file">Logo azienda</label>
    <input id="settings-logo-file" type="file" accept="image/*" style="display:block; margin-bottom:.5rem">
    <img id="settings-logo-preview" alt="Anteprima logo" style="display:none; max-width:120px; margin-bottom:.5rem">
    <button id="settings-logo-remove" type="button" class="btn btn-danger" style="display:block; margin-bottom:.5rem">Rimuovi logo</button>
  </div>
  <div id="st-roles" class="settings-roles-list"></div>
    </section>

    <!-- PROGRAMMA LAVORI (Agenda) -->
    <section id="page-agenda" class="page" style="display:none">
      <div class="card" style="margin-bottom:1rem">
        <div class="card-header"><h2>Riepilogo</h2></div>
        <div class="card-content"><div class="recap" id="recap-agenda"></div></div>
      </div>
      <div class="agenda-wrap">
        <!-- Editor -->
        <section class="ag-form">
          <h3 style="margin:.25rem 0 .75rem">Nuovo/Appuntamento</h3>
          <input type="hidden" id="ag-edit-id">
          <div class="row two">
            <div><label>Data</label><input id="ag-date" type="date"></div>
            <div class="row two">
              <div><label>Inizio</label><input id="ag-from" type="time" value="08:00"></div>
              <div><label>Fine</label><input id="ag-to" type="time" value="12:00"></div>
            </div>
          </div>
          <div class="row two">
            <div><label>Cantiere</label><select id="ag-site"></select></div>
            <div><label>Colore</label><input id="ag-color" type="color" value="#4da3ff" style="height:40px"></div>
          </div>
          <div class="row">
            <label>Collaboratori</label>
            <div id="ag-collab-picker" class="collab-picker">
              <input id="ag-collab-search" class="collab-input" placeholder="Cerca e seleziona…">
              <div id="ag-collab-dd" class="collab-dropdown"></div>
            </div>
          </div>
          <div class="row"><label>Descrizione</label><input id="ag-desc" placeholder="lavoro / luogo / note…"></div>
          <div id="ag-conflict" class="conflict"></div>
          <div class="row" style="display:flex;gap:.5rem">
            <button id="ag-save" class="btn btn-primary" type="button">Salva</button>
            <button id="ag-reset" class="btn btn-ghost" type="button">Pulisci</button>
            <button id="ag-delete" class="btn btn-danger" type="button" style="display:none">Elimina</button>
          </div>
        </section>

        <!-- Calendario -->
        <section class="ag-cal">
          <div class="ag-monthbar">
            <div class="ag-toolbar">
              <button id="ag-prev" class="btn btn-ghost" type="button">◀</button>
              <div id="ag-title" style="font-weight:800"></div>
              <button id="ag-next" class="btn btn-ghost" type="button">▶</button>
              <button id="ag-today" class="btn btn-ghost" type="button">Oggi</button>
            </div>
            <div class="ag-filters" id="ag-filters"></div>
            <div>
              <button id="btn-ag-export" class="btn btn-primary" type="button">Esporta settimanale (PDF)</button>
            </div>
          </div>
          <div class="ag-grid" id="ag-grid"></div>
        </section>
      </div>

          <!-- SLOT LIBERI (settimana) -->
          <section class="card" id="slots-card" style="margin-top:1rem">
            <div class="card-header">
              <h2>Slot liberi (settimana)</h2>
              <div style="display:flex;gap:.5rem;align-items:center">
                <button id="sl-prev" class="btn btn-ghost" type="button">◀</button>
                <div id="sl-title" style="font-weight:800"></div>
                <button id="sl-next" class="btn btn-ghost" type="button">▶</button>
                <button id="sl-today" class="btn btn-ghost" type="button">Oggi</button>
              </div>
            </div>
            <div class="card-content">
              <div id="sl-summary" class="kpi" style="margin-bottom:.75rem">
                <div class="label">Riepilogo settimana</div>
                <div class="value" id="sl-line">—</div>
                <div class="kpi-sub" id="sl-sub">—</div>
              </div>

              <div class="slots-table-wrap">
                <table class="tbl" id="sl-table"></table>
              </div>
              <div class="muted" style="margin-top:.5rem">
                Definizione slot: <b>08–12</b> e <b>13–17</b> (lun–ven). Modificabile nel codice (SESSIONS / WORK_DAYS).
              </div>
            </div>
          </section>

      <!-- VISTA MATRICE SETTIMANALE -->
      <section class="card" id="ag-matrix-card" style="margin-top:1rem">
        <div class="card-header">
          <h2>Programma (vista matrice)</h2>
          <div class="ag-matrix-toolbar">
            <div style="display:flex;gap:.5rem;align-items:center">
              <button id="mx-prev" class="btn btn-ghost" type="button">◀</button>
              <div id="mx-title" style="font-weight:800"></div>
              <button id="mx-next" class="btn btn-ghost" type="button">▶</button>
              <button id="mx-today" class="btn btn-ghost" type="button">Oggi</button>
            </div>
            <div style="display:flex;gap:.5rem;align-items:center">
              <label class="pill" style="cursor:pointer"><input id="mx-toggle" type="checkbox"> Mostra solo selezionati</label>
              <button id="mx-switch" class="btn btn-ghost" type="button">Vista mensile</button>
            </div>
          </div>
        </div>
        <div class="card-content">
          <div class="ag-matrix-wrap">
            <table class="ag-matrix" id="ag-matrix"></table>
          </div>
        </div>
      </section>
    </section>

    <!-- ARCHIVIO -->
    <section id="page-archive" class="page" style="display:none">
      <section class="card">
        <div class="card-header">
          <h2>Archivio</h2>
          <div class="pill"><span class="muted">Ricerca</span> <input id="ar-search" placeholder="Cerca in archivio…" style="border:none;background:transparent;padding:0 .25rem;outline:none"></div>
        </div>
        <div class="card-content">
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem">
            <button class="btn btn-ghost" data-ar="sites">Cantieri</button>
            <button class="btn btn-ghost" data-ar="offers">Offerte</button>
            <button class="btn btn-ghost" data-ar="collaborators">Collaboratori</button>
            <button class="btn btn-ghost" data-ar="expenses">Spese</button>
            <button class="btn btn-ghost" data-ar="invoices">Fatture</button>
            <button class="btn btn-ghost" data-ar="payments">Incassi</button>
            <button class="btn btn-ghost" data-ar="tickets">Ticket</button>
          </div>
          <div id="ar-list" class="list-scroll"></div>
        </div>
      </section>
    </section>

      <!-- Inbox Collaboratori (UI minimale, personalizzala come vuoi) -->
      <div id="collab-inbox" class="card" style="margin:16px 0;">
        <h3 class="title" style="margin:0 0 8px">Inbox Collaboratori</h3>
        <div class="muted" style="margin-bottom:8px">Ticket inviati dai collaboratori in attesa di verifica</div>
        <div class="list" id="collab-inbox-list"></div>
      </div>
  </main>
</div>

<!-- TOAST -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Hidden file input for JSON import -->
<input id="json-file-input" type="file" accept="application/json" style="display:none">

<!-- Drag & Drop Overlay -->
<div id="drop-overlay" class="drop"><div class="pill" style="font-size:1.1rem">Rilascia qui il file <b>.json</b> per l'import</div></div>

<div id="apps-webview" class="overlay" role="dialog" aria-modal="true" style="z-index:10001">
  <div class="palette" style="width:min(1100px,100%); height:min(80vh,90%); display:flex; flex-direction:column">
    <header style="display:flex; align-items:center; gap:.5rem; padding:.6rem .8rem; border-bottom:1px solid var(--border)">
      <button id="apps-webview-back" class="btn btn-ghost" type="button">← Indietro</button>
      <div id="apps-webview-title" style="font-weight:800"></div>
    </header>
  <iframe id="apps-iframe" style="flex:1; border:0" sandbox="allow-scripts allow-forms"></iframe>
  </div>
</div>

<div id="ti-day-overlay" class="overlay" aria-modal="true" role="dialog">
  <div class="palette" style="width:min(980px,100%); max-height:86vh; overflow:auto; border-radius:16px">
    <header style="display:flex;gap:.75rem;align-items:center;padding:.8rem 1rem;border-bottom:1px solid var(--border)">
      <div id="ti-day-title" style="font-weight:800;font-size:1.05rem">Dettagli giorno</div>
      <div style="margin-left:auto;display:flex;gap:.5rem" id="ti-day-kpis"></div>
      <button id="ti-day-close" class="btn btn-ghost">Chiudi</button>
    </header>
    <div id="ti-day-body" style="padding:1rem">
      <!-- riempito da JS -->
    </div>
  </div>
</div>

<!-- Command Palette -->
<div id="palette-overlay" class="overlay" aria-modal="true" role="dialog" aria-label="Command Palette">
  <div class="palette">
    <header><span class="muted">⌘</span><input id="palette-input" placeholder="Digita un comando o cerca…"></header>
    <div id="palette-results" class="results"></div>
  </div>
</div>

<!-- Shortcuts Modal -->
<div id="shortcuts-modal" class="modal" aria-modal="true" role="dialog" aria-label="Scorciatoie">
  <div class="box">
    <h2>Scorciatoie da tastiera</h2>
    <p>Puoi navigare ed eseguire le azioni più frequenti senza toccare il mouse.</p>
    <ul>
      <li><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">K</span> – Command Palette</li>
  <li><span class="kbd">G</span> <span class="kbd">D</span> Dashboard · <span class="kbd">G</span> <span class="kbd">C</span> Cantieri · <span class="kbd">G</span> <span class="kbd">O</span> Offerte · <span class="kbd">G</span> <span class="kbd">L</span> Collaboratori · <span class="kbd">G</span> <span class="kbd">T</span> Ticket · <span class="kbd">G</span> <span class="kbd">F</span> Fatture · <span class="kbd">G</span> <span class="kbd">P</span> Incassi · <span class="kbd">G</span> <span class="kbd">E</span> Spese · <span class="kbd">G</span> <span class="kbd">B</span> Bilanci · <span class="kbd">G</span> <span class="kbd">A</span> Applicazioni · <span class="kbd">G</span> <span class="kbd">R</span> Report · <span class="kbd">G</span> <span class="kbd">V</span> Archivio · <span class="kbd">G</span> <span class="kbd">S</span> Impostazioni</li>
  <li><span class="kbd">N</span> <span class="kbd">T</span> nuovo Ticket · <span class="kbd">N</span> <span class="kbd">F</span> nuova Fattura · <span class="kbd">N</span> <span class="kbd">P</span> nuovo Incasso · <span class="kbd">N</span> <span class="kbd">S</span> nuova Spesa · <span class="kbd">N</span> <span class="kbd">O</span> nuova Offerta</li>
      <li><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">E</span> Esporta CSV · <span class="kbd">Ctrl/Cmd</span>+<span class="kbd">B</span> Backup JSON · <span class="kbd">Ctrl/Cmd</span>+<span class="kbd">R</span> Importa JSON</li>
      <li><span class="kbd">Ctrl/Cmd</span>+<span class="kbd">Z</span> Annulla · <span class="kbd">Ctrl/Cmd</span>+<span class="kbd">Shift</span>+<span class="kbd">Z</span> (o <span class="kbd">Ctrl</span>+<span class="kbd">Y</span>) Ripeti</li>
      <li><span class="kbd">?</span> Apri/chiudi questo aiuto</li>
    </ul>
    <div style="text-align:right; margin-top:.75rem"><button id="close-shortcuts" class="btn btn-primary">Ok</button></div>
  </div>
</div>

<!-- Edit Modal for Invoices and Tickets -->
<div id="edit-modal" class="edit-modal" aria-modal="true" role="dialog">
  <div class="edit-modal-content">
    <div class="edit-modal-header">
      <h2 id="edit-modal-title">Modifica</h2>
      <button class="close-modal" id="close-edit-modal">×</button>
    </div>
    <div id="edit-modal-body">
      <!-- Content will be dynamically inserted here -->
    </div>
  </div>
</div>

  <!-- Month breakdown modal -->
  <div id="month-modal" class="modal" aria-modal="true" role="dialog" aria-label="Dettaglio mese">
    <div class="box" style="width:min(980px,100%)">
      <h2 id="month-title" style="margin-top:0">Dettaglio mese</h2>
      <div id="month-body"></div>
      <div style="text-align:right;margin-top:1rem">
        <button class="btn btn-primary" type="button" onclick="closeMonthModal()">Chiudi</button>
      </div>
    </div>
  </div>

<!-- Templates -->
<template id="tpl-mat">
  <div class="material-row">
    <input placeholder="Descrizione materiale" class="mat-desc">
    <input type="number" min="0" step="0.01" placeholder="Quantità" class="mat-qty">
    <input type="number" min="0" step="0.01" placeholder="Costo unitario" class="mat-cost">
    <button type="button" class="remove-btn" aria-label="Rimuovi materiale">×</button>
  </div>
</template>

<template id="tpl-fase">
  <div class="fase-row">
    <input placeholder="Nome fase (es. Posa tubi)" class="fase-name">
    <input type="number" min="0" max="100" step="1" placeholder="Peso %" class="fase-weight">
    <button type="button" class="remove-btn" aria-label="Rimuovi fase">×</button>
  </div>
</template>

<template id="tpl-invoice-form">
  <div class="card" id="invoice-form-card" style="margin-bottom:1rem; padding:1rem">
    <form id="invoice-form" class="row two" autocomplete="off">
      <div><label>Numero</label><input id="inv-number" required></div>
      <div><label>Data</label><input id="inv-date" type="date" required></div>
      <div><label>Scadenza</label><input id="inv-due" type="date" required></div>
      <div><label>Cliente</label><input id="inv-customer"></div>
      <div><label>Cantiere (opz.)</label>
        <select id="inv-site-select"><option value="">Nessuno</option></select>
      </div>
      <div><label>Oggetto</label><input id="inv-subject"></div>
      <div><label>Importo (imponibile)</label><input id="inv-amount" type="number" min="0" step="0.01"></div>
      <div><label>IVA (%)</label><input id="inv-vat" type="number" min="0" step="0.1" placeholder="usa impostazioni se vuoto"></div>
      <div><label>Stato</label>
        <select id="inv-status-field">
          <option value="draft">Bozza</option><option value="issued">Emessa</option>
          <option value="partial">Parziale</option><option value="paid">Pagata</option>
          <option value="overdue">Scaduta</option><option value="canceled">Annullata</option>
        </select>
      </div>
      <div style="grid-column:1/-1; display:flex; gap:.5rem">
        <button id="btn-inv-submit" class="btn btn-primary" type="submit">Salva Fattura</button>
        <button id="btn-inv-cancel" class="btn btn-ghost" type="button">Annulla</button>
        <button id="btn-inv-duplicate" class="btn btn-ghost" type="button">Duplica</button>
      </div>
    </form>
  </div>
</template>

<template id="tpl-payment-form">
  <div class="card" id="payment-form-card" style="margin-bottom:1rem; padding:1rem">
    <form id="payment-form" class="row two" autocomplete="off">
      <div><label>Data</label><input id="pay-date" type="date" required></div>
      <div><label>Importo</label><input id="pay-amount" type="number" min="0" step="0.01" required></div>
      <div><label>Metodo di incasso</label>
        <select id="pay-method-field"><option value="bank">Bonifico</option><option value="cash">Contanti</option><option value="card">Carta</option><option value="other">Altro</option></select>
      </div>
      <div><label>Riferimento</label><input id="pay-ref" placeholder="es. INV-2025-012 #bonifico"></div>
      <div><label>Nota</label><input id="pay-note"></div>
      <div><label>Collega a fattura (opz.)</label><select id="pay-invoice-select"><option value="">Nessuna</option></select></div>
      <div style="grid-column:1/-1; display:flex; gap:.5rem">
        <button id="btn-pay-submit" class="btn btn-primary" type="submit">Salva Incasso</button>
        <button id="btn-pay-cancel" class="btn btn-ghost" type="button">Annulla</button>
      </div>
    </form>
  </div>
</template>

<script>
(function(){
'use strict';

// Safe noop
window.toggleShortcuts = () => { };

/* ===========================================================
   STATE & SCHEMA + HISTORY (rename to avoid window.history)
   =========================================================== */
const STORAGE_KEY = 'gestione-cantieri';
const LS_CHUNK_PREFIX = STORAGE_KEY + ':part:';
const LS_CHUNK_META   = STORAGE_KEY + ':parts';
const SCHEMA_VERSION = 10; // v10: app links icon support + DnD scope

let state = {
  schemaVersion: SCHEMA_VERSION,
  sites: [],
  collaborators: [],
  tickets: [],
  invoices: [],
  payments: [],
  expenses: [],
  offers: [],
  agenda: [],
  archive: { sites:[], offers:[], collaborators:[], expenses:[], invoices:[], tickets:[], payments:[] },
  forecast: { incomes: [], expenses: [] },
  settings: {
    costHour: 35, markup: 10, currency: 'CHF', vat: 8.1,
    fixedMonth: 115000, regiaRate: 85, roles: [],
    estRevenue: 115000, estCosts: 90000,
    accountingMethod: 'cash',
    logoDataUrl: null,
    appsLinks: [],
    importOnlyInSettings: true
  },
  meta: { version: '10.0', createdAt: new Date().toISOString() },
  _lastSaveAt: null
};

// History (undo/redo)
const HISTORY_LIMIT = 20;
let undoStack = [];
let historyIndex = -1;
function pushHistory(){
  try{
    const snap = JSON.stringify(state);
    if(historyIndex < undoStack.length-1) undoStack = undoStack.slice(0, historyIndex+1);
    undoStack.push(snap);
    if(undoStack.length > HISTORY_LIMIT) undoStack.shift();
    historyIndex = undoStack.length-1;
  }catch(e){ console.warn('History push failed', e); }
}
function canUndo(){ return historyIndex > 0; }
function canRedo(){ return historyIndex < undoStack.length-1; }
function doUndo(){ if(!canUndo()) return; historyIndex--; state = ensureStateShape(JSON.parse(undoStack[historyIndex])); afterStateChange({silentSave:true}); showToast('Annullato'); }
function doRedo(){ if(!canRedo()) return; historyIndex++; state = ensureStateShape(JSON.parse(undoStack[historyIndex])); afterStateChange({silentSave:true}); showToast('Ripetuto'); }

/* ===========================================================
   UTIL
   =========================================================== */
const safeNum = v => Number.isFinite(+v) ? +v : 0;
const clamp = (x, a, b)=> Math.max(a, Math.min(b, x));
const id = ()=> (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now())+'-'+Math.random().toString(16).slice(2);
const byId = (id)=> document.getElementById(id);
const formatCurrency = (amount, currency = state.settings.currency) =>
  new Intl.NumberFormat('it-CH', {style:'currency', currency}).format(Number.isFinite(amount)?amount:0);
const fmtNum = (n)=> new Intl.NumberFormat('it-CH').format(safeNum(n));
const cssEscape = (val)=>{
  const str = String(val ?? '');
  if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function') return CSS.escape(str);
  return str.replace(/[^a-zA-Z0-9_\-]/g, ch=>`\\${ch}`);
};
const debounce = (fn, ms=200)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

// >>> PATCH: MONEY (fixed-point) — niente floating point per CHF/EUR/USD
const Money = (function () {
  const decimalsMap = { CHF: 2, EUR: 2, USD: 2 };

  const currentCurrency = () => state?.settings?.currency || 'CHF';
  const getDec = () => decimalsMap[currentCurrency()] ?? 2;
  const pow10 = (n) => (n === 0 ? 1 : 10 ** n);
  const toInt = (value) => Number.isFinite(+value) ? Math.round(+value) : 0;

  const toMinor = (value) => {
    const num = Number(value ?? 0);
    if (!Number.isFinite(num)) return 0;
    return Math.round(num * pow10(getDec()));
  };

  const fromMinor = (minor) => toInt(minor) / pow10(getDec());

  const format = (minor, currency = currentCurrency()) =>
    new Intl.NumberFormat('it-CH', { style: 'currency', currency }).format(fromMinor(minor));

  const add = (...values) => values.reduce((sum, val) => sum + toInt(val), 0);

  const sub = (a, b) => toInt(a) - toInt(b);

  const mulPct = (minor, pct) => {
    const base = toInt(minor);
    const ratio = Number(pct ?? 0);
    if (!Number.isFinite(ratio)) return 0;
    return Math.round(base * ratio / 100);
  };

  return { toMinor, fromMinor, format, add, sub, mulPct };
})();

// Protezione contro valori non numerici
function safeMinor(v) {
  return Number.isFinite(v) ? v : 0;
}

// >>> PATCH: escape HTML
const h = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
// >>> PATCH: ISO date math helpers for recurring
function pad2(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ if(!(d instanceof Date) || isNaN(+d)) return ''; return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function addDaysISO(iso, n){ const d = new Date(iso+'T00:00:00Z'); d.setUTCDate(d.getUTCDate()+n); return toISODate(new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()))); }
function endOfMonth(y, m){ return new Date(Date.UTC(y, m+1, 0)).getUTCDate(); }
function addMonthsClamp(iso, n, dayOfMonth){
  if(!iso) return '';
  const d = new Date(iso+'T00:00:00Z');
  const y = d.getUTCFullYear(); const m = d.getUTCMonth(); const day = typeof dayOfMonth==='number' && dayOfMonth>0 ? dayOfMonth : d.getUTCDate();
  const targetM = m + n;
  const ty = y + Math.floor(targetM/12);
  const tm = ((targetM%12)+12)%12;
  const dom = Math.min(day, endOfMonth(ty, tm));
  return toISODate(new Date(Date.UTC(ty, tm, dom)));
}
// >>> FIX: addYears clamp 29 feb e coerenza con helper EOM
function addYears(iso, n){
  if(!iso) return '';
  // preserva il giorno della data di ancoraggio, clamp se necessario (es. 31 -> 30/29/28)
  const d = new Date(iso+'T00:00:00Z');
  const y = d.getUTCFullYear() + n;
  const m = d.getUTCMonth();
  const day = d.getUTCDate();
  const dom = Math.min(day, endOfMonth(y, m));
  return toISODate(new Date(Date.UTC(y, m, dom)));
}
// >>> PATCH: DATE helpers + overdue coerente
const Dates = {
  toISO: (v) => { if (!v) return ''; const d = new Date(v); return isNaN(+d) ? '' : d.toISOString().slice(0,10); },
  todayISO: () => new Date().toISOString().slice(0,10),
  isBeforeToday: (iso) => !!iso && iso < Dates.todayISO()
};
const MONTH_LABELS_IT = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
function monthKeyLabel(key){
  if(!key || key==='—') return 'Senza data';
  const parts = String(key).split('-');
  const y = parts[0];
  const m = Number(parts[1])||0;
  const name = MONTH_LABELS_IT[m-1] || '';
  return `${name} ${y}`.trim();
}
function monthKeyRange(key){
  if(!key || key==='—') return null;
  const parts = String(key).split('-');
  const y = Number(parts[0])||0;
  const m = Number(parts[1])||0;
  if(!y || !m) return null;
  const endDay = endOfMonth(y, m-1);
  return {
    from: `${key}-01`,
    to: `${key}-${String(endDay).padStart(2,'0')}`
  };
}

function isInvoiceOverdue(inv) {
  if (!inv) return false;
  const status = String(inv.status || '').toLowerCase();
  if (status === 'paid' || status === 'canceled') return false;
  const iso = Dates.toISO(inv.dueDate || inv.due || inv.scadenza);
  if (!iso) return status === 'overdue';
  return Dates.isBeforeToday(iso);
}

function showToast(message, type='info'){
  const t = byId('toast'); if(!t) return;
  t.textContent = message; t.className = 'toast '+type; t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 2800);
}

function monthISORange(y,m){
  const from = new Date(Date.UTC(y, m, 1));
  const to   = new Date(Date.UTC(y, m+1, 0));
  const iso = (d)=> `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
  return { from: iso(from), to: iso(to) };
}

function openMonthModal(){ document.getElementById('month-modal')?.classList.add('show'); }
function closeMonthModal(){ document.getElementById('month-modal')?.classList.remove('show'); }
window.closeMonthModal = closeMonthModal;

/* ===========================================================
   STORAGE + MIGRATION
   =========================================================== */
function ensureStateShape(s){
  const base = {
  
    schemaVersion: SCHEMA_VERSION,
    sites: [],
    collaborators: [],
    tickets: [],
    invoices: [],
    payments: [],
    expenses: [],
    offers: [],
    agenda: [],
  settings: { costHour:35, markup:10, currency:'CHF', vat:8.1, fixedMonth:115000, regiaRate:85, roles:[], estRevenue:115000, estCosts:90000, accountingMethod:'cash', logoDataUrl:null, appsLinks:[], importOnlyInSettings:true }
  };
  let out = Object.assign({}, base, s||{});
  out.sites = Array.isArray(out.sites)? out.sites : [];
  out.collaborators = Array.isArray(out.collaborators)? out.collaborators : [];
  out.tickets = Array.isArray(out.tickets)? out.tickets : [];
  out.invoices = Array.isArray(out.invoices)? out.invoices : [];
  out.payments = Array.isArray(out.payments)? out.payments : [];
  out.expenses = Array.isArray(out.expenses)? out.expenses : [];
  out.offers = Array.isArray(out.offers)? out.offers : [];
  out.agenda = Array.isArray(out.agenda)? out.agenda : [];
  if(!out.forecast) out.forecast = { incomes: [], expenses: [] };
  if(!Array.isArray(out.forecast.incomes))  out.forecast.incomes  = [];
  if(!Array.isArray(out.forecast.expenses)) out.forecast.expenses = [];
  out.settings = Object.assign({}, base.settings, out.settings||{});
  if(!out.meta) out.meta = {version:'6.0', createdAt: new Date().toISOString()};
  if(!out.schemaVersion) out.schemaVersion = 1;
  out = migrate(out);
  if(!out.archive) out.archive = {};
  ['sites','offers','collaborators','expenses','invoices','tickets','payments'].forEach(k=>{
    if(!Array.isArray(out.archive[k])) out.archive[k]=[];
  });
  if(!Array.isArray(out.archive.expensesPaid)) out.archive.expensesPaid = [];
  const normLinks = (Array.isArray(out.settings?.appsLinks) ? out.settings.appsLinks.slice(0,20) : []).map(link=>{
    const cleaned = {
      id: (typeof link?.id === 'string' && link.id) ? link.id : `app-${Math.random().toString(36).slice(2,10)}`,
      label: typeof link?.label === 'string' ? link.label : '',
      url: typeof link?.url === 'string' ? link.url : '',
      icon: (typeof link?.icon === 'string' && link.icon) ? link.icon : 'google',
      shape: typeof link?.shape === 'string' ? link.shape : 'rounded'
    };
    const iconUrl = (typeof link?.iconUrl === 'string' && link.iconUrl) ? link.iconUrl : (cleaned.url ? faviconUrlFor(cleaned.url) : '');
    if(iconUrl) cleaned.iconUrl = iconUrl;
    return cleaned;
  });
  out.settings.appsLinks = normLinks;
  return out;
}
function migrate(s){
  if((s.schemaVersion||1) < 2){ s.schemaVersion = 2; }
  if((s.schemaVersion||1) < 3){ s.offers = s.offers||[]; s.schemaVersion = 3; }
  if((s.schemaVersion||1) < 4){ s.settings = Object.assign({logoDataUrl:null}, s.settings||{}); s.meta = {version:'4.0', createdAt: new Date().toISOString()}; s.schemaVersion = 4; }
  if((s.schemaVersion||1) < 5){ s.meta = {version:'5.0', createdAt: new Date().toISOString()}; s.schemaVersion = 5; }
  if((s.schemaVersion||1) < 6){
    // Initialize phases fields for each site
    if (Array.isArray(s.sites)){
      s.sites.forEach(site=>{
        site.phases = Array.isArray(site.phases) ? site.phases.map(p=>({
          id: p.id || id(),
          name: p.name || '',
          weight: safeNum(p.weight)||0,
          done: !!p.done,
          attributedValue: safeNum(p.attributedValue)||0,
          attributedAt: p.attributedAt || null
        })) : [];
      });
    }
    s.meta = {version:'6.0', createdAt: s.meta?.createdAt || new Date().toISOString()};
    s.schemaVersion = 6;
  }
  if((s.schemaVersion||1) < 7){
    // v7: recurring expenses series fields
    if (Array.isArray(s.expenses)){
      s.expenses = s.expenses.map(e=>{
        const recurring = e.recurring || 'none';
        const out = { ...e };
        out.recurring = recurring;
        if (recurring !== 'none'){
          const iso = String(e.anchorDate || e.date || '').slice(0,10) || '';
          out.anchorDate = iso;
          // choose seriesId; keep existing if present, else use own id
          out.seriesId = e.seriesId || e.id;
          const d = iso ? new Date(iso) : null;
          out.dayOfMonth = Number.isFinite(+e.dayOfMonth) && +e.dayOfMonth>0 ? +e.dayOfMonth : (d? d.getDate(): undefined);
          const paid = Array.isArray(e.occurrencesPaid) ? e.occurrencesPaid.filter(Boolean) : [];
          // dedupe
          out.occurrencesPaid = Array.from(new Set(paid));
        } else {
          // ensure no stray series fields break consumers
          if (!Array.isArray(out.occurrencesPaid)) out.occurrencesPaid = [];
        }
        return out;
      });
    }
    s.meta = {version:'7.0', createdAt: s.meta?.createdAt || new Date().toISOString()};
    s.schemaVersion = 7;
  }
  if((s.schemaVersion||1) < 8){
    // v8: ensure invoices carry siteId (nullable)
    if (Array.isArray(s.invoices)){
      s.invoices = s.invoices.map(inv => ({ ...inv, siteId: inv.siteId ?? null }));
    }
    s.meta = {version:'8.0', createdAt: s.meta?.createdAt || new Date().toISOString()};
    s.schemaVersion = 8;
  }
  if((s.schemaVersion||1) < 9){
    s.settings = Object.assign({appsLinks:[], importOnlyInSettings:true}, s.settings||{});
    if(!Array.isArray(s.settings.appsLinks)) s.settings.appsLinks = [];
    if(typeof s.settings.importOnlyInSettings !== 'boolean') s.settings.importOnlyInSettings = true;
    s.meta = {version:'9.0', createdAt: s.meta?.createdAt || new Date().toISOString()};
    s.schemaVersion = 9;
  }
  if((s.schemaVersion||1) < 10){
    const links = Array.isArray(s.settings?.appsLinks) ? s.settings.appsLinks.slice(0,20).map(link=>{
      const cleaned = {
        id: (typeof link?.id === 'string' && link.id) ? link.id : `app-${Math.random().toString(36).slice(2,10)}`,
        label: typeof link?.label === 'string' ? link.label : '',
        url: typeof link?.url === 'string' ? link.url : '',
        icon: (typeof link?.icon === 'string' && link.icon) ? link.icon : 'google',
        shape: typeof link?.shape === 'string' ? link.shape : 'rounded'
      };
      const iconUrl = (typeof link?.iconUrl === 'string' && link.iconUrl) ? link.iconUrl : (cleaned.url ? faviconUrlFor(cleaned.url) : '');
      if(iconUrl) cleaned.iconUrl = iconUrl;
      return cleaned;
    }) : [];
    if (Array.isArray(s.collaborators)){
      s.collaborators = s.collaborators.map((c,i)=> ({...c, order: Number.isFinite(+c?.order) ? +c.order : i }));
    }
    s.settings = Object.assign({appsLinks:[], importOnlyInSettings:true}, s.settings||{});
    s.settings.appsLinks = links;
    s.meta = {version:'10.0', createdAt: s.meta?.createdAt || new Date().toISOString()};
    s.schemaVersion = 10;
  }
  if (Array.isArray(s.settings?.appsLinks)) {
    s.settings.appsLinks = s.settings.appsLinks.map(l=>{
      const out = {...l};
      if(out.iconDataUrl){ delete out.iconDataUrl; }
      if(!out.iconUrl && out.url) out.iconUrl = faviconUrlFor(out.url);
      return out;
    });
  }
  // >>> PATCH: migrazione netSalary nei collaboratori + isRegia nei ticket
  if (Array.isArray(s.collaborators)) {
    s.collaborators = s.collaborators.map(c => ({
      ...c,
      netSalary: Number(c.netSalary || 0),
      hireDate: c.hireDate || null,
      monthlyHours: Number.isFinite(+c.monthlyHours) && +c.monthlyHours >= 0 ? +c.monthlyHours : null
    }));
  }
  if (Array.isArray(s.tickets)) {
    s.tickets = s.tickets.map(t => ({ ...t, isRegia: !!t.isRegia }));
  }
  // v8.1: multi-collaboratore — migra collabId -> collabIds
  if (Array.isArray(s.tickets)){
    s.tickets = s.tickets.map(t=>{
      if (!Array.isArray(t.collabIds) && t.collabId){ t.collabIds = [t.collabId]; }
      return t;
    });
  }
  // v10.1: categorie e ore preventivate per offerte/cantieri
  if (Array.isArray(s.offers)) {
    s.offers = s.offers.map(o => ({
      ...o,
      category: (o.category === 'fv' || o.category === 'ele') ? o.category : 'ele',
      estHours: Number.isFinite(+o.estHours) ? +o.estHours : 0
    }));
  }
  if (Array.isArray(s.sites)) {
    s.sites = s.sites.map(si => ({
      ...si,
      category: (si.category === 'fv' || si.category === 'ele') ? si.category : 'ele'
    }));
  }
  // v10.2: fasi sulle offerte
  if (Array.isArray(s.offers)) {
    s.offers = s.offers.map(o => ({
      ...o,
      phases: Array.isArray(o.phases)
        ? o.phases.map(p => ({
            id: p.id || id(),
            name: p.name || '',
            weight: Number.isFinite(+p.weight) ? +p.weight : 0
          }))
        : []
    }));
  }
  if (!s.archive) s.archive = { sites:[], offers:[], collaborators:[], expenses:[], invoices:[], tickets:[], payments:[], expensesPaid:[] };
  ['sites','offers','collaborators','expenses','invoices','tickets','payments','expensesPaid'].forEach(k=>{
    if(!Array.isArray(s.archive[k])) s.archive[k]=[];
  });
  if(!s.forecast) s.forecast = { incomes: [], expenses: [] };
  if(!Array.isArray(s.forecast.incomes))  s.forecast.incomes  = [];
  if(!Array.isArray(s.forecast.expenses)) s.forecast.expenses = [];
  return s;
}
// v6.1 hotfix — LIVE counters (globals + helpers)
let liveCountersStartTime = null;
let __liveIntervalId = null;
let liveSnapshot = {
  actualRevenueToDate: 0,
  expectedRevenueToDate: 0,
  actualCostsToDate: 0,
  expectedCostsToDate: 0
};

function getYearProgress() {
  const now = new Date();
  const start = new Date(now.getFullYear(), 0, 1);
  const end   = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
  return (now - start) / (end - start);
}

function sumPaymentsYTD() {
  const y = new Date().getFullYear();
  return (state.payments||[])
    .filter(p => (new Date(p.date)).getFullYear() === y)
    .reduce((s,p)=> s + (Number(p.amount)||0), 0);
}

// removed _Safe variant in favor of unified getCollabCostRate

function sumTicketLaborCostYTD() {
  const y = new Date().getFullYear();
  return (state.tickets||[])
    .filter(t => (new Date(t.date)).getFullYear() === y)
    .reduce((s,t)=> s + Money.fromMinor(ticketLaborMinor(t)), 0);
}

function sumTicketMaterialCostYTD() {
  const y = new Date().getFullYear();
  return (state.tickets||[])
    .filter(t => (new Date(t.date)).getFullYear() === y)
    .reduce((s,t)=> s + (Number(t.totalMaterialCost)||0), 0);
}

function sumExpensesPaidYTD() {
  const y = new Date().getFullYear();
  return (state.expenses||[])
    .filter(e => e.status === 'paid' && (new Date(e.date)).getFullYear() === y)
    .reduce((s,e)=> s + (Number(e.amount)||0), 0);
}

function startLiveCounters(){
  if (__liveIntervalId) return;
  recomputeLiveSnapshot();
  liveCountersStartTime = Date.now();
  __liveIntervalId = setInterval(()=> updateLiveCounters(), 1000);
  updateLiveCounters();
}

function recomputeLiveSnapshot(){
  const progress = getYearProgress();
  const estRevenue = Number(state.settings.estRevenue)||0;
  const estCosts   = Number(state.settings.estCosts)||0;
  const actualRevenueToDate = sumPaymentsYTD();
  const actualCostsToDate   = sumTicketLaborCostYTD() + sumTicketMaterialCostYTD() + sumExpensesPaidYTD();
  const expectedRevenueToDate = estRevenue * progress;
  const expectedCostsToDate   = estCosts   * progress;
  liveSnapshot = { actualRevenueToDate, expectedRevenueToDate, actualCostsToDate, expectedCostsToDate };
}

function updateLiveCounters(){
  const jitterK = Math.sin(((Date.now()-liveCountersStartTime)/1000)*0.2);
  const revDelta = liveSnapshot.actualRevenueToDate - liveSnapshot.expectedRevenueToDate;
  const costDelta= liveSnapshot.actualCostsToDate   - liveSnapshot.expectedCostsToDate;
  const liveRevenue = liveSnapshot.expectedRevenueToDate + revDelta + jitterK*0.0005* Math.max(1, liveSnapshot.expectedRevenueToDate);
  const liveCosts   = liveSnapshot.expectedCostsToDate   + costDelta + jitterK*0.0005* Math.max(1, liveSnapshot.expectedCostsToDate);
  const liveProfit  = liveRevenue - liveCosts;
  const revLossPct  = liveSnapshot.expectedRevenueToDate>0 ? ((revDelta || 0) / liveSnapshot.expectedRevenueToDate)*100 : 0;
  const costOverPct = liveSnapshot.expectedCostsToDate>0   ? ((costDelta || 0) / liveSnapshot.expectedCostsToDate)*100   : 0;
  const marginPct   = liveRevenue>0 ? (liveProfit/liveRevenue)*100 : 0;
  const set = (id,val)=>{ const el=byId(id); if(el) el.textContent = val; };
  set('h-live-revenue', formatCurrency(liveRevenue));
  set('h-live-costs',   formatCurrency(liveCosts));
  set('h-live-profit',  formatCurrency(liveProfit));
  set('h-live-profit-margin', `${marginPct.toFixed(1)}%`);
  const revBaseEl = byId('h-live-revenue-base');
  const revExtraEl= byId('h-live-revenue-extra');
  if(revBaseEl)  revBaseEl.textContent  = formatCurrency(liveSnapshot.expectedRevenueToDate);
  if(revExtraEl) revExtraEl.textContent = `${revDelta>=0?'+':''}${formatCurrency(revDelta)} (${revLossPct.toFixed(1)}%)`;
  const costBaseEl = byId('h-live-costs-base');
  const costExtraEl= byId('h-live-costs-extra');
  if(costBaseEl)  costBaseEl.textContent  = formatCurrency(liveSnapshot.expectedCostsToDate);
  if(costExtraEl) costExtraEl.textContent = `${costDelta>=0?'+':''}${formatCurrency(costDelta)} (${costOverPct.toFixed(1)}%)`;
}

/* ==== IndexedDB wrapper (salva lo stato pesante fuori da localStorage) ==== */
const IDB_DB = 'gc_store';
const IDB_STORE = 'state';
const IDB_KEY = 'gestione-cantieri';

function idbOpen(){
  return new Promise((res,rej)=>{
    if(!('indexedDB' in window)) return rej(new Error('IDB not available'));
    const rq = indexedDB.open(IDB_DB, 1);
    rq.onupgradeneeded = ()=> {
      const db = rq.result;
      if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
    };
    rq.onsuccess = ()=> res(rq.result);
    rq.onerror = ()=> rej(rq.error);
  });
}
async function idbSet(key, value){
  const db = await idbOpen();
  return new Promise((res,rej)=>{
    const tx = db.transaction(IDB_STORE,'readwrite');
    tx.objectStore(IDB_STORE).put(value, key);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function idbGet(key){
  const db = await idbOpen();
  return new Promise((res,rej)=>{
    const tx = db.transaction(IDB_STORE,'readonly');
    const rq = tx.objectStore(IDB_STORE).get(key);
    rq.onsuccess = ()=> res(rq.result ?? null);
    rq.onerror = ()=> rej(rq.error);
  });
}

/* ==== MIGRAZIONE leggerimento stato: rimuovi iconDataUrl ingombranti ==== */
function _pruneHeavy(stateObj){
  try{
    if(Array.isArray(stateObj?.settings?.appsLinks)){
      stateObj.settings.appsLinks.forEach(l=>{ if(l.iconDataUrl) delete l.iconDataUrl; });
    }
  }catch(_){ }
  return stateObj;
}

function lsSaveChunked(key, obj){
  const s = JSON.stringify(obj);
  const SIZE = 450000;
  const parts = Math.ceil(s.length / SIZE);
  try{
    const prev = Number(localStorage.getItem(LS_CHUNK_META) || 0);
    for(let i=0;i<prev;i++) localStorage.removeItem(LS_CHUNK_PREFIX+i);
  }catch(_){ }
  for(let i=0;i<parts;i++){
    localStorage.setItem(LS_CHUNK_PREFIX+i, s.slice(i*SIZE,(i+1)*SIZE));
  }
  localStorage.setItem(LS_CHUNK_META, String(parts));
  localStorage.setItem(key, JSON.stringify({v:1, parts}));
}
function lsLoadChunked(key){
  try{
    const head = JSON.parse(localStorage.getItem(key) || 'null');
    if(!head || !head.parts) return null;
    let s = '';
    for(let i=0;i<Number(head.parts);i++){
      const chunk = localStorage.getItem(LS_CHUNK_PREFIX+i) || '';
      s += chunk;
    }
    return JSON.parse(s);
  }catch(e){ console.warn('chunk load fail', e); return null; }
}
async function saveState(skipHistory=false){
  try{
    state._lastSaveAt = new Date().toISOString();
    _pruneHeavy(state);
    // 1) prova IndexedDB
    await idbSet(IDB_KEY, state);
    // 2) solo “testa” in LS (metadati)
    localStorage.setItem(STORAGE_KEY, JSON.stringify({v:2, where:'idb', savedAt: state._lastSaveAt}));
    if(!skipHistory) pushHistory();
    updateFileVersion();
  }catch(e){
    console.warn('IDB save fail, fallback LS', e);
    try{
      const s = JSON.stringify(_pruneHeavy(state));
      if(s.length > 4_000_000) lsSaveChunked(STORAGE_KEY, state);
      else {
        localStorage.setItem(STORAGE_KEY, s);
        const prev = Number(localStorage.getItem(LS_CHUNK_META) || 0);
        for(let i=0;i<prev;i++) localStorage.removeItem(LS_CHUNK_PREFIX+i);
        localStorage.removeItem(LS_CHUNK_META);
      }
      if(!skipHistory) pushHistory();
      updateFileVersion();
    }catch(e2){
      console.error('Fallback LS fail', e2);
      showToast('Memoria locale piena: fai Backup JSON', 'error');
    }
  }
}

function openTicketModal(ticket){
  if(!ticket) return;
  openTicketEditorInModal(String(ticket.id));
}
/* === Popup dettagli cantiere + Modifica === */
function siteTickets(siteId){
  return (state.tickets||[]).filter(t=> t.siteId===siteId);
}
function sitePhotos(siteId){
  return siteTickets(siteId)
    .filter(t => Array.isArray(t.photos) && t.photos.length)
    .flatMap(t => t.photos.map(p => ({
      ...p,
      date: t.date || '',
      by: (t.collabIds||[]).map(cid => state.collaborators.find(c=>c.id===cid)?.name).filter(Boolean).join(', ')
    })));
}

function renderSiteDetailHTML(s){
  const tix = siteTickets(s.id);
  const hoursUsed = tix.reduce((sum,t)=> sum + (Number(t.hours)||0), 0);
  const matsUsed  = tix.reduce((sum,t)=> sum + (Number(t.totalMaterialCost)||0), 0);
  const hoursPerc = s.estimatedHours>0 ? (hoursUsed/s.estimatedHours*100) : 0;
  const matPerc   = s.materialBudget>0 ? (matsUsed/s.materialBudget*100) : 0;

  const {hoursByPhase, matByPhase} = (function(){
    const hb=new Map(), mb=new Map();
    tix.forEach(t=>{
      const key = t.phaseId||'__';
      hb.set(key,(hb.get(key)||0)+(Number(t.hours)||0));
      mb.set(key,(mb.get(key)||0)+(Number(t.totalMaterialCost)||0));
    });
    return {hoursByPhase:hb, matByPhase:mb};
  })();

  const phases = (s.phases||[]).map(p=>{
    const plannedH = (Number(s.estimatedHours)||0) * ((Number(p.weight)||0)/100);
    const hUsed = Number(hoursByPhase.get(p.id)||0);
    const hPerc = plannedH>0 ? (hUsed/plannedH*100) : 0;
    const mUsed = Number(matByPhase.get(p.id)||0);
    return `
      <div style="margin:.35rem 0">
        <div style="display:flex;justify-content:space-between">
          <div class="muted">${h(p.name)} <span class="muted">(${p.weight||0}%)</span></div>
          <div class="muted">${hPerc.toFixed(1)}%</div>
        </div>
        <div class="progress"><span style="width:${Math.min(hPerc,100)}%"></span></div>
        <div class="muted" style="font-size:.8rem;margin-top:.15rem">Ore ${fmtNum(hUsed)} / ${fmtNum(plannedH)} · Materiali ${formatCurrency(mUsed)}</div>
      </div>`;
  }).join('') || `<div class="muted">Nessuna fase definita</div>`;

  const recentTable = tix.slice(-8).reverse().map(t=>{
    const names = (t.collabIds||[]).map(cid => state.collaborators.find(c=>c.id===cid)?.name || 'N/D').join(', ');
    const ph = (s.phases||[]).find(p=> p.id===t.phaseId);
    return `<tr>
      <td>${t.date ? new Date(t.date).toLocaleDateString('it-CH') : '—'}</td>
      <td>${h(names||'—')}</td>
      <td>${h(ph?ph.name:'—')}</td>
      <td class="right">${(Number(t.hours)||0).toFixed(2)}</td>
      <td class="right">${formatCurrency(t.totalMaterialCost||0)}</td>
    </tr>`;
  }).join('') || `<tr><td colspan="5" class="muted">Nessun ticket</td></tr>`;

  const photos = sitePhotos(s.id);
  const gallery = photos.length ? `
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:.5rem">
      ${photos.map(p=>`
        <figure class="card" style="padding:6px">
          <img src="${h(p.dataUrl||'')}" alt="" style="width:100%;height:96px;object-fit:cover;border-radius:8px">
          <figcaption class="muted" style="font-size:.75rem;margin-top:.25rem">${h(p.date||'')}<br>${h(p.by||'')}</figcaption>
        </figure>
      `).join('')}
    </div>` : `<div class="muted">Nessuna foto caricata.</div>`;

  return `
    <div class="row two" style="margin:.25rem 0">
      <div><span class="muted">Progetto:</span> <b>${s.category==='fv'?'Fotovoltaico':'Elettrico'}</b></div>
      <div><span class="muted">Stato:</span> <b>${s.status==='attivo'?'Attivo':'Terminato'}</b></div>
      <div><span class="muted">Ore prev.:</span> <b>${fmtNum(s.estimatedHours||0)}</b></div>
      <div><span class="muted">Ore lav.:</span> <b>${fmtNum(hoursUsed)}</b></div>
      ${s.offerAmount ? `<div><span class="muted">Importo offerta:</span> <b>${formatCurrency(s.offerAmount)}</b></div>`:''}
      ${s.materialBudget ? `<div><span class="muted">Budget materiali:</span> <b>${formatCurrency(s.materialBudget)}</b></div>`:''}
    </div>

    <div style="margin-top:.5rem">
      <div class="muted">Avanzamento ore</div>
      <div class="progress"><span style="width:${Math.min(hoursPerc,100)}%"></span></div>
      <div class="muted" style="font-size:.8rem;margin-top:.15rem">${hoursPerc.toFixed(1)}%</div>
    </div>

    <div style="margin-top:.5rem">
      <div class="muted">Avanzamento materiali</div>
      <div class="progress"><span style="width:${Math.min(matPerc,100)}%"></span></div>
      <div class="muted" style="font-size:.8rem;margin-top:.15rem">${matPerc.toFixed(1)}%</div>
    </div>

    ${s.note ? `<div style="margin-top:.5rem"><span class="muted">Note:</span> ${h(s.note)}</div>`:''}

    <h3 style="margin:.75rem 0 .35rem">Fasi</h3>
    ${phases}

    <h3 style="margin:.75rem 0 .35rem">Ticket recenti</h3>
    <div style="max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:10px">
      <table>
        <thead><tr><th>Data</th><th>Collab</th><th>Fase</th><th class="right">Ore</th><th class="right">Materiali</th></tr></thead>
        <tbody>${recentTable}</tbody>
      </table>
    </div>

    <h3 style="margin:.75rem 0 .35rem">Foto cantiere</h3>
    ${gallery}
  `;
}

function renderSiteEditFormHTML(s){
  return `
    <form id="site-edit-form" class="row two" autocomplete="off">
      <input type="hidden" name="id" value="${h(s.id)}">
      <div><label>Nome</label><input name="name" value="${h(s.name)}" required></div>
      <div><label>Ore preventivate</label><input name="estimatedHours" type="number" step="0.01" value="${s.estimatedHours||0}"></div>
      <div><label>Importo offerta</label><input name="offerAmount" type="number" step="0.01" value="${s.offerAmount||0}"></div>
      <div><label>Progetto</label>
        <select name="category"><option value="fv" ${s.category==='fv'?'selected':''}>Fotovoltaico</option><option value="ele" ${s.category!=='fv'?'selected':''}>Elettrico</option></select>
      </div>
      <div><label>Budget materiali</label><input name="materialBudget" type="number" step="0.01" value="${s.materialBudget||0}"></div>
      <div style="grid-column:1/-1"><label>Note</label><input name="note" value="${h(s.note||'')}"></div>
      <div style="grid-column:1/-1; display:flex; gap:.5rem; margin-top:.25rem">
        <button class="btn btn-primary" type="submit">Salva</button>
        <button class="btn btn-ghost" type="button" id="site-edit-cancel">Annulla</button>
      </div>
    </form>`;
}

function openSiteModal(siteId){
  const s = state.sites.find(x=> String(x.id)===String(siteId));
  if(!s){ showToast('Cantiere non trovato','error'); return; }

  selectSite(String(siteId));

  const tix = (state.tickets||[])
    .filter(t=> String(t?.siteId) === String(siteId))
    .slice()
    .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));

  const totOre = safeNum(s.estimatedHours);
  const oreLavorate = tix.reduce((acc,t)=> acc + safeNum(t.hours), 0);
  const matsTot = tix.reduce((acc,t)=> acc + safeNum(t.totalMaterialCost||0), 0);
  const perc = totOre > 0 ? (oreLavorate/totOre)*100 : 0;

  const top = `
    <div class="detail-grid">
      <div><span class="muted">Nome</span><div style="font-weight:800">${h(s.name)}</div></div>
      <div><span class="muted">Categoria</span><div>${s.category==='fv'?'Fotovoltaico':'Elettrico'}</div></div>
      <div><span class="muted">Ore preventivate</span><div>${fmtNum(totOre)}</div></div>
      <div><span class="muted">Ore lavorate</span><div>${fmtNum(oreLavorate)}</div></div>
      ${s.offerAmount? `<div><span class="muted">Importo offerta</span><div>${formatCurrency(s.offerAmount||0)}</div></div>`:''}
      ${s.materialBudget? `<div><span class="muted">Budget materiali</span><div>${formatCurrency(s.materialBudget||0)}</div></div>`:''}
    </div>
    <div style="margin-top:.75rem">
      <div class="muted">Avanzamento ore</div>
      <div class="progress" style="margin-top:.25rem"><span style="width:${Math.min(100, perc)}%"></span></div>
      <div class="muted" style="font-size:.85rem;margin-top:.25rem">
        ${fmtNum(oreLavorate)} / ${fmtNum(totOre)} h · Materiali ${formatCurrency(matsTot)}
      </div>
    </div>`;

  const rows = tix.map(t=>{
    const collabNames = (Array.isArray(t.collabIds)?t.collabIds:(t.collabId?[t.collabId]:[]))
      .map(cid => (state.collaborators.find(c=>c.id===cid)?.name) || 'N/D')
      .join(', ');
    const phase = (s?.phases||[]).find(p=> p.id===t.phaseId);
    return `<tr>
      <td>${t.date ? new Date(t.date).toLocaleDateString('it-CH') : '—'}</td>
      <td>${h(collabNames||'—')}</td>
      <td>${h(phase?phase.name:'—')}</td>
      <td class="right">${fmtNum(t.hours||0)}</td>
      <td class="right">${formatCurrency(t.totalMaterialCost||0)}</td>
      <td class="table-actions">
        <button class="btn btn-ghost edit-action js-open-ticket" data-tid="${t.id}">Modifica</button>
      </td>
    </tr>`;
  }).join('');

  const html = `
    <div class="detail-section">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:.75rem; gap:.5rem; flex-wrap:wrap">
        <h3 style="margin:0">Cantiere • ${h(s.name)}</h3>
        <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; justify-content:flex-end">
          <span class="site-badge ${s.status==='attivo'?'sb-active':'sb-ended'}">${s.status==='attivo'?'Attivo':'Terminato'}</span>
          <button class="btn btn-primary" id="site-edit-trigger">Modifica cantiere</button>
          <button class="btn btn-ghost" onclick="archiveSite('${s.id}')">Archivia</button>
          <button class="btn btn-ghost" onclick="deleteSite('${s.id}')">Elimina</button>
        </div>
      </div>
      ${top}
      <div style="margin-top:1rem">
        <h3 style="margin:0 0 .5rem">Tutti i ticket</h3>
        ${tix.length
          ? `<div class="table-scroll-lg">
               <table>
                 <thead>
                   <tr><th>Data</th><th>Collaboratori</th><th>Fase</th><th class="right">Ore</th><th class="right">Materiali</th><th></th></tr>
                 </thead>
                 <tbody>${rows}</tbody>
               </table>
             </div>`
          : `<div class="muted">Nessun ticket per questo cantiere</div>`}
      </div>
    </div>`;

  const {body, modal} = openFloatingModal(`Cantiere • ${s.name}`, html) || {};
  if(!body) return;
  if(modal){
    modal.dataset.modalType = 'site';
    modal.dataset.entityId = String(siteId);
  }

  window.__modalAfterClose = ()=>{
    renderSiteList();
    selectSite(String(siteId));
  };

  body.querySelector('#site-edit-trigger')?.addEventListener('click', ()=>{
    openSiteEditorInModal(String(siteId));
  });

  body.querySelectorAll('.js-open-ticket')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tid = btn.getAttribute('data-tid');
      if(tid) openTicketEditorInModal(String(tid), {
        afterClose: ()=>{
          selectSite(String(siteId));
          openSiteModal(String(siteId));
        }
      });
    });
  });
}
function closeSiteModalIfOpen(siteId){
  const modal = byId('edit-modal');
  if(!modal || !modal.classList.contains('show')) return;
  if(modal.dataset.modalType !== 'site') return;
  if(siteId && modal.dataset.entityId !== String(siteId)) return;
  if(typeof window.__floatingModalClose === 'function') window.__floatingModalClose();
  else modal.classList.remove('show');
}
function refreshSiteModal(siteId){
  const modal = byId('edit-modal');
  if(!modal || !modal.classList.contains('show')) return;
  if(modal.dataset.modalType !== 'site') return;
  const targetId = modal.dataset.entityId;
  if(siteId && String(siteId) !== String(targetId)) return;
  openSiteModal(String(targetId));
}
async function loadState(){
  try{
    const head = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
    let loaded = null;
    if(head && head.v===2 && head.where==='idb'){
      loaded = await idbGet(IDB_KEY);
    }else if(head && head.v===1){
      loaded = lsLoadChunked(STORAGE_KEY);
    }else if(localStorage.getItem(STORAGE_KEY)){
      loaded = JSON.parse(localStorage.getItem(STORAGE_KEY));
    }
    state = loaded ? ensureStateShape(loaded) : ensureStateShape(null);
  }catch(e){
    console.warn('loadState error', e);
    state = ensureStateShape(null);
  }
  pushHistory();
}
async function clearLocalCache(){
  try{
    const prev = Number(localStorage.getItem(LS_CHUNK_META) || 0);
    for(let i=0;i<prev;i++) localStorage.removeItem(LS_CHUNK_PREFIX+i);
    localStorage.removeItem(LS_CHUNK_META);
    showToast('Cache locale pulita ✅','success');
  }catch(_){ }
}
function emergencySessionBackup(){
  try{
    sessionStorage.setItem('gestione-cantieri-backup', JSON.stringify(_pruneHeavy(state)));
    showToast('Backup di emergenza in sessione creato','warn');
  }catch(_){ }
}
window.addEventListener('beforeunload', ()=>{ try{ saveState(true); }catch(_){} });
function afterStateChange({silentSave=false}={}){ if(!silentSave) saveState(true); updateAll(); }

/* ===========================================================
   ROUTER + NAV + THEME
   =========================================================== */
const routes = ['home','offers','cantieri','collab','ticket','invoices','overdue','payments','expenses','bilanci','forecast','apps','reports','settings','agenda','archive'];
window.currentRoute = 'home';

function goTo(route){
  if(!routes.includes(route)) route = 'home';
  window.currentRoute = route;
  document.querySelectorAll('aside .nav button').forEach(b=>{
    const active = b.dataset.route===route;
    b.classList.toggle('active', active);
    b.setAttribute('aria-current', active ? 'page' : 'false');
  });
  routes.forEach(r=>{ const el = byId('page-'+r); if(el) el.style.display = (r===route) ? 'block' : 'none'; });
  if(location.hash !== '#'+route) historyPushHash('#'+route);
  const page = byId('page-'+route); if(page) page.setAttribute('tabindex','-1'), page.focus({preventScroll:true});
  if(route==='invoices') renderInvoiceList();
  if(route==='overdue') renderOverdueInvoices();
  if(route==='payments') renderPaymentList();
  if(route==='expenses') renderExpenseList();
  if(route==='bilanci') renderBilanci();
  if(route==='forecast') setupForecast();
  if(route==='offers') renderOfferList();
  if(route==='ticket') renderLastTickets();
  if(route==='apps') renderAppsGrid();
  if(route==='settings') setupAppsSettings();
  if(route==='reports') setupReports();
  if(route==='archive'){ bindArchivePage(); renderArchive('sites'); }
  renderPageRecap(route);
}
function historyPushHash(h){ try{ window.history.replaceState(null,'',h); }catch(_){} }
function setupNavigation(){
  document.querySelectorAll('aside .nav button').forEach(btn=>{ btn.addEventListener('click', ()=> goTo(btn.dataset.route)); });
  window.addEventListener('hashchange', ()=> goTo((location.hash||'#home').slice(1)));
  goTo((location.hash||'#home').slice(1));
}
function setupTheme(){
  const sw = byId('theme-switch');
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  sw?.addEventListener('click', ()=>{ const t = document.documentElement.getAttribute('data-theme'); const next = t==='light'?'dark':'light'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); });
}

function performLogout(detail='uscita manuale'){
  if(performLogout.__running) return;
  performLogout.__running = true;
  let session = null;
  try{ session = JSON.parse(localStorage.getItem('gc_auth_user')||'null'); }
  catch(_){ session = null; }

  const detailSafe = (()=>{
    try{ const txt = String(detail ?? '').trim(); return txt || 'uscita manuale'; }
    catch(_){ return 'uscita manuale'; }
  })();

  let logged = false;
  try{
    if(typeof window.gcAudit === 'function'){
      window.gcAudit('logout', detailSafe);
      logged = true;
    }
  }catch(_){ logged = false; }

  if(!logged){
    try{
      const key = 'gc_audit_v1';
      let list;
      try{ list = JSON.parse(localStorage.getItem(key)||'[]'); }
      catch(_){ list = []; }
      list.unshift({
        ts: new Date().toISOString(),
        user: session?.username || 'sconosciuto',
        type: 'logout',
        detail: detailSafe
      });
      localStorage.setItem(key, JSON.stringify(list));
    }catch(_){ }
  }

  try{ sessionStorage.setItem('gc_manual_logout','1'); }
  catch(_){ }

  try{ localStorage.removeItem('gc_auth_user'); }
  catch(_){ }

  try{ alert('Logout eseguito, sessione terminata.'); }
  catch(_){ }

  location.href = 'login.html';
}

function handleExternalCommand(detail){
  const cmd = typeof detail === 'string' ? detail : (detail && (detail.command || detail.id || detail.type || detail.name || detail.action));
  if(!cmd) return;
  if(String(cmd).toLowerCase() === 'logout') performLogout();
}

window.performLogout = performLogout;
window.gcHandleCommand = function(cmd){ handleExternalCommand(cmd); };
window.gcCommand = function(cmd){ handleExternalCommand(cmd); };
window.addEventListener('gc:command', (ev)=> handleExternalCommand(ev.detail));

/* ===========================================================
   COMMAND PALETTE + SHORTCUTS + SEARCH
   =========================================================== */
const paletteOverlay = byId('palette-overlay'); const paletteInput = byId('palette-input'); const paletteResults = byId('palette-results');
const commands = [
  {id:'go:home', label:'Vai: Dashboard', action:()=>goTo('home'), k:'G D'},
  {id:'go:offers', label:'Vai: Offerte', action:()=>goTo('offers'), k:'G O'},
  {id:'go:cantieri', label:'Vai: Cantieri', action:()=>goTo('cantieri'), k:'G C'},
  {id:'go:collab', label:'Vai: Collaboratori', action:()=>goTo('collab'), k:'G L'},
  {id:'go:ticket', label:'Vai: Nuovo Ticket', action:()=>goTo('ticket'), k:'G T'},
  {id:'go:invoices', label:'Vai: Fatture', action:()=>goTo('invoices'), k:'G F'},
  {id:'go:payments', label:'Vai: Incassi', action:()=>goTo('payments'), k:'G P'},
  {id:'go:expenses', label:'Vai: Spese', action:()=>goTo('expenses'), k:'G E'},
  {id:'go:bilanci', label:'Vai: Bilanci', action:()=>goTo('bilanci'), k:'G B'},
  {id:'go:apps',    label:'Vai: Applicazioni', action:()=>goTo('apps'), k:'G A'},
  {id:'go:reports', label:'Vai: Report',        action:()=>goTo('reports'), k:'G R'},
  {id:'go:archive', label:'Vai: Archivio',      action:()=>goTo('archive'), k:'G V'},
  {id:'go:settings', label:'Vai: Impostazioni & Dati', action:()=>goTo('settings'), k:'G S'},
  {id:'new:ticket', label:'Nuovo Ticket', action:()=>{goTo('ticket'); byId('ti-collab-search')?.focus();}, k:'N T'},
  {id:'new:invoice', label:'Nuova Fattura', action:()=>{goTo('invoices'); showInvoiceForm();}, k:'N F'},
  {id:'new:payment', label:'Nuovo Incasso', action:()=>{goTo('payments'); showPaymentForm();}, k:'N P'},
  {id:'new:expense', label:'Nuova Spesa', action:()=>{goTo('expenses'); showExpenseForm();}, k:'N S'},
  {id:'new:offer', label:'Nuova Offerta', action:()=>{goTo('offers'); byId('of-nome')?.focus();}, k:'N O'},
  {id:'data:csv', label:'Esporta CSV', action:exportCSV, k:'Ctrl/Cmd+E'},
  {id:'data:backup', label:'Backup JSON', action:backupData, k:'Ctrl/Cmd+B'},
  {id:'data:restore', label:'Importa JSON', action:restoreData, k:'Ctrl/Cmd+R'},
  {id:'data:export-state', label:'Backup completo (JSON app)', action:exportAppState},
  {id:'data:import-state', label:'Importa backup completo (JSON app)', action:importAppState},
  {id:'help:shortcuts', label:'Mostra scorciatoie (?)', action:()=>window.toggleShortcuts?.()},
  {id:'auth:logout', label:'Logout', action:()=>performLogout(), k:'Ctrl/Cmd+Shift+Q'}
];
commands.push({id:'data:clear-cache', label:'Pulisci cache locale (LS chunk)', action:clearLocalCache});
commands.push({id:'data:session-backup', label:'Backup emergenza (SessionStorage)', action:emergencySessionBackup});
function openPalette(prefill=''){ paletteOverlay.classList.add('show'); paletteInput.value = prefill; renderPalette(prefill); setTimeout(()=> paletteInput.focus(), 0); }
function closePalette(){ paletteOverlay.classList.remove('show'); }
function renderPalette(q=''){
  const needle = q.trim().toLowerCase();
  const all = [
    ...commands,
    ...state.sites.map(s=>({id:'site:'+s.id, label:'Cantiere: '+s.name, action:()=>{goTo('cantieri'); selectSite(s.id);} })),
    ...state.collaborators.map(c=>({id:'collab:'+c.id, label:'Collaboratore: '+c.name, action:()=>{goTo('collab'); selectCollab(c.id);} })),
    ...state.invoices.map(i=>({id:'inv:'+i.id, label:`Fattura ${i.number} – ${i.customer||''}`.trim(), action:()=>{goTo('invoices'); showInvoiceDetail(i.id);} })),
  ...state.payments.map(p=>({id:'pay:'+p.id, label:`Incasso ${formatCurrency(p.amount)} – ${p.reference||'N/D'}`, action:()=>{goTo('payments'); showPaymentDetail(p.id);} })),
    ...state.offers.map(o=>({id:'offer:'+o.id, label:`Offerta: ${o.nome} – ${o.cliente||''}`.trim(), action:()=>{goTo('offers'); selectOffer(o.id);} })),
    ...state.expenses.map(e=>({id:'exp:'+e.id, label:`Spesa: ${(e.category||'Senza categoria')} – ${formatCurrency(e.amount||0)} ${e.desc?('· '+e.desc):''}`.trim(), action:()=>{goTo('expenses'); showExpenseDetail(e.id);} }))
  ];
  const res = needle ? all.filter(x=> x.label.toLowerCase().includes(needle)) : all.slice(0,30);
  paletteResults.innerHTML = res.length ? res.map((r,idx)=> `<div data-id="${r.id}" class="${idx===0?'active':''}"><span>${r.label}</span><span class="muted">${r.k||''}</span></div>`).join('') : `<div class="muted" style="padding:.9rem">Nessun risultato</div>`;
}
paletteInput?.addEventListener('input', e=> renderPalette(e.target.value));
paletteResults?.addEventListener('click', e=>{ const row = e.target.closest('div[data-id]'); if(!row) return; runPaletteCommand(row.dataset.id); });
paletteOverlay?.addEventListener('keydown', e=>{
  const active = paletteResults.querySelector('.active');
  if(e.key==='Escape'){ closePalette(); return; }
  if(e.key==='Enter'){ active?.click(); return; }
  if(e.key==='ArrowDown'){ e.preventDefault(); const n=active?.nextElementSibling; if(n){ active.classList.remove('active'); n.classList.add('active'); n.scrollIntoView({block:'nearest'});} }
  if(e.key==='ArrowUp'){ e.preventDefault(); const p=active?.previousElementSibling; if(p){ active.classList.remove('active'); p.classList.add('active'); p.scrollIntoView({block:'nearest'});} }
});
function runPaletteCommand(idOrLabel){
  const all = [...commands,
    ...state.sites.map(s=>({id:'site:'+s.id, action:()=>{goTo('cantieri'); selectSite(s.id);}})),
    ...state.collaborators.map(c=>({id:'collab:'+c.id, action:()=>{goTo('collab'); selectCollab(c.id);}})),
    ...state.invoices.map(i=>({id:'inv:'+i.id, action:()=>{goTo('invoices'); showInvoiceDetail(i.id);}})),
    ...state.payments.map(p=>({id:'pay:'+p.id, action:()=>{goTo('payments'); showPaymentDetail(p.id);}})),
    ...state.offers.map(o=>({id:'offer:'+o.id, action:()=>{goTo('offers'); selectOffer(o.id);}})),
    ...state.expenses.map(e=>({id:'exp:'+e.id, action:()=>{goTo('expenses'); showExpenseDetail(e.id);}}))
  ];
  const cmd = all.find(c=> c.id===idOrLabel || c.label===idOrLabel);
  closePalette(); cmd?.action?.();
}
function setupShortcuts(){
  const modal = byId('shortcuts-modal');
  const toggle = ()=> modal.classList.toggle('show'); window.toggleShortcuts = toggle;
  byId('close-shortcuts')?.addEventListener('click', toggle);
  window.addEventListener('keydown', (e)=>{
    const isTypingTarget = (el) => {
      const tag = (el?.tagName || '').toUpperCase();
      return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || el?.isContentEditable;
    };
    // Se sto scrivendo in un campo o se è aperta palette/modal, ignora tutte le scorciatoie
    const paletteOpen = document.getElementById('palette-overlay')?.classList.contains('show');
    const modalOpen = document.getElementById('shortcuts-modal')?.classList.contains('show');
    if (isTypingTarget(e.target) || paletteOpen || modalOpen) return;
    if ((e.key==='k' || e.key==='K') && (e.ctrlKey||e.metaKey)){ e.preventDefault(); openPalette(byId('global-search')?.value||''); }
    if (e.key==='?' || (e.shiftKey && e.key==='/')) { e.preventDefault(); toggle(); }
    if (e.key.toLowerCase()==='g'){ let once=true; const on2 = (ev)=>{ if(once){
      const paletteOpen = document.getElementById('palette-overlay')?.classList.contains('show');
      const modalOpen = document.getElementById('shortcuts-modal')?.classList.contains('show');
      if (isTypingTarget(ev.target) || paletteOpen || modalOpen) return;
  once=false; window.removeEventListener('keydown', on2); const m = ev.key.toLowerCase();
  if(m==='d') goTo('home'); if(m==='o') goTo('offers'); if(m==='c') goTo('cantieri'); if(m==='l') goTo('collab'); if(m==='t') goTo('ticket'); if(m==='f') goTo('invoices'); if(m==='p') goTo('payments'); if(m==='e') goTo('expenses'); if(m==='b') goTo('bilanci'); if(m==='a') goTo('apps'); if(m==='r') goTo('reports'); if(m==='v') goTo('archive'); if(m==='s') goTo('settings'); }}; window.addEventListener('keydown', on2, {once:true}); }
    if (e.key.toLowerCase()==='n'){ let once=true; const on2 = (ev)=>{ if(once){
      const paletteOpen = document.getElementById('palette-overlay')?.classList.contains('show');
      const modalOpen = document.getElementById('shortcuts-modal')?.classList.contains('show');
      if (isTypingTarget(ev.target) || paletteOpen || modalOpen) return;
      once=false; window.removeEventListener('keydown', on2); const m = ev.key.toLowerCase();
  if(m==='t'){ goTo('ticket'); byId('ti-collab-search')?.focus(); } if(m==='f'){ goTo('invoices'); showInvoiceForm(); } if(m==='p'){ goTo('payments'); showPaymentForm(); } if(m==='s'){ goTo('expenses'); showExpenseForm(); } if(m==='o'){ goTo('offers'); byId('of-nome')?.focus(); } }}; window.addEventListener('keydown', on2, {once:true}); }
    if ((e.ctrlKey||e.metaKey) && !e.shiftKey && e.key.toLowerCase()==='e'){ e.preventDefault(); exportCSV(); }
    if ((e.ctrlKey||e.metaKey) && !e.shiftKey && e.key.toLowerCase()==='b'){ e.preventDefault(); backupData(); }
    if ((e.ctrlKey||e.metaKey) && !e.shiftKey && e.key.toLowerCase()==='r'){ e.preventDefault(); restoreData(); }
    if ((e.ctrlKey||e.metaKey) && !e.shiftKey && e.key.toLowerCase()==='z'){ e.preventDefault(); doUndo(); }
    if (((e.ctrlKey||e.metaKey) && e.shiftKey && e.key.toLowerCase()==='z') || (e.ctrlKey && !e.metaKey && e.key.toLowerCase()==='y')){ e.preventDefault(); doRedo(); }
  });
  byId('global-search')?.addEventListener('input', debounce(e=> openPalette(e.target.value), 250));
}

/* ===========================================================
   EXPORT / BACKUP / RESTORE + DnD + Share
   =========================================================== */
function updateFileVersion(){
  const last = state._lastSaveAt ? new Date(state._lastSaveAt).toLocaleString('it-CH') : '';
  const ver = `v${state.meta?.version || '10.0'} • schema ${state.schemaVersion}`;
  const el1 = byId('file-version'); if(el1) el1.textContent = `${ver}${last ? ' • Ultimo salvataggio: '+last : ''}`;
  const el2 = byId('file-version-side'); if(el2) el2.textContent = ver;
  const el3 = byId('last-save-side'); if(el3) el3.textContent = last || '—';
}
function downloadBlob(blob, filename){
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
}
function toCSV(rows){
  if(!rows || !rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
  const head = headers.map(esc).join(';');
  const body = rows.map(r => headers.map(h=> esc(r[h])).join(';')).join('\n');
  return head+'\n'+body;
}
const safeStr = (v,d='')=> (v===undefined || v===null) ? d : v;

function exportCSV(){
  try{
    const now = new Date();
    const ts = now.toISOString().replace(/[:T]/g,'-').slice(0,19);
    const tRows = state.tickets.map(t=>({
      id:safeStr(t.id), data:safeStr(t.date), collaboratore_id:(Array.isArray(t.collabIds)? t.collabIds.join(',') : safeStr(t.collabId)),
      cantiere_id:safeStr(t.siteId), cantiere_nome:safeStr(t.siteName),
      fase_id:safeStr(t.phaseId), ore: safeNum(t.hours).toFixed(2),
      materiali_valore: safeNum(t.totalMaterialCost).toFixed(2),
      materiali_dettaglio: (t.materials?.length ? JSON.stringify(t.materials) : ''),
      nota:safeStr(t.note), creato_il:safeStr(t.createdAt)
    }));
    downloadBlob(new Blob([toCSV(tRows)],{type:'text/csv;charset=utf-8'}), `tickets_${ts}.csv`);

    const iRows = state.invoices.map(i=>({
      id:safeStr(i.id), numero:safeStr(i.number), data:safeStr(i.date), scadenza:safeStr(i.dueDate),
      cliente:safeStr(i.customer), oggetto:safeStr(i.subject), imponibile:safeNum(i.amount).toFixed(2),
      iva_perc: String(i.vat??''), stato:safeStr(i.status), creato_il:safeStr(i.createdAt), aggiornato_il:safeStr(i.updatedAt)
    }));
    downloadBlob(new Blob([toCSV(iRows)],{type:'text/csv;charset=utf-8'}), `invoices_${ts}.csv`);

    const pRows = state.payments.map(p=>({
      id:safeStr(p.id), data:safeStr(p.date), importo:safeNum(p.amount).toFixed(2),
      metodo:safeStr(p.method), riferimento:safeStr(p.reference), nota:safeStr(p.note),
      fattura_id:safeStr(p.invoiceId), creato_il:safeStr(p.createdAt), aggiornato_il:safeStr(p.updatedAt)
    }));
    downloadBlob(new Blob([toCSV(pRows)],{type:'text/csv;charset=utf-8'}), `payments_${ts}.csv`);

    const exRows = state.expenses.map(e=>({
      id:safeStr(e.id), data:safeStr(e.date), importo:safeNum(e.amount).toFixed(2),
      categoria:safeStr(e.category), stato:safeStr(e.status), descrizione:safeStr(e.desc),
      ricorrenza:safeStr(e.recurring||'none'), fine_ricorrenza:safeStr(e.recEnd), creato_il:safeStr(e.createdAt), aggiornato_il:safeStr(e.updatedAt)
    }));
    downloadBlob(new Blob([toCSV(exRows)],{type:'text/csv;charset=utf-8'}), `expenses_${ts}.csv`);

    // >>> PATCH: includi stipendio netto mensile nel CSV collaboratori
    const cRows = state.collaborators.map(c=>({
      id:safeStr(c.id),
      nome:safeStr(c.name),
      ruolo:safeStr(c.role),
      tariffa_oraria:safeNum(c.rate).toFixed(2),
      stipendio_netto:safeNum(c.netSalary).toFixed(2),
      ore_mensili_previste: c.monthlyHours == null ? '' : safeNum(c.monthlyHours).toFixed(2),
      stipendio_lordo_stimato:(()=>{
        const hours = safeNum(c.monthlyHours);
        if(hours<=0) return '';
        const rate = getCollabCostRate(c.id);
        return (hours * rate).toFixed(2);
      })(),
      nota:safeStr(c.note),
      creato_il:safeStr(c.createdAt)
    }));
    downloadBlob(new Blob([toCSV(cRows)],{type:'text/csv;charset=utf-8'}), `collaborators_${ts}.csv`);

    const sRows = state.sites.map(s=>({id:safeStr(s.id), nome:safeStr(s.name), ore_preventivate:safeNum(s.estimatedHours).toFixed(2),
      importo_offerta:safeNum(s.offerAmount).toFixed(2), budget_materiali:safeNum(s.materialBudget).toFixed(2),
      fasi: (s.phases?.length ? JSON.stringify(s.phases) : ''), note:safeStr(s.note), stato:safeStr(s.status), creato_il:safeStr(s.createdAt)}));
    downloadBlob(new Blob([toCSV(sRows)],{type:'text/csv;charset=utf-8'}), `sites_${ts}.csv`);

    const oRows = state.offers.map(o=>({id:safeStr(o.id), nome:safeStr(o.nome), cliente:safeStr(o.cliente),
      importo:safeNum(o.importo).toFixed(2), probabilita:String(safeNum(o.probabilita).toFixed(0)),
      scadenza:safeStr(o.scadenza), stato:safeStr(o.stato), note:safeStr(o.note), creato_il:safeStr(o.createdAt), aggiornato_il:safeStr(o.updatedAt)}));
    downloadBlob(new Blob([toCSV(oRows)],{type:'text/csv;charset=utf-8'}), `offers_${ts}.csv`);

    showToast('Esportazione CSV completata ✅','success');
  }catch(e){ console.error(e); showToast('Errore durante l\'esportazione CSV','error'); }
}

function backupData(){
  try{
    const ts = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
  const payload = { meta:{app:'gestione-cantieri', version: state.meta?.version||'10.0', schemaVersion:state.schemaVersion, savedAt:new Date().toISOString(), locale:'it-CH'}, data: state };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    if (window.showSaveFilePicker){
      (async ()=>{
        try{
          const handle = await showSaveFilePicker({suggestedName:`backup_gestione_cantieri_${ts}.json`, types:[{description:'JSON', accept:{'application/json':['.json']}}]});
          const writable = await handle.createWritable(); await writable.write(blob); await writable.close();
          showToast('Backup salvato ✅');
        }catch(err){ downloadBlob(blob, `backup_gestione_cantieri_${ts}.json`); showToast('Backup scaricato ✅'); }
      })();
    }else{ downloadBlob(blob, `backup_gestione_cantieri_${ts}.json`); showToast('Backup scaricato ✅'); }
  }catch(e){ console.error(e); showToast('Errore durante il backup','error'); }
}

function exportAppState() {
  try {
    const stateBackup = {
      meta: state.meta,
      data: state
    };
    const jsonBlob = new Blob([JSON.stringify(stateBackup, null, 2)], { type: 'application/json' });
    downloadBlob(jsonBlob, 'backup_app_state.json');
    showToast('Backup dell\'intera app eseguito ✅', 'success');
  } catch (e) {
    console.error('Errore nell\'esportazione dello stato:', e);
    showToast('Errore durante il salvataggio del backup', 'error');
  }
}

function applyImportedState(candidate){
  if(!candidate) throw new Error('Stato importato vuoto');
  const theme = document.documentElement.getAttribute('data-theme')||'dark';
  const restored = ensureStateShape(candidate);
  restored.meta = Object.assign({}, restored.meta||{}, { source:'import' });
  restored.expenses = (restored.expenses||[]).map(e=> ({
    ...e,
    date: (e.date||'').slice(0,10),
    anchorDate: (e.anchorDate||'').slice(0,10),
    recEnd: (e.recEnd||'').slice(0,10),
    occurrencesPaid: Array.from(new Set((e.occurrencesPaid||[]).map(x=> String(x).slice(0,10))))
  }));
  state = restored;
  saveState();
  updateAll();
  loadSettingsForm();
  document.documentElement.setAttribute('data-theme', theme);
}

async function importAppState() {
  const inputFile = document.createElement('input');
  inputFile.type = 'file';
  inputFile.accept = 'application/json';
  inputFile.addEventListener('change', async (event) => {
    const file = event.target.files?.[0];
    if (!file) {
      inputFile.remove();
      return;
    }
    try {
      const text = await file.text();
      const importedData = JSON.parse(text);
      const payload = importedData?.data || importedData;
      if (payload) {
        applyImportedState(payload);
        showToast('Dati importati con successo ✅', 'success');
      } else {
        showToast('Formato JSON non valido.', 'error');
      }
    } catch (error) {
      console.error('Errore nell\'importazione dei dati:', error);
      showToast('Errore durante l\'importazione', 'error');
    }
    inputFile.remove();
  }, { once: true });
  inputFile.click();
}
window.exportAppState = exportAppState;
window.importAppState = importAppState;

function restoreData(){
  const input = byId('json-file-input');
  input.value = '';
  input.onchange = async ()=>{
    const file = input.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const parsed = JSON.parse(text);
      const candidate = parsed?.data ? parsed.data : parsed;
      applyImportedState(candidate);
      showToast('Import completato ✅','success');
    }catch(e){ console.error('restoreData parse', e); showToast('File non valido','error'); }
  };
  input.click();
}

// Drag & Drop JSON
(function setupDnD(){
  const overlay = byId('drop-overlay');
  let depth = 0;
  const on = (t)=>{ overlay.classList.toggle('show', t); };
  window.addEventListener('dragenter', (e)=>{
    const onlyHere = !!state.settings?.importOnlyInSettings;
    const allowed = !onlyHere || window.currentRoute==='settings';
    if(!allowed){ return; }
    e.preventDefault(); depth++; on(true);
  });
  window.addEventListener('dragleave', (e)=>{
    const onlyHere = !!state.settings?.importOnlyInSettings;
    const allowed = !onlyHere || window.currentRoute==='settings';
    if(!allowed){ return; }
    e.preventDefault(); depth--; if(depth<=0) on(false);
  });
  window.addEventListener('dragover', (e)=>{
    const onlyHere = !!state.settings?.importOnlyInSettings;
    const allowed = !onlyHere || window.currentRoute==='settings';
    if(!allowed){ return; }
    e.preventDefault();
  });
  window.addEventListener('drop', async (e)=>{
    const onlyHere = !!state.settings?.importOnlyInSettings;
    const allowed = !onlyHere || window.currentRoute==='settings';
    if(!allowed){ depth=0; on(false); return; }
    e.preventDefault(); depth=0; on(false);
    const f = e.dataTransfer?.files?.[0]; if(!f) return;
    try{
      const text = await f.text();
      const parsed = JSON.parse(text);
      const candidate = parsed?.data ? parsed.data : parsed;
      applyImportedState(candidate);
      showToast('Import completato ✅','success');
    }catch(err){ console.error(err); showToast('File non valido','error'); }
  });
})();

// Web Share JSON
async function shareJSON(){
  try{
  const payload = { meta:{app:'gestione-cantieri', version:state.meta?.version||'10.0', schemaVersion:state.schemaVersion, savedAt:new Date().toISOString()}, data:state };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const file = new File([blob], 'backup_gestione_cantieri.json', {type:'application/json'});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:'Backup Gestione Cantieri', files:[file]});
      showToast('Condiviso ✅');
    }else{
      downloadBlob(blob, 'backup_gestione_cantieri.json');
      showToast('Browser non supporta Share: file scaricato','info');
    }
  }catch(e){ console.error(e); showToast('Condivisione non riuscita','error'); }
}

/* ===========================================================
   SETTINGS + LOGO + ROLES
   =========================================================== */
function setupSettings(){
  byId('btn-add-role')?.addEventListener('click', ()=> addRoleRow());
  loadSettingsForm();
  const chk = byId('st-dnd-only-settings'); if(chk) chk.checked = !!state.settings.importOnlyInSettings;
  byId('set-form')?.addEventListener('submit', (e)=>{
    e.preventDefault();
    state.settings.costHour  = safeNum(byId('st-cost-h').value)||35;
    state.settings.markup    = safeNum(byId('st-markup').value)||10;
    state.settings.currency  = byId('st-currency').value;
    state.settings.vat       = safeNum(byId('st-vat').value)||8.1;
    state.settings.accountingMethod = byId('st-accounting-method').value || 'cash';
    state.settings.fixedMonth= safeNum(byId('st-fixed-month').value)||115000;
    state.settings.regiaRate = safeNum(byId('st-regia-rate').value)||85;
    state.settings.estRevenue= safeNum(byId('set-est-revenue').value)||115000;
    state.settings.estCosts  = safeNum(byId('set-est-costs').value)||90000;
    const roles = []; document.querySelectorAll('#st-roles .role-row').forEach(r=>{
      const name = r.querySelector('.role-name').value.trim();
      const cost = safeNum(r.querySelector('.role-cost').value);
      if(name && cost>0) roles.push({name, cost});
    });
    state.settings.roles = roles;
    const limitDnd = byId('st-dnd-only-settings');
    if(limitDnd) state.settings.importOnlyInSettings = !!limitDnd.checked;
    afterStateChange();
    showToast('Impostazioni salvate ✅','success');
  });
  byId('btn-backup-2')?.addEventListener('click', backupData);
  byId('btn-restore-2')?.addEventListener('click', restoreData);
  byId('btn-share-json')?.addEventListener('click', shareJSON);

  // Logo upload
  const f = byId('settings-logo-file'); const pv = byId('settings-logo-preview');
  const remove = byId('settings-logo-remove');
  f?.addEventListener('change', async ()=>{
    const file = f.files?.[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{ state.settings.logoDataUrl = reader.result; applyLogo(); afterStateChange(); showToast('Logo aggiornato ✅','success'); updateFaviconFromLogo(); };
    reader.readAsDataURL(file);
  });
  remove?.addEventListener('click', ()=>{ state.settings.logoDataUrl = null; applyLogo(); afterStateChange(); showToast('Logo rimosso','info'); updateFaviconFromLogo(); });

  // Preview initial
  if(state.settings.logoDataUrl){ pv.src = state.settings.logoDataUrl; pv.style.display='block'; }
}
function updateFaviconFromLogo(){
  const link = document.querySelector('#dynamic-favicon'); if(!link) return;
  if(state.settings.logoDataUrl){ link.href = state.settings.logoDataUrl; } // semplice: usa data url direttamente
}
function applyLogo(){
  const brand = byId('brand-logo'); const img = byId('brand-logo-img'); const pv = byId('settings-logo-preview');
  if(state.settings.logoDataUrl){
    img.src = state.settings.logoDataUrl; img.style.display='block'; brand.classList.add('has-img'); if(pv){ pv.src = state.settings.logoDataUrl; pv.style.display='block'; }
  } else {
    img.src=''; img.style.display='none'; brand.classList.remove('has-img'); if(pv){ pv.src=''; pv.style.display='none'; }
  }
  // LOGO IN TOPBAR (nuovo + fallback)
  const topbarLogo = byId('app-logo-topbar');
  if(topbarLogo){
    let src = state.settings.logoDataUrl;
    // fallback: se non c'è ancora il logo salvato ma in sidebar è già caricato
    const sideImg = byId('brand-logo-img');
    if(!src && sideImg && sideImg.src) src = sideImg.src;
    if(src){ topbarLogo.src = src; topbarLogo.style.display='block'; }
    else { topbarLogo.removeAttribute('src'); topbarLogo.style.display='none'; }
  }
}
function loadSettingsForm(){
  const s = state.settings;
  const set = (id,val)=>{ const el = byId(id); if(el) el.value = val; };
  const chk = byId('st-dnd-only-settings'); if(chk) chk.checked = !!s.importOnlyInSettings;
  set('st-cost-h', s.costHour); set('st-markup', s.markup); set('st-currency', s.currency);
  set('st-vat', s.vat); set('st-fixed-month', s.fixedMonth); set('st-regia-rate', s.regiaRate);
  set('set-est-revenue', s.estRevenue); set('set-est-costs', s.estCosts);
  set('st-accounting-method', s.accountingMethod || 'cash');
  const c = byId('st-roles'); c.innerHTML = ''; (s.roles||[]).forEach(r=> addRoleRow(r.name, r.cost));
  applyLogo(); updateFaviconFromLogo();
}
function addRoleRow(name='', cost=''){
  const c = byId('st-roles');
  const row = document.createElement('div');
  row.className = 'role-row'; row.style.display='grid'; row.style.gridTemplateColumns='1fr 1fr auto'; row.style.gap='.5rem'; row.style.alignItems='center';
  row.innerHTML = `<input class="role-name" placeholder="Nome ruolo" value="${name}"><input type="number" class="role-cost" placeholder="Costo orario" value="${cost}" step="0.01"><button type="button" class="remove-btn">×</button>`;
  row.querySelector('.remove-btn').addEventListener('click', ()=> row.remove());
  c.appendChild(row);
}

const SHAPES = {
  rounded:(txt)=>`<div style="width:36px;height:36px;border-radius:10px;border:1px solid var(--border);display:grid;place-items:center;background:var(--panel)"><b>${txt}</b></div>`,
  circle:(txt)=>`<div style="width:36px;height:36px;border-radius:999px;border:1px solid var(--border);display:grid;place-items:center;background:var(--panel)"><b>${txt}</b></div>`,
  diamond:(txt)=>`<div style="width:36px;height:36px;transform:rotate(45deg);border:1px solid var(--border);background:var(--panel);display:grid;place-items:center"><span style="transform:rotate(-45deg);font-weight:800">${txt}</span></div>`
};
const initials = (s='') => (s.trim().match(/\p{L}/gu)||[]).slice(0,2).join('').toUpperCase() || '•';

function renderAppsGrid(){
  const grid = byId('apps-grid'); if(!grid) return;
  const items = (state.settings.appsLinks||[]).slice(0,20);
  grid.innerHTML = items.length ? items.map((a,idx)=> {
    const label = h(a.label||'Link');
    const url   = h(a.url||'');
    const iconMarkup = a.iconUrl
      ? `<img src="${a.iconUrl}" alt="" referrerpolicy="no-referrer"
           style="width:36px;height:36px;border-radius:8px"
           onerror="this.onerror=null; this.src='${fallbackFaviconUrl(a.url)}';">`
      : (a.shape && SHAPES[a.shape] ? SHAPES[a.shape](initials(label)) : SHAPES.rounded(initials(label)));
    return `<button class="card apps-link" type="button" data-idx="${idx}" data-label="${label}" data-url="${url}" style="padding:1rem; text-align:center; aspect-ratio:1/1; display:grid; place-items:center" title="${url}">
    <div class="apps-icon">${iconMarkup}</div>
    <div style="margin-top:.4rem; font-weight:800">${label}</div>
  </button>`; // placeholder, poi aggiorniamo con favicon
  }).join('') : `<div class="muted">Nessun link configurato.</div>`;
  // Avvia il prefetch delle icone in background
  items.forEach(async (a,i)=>{
    if(!a.iconUrl && a.url){
      await ensureAppIcon(a);
      const spot = grid.querySelector(`.apps-link[data-idx="${i}"] .apps-icon`);
      if(spot && a.iconUrl){
        spot.innerHTML = `<img src="${a.iconUrl}" alt="" referrerpolicy="no-referrer"
        style="width:36px;height:36px;border-radius:8px"
        onerror="this.onerror=null; this.src='${fallbackFaviconUrl(a.url)}';">`;
      }
    }
  });
  grid.querySelectorAll('.apps-link').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const label = btn.dataset.label || 'Link';
      const url = btn.dataset.url || '';
      if(!url) return;
      openAppWebview(label, url);
    });
  });
}

function renderAppsSettings(){
  const c = byId('apps-links-list'); if(!c) return;
  const items = state.settings.appsLinks||[];
  const iconOpts = Object.keys(ICONS||{}).map(k=>`<option value="${h(k)}">${h(k)}</option>`).join('');
  const shapeOpts = Object.keys(SHAPES).map(k=>`<option value="${k}">${k}</option>`).join('');
  c.innerHTML = items.length ? items.map(a=>`
    <div class="card" style="padding:.5rem; display:grid; grid-template-columns:90px 1.2fr 1.8fr 150px auto auto; gap:.5rem; align-items:center">
      <div style="display:flex;align-items:center;gap:.5rem">
        <div style="width:36px;height:36px;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;background:var(--panel)">
          ${a.iconUrl ? `<img src="${a.iconUrl}" alt="" referrerpolicy="no-referrer" style="width:24px;height:24px;border-radius:6px" onerror="this.onerror=null; this.src='${fallbackFaviconUrl(a.url)}';">` : (a.shape && SHAPES[a.shape] ? SHAPES[a.shape](initials(a.label||'Link')) : SHAPES.rounded(initials(a.label||'Link')))}
        </div>
        <select data-id="${a.id}" data-k="icon">${iconOpts}</select>
      </div>
      <input value="${h(a.label||'')}"  data-id="${a.id}" data-k="label"  placeholder="Etichetta (es. Google)">
      <input value="${h(a.url||'')}"    data-id="${a.id}" data-k="url"    placeholder="https://...">
      <select data-id="${a.id}" data-k="shape" style="${a.iconUrl?'display:none':''}">${shapeOpts}</select>
      <button class="btn btn-ghost" data-id="${a.id}" data-act="refresh">Aggiorna icona</button>
      <button class="btn btn-ghost" data-id="${a.id}">Elimina</button>
    </div>`).join('') : `<div class="muted" style="padding:.5rem">Nessun link configurato.</div>`;
  c.querySelectorAll('select[data-k="icon"]').forEach(sel=>{
    const it = items.find(x=>x.id===sel.dataset.id);
    sel.value = it?.icon || 'google';
  });
  c.querySelectorAll('input,select:not([data-k="shape"])').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const id = inp.dataset.id; const key = inp.dataset.k;
      const arr = state.settings.appsLinks = state.settings.appsLinks||[];
      const it = arr.find(x=>x.id===id); if(!it) return;
      it[key] = key==='icon' ? (inp.value || 'google') : inp.value.trim();
      afterStateChange();
      renderAppsGrid();
    });
  });
  c.querySelectorAll('select[data-k="shape"]').forEach(sel=>{
    const it = items.find(x=>x.id===sel.dataset.id); sel.value = it?.shape || 'rounded';
    sel.addEventListener('change', ()=>{
      const target = items.find(x=>x.id===sel.dataset.id); if(!target) return;
      target.shape = sel.value;
      afterStateChange();
      renderAppsGrid();
    });
  });
  c.querySelectorAll('button[data-act="refresh"]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const it = items.find(x=> x.id===btn.dataset.id); if(!it || !it.url) return;
      const next = faviconUrlFor(it.url);
      it.iconUrl = next || '';
      afterStateChange();
      renderAppsSettings();
      renderAppsGrid();
      showToast('Icona aggiornata ✅','success');
    });
  });
  c.querySelectorAll('button[data-id]:not([data-act])').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.settings.appsLinks = (state.settings.appsLinks||[]).filter(x=>x.id!==btn.dataset.id);
      afterStateChange();
      renderAppsSettings();
      renderAppsGrid();
    });
  });
}

// ==== FAVICON (no CORS): memorizziamo solo l'URL ====
// 1) URL Google S2 (nessun canvas, nessun fetch), 2) fallback /favicon.ico
function faviconUrlFor(siteUrl){
  try{
    const u = new URL(siteUrl);
    return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=64`;
  }catch(_){ return ''; }
}
function fallbackFaviconUrl(siteUrl){
  try{
    const u = new URL(siteUrl);
    return `${u.protocol}//${u.hostname}/favicon.ico`;
  }catch(_){ return ''; }
}
// Assicura iconUrl (non dataUrl); se google s2 fallisce in <img>, passiamo a /favicon.ico
async function ensureAppIcon(a){
  if(a.iconUrl) return a.iconUrl;
  const url = faviconUrlFor(a.url);
  a.iconUrl = url || '';
  // non salviamo immagini; salviamo solo la stringa URL (riduce lo stato)
  // NB: se l'img fallisce a runtime, lo cambiamo onerror (vedi render)
  afterStateChange({silentSave:true});
  return a.iconUrl;
}

function repParseRange(kind){
  const today = new Date().toISOString().slice(0,10);
  if(kind==='week')  return {from: addDaysISO(today,-7),  to: today};
  if(kind==='month') return {from: addDaysISO(today,-30), to: today};
  const f = byId('rep-from')?.value||today, t = byId('rep-to')?.value||today;
  return {from:f, to:t};
}
function inISORange(iso, r){ if(!iso) return false; const x=iso.slice(0,10); return x>=r.from && x<=r.to; }
function renderSiteList(){
  const list = state.sites || [];
  const q = (byId('si-search')?.value||'').toLowerCase();
  const f = byId('si-filter')?.value || '';
  const filtered = list.filter(s=>{
    const hit = s.name.toLowerCase().includes(q);
    const stOk = f ? s.status===f : true;
    return hit && stOk;
  });

  const fv  = filtered.filter(s=> s.category==='fv');
  const ele = filtered.filter(s=> s.category!=='fv');

  const tpl = (s)=> {
    const tix = (state.tickets||[]).filter(t=> t.siteId===s.id);
    const hours = tix.reduce((sum,t)=> sum + safeNum(t.hours), 0);
    const mats  = tix.reduce((sum,t)=> sum + safeNum(t.totalMaterialCost), 0);
    return `<div class="card" data-id="${s.id}" style="padding:.8rem; cursor:pointer; display:grid; grid-template-columns:1fr auto; gap:.25rem">
      <div>
        <div style="font-weight:800">${h(s.name)}</div>
        <div class="muted" style="font-size:.85rem">Ore prev.: ${fmtNum(s.estimatedHours||0)} · Ore lav.: ${fmtNum(hours)} · Mat.: ${formatCurrency(mats)}</div>
        ${(s.offerAmount? `<div class="muted" style="font-size:.85rem">Offerta: ${formatCurrency(s.offerAmount)}</div>`:'')}
      </div>
      <div style="text-align:right">
        <div class="site-badge ${s.status==='attivo'?'sb-active':'sb-ended'}">${s.status==='attivo'?'Attivo':'Terminato'}</div>
        <div style="margin-top:.25rem; display:flex; gap:.3rem; justify-content:flex-end">
          <button class="btn btn-ghost" onclick="editSite('${s.id}')">Modifica</button>
          <button class="btn btn-ghost" onclick="toggleSiteStatus('${s.id}')">${s.status==='attivo'?'Termina':'Riattiva'}</button>
          <button class="btn btn-ghost" onclick="deleteSite('${s.id}')">Elimina</button>
        </div>
      </div>
    </div>`;
  };

  const boxFV  = byId('si-list-fv');
  const boxELE = byId('si-list-ele');
  if (boxFV)  { boxFV.innerHTML  = fv.length  ? fv.map(tpl).join('')  : `<div class="empty">Nessun cantiere FV</div>`; bindSiteListClicks(boxFV); }
  if (boxELE) { boxELE.innerHTML = ele.length ? ele.map(tpl).join('') : `<div class="empty">Nessun cantiere Elettrico</div>`; bindSiteListClicks(boxELE); }

  const legacy = byId('si-list');
  if(legacy){ legacy.innerHTML = '<div class="muted">Consulta le liste per categoria qui sotto.</div>'; }

  renderSiteStats(filtered);
  renderPageRecap('cantieri');
}
function bindSiteListClicks(container){
  if(!container) return;
  container.querySelectorAll('[data-id]')?.forEach(el=>{
    el.addEventListener('click', (ev)=>{
      if(ev.target.closest('button')) return;
      const siteId = el.dataset.id;
      selectSite(siteId);
      openSiteModal(siteId);
    });
  });
}
function renderSiteStats(list){
  const c = byId('si-stats'); if(!c) return;

  const tixBySite = (id)=> (state.tickets||[]).filter(t=> t.siteId===id);
  const agg = (arr)=> {
    const tot = arr.length;
    const hoursPrev = arr.reduce((s,x)=> s + safeNum(x.estimatedHours), 0);
    const offerSum  = arr.reduce((s,x)=> s + safeNum(x.offerAmount), 0);
    const workedH   = arr.reduce((s,x)=> s + tixBySite(x.id).reduce((a,t)=> a + safeNum(t.hours),0), 0);
    const matsSum   = arr.reduce((s,x)=> s + tixBySite(x.id).reduce((a,t)=> a + safeNum(t.totalMaterialCost),0), 0);
    const active    = arr.filter(x=> x.status==='attivo').length;
    const ended     = arr.filter(x=> x.status==='terminato').length;
    return {tot, hoursPrev, offerSum, workedH, matsSum, active, ended};
  };

  const ALL = agg(list);
  const FV  = agg(list.filter(x=> x.category==='fv'));
  const ELE = agg(list.filter(x=> x.category!=='fv'));

  const pct = (num, den)=> den>0 ? (num/den*100).toFixed(1) : '0.0';

  c.innerHTML = `
    <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:1rem">
      <div class="kpi"><div class="label">Cantieri totali</div><div class="value">${ALL.tot}</div><div class="kpi-sub">Attivi ${ALL.active} · Terminati ${ALL.ended}</div></div>
      <div class="kpi"><div class="label">Fotovoltaico</div><div class="value">${FV.tot}</div><div class="kpi-sub">Attivi ${FV.active} · Terminati ${FV.ended}</div></div>
      <div class="kpi"><div class="label">Elettrico</div><div class="value">${ELE.tot}</div><div class="kpi-sub">Attivi ${ELE.active} · Terminati ${ELE.ended}</div></div>
    </div>
    <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem">
      <div class="card" style="padding:.8rem">
        <div class="muted">Ore preventivate (Tot/FV/ELE)</div>
        <div style="font-weight:800">${fmtNum(ALL.hoursPrev)} · ${fmtNum(FV.hoursPrev)} · ${fmtNum(ELE.hoursPrev)}</div>
      </div>
      <div class="card" style="padding:.8rem">
        <div class="muted">Ore lavorate (Tot/FV/ELE)</div>
        <div style="font-weight:800">${fmtNum(ALL.workedH)} · ${fmtNum(FV.workedH)} · ${fmtNum(ELE.workedH)}</div>
      </div>
      <div class="card" style="padding:.8rem">
        <div class="muted">Materiali (Tot/FV/ELE)</div>
        <div style="font-weight:800">${formatCurrency(ALL.matsSum)} · ${formatCurrency(FV.matsSum)} · ${formatCurrency(ELE.matsSum)}</div>
      </div>
    </div>
    <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem">
      <div class="card" style="padding:.8rem">
        <div class="muted">Importi offerta</div>
        <div style="font-weight:800">Tot: ${formatCurrency(ALL.offerSum)}</div>
        <div class="muted">FV: ${formatCurrency(FV.offerSum)} · ELE: ${formatCurrency(ELE.offerSum)}</div>
      </div>
      <div class="card" style="padding:.8rem">
        <div class="muted">Avanzamento medio ore</div>
        <div style="font-weight:800">${pct(ALL.workedH, ALL.hoursPrev)}%</div>
      </div>
      <div class="card" style="padding:.8rem">
        <div class="muted">Avanzamento medio (FV/ELE)</div>
        <div style="font-weight:800">${pct(FV.workedH, FV.hoursPrev)}% / ${pct(ELE.workedH, ELE.hoursPrev)}%</div>
      </div>
    </div>
  `;
}
function renderReports(){
  const todayISO = Dates.todayISO();
  const rngEl = byId('rep-range');
  const customFrom = byId('rep-from');
  const customTo = byId('rep-to');
  const mode = rngEl?.value || 'month';

  const isoStartOfMonth = (iso)=>{
    if(!iso) return todayISO;
    const d = new Date(iso+'T00:00:00Z');
    d.setUTCDate(1);
    return toISODate(new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)));
  };
  const isoEndOfMonth = (iso)=>{
    if(!iso) return todayISO;
    const d = new Date(iso+'T00:00:00Z');
    d.setUTCMonth(d.getUTCMonth()+1);
    d.setUTCDate(0);
    return toISODate(new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())));
  };

  let from = todayISO;
  let to = todayISO;
  switch(mode){
    case 'week':
      from = addDaysISO(todayISO, -6);
      break;
    case 'month':
      from = isoStartOfMonth(todayISO);
      break;
    case 'quarter':
      from = addMonthsClamp(todayISO, -2, 1);
      from = from.slice(0,7)+'-01';
      break;
    case 'custom':
      from = customFrom?.value || todayISO;
      to = customTo?.value || todayISO;
      break;
    default:
      from = todayISO;
  }
  if(mode!=='custom'){ to = todayISO; }
  if(from > to){ const tmp = from; from = to; to = tmp; }

  const r = {from, to};

  let selId = byId('rep-collab')?.value || '';
  if(!selId && state.collaborators?.length){ selId = state.collaborators[0].id; }

  const collabTickets = (state.tickets||[]).filter(t=>{
    if(!selId) return false;
    const ids = Array.isArray(t.collabIds) ? t.collabIds.filter(Boolean) : (t.collabId ? [t.collabId] : []);
    return ids.includes(selId) && inISORange(String(t.date||''), r);
  });
  const hours = collabTickets.reduce((s,t)=> s + safeNum(t.hours), 0);
  const mats  = collabTickets.reduce((s,t)=> s + safeNum(t.totalMaterialCost), 0);
  const cards = byId('rep-collab-cards');
  if(cards){
    const rate = getCollabCostRate(selId);
    const laborMinor = Money.toMinor(hours*rate);
    cards.innerHTML = `
      <div class="card" style="padding:1rem"><div class="muted">Ore totali</div><div style="font-weight:800;font-size:1.4rem">${fmtNum(hours)}</div></div>
      <div class="card" style="padding:1rem"><div class="muted">Costo ore</div><div style="font-weight:800;font-size:1.4rem">${Money.format(laborMinor)}</div></div>
      <div class="card" style="padding:1rem"><div class="muted">Materiali</div><div style="font-weight:800;font-size:1.4rem">${formatCurrency(mats)}</div></div>`;
  }

  const sel = byId('rep-collab');
  if(sel){
    const prev = sel.value;
    sel.innerHTML = (state.collaborators||[]).map(c=>`<option value="${c.id}">${h(c.name)}</option>`).join('');
    if(selId && sel.querySelector(`option[value="${selId}"]`)){
      sel.value = selId;
    } else if(prev && sel.querySelector(`option[value="${prev}"]`)){
      sel.value = prev;
      selId = prev;
    }
  }

  const bySite = new Map();
  (state.tickets||[]).forEach(t=>{
    if(!inISORange(String(t.date||''), r)) return;
    const k = t.siteId||'__';
    const x = bySite.get(k)||{hours:0, materials:0};
    x.hours += safeNum(t.hours); x.materials += safeNum(t.totalMaterialCost);
    bySite.set(k,x);
  });
  const list = [...bySite.entries()].sort((a,b)=> b[1].hours - a[1].hours).slice(0,6)
    .map(([siteId,v])=>{
      const s = state.sites.find(site=>site.id===siteId);
      return `<div class="card" style="padding:.8rem;display:flex;justify-content:space-between"><div><div style="font-weight:800">${h(s?.name||'N/D')}</div><div class="muted">${fmtNum(v.hours)} h • ${formatCurrency(v.materials)}</div></div></div>`;
    }).join('') || `<div class="muted">Nessun dato</div>`;
  const boxSites = byId('rep-sites-cards'); if(boxSites) boxSites.innerHTML = list;

  const paySum = (state.payments||[]).filter(p=> inISORange(String(p.date||''), r)).reduce((s,p)=> s+safeNum(p.amount),0);
  const expSum = (state.expenses||[]).filter(e=> inISORange(String(e.date||''), r)).reduce((s,e)=> s+safeNum(e.amount),0);
  const fin = byId('rep-finance-cards');
  if(fin){
    fin.innerHTML = `
      <div class="grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.75rem">
        <div class="card" style="padding:1rem"><div class="muted">Incassi</div><div style="font-weight:800;font-size:1.4rem">${formatCurrency(paySum)}</div></div>
        <div class="card" style="padding:1rem"><div class="muted">Spese</div><div style="font-weight:800;font-size:1.4rem">${formatCurrency(expSum)}</div></div>
        <div class="card" style="padding:1rem"><div class="muted">Margine (semplice)</div><div style="font-weight:800;font-size:1.4rem">${formatCurrency(paySum-expSum)}</div></div>
      </div>`;
  }
}

function toggleRepCustom(){ const x=byId('rep-custom'); if(!x) return; const rng=byId('rep-range'); x.style.display = (rng&&rng.value==='custom')?'grid':'none'; }
function setupReports(){
  toggleRepCustom();
  renderReports();
}

function setupAppsSettings(){
  const addBtn = byId('apps-add');
  const options = Object.keys(ICONS||{}).map(k=>`<option value="${h(k)}">${h(k)}</option>`).join('');
  if(addBtn){
    let iconSelect = byId('apps-new-icon');
    if(!iconSelect){
      iconSelect = document.createElement('select');
      iconSelect.id = 'apps-new-icon';
      iconSelect.style.minWidth = '120px';
      iconSelect.innerHTML = options;
      addBtn.insertAdjacentElement('beforebegin', iconSelect);
      iconSelect.value = 'google';
    } else {
      const prev = iconSelect.value;
      iconSelect.innerHTML = options;
      iconSelect.value = prev || 'google';
    }
  }
  if(addBtn && !addBtn.dataset.bound){
    addBtn.dataset.bound = '1';
    addBtn.addEventListener('click', ()=>{
      const icon = (byId('apps-new-icon')?.value || 'google');
      const labelEl = byId('apps-new-label');
      const urlEl   = byId('apps-new-url');
      const label = (labelEl?.value || '').trim();
      const url   = (urlEl?.value || '').trim();
      if(!label || !url) return showToast('Inserisci etichetta e URL','error');
      const arr = state.settings.appsLinks = state.settings.appsLinks||[];
      if(arr.length>=20) return showToast('Max 20 link','error');
  arr.push({id:id(), icon, label, url, iconUrl:'', shape:'rounded'});
      if(labelEl) labelEl.value='';
      if(urlEl) urlEl.value='';
      (async () => { 
        const it = arr[arr.length-1];
        await ensureAppIcon(it);
        if(!it.iconUrl) { it.shape = 'rounded'; }
        afterStateChange(); renderAppsSettings(); renderAppsGrid();
      })();
      showToast('Link aggiunto ✅','success');
    });
  }
  renderAppsSettings();
}

function openAppWebview(title, url){
  const overlay = byId('apps-webview');
  const titleEl = byId('apps-webview-title');
  const iframe = byId('apps-iframe');
  if(!overlay || !titleEl || !iframe){
    if(url) window.open(url, '_blank');
    return;
  }
  titleEl.textContent = title;
  iframe.src = url;
  overlay.classList.add('show');
}

(function bindAppsWebviewBack(){
  const back = byId('apps-webview-back');
  if(back && !back.dataset.bound){
    back.dataset.bound = '1';
    back.addEventListener('click', ()=>{
      const overlay = byId('apps-webview');
      const iframe = byId('apps-iframe');
      overlay?.classList.remove('show');
      if(iframe) iframe.src = 'about:blank';
      goTo('apps');
    });
  }
})();

/* ===========================================================
   OFFERTE
   =========================================================== */
function setupOffers(){
  const form = byId('offer-form');
  if(form && form.dataset.bound !== '1'){
    form.dataset.bound = '1';
    let editField = byId('of-edit-id');
    if(!editField){
      editField = document.createElement('input');
      editField.type = 'hidden';
      editField.id = 'of-edit-id';
      form.prepend(editField);
    }
    form.addEventListener('reset', ()=>{
      const box = byId('of-fasi'); if(box) box.innerHTML='';
      if(byId('of-cat')) byId('of-cat').value = 'ele';
      if(editField) editField.value = '';
    });
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const nome = byId('of-nome').value.trim();
      const cliente = byId('of-cliente').value.trim();
      const importo = safeNum(byId('of-importo').value);
      const probabilita = safeNum(byId('of-probabilita').value);
      const scadenza = byId('of-scadenza').value;
      const stato = byId('of-stato').value;
      const note = byId('of-note').value;
      const category = (byId('of-cat')?.value === 'fv') ? 'fv' : 'ele';
      const estHours = safeNum(byId('of-ore')?.value);

      const phases = [];
      let totalWeight = 0;
      document.querySelectorAll('#of-fasi .fase-row').forEach(r=>{
        const name = r.querySelector('.fase-name')?.value?.trim();
        const w = safeNum(r.querySelector('.fase-weight')?.value);
        if(name && w>0){ phases.push({id:id(), name, weight:w}); totalWeight += w; }
      });
      if (phases.length && totalWeight !== 100) {
        showToast(`Il peso delle fasi (Offerta) deve essere 100% (attuale: ${totalWeight}%)`,'error');
        return;
      }
      const editId = editField?.value?.trim() || '';
      const phaseRows = Array.from(document.querySelectorAll('#of-fasi .fase-row'));
      const phasesWithId = phases.map((p, idx)=>{
        const row = phaseRows[idx];
        const pid = row?.dataset?.pid || '';
        return { id: pid || p.id, name: p.name, weight: p.weight };
      });
      phaseRows.forEach((row, idx)=>{
        if(row) row.dataset.pid = phasesWithId[idx]?.id || '';
      });

      let nextSelectId = '';
      if(editId){
        const offer = state.offers.find(o=> o.id===editId);
        if(!offer){ showToast('Offerta non trovata','error'); return; }
        offer.nome = nome;
        offer.cliente = cliente;
        offer.importo = importo;
        offer.probabilita = probabilita;
        offer.scadenza = scadenza;
        offer.stato = stato;
        offer.note = note;
        offer.category = category;
        offer.estHours = estHours;
        offer.phases = phasesWithId;
        offer.updatedAt = new Date().toISOString();
        afterStateChange();
        showToast(`Offerta "${nome}" aggiornata ✅`,'success');
        nextSelectId = offer.id;
      }else{
        const newOffer = {
          id: id(),
          nome, cliente, importo, probabilita, scadenza, stato, note,
          category,
          estHours,
          phases: phasesWithId,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        state.offers.push(newOffer);
        afterStateChange();
        showToast(`Offerta "${nome}" creata ✅`,'success');
        nextSelectId = newOffer.id;
      }

      form.reset();
      const box = byId('of-fasi'); if(box) box.innerHTML='';
      if(byId('of-cat')) byId('of-cat').value = 'ele';
      if(editField) editField.value = '';
      renderOfferList();
      if(nextSelectId) selectOffer(nextSelectId);
    });
  }
  const addBtn = byId('btn-of-add-fase');
  if(addBtn && addBtn.dataset.bound !== '1'){
    addBtn.dataset.bound = '1';
    addBtn.addEventListener('click', ()=> addOfferFaseRow());
  }
  byId('of-search')?.addEventListener('input', debounce(renderOfferList,150));
  byId('of-filter')?.addEventListener('change', renderOfferList);
  renderOfferList();
}

function fillOfferForm(offer){
  if(!offer) return;
  const form = byId('offer-form');
  if(!form) return;
  const set = (id, value='')=>{ const el = byId(id); if(el) el.value = value; };
  const editField = byId('of-edit-id'); if(editField) editField.value = offer.id;
  set('of-nome', offer.nome||'');
  set('of-cliente', offer.cliente||'');
  set('of-importo', offer.importo||'');
  set('of-probabilita', offer.probabilita||'');
  set('of-scadenza', offer.scadenza||'');
  set('of-stato', offer.stato||'in_corso');
  set('of-note', offer.note||'');
  set('of-cat', offer.category||'ele');
  set('of-ore', offer.estHours||'');

  const box = byId('of-fasi');
  if(box){
    box.innerHTML='';
    (offer.phases || []).forEach(p=> addOfferFaseRow(p.name||'', p.weight||'', p.id));
  }
}
function renderOfferList(){
  const all = state.offers || [];
  const q = (byId('of-search')?.value||'').toLowerCase();
  const f = byId('of-filter')?.value || '';
  const filtered = all.filter(o=>{
    const hit = o.nome.toLowerCase().includes(q) || (o.cliente||'').toLowerCase().includes(q);
    const statusOk = f ? o.stato===f : true;
    return hit && statusOk;
  });

  const fv  = filtered.filter(o=> o.category==='fv');
  const ele = filtered.filter(o=> o.category!=='fv');

  const tpl = (o)=>`
    <div class="card" data-id="${o.id}" style="padding:.8rem; cursor:pointer">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div>
          <div style="font-weight:800">${h(o.nome)}</div>
          <div class="muted" style="font-size:.85rem">${h(o.cliente)||'—'} • ${formatCurrency(o.importo)}</div>
          ${o.estHours? `<div class="muted" style="font-size:.85rem">Ore prev.: ${fmtNum(o.estHours)}</div>`:''}
          ${o.note? `<div class="muted" style="font-size:.85rem; margin-top:.25rem">${h(o.note)}</div>`:''}
        </div>
        <div style="text-align:right">
          <div class="offer-badge ${getProbabilityClass(o.probabilita)}">${o.probabilita}%</div>
          <div class="muted" style="font-size:.75rem; margin-top:.25rem">${getStatoText(o.stato)}</div>
        </div>
      </div>
    </div>`;

  function bindOfferListClicks(container){
    if(!container) return;
    container.querySelectorAll('[data-id]')?.forEach(el=>{
      el.addEventListener('click', (ev)=>{
        if(ev.target.closest('button')) return;
        selectOffer(el.dataset.id);
        openOfferModal(el.dataset.id);
      });
    });
  }

  const boxFV  = byId('of-list-fv');
  const boxELE = byId('of-list-ele');

  if (boxFV)  { boxFV.innerHTML  = fv.length  ? fv.map(tpl).join('')  : `<div class="empty">Nessuna offerta FV</div>`;  bindOfferListClicks(boxFV); }
  if (boxELE) { boxELE.innerHTML = ele.length ? ele.map(tpl).join('') : `<div class="empty">Nessuna offerta Elettrica</div>`; bindOfferListClicks(boxELE); }

  const legacy = byId('of-list');
  if(legacy){ legacy.innerHTML = '<div class="muted">Consulta le liste per categoria qui sotto.'; }

  renderOfferStats(filtered);
  renderPageRecap('offers');
}
const getProbabilityClass = (p)=> p>=70?'ob-high':p>=40?'ob-medium':p>0?'ob-low':'ob-unknown';
const getStatoText = s=> ({in_corso:'In Corso', vinta:'Vinta', persa:'Persa', annullata:'Annullata'})[s]||s;
function selectOffer(id){
  ['of-list','of-list-fv','of-list-ele'].forEach(listId=>{
    document.querySelectorAll(`#${listId} [data-id]`)?.forEach(el=> el.classList.toggle('active', el.dataset.id===id));
  });
  showOfferDetail(id);
}
function renderOfferStats(list){
  const c = byId('of-stats'); if(!c) return;
  const sumImporto = list.reduce((s,o)=> s + safeNum(o.importo), 0);
  const sumHours   = list.reduce((s,o)=> s + safeNum(o.estHours), 0);

  const byCat = (cat)=> list.filter(o=> o.category===cat);
  const fv  = byCat('fv');
  const ele = byCat('ele');

  const stat = (arr)=>({
    n: arr.length,
    importo: arr.reduce((s,o)=> s + safeNum(o.importo), 0),
    hours:   arr.reduce((s,o)=> s + safeNum(o.estHours), 0),
    byStatus: {
      in_corso: arr.filter(o=>o.stato==='in_corso').length,
      vinta:    arr.filter(o=>o.stato==='vinta').length,
      persa:    arr.filter(o=>o.stato==='persa').length,
      annullata:arr.filter(o=>o.stato==='annullata').length
    }
  });

  const SALL = stat(list);
  const SFV  = stat(fv);
  const SELE = stat(ele);

  c.innerHTML = `
    <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:1rem">
      <div class="kpi"><div class="label">Totale offerte</div><div class="value">${SALL.n}</div><div class="kpi-sub">Importo: ${formatCurrency(SALL.importo)} · Ore prev.: ${fmtNum(SALL.hours)}</div></div>
      <div class="kpi"><div class="label">Fotovoltaico</div><div class="value">${SFV.n}</div><div class="kpi-sub">Importo: ${formatCurrency(SFV.importo)} · Ore prev.: ${fmtNum(SFV.hours)}</div></div>
      <div class="kpi"><div class="label">Elettrico</div><div class="value">${SELE.n}</div><div class="kpi-sub">Importo: ${formatCurrency(SELE.importo)} · Ore prev.: ${fmtNum(SELE.hours)}</div></div>
    </div>
    <div style="margin-top:.75rem;display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">
      ${['Totale','FV','Elettrico'].map((lbl,i)=>{
        const X = [SALL,SFV,SELE][i];
        return `<div class="card" style="padding:.8rem">
          <div class="muted" style="margin-bottom:.35rem">${lbl} per stato</div>
          <div class="pill">In corso: <b>${X.byStatus.in_corso}</b></div>
          <div class="pill">Vinte: <b>${X.byStatus.vinta}</b></div>
          <div class="pill">Perse: <b>${X.byStatus.persa}</b></div>
          <div class="pill">Annullate: <b>${X.byStatus.annullata}</b></div>
        </div>`;
      }).join('')}
    </div>`;
}
function renderOfferDetailHTML(o, {includeEditButton = true} = {}){
  if(!o) return `<div class="muted">Offerta non trovata.</div>`;
  const scadenza = o.scadenza ? new Date(o.scadenza).toLocaleDateString('it-CH') : '—';
  const probClass = getProbabilityClass(o.probabilita);
  const probLabel = o.probabilita>=70?'Alta':o.probabilita>=40?'Media':o.probabilita>0?'Bassa':'Sconosciuta';
  const phasesHtml = (o.phases && o.phases.length)
    ? `<div style="margin-top:.75rem">
        <h4 style="margin:0 0 .35rem">Fasi</h4>
        ${o.phases.map(p=> `<div class="muted" style="font-size:.85rem">${h(p.name||'—')} · ${safeNum(p.weight)}%</div>`).join('')}
      </div>`
    : '';
  return `
    <div class="detail-section">
      <h3 style="margin:0 0 .25rem">${h(o.nome)}</h3>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem">
        <div><span class="muted">Cliente:</span> <b>${h(o.cliente)||'—'}</b></div>
        <div><span class="muted">Importo:</span> <b>${formatCurrency(o.importo)}</b></div>
        <div><span class="muted">Probabilità:</span> <b>${o.probabilita}%</b> <span class="offer-badge ${probClass}" style="margin-left:.5rem">${probLabel}</span></div>
        <div><span class="muted">Scadenza:</span> <b>${scadenza}</b></div>
        <div><span class="muted">Stato:</span> <b>${getStatoText(o.stato)}</b></div>
      </div>
  ${o.note ? `<div style="margin-top:.5rem"><span class="muted">Note:</span> ${h(o.note)}</div>` : ''}
      ${phasesHtml}
      <div class="detail-actions" style="margin-top:1rem; display:flex; gap:.5rem; flex-wrap:wrap">
        ${includeEditButton ? `<button class="btn btn-primary" onclick='editOffer("${o.id}")'>Modifica</button>` : ''}
        <button class="btn ${o.stato==='in_corso'?'btn-success':'btn-ghost'}" onclick="changeOfferStatus('${o.id}', 'vinta')" ${o.stato!=='in_corso'?'disabled':''}>Segna come Vinta</button>
        <button class="btn ${o.stato==='in_corso'?'btn-danger':'btn-ghost'}" onclick="changeOfferStatus('${o.id}', 'persa')" ${o.stato!=='in_corso'?'disabled':''}>Segna come Persa</button>
        <button class="btn btn-ghost" onclick="archiveOffer('${o.id}')">Archivia</button>
        <button class="btn btn-ghost" onclick="deleteOffer('${o.id}')">Elimina</button>
        ${o.stato==='vinta'
          ? `<button class="btn btn-success" onclick="convertOfferToSite('${o.id}')">Trasforma in Cantiere</button>`
          : ''
        }
      </div>
    </div>`;
}

function showOfferDetail(id){
  const c = byId('offer-detail');
  if(!c){ return; }
  const offer = state.offers.find(x=> String(x.id)===String(id));
  c.innerHTML = offer ? renderOfferDetailHTML(offer) : `<div class="muted">Seleziona un'offerta.</div>`;
}
function closeOfferModalIfOpen(offerId){
  const modal = byId('edit-modal');
  if(!modal) return;
  if(!modal.classList.contains('show')) return;
  const target = modal.dataset.entityId;
  const type = modal.dataset.modalType;
  if(type === 'offer' && (!offerId || target === String(offerId))){
    if(typeof window.__floatingModalClose === 'function') window.__floatingModalClose();
    else modal.classList.remove('show');
  }
}
function refreshOfferModal(offerId){
  const modal = byId('edit-modal');
  if(!modal || !modal.classList.contains('show')) return;
  if(modal.dataset.modalType !== 'offer') return;
  const targetId = offerId || modal.dataset.entityId;
  if(!targetId){ return; }
  openOfferModal(targetId);
}
function openOfferModal(offerId){
  const offer = state.offers.find(x=> String(x.id)===String(offerId));
  if(!offer){ showToast('Offerta non trovata','error'); return; }
  const scadenza = offer.scadenza ? new Date(offer.scadenza).toLocaleDateString('it-CH') : '—';
  const updatedAt = offer.updatedAt ? new Date(offer.updatedAt).toLocaleDateString('it-CH') : '—';
  const createdAt = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString('it-CH') : '—';
  const probClass = getProbabilityClass(offer.probabilita);
  const probLabel = offer.probabilita>=70?'Alta':offer.probabilita>=40?'Media':offer.probabilita>0?'Bassa':'Sconosciuta';
  const phasesHtml = (offer.phases && offer.phases.length)
    ? `<div style="margin-top:1rem">
         <div class="muted" style="font-size:.85rem;margin-bottom:.35rem">Fasi preventivate</div>
         <div style="display:flex; flex-direction:column; gap:.35rem">
           ${offer.phases.map(p=> `<div class="pill">${h(p.name||'—')} · ${safeNum(p.weight)}%</div>`).join('')}
         </div>
       </div>`
    : `<div class="muted" style="margin-top:1rem">Nessuna fase definita</div>`;

  const detailHtml = `
    <div class="detail-section">
      <div class="detail-grid">
        <div><span class="muted">Nome</span><div style="font-weight:800">${h(offer.nome)}</div></div>
        <div><span class="muted">Cliente</span><div style="font-weight:800">${h(offer.cliente)||'—'}</div></div>
        <div><span class="muted">Importo</span><div style="font-weight:800">${formatCurrency(offer.importo)}</div></div>
        <div><span class="muted">Categoria</span><div style="font-weight:800">${offer.category==='fv'?'Fotovoltaico':'Elettrico'}</div></div>
        <div><span class="muted">Probabilità</span><div style="display:flex; gap:.35rem; align-items:center"><span style="font-weight:800">${offer.probabilita}%</span><span class="offer-badge ${probClass}">${probLabel}</span></div></div>
        <div><span class="muted">Scadenza</span><div style="font-weight:800">${scadenza}</div></div>
        <div><span class="muted">Ore preventivate</span><div style="font-weight:800">${fmtNum(offer.estHours||0)}</div></div>
        <div><span class="muted">Stato</span><div style="font-weight:800">${getStatoText(offer.stato)}</div></div>
      </div>
      ${offer.note ? `<div style="margin-top:1rem"><span class="muted">Note</span><div>${h(offer.note)}</div></div>` : ''}
      ${phasesHtml}
      <div class="detail-actions" style="margin-top:1.5rem; display:flex; gap:.5rem; flex-wrap:wrap">
        <button class="btn btn-primary" id="offer-edit-trigger">Modifica</button>
        <button class="btn ${offer.stato==='in_corso'?'btn-success':'btn-ghost'}" onclick="changeOfferStatus('${offer.id}','vinta')" ${offer.stato!=='in_corso'?'disabled':''}>Segna come Vinta</button>
        <button class="btn ${offer.stato==='in_corso'?'btn-danger':'btn-ghost'}" onclick="changeOfferStatus('${offer.id}','persa')" ${offer.stato!=='in_corso'?'disabled':''}>Segna come Persa</button>
        <button class="btn btn-ghost" onclick="archiveOffer('${offer.id}')">Archivia</button>
        <button class="btn btn-ghost" onclick="deleteOffer('${offer.id}')">Elimina</button>
        ${offer.stato==='vinta'? `<button class="btn btn-success" onclick="convertOfferToSite('${offer.id}')">Trasforma in Cantiere</button>` : ''}
      </div>
      <div class="muted" style="font-size:.75rem; margin-top:1rem">Creata il ${createdAt} · Aggiornata il ${updatedAt}</div>
    </div>`;

  const wrapperHtml = `
    <div class="modal-sections">
      <div id="offer-detail-modal">${detailHtml}</div>
      <div id="offer-edit-wrap" style="display:none"></div>
    </div>`;

  const {body, close} = openFloatingModal(`Offerta · ${h(offer.nome)}`, wrapperHtml);
  const modal = byId('edit-modal');
  if(modal){
    modal.dataset.modalType = 'offer';
    modal.dataset.entityId = String(offer.id);
  }
  window.__modalAfterClose = ()=>{
    renderOfferList();
    selectOffer(offer.id);
  };

  if(!body) return;

  const editBtn = body.querySelector('#offer-edit-trigger');
  if(editBtn){
    editBtn.addEventListener('click', ()=>{
      const detailBox = body.querySelector('#offer-detail-modal');
      const editBox = body.querySelector('#offer-edit-wrap');
      const form = byId('offer-form');
      if(!detailBox || !editBox || !form) return;
      if(editBox.dataset.editing === '1') return;

      detailBox.style.display = 'none';
      editBox.style.display = 'block';
      editBox.dataset.editing = '1';
      goTo('offers');
      fillOfferForm(offer);

      const card = form.closest('.card') || form;
      if(!card || !card.parentElement) return;
      const host = card.parentElement;
      const placeholder = document.createElement('div');
      placeholder.style.display = 'none';
      host.insertBefore(placeholder, card);

      const onSubmit = ()=>{
        setTimeout(()=>{
          if(typeof close === 'function') close();
        }, 30);
        form.removeEventListener('submit', onSubmit);
      };

      window.__modalReturn = {
        node: card,
        host,
        placeholder,
        restore(){
          try{
            form.removeEventListener('submit', onSubmit);
            if(placeholder.parentNode){ host.replaceChild(card, placeholder); }
            placeholder.remove();
            delete editBox.dataset.editing;
            detailBox.style.display = '';
            editBox.style.display = 'none';
            form.reset();
            const faseBox = byId('of-fasi'); if(faseBox) faseBox.innerHTML='';
            const editId = byId('of-edit-id'); if(editId) editId.value='';
          }catch(err){ console.error('Ripristino form offerta fallito', err); }
          window.__modalReturn = null;
        }
      };

      editBox.appendChild(card);
      form.addEventListener('submit', onSubmit);
    });
  }
}
window.editOffer = (id)=>{
  const offer = state.offers.find(x=> String(x.id)===String(id));
  if(!offer){ showToast('Offerta non trovata','error'); return; }
  openOfferModal(offer.id);
  setTimeout(()=>{ byId('offer-edit-trigger')?.click(); }, 50);
};
window.changeOfferStatus = (id, st)=>{
  const offer = state.offers.find(x=> String(x.id)===String(id));
  if(!offer) return;
  offer.stato = st;
  offer.updatedAt = new Date().toISOString();
  afterStateChange();
  renderOfferList();
  selectOffer(offer.id);
  refreshOfferModal(offer.id);
  showToast(`Offerta ${st==='vinta'?'vinta':'persa'}`,'success');
};
window.deleteOffer = (id)=>{
  if(!confirm('Eliminare l\'offerta selezionata?')) return;
  state.offers = state.offers.filter(o=> String(o.id)!==String(id));
  afterStateChange();
  renderOfferList();
  byId('offer-detail').innerHTML='<div class="muted">Seleziona un\'offerta.</div>';
  closeOfferModalIfOpen(id);
  showToast('Offerta eliminata','success');
};
window.archiveOffer = (id)=>{
  const offer = state.offers.find(x=> String(x.id)===String(id));
  if(!offer) return;
  if(!confirm('Archiviare l\'offerta selezionata?')) return;
  archiveItem('offers', offer);
  state.offers = state.offers.filter(o=> String(o.id)!==String(id));
  afterStateChange();
  renderOfferList();
  byId('offer-detail').innerHTML='<div class="muted">Seleziona un\'offerta.</div>';
  closeOfferModalIfOpen(id);
  if(window.currentRoute==='archive'){
    const active = document.querySelector('#page-archive [data-ar].active')?.getAttribute('data-ar') || 'offers';
    renderArchive(active);
  }
  showToast('Offerta archiviata','success');
};
window.convertOfferToSite = (offerId)=>{
  const o = (state.offers||[]).find(x=> String(x.id)===String(offerId));
  if(!o){ showToast('Offerta non trovata','error'); return; }

  const name = o.nome || `Da offerta ${o.id}`;
  const category = (o.category === 'fv') ? 'fv' : 'ele';
  const estimatedHours = safeNum(o.estHours);
  const offerAmount = safeNum(o.importo);
  const materialBudget = 0;
  const note = `Derivato da offerta: ${o.nome}${o.cliente?(' — '+o.cliente):''}`;
  const phases = (o.phases||[]).map(p => ({ id:id(), name:p.name, weight:safeNum(p.weight) }));

  let totalWeight = phases.reduce((s,p)=> s + safeNum(p.weight), 0);
  if (phases.length && totalWeight !== 100) {
    showToast(`Fasi offerta non al 100% (${totalWeight}%). Correggo automaticamente.`, 'warn');
    phases.forEach(p => p.weight = Math.round((safeNum(p.weight)/Math.max(1,totalWeight))*100));
    totalWeight = phases.reduce((s,p)=> s + safeNum(p.weight), 0);
    const diff = 100 - totalWeight;
    if (diff!==0 && phases.length){ phases[0].weight = safeNum(phases[0].weight) + diff; }
  }

  const payload = {
    id: id(),
    name,
    category,
    estimatedHours,
    offerAmount,
    materialBudget,
    phases,
    note,
    status: 'attivo',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  state.sites = Array.isArray(state.sites) ? state.sites : [];
  state.sites.push(payload);

  o.stato = 'vinta';
  o.updatedAt = new Date().toISOString();

  afterStateChange();
  renderSiteList();
  updateSitesDropdown();
  renderOfferList();
  selectOffer(o.id);
  closeOfferModalIfOpen(o.id);
  showToast('Cantiere creato dall’offerta ✅', 'success');
  goTo('cantieri');
  selectSite(payload.id);
};

/* ===================== PREVISIONI ===================== */

function setupForecast(){
  const dateInput = byId('fc-date');
  if(dateInput && !dateInput.value) dateInput.value = Dates.todayISO();

  const form = byId('fc-form');
  if(form && form.dataset.bound!=='1'){
    form.dataset.bound = '1';
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const type   = byId('fc-type').value;
      const date   = byId('fc-date').value;
      const amount = safeNum(byId('fc-amount').value);
      const label  = (byId('fc-label').value || '').trim();
      const note   = (byId('fc-note').value   || '').trim();

      if(!date || amount<=0) { showToast('Compila data e importo validi','error'); return; }

      const item = { id:id(), date, amount, label, note, status:'planned', createdAt:new Date().toISOString() };

      if(type==='income')  state.forecast.incomes.push(item);
      else                 state.forecast.expenses.push(item);

      afterStateChange();
      e.target.reset();
      const d = byId('fc-date'); if(d) d.value = Dates.todayISO();

      renderForecastLists();
      renderForecastChart();
      renderForecastSummary();
      showToast(`${type==='income'?'Incasso':'Spesa'} previsto aggiunto ✅`, 'success');
    });
  }

  renderForecastLists();
  renderForecastChart();
  renderForecastSummary();
}

function renderForecastLists(){
  const mkRow = (it, kind)=>`
    <div class="card" style="padding:.6rem; display:grid; grid-template-columns:1fr auto; gap:.35rem" data-id="${it.id}" data-kind="${kind}">
      <div>
        <div style="font-weight:800">${h(it.label|| (kind==='income'?'Incasso previsto':'Spesa prevista'))}</div>
        <div class="muted" style="font-size:.85rem">${it.date} · ${h(it.note||'')}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${formatCurrency(it.amount)}</div>
        <div class="muted" style="font-size:.8rem">${it.status==='done'?'✓ fatto':'previsto'}</div>
        <div style="margin-top:.25rem; display:flex; gap:.3rem; justify-content:flex-end">
          <label class="pill" style="cursor:pointer"><input type="checkbox" class="fc-done" ${it.status==='done'?'checked':''}> ${kind==='income'?'Incassato':'Pagata'}</label>
          <button class="btn btn-ghost fc-edit">Modifica</button>
          <button class="btn btn-ghost fc-del">Elimina</button>
        </div>
      </div>
    </div>`;

  const inBox = byId('fc-list-in');
  const exBox = byId('fc-list-ex');
  const incomes  = (state.forecast.incomes || []).slice().sort((a,b)=> String(a.date).localeCompare(String(b.date)));
  const expenses = (state.forecast.expenses|| []).slice().sort((a,b)=> String(a.date).localeCompare(String(b.date)));

  if(inBox) inBox.innerHTML = incomes.length ? incomes.map(x=> mkRow(x,'income')).join('') : `<div class="empty">Nessun incasso previsto</div>`;
  if(exBox) exBox.innerHTML = expenses.length ? expenses.map(x=> mkRow(x,'expense')).join('') : `<div class="empty">Nessuna spesa prevista</div>`;

  function bind(container){
    container.querySelectorAll('[data-id]')?.forEach(card=>{
      const id   = card.getAttribute('data-id');
      const kind = card.getAttribute('data-kind');

      card.querySelector('.fc-done')?.addEventListener('change', (e)=>{
        const arr = kind==='income' ? state.forecast.incomes : state.forecast.expenses;
        const it = arr.find(x=> x.id===id); if(!it) return;
        it.status = e.target.checked ? 'done' : 'planned';
        it.updatedAt = new Date().toISOString();
        afterStateChange();
        renderForecastLists();
        renderForecastChart();
        renderForecastSummary();
      });

      card.querySelector('.fc-edit')?.addEventListener('click', ()=>{
        const arr = kind==='income' ? state.forecast.incomes : state.forecast.expenses;
        const it = arr.find(x=> x.id===id); if(!it) return;
        const html = `
          <form id="fc-edit-form" class="row two">
            <div><label>Data</label><input name="date" type="date" value="${it.date}" required></div>
            <div><label>Importo</label><input name="amount" type="number" step="0.01" min="0" value="${it.amount}" required></div>
            <div style="grid-column:1/-1"><label>Etichetta</label><input name="label" value="${h(it.label||'')}"></div>
            <div style="grid-column:1/-1"><label>Note</label><input name="note" value="${h(it.note||'')}"></div>
            <div style="grid-column:1/-1; display:flex; gap:.5rem">
              <button class="btn btn-primary" type="submit">Salva</button>
              <button class="btn btn-ghost" type="button" id="fc-edit-cancel">Annulla</button>
            </div>
          </form>`;
        openModal(`${kind==='income'?'Incasso':'Spesa'} previsto`, html);
        byId('fc-edit-cancel')?.addEventListener('click', ()=> byId('edit-modal')?.classList.remove('show'));
        byId('fc-edit-form')?.addEventListener('submit', ev=>{
          ev.preventDefault();
          it.date   = ev.target.date.value;
          it.amount = safeNum(ev.target.amount.value);
          it.label  = (ev.target.label.value||'').trim();
          it.note   = (ev.target.note.value||'').trim();
          it.updatedAt = new Date().toISOString();
          afterStateChange();
          byId('edit-modal')?.classList.remove('show');
          renderForecastLists();
          renderForecastChart();
          renderForecastSummary();
          showToast('Voce aggiornata ✅','success');
        });
      });

      card.querySelector('.fc-del')?.addEventListener('click', ()=>{
        if(!confirm('Eliminare questa voce?')) return;
        if(kind==='income'){
          state.forecast.incomes = state.forecast.incomes.filter(x=> x.id!==id);
        }else{
          state.forecast.expenses = state.forecast.expenses.filter(x=> x.id!==id);
        }
        afterStateChange();
        renderForecastLists();
        renderForecastChart();
        renderForecastSummary();
        showToast('Voce eliminata ✅','success');
      });
    });
  }

  if(inBox) bind(inBox);
  if(exBox) bind(exBox);
  renderForecastSummary();
}

function renderForecastChart(){
  const cvs = byId('fc-chart'); if(!cvs) return;

  // 12 mesi dell'anno corrente
  const months = monthsOfCurrentYear();
  const year = months[0].y;

  // map per sommare importi per mese/anno
  const sumByYM = (arr)=> {
    const m = new Map();
    arr.forEach(x=>{
      const d = new Date((x.date||'')+'T00:00:00');
      if(isNaN(+d) || d.getFullYear()!==year) return;
      const key = `${d.getFullYear()}-${d.getMonth()}`;
      m.set(key, (m.get(key)||0) + safeNum(x.amount));
    });
    return m;
  };

  const inMap = sumByYM(state.forecast?.incomes || []);
  const exMap = sumByYM(state.forecast?.expenses || []);

  const revenues = months.map(m => inMap.get(`${m.y}-${m.m}`) || 0);
  const costs    = months.map(m => exMap.get(`${m.y}-${m.m}`) || 0);

  // disegna con assi e salviamo gli hitbox
  drawBarsWithAxes(cvs, revenues, costs, months.map(m=> m.label), {
    yLabelFmt: v => new Intl.NumberFormat('it-CH', { style:'currency', currency: state.settings.currency||'CHF' }).format(v)
  });

  // bind click una sola volta
  if(!cvs._fcClickBound){
    cvs.addEventListener('click', (ev)=>{
      const rect = cvs.getBoundingClientRect();
      const x = (ev.clientX - rect.left) * (cvs.width / rect.width) / (window.devicePixelRatio||1);
      const y = (ev.clientY - rect.top)  * (cvs.height/ rect.height)/ (window.devicePixelRatio||1);

      const hits = cvs._fcHits || [];
      const hit = hits.find(h => x>=h.x && x<=h.x+h.w && y>=h.y && y<=h.y+h.h);
      if(!hit) return;

      // mese cliccato
  const m = months[hit.idx];

      // filtra voci forecast di quel mese
      const inItems = (state.forecast?.incomes||[]).filter(it=>{
        const d = new Date((it.date||'')+'T00:00:00');
        return !isNaN(+d) && d.getFullYear()===m.y && d.getMonth()===m.m;
      });
      const exItems = (state.forecast?.expenses||[]).filter(it=>{
        const d = new Date((it.date||'')+'T00:00:00');
        return !isNaN(+d) && d.getFullYear()===m.y && d.getMonth()===m.m;
      });

      const fmt = (n)=> new Intl.NumberFormat('it-CH',{style:'currency',currency:state.settings.currency||'CHF'}).format(n);
      const sum = (a)=> a.reduce((s,x)=> s + safeNum(x.amount), 0);

      const mkList = (items, labDone, labPln) => items.length
        ? `<table class="tbl" style="margin:.35rem 0">
            <thead><tr><th>Data</th><th>Voce</th><th class="right">Importo</th><th>Stato</th></tr></thead>
            <tbody>
            ${items.map(it => `
              <tr>
                <td>${it.date||''}</td>
                <td>${h(it.label||'—')}</td>
                <td class="right">${fmt(it.amount)}</td>
                <td>${it.status==='done' ? labDone : labPln}</td>
              </tr>`).join('')}
            </tbody>
          </table>`
        : `<div class="muted">Nessuna voce</div>`;

      const html = `
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem">
          <section>
            <h3 style="margin:.2rem 0">Incassi previsti</h3>
            <div class="muted">Totale mese: <b>${fmt(sum(inItems))}</b></div>
            ${mkList(inItems, 'Incassato', 'Previsto')}
          </section>
          <section>
            <h3 style="margin:.2rem 0">Spese previste</h3>
            <div class="muted">Totale mese: <b>${fmt(sum(exItems))}</b></div>
            ${mkList(exItems, 'Pagata', 'Prevista')}
          </section>
        </div>
      `;
      openModal(`Dettagli • ${new Date(m.y, m.m, 1).toLocaleDateString('it-CH', { month:'long', year:'numeric' })}`, html);
    });
    cvs._fcClickBound = true;
  }
}

function renderForecastSummary(){
  const curYear = new Date().getFullYear();
  const fmt = (n)=> new Intl.NumberFormat('it-CH',{style:'currency', currency: state?.settings?.currency || 'CHF'}).format(Number(n)||0);

  const incs = Array.isArray(state?.forecast?.incomes) ? state.forecast.incomes : [];
  const exps = Array.isArray(state?.forecast?.expenses) ? state.forecast.expenses : [];

  const inYear = (x)=> {
    const d = new Date(String(x?.date||'')+'T00:00:00');
    return !isNaN(+d) && d.getFullYear() === curYear;
  };

  const sum = (arr, status)=> arr
    .filter(inYear)
    .filter(x => status ? String(x.status)==='done' : String(x.status)!=='done')
    .reduce((s, x)=> s + (Number(x.amount)||0), 0);

  const incPlanned = sum(incs, false);
  const incDone    = sum(incs, true);
  const expPlanned = sum(exps, false);
  const expDone    = sum(exps, true);

  const netForecast = incPlanned - expPlanned;
  const netDone     = incDone    - expDone;

  const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = fmt(val); };

  set('fc-sum-inc-planned', incPlanned);
  set('fc-sum-inc-done',    incDone);
  set('fc-sum-exp-planned', expPlanned);
  set('fc-sum-exp-done',    expDone);
  set('fc-sum-net-forecast',netForecast);
  set('fc-sum-net-done',    netDone);
}

/* ===========================================================
   CANTIERI (create/edit) + AVANZAMENTO - IMPROVED PERCENTAGES
   =========================================================== */
function setupSites(){
  const btnAdd = byId('btn-add-fase');
  if(btnAdd && btnAdd.dataset.bound!=='1'){
    btnAdd.dataset.bound = '1';
    btnAdd.addEventListener('click', ()=> addFaseRow());
  }

  const form = byId('site-form');
  if(form && form.dataset.bound!=='1'){
    form.dataset.bound = '1';
    form.addEventListener('reset', ()=>{
      byId('si-edit-id').value='';
      byId('si-fasi').innerHTML='';
      if(byId('si-cat')) byId('si-cat').value='ele';
    });
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const editId = byId('si-edit-id').value || null;

      const name = byId('si-nome').value.trim();
      const estimatedHours = safeNum(byId('si-est').value);
      const offerAmount = safeNum(byId('si-offer').value);
      const materialBudget = safeNum(byId('si-mat-budget').value);
      const note = byId('si-note').value;

      const phases=[]; let totalWeight=0;
      document.querySelectorAll('#si-fasi .fase-row').forEach(r=>{
        const n = r.querySelector('.fase-name').value.trim();
        const w = safeNum(r.querySelector('.fase-weight').value);
        if(n && w>0){
          const existingPid = r.dataset.pid || '';
          phases.push({ id: existingPid || id(), name:n, weight:w });
          totalWeight += w;
        }
      });

      if(phases.length && totalWeight!==100){
        showToast(`Il peso delle fasi deve essere 100% (attuale: ${totalWeight}%)`,'error');
        return;
      }

      if(editId){
        const idx = state.sites.findIndex(s=> s.id===editId);
        if(idx>-1){
          const prev = state.sites[idx];

          const prevIds = new Set((prev.phases||[]).map(p=> p.id));
          const newIds  = new Set(phases.map(p=> p.id));
          const removed = [...prevIds].filter(pid=> !newIds.has(pid));

          const payload = {
            ...prev,
            name,
            estimatedHours,
            offerAmount,
            materialBudget,
            note,
            category: byId('si-cat') ? (byId('si-cat').value || prev.category) : prev.category,
            phases,
            updatedAt:new Date().toISOString()
          };

          state.sites[idx] = payload;

          if(removed.length){
            reconcileTicketsForRemovedPhases(editId, removed, prev);
          }

          afterStateChange();
          showToast(`Cantiere "${name}" aggiornato ✅`,'success');
        }
      } else {
        const payload = {
          id: id(),
          name,
          estimatedHours,
          offerAmount,
          materialBudget,
          phases,
          note,
          category: byId('si-cat') ? byId('si-cat').value : 'ele',
          status:'attivo',
          createdAt:new Date().toISOString(),
          updatedAt:new Date().toISOString()
        };
        state.sites.push(payload);
        afterStateChange();
        showToast(`Cantiere "${name}" creato ✅`,'success');
      }

      form.reset();
      byId('si-fasi').innerHTML='';
      byId('si-edit-id').value='';
      if(byId('si-cat')) byId('si-cat').value='ele';
      renderSiteList();
      updateSitesDropdown();
    });
  }
  byId('si-search')?.addEventListener('input', debounce(renderSiteList,150));
  byId('si-filter')?.addEventListener('change', renderSiteList);
  renderSiteList();
}
function fillSiteForm(site){
  if(!site) return;
  const set = (id, value='')=>{ const el = byId(id); if(el) el.value = value; };
  set('si-edit-id', site.id || '');
  set('si-nome', site.name || '');
  set('si-est', site.estimatedHours || '');
  set('si-offer', site.offerAmount || '');
  set('si-mat-budget', site.materialBudget || '');
  set('si-note', site.note || '');
  const cat = byId('si-cat'); if(cat) cat.value = site.category || 'ele';
  const box = byId('si-fasi');
  if(box){
    box.innerHTML = '';
    (site.phases || []).forEach(p=> addFaseRow(p.name || '', p.weight || '', p.id));
  }
}
function openSiteEditorInModal(siteId){
  goTo('cantieri');
  const site = state.sites.find(x=> String(x.id)===String(siteId));
  if(site){ fillSiteForm(site); }
  if(site) selectSite(String(siteId));
  const form = byId('site-form');
  if(!form) return;

  const card = form.closest('.card') || form;
  const host = card?.parentElement;
  if(!host){ return; }

  const placeholder = document.createElement('div');
  placeholder.style.display = 'none';
  host.insertBefore(placeholder, card);

  const ctx = openFloatingModal(`Modifica cantiere • ${h(site?.name || '')}`, '');
  const body = ctx?.body;
  const close = ctx?.close;
  if(!body){
    if(placeholder.parentNode){ host.replaceChild(card, placeholder); }
    placeholder.remove();
    return;
  }

  const onSubmitOnce = ()=>{
    setTimeout(()=>{
      window.__modalAfterClose = ()=>{
        renderSiteList();
        selectSite(String(siteId));
        openSiteModal(String(siteId));
      };
      if(typeof close === 'function') close();
    }, 0);
    form.removeEventListener('submit', onSubmitOnce);
  };

  window.__modalReturn = {
    node: card,
    host,
    placeholder,
    restore(){
      try{
        form.removeEventListener('submit', onSubmitOnce);
        if(placeholder.parentNode){ host.replaceChild(card, placeholder); }
        placeholder.remove();
        const editId = byId('si-edit-id'); if(editId) editId.value='';
      }catch(err){ console.error('Ripristino form cantiere fallito', err); }
      window.__modalReturn = null;
    }
  };

  window.__modalAfterClose = ()=>{
    renderSiteList();
    selectSite(String(siteId));
  };

  body.appendChild(card);
  body.scrollTop = 0;
  form.addEventListener('submit', onSubmitOnce);
}
function openTicketEditorInModal(ticketId, opts = {}){
  const ticket = (state.tickets||[]).find(x=> String(x.id)===String(ticketId));
  if(!ticket){ showToast('Ticket non trovato','error'); return; }

  const afterClose = typeof opts.afterClose === 'function' ? opts.afterClose : null;

  goTo('ticket');
  if(typeof editTicket === 'function'){
    editTicket(String(ticketId));
  }

  const formEl = byId('ticket-form');
  if(!formEl) return;
  const card = formEl.closest('.card') || formEl;
  const host = card?.parentElement;
  if(!host) return;

  const placeholder = document.createElement('div');
  placeholder.style.display = 'none';
  host.insertBefore(placeholder, card);

  const ctx = openFloatingModal(`Modifica ticket • ${ticket.date ? new Date(ticket.date).toLocaleDateString('it-CH') : ''}`, '');
  const body = ctx?.body;
  const close = ctx?.close;
  if(!body){
    if(placeholder.parentNode){ host.replaceChild(card, placeholder); }
    placeholder.remove();
    return;
  }

  const baseAfterClose = ()=>{
    renderLastTickets();
    renderTicketCalendarMonth();
  };

  const assignAfterClose = (handler)=>{ window.__modalAfterClose = handler; };

  const onSubmitOnce = ()=>{
    setTimeout(()=>{
      assignAfterClose(()=>{
        baseAfterClose();
        if(afterClose) afterClose();
      });
      if(typeof close === 'function') close();
    }, 0);
    formEl.removeEventListener('submit', onSubmitOnce);
  };

  window.__modalReturn = {
    node: card,
    host,
    placeholder,
    restore(){
      try{
        formEl.removeEventListener('submit', onSubmitOnce);
        if(placeholder.parentNode){ host.replaceChild(card, placeholder); }
        placeholder.remove();
        const editField = byId('ti-edit-id'); if(editField) editField.value='';
      }catch(err){ console.error('Ripristino form ticket fallito', err); }
      window.__modalReturn = null;
    }
  };

  assignAfterClose(()=>{
    baseAfterClose();
    if(afterClose) afterClose();
  });

  body.appendChild(card);
  body.scrollTop = 0;

  const siteSel = byId('ti-site');
  if(siteSel && !String(ticket.siteId||'').startsWith('manual-')){
    siteSel.value = ticket.siteId || '';
    const site = (state.sites||[]).find(s=> s.id===ticket.siteId);
    if(site){
      populatePhases(site);
      const phSel = byId('ti-phase'); if(phSel) phSel.value = ticket.phaseId || '';
    }
  }

  formEl.addEventListener('submit', onSubmitOnce);
}
function addFaseRow(name='', weight='', pid=''){
  const t = byId('tpl-fase'); const c = byId('si-fasi'); if(!t||!c) return;
  const clone = t.content.cloneNode(true);
  const row = clone.querySelector('.fase-row');
  row.dataset.pid = pid ? String(pid) : '';
  row.querySelector('.fase-name').value = name;
  row.querySelector('.fase-weight').value = weight;
  row.querySelector('.remove-btn').addEventListener('click', e=> e.target.closest('.fase-row').remove());
  c.appendChild(clone);
}
function addOfferFaseRow(name='', weight='', pid=''){
  const t = byId('tpl-fase'); const c = byId('of-fasi'); if(!t||!c) return;
  const clone = t.content.cloneNode(true);
  const row = clone.querySelector('.fase-row');
  if(!row) return;
  row.dataset.pid = pid ? String(pid) : '';
  row.querySelector('.fase-name').value = name;
  row.querySelector('.fase-weight').value = weight;
  row.querySelector('.remove-btn').addEventListener('click', e=> e.target.closest('.fase-row').remove());
  c.appendChild(clone);
}
/* ===== MODAL GENERICO ===== */
function openModal(title, html){
  const modal = document.getElementById('edit-modal');
  if(!modal) return;
  modal.querySelector('#edit-modal-title').textContent = title || 'Dettagli';
  modal.querySelector('#edit-modal-body').innerHTML = html || '';
  modal.classList.add('show');
}
window.__floatingModalClose = null;
window.__modalReturn = null;
window.__modalAfterClose = null;
function openFloatingModal(title, html){
  const modal = byId('edit-modal');
  const modalTitle = byId('edit-modal-title');
  const body = byId('edit-modal-body');
  if(!modal || !modalTitle || !body) return {body:null, close:()=>{}, modal:null};

  if(typeof window.__floatingModalClose === 'function'){
    window.__floatingModalClose();
  }

  modalTitle.textContent = title || 'Dettagli';
  body.innerHTML = html || '';
  modal.dataset.modalType = modal.dataset.modalType || '';
  modal.dataset.entityId = modal.dataset.entityId || '';
  modal.classList.add('shown');
  modal.classList.add('show');

  const close = ()=>{
    if(window.__modalReturn && typeof window.__modalReturn.restore === 'function'){
      try{ window.__modalReturn.restore(); }
      catch(err){ console.error('Errore durante il ripristino del contenuto modal', err); }
      window.__modalReturn = null;
    }
    body.innerHTML = '';
    modal.classList.remove('show');
    modal.classList.remove('shown');
    delete modal.dataset.modalType;
    delete modal.dataset.entityId;
    modal.removeEventListener('click', onBackdrop);
    if(closeBtn) closeBtn.onclick = null;
    const hook = window.__modalAfterClose;
    window.__modalAfterClose = null;
    window.__floatingModalClose = null;
    if(typeof hook === 'function'){
      try{ hook(); }
      catch(err){ console.error('Errore nel post-close modal', err); }
    }
  };

  const closeBtn = byId('close-edit-modal');
  const onBackdrop = (ev)=>{ if(ev.target === modal){ close(); } };
  modal.addEventListener('click', onBackdrop);
  if(closeBtn){ closeBtn.onclick = ()=> close(); }

  window.__floatingModalClose = close;
  window.__modalAfterClose = null;

  return {body, close, modal};
}
document.getElementById('close-edit-modal')?.addEventListener('click', ()=> {
  if(typeof window.__floatingModalClose === 'function'){
    window.__floatingModalClose();
  } else {
    document.getElementById('edit-modal')?.classList.remove('show');
  }
});

/* ===== FORM CANTIERE IN MODAL ===== */
window.editSite = (siteId)=>{
  openSiteEditorInModal(String(siteId));
};
function selectSite(siteId){
  ['#si-list', '#si-list-fv', '#si-list-ele'].forEach(sel=>{
    document.querySelectorAll(`${sel} [data-id]`)?.forEach(el=> el.classList.toggle('active', el.dataset.id===siteId));
  });
  showSiteDetail(siteId);
}
function sitePhaseProgressCalc(site){
  const tickets = state.tickets.filter(t=> t.siteId===site.id);
  const hoursByPhase = new Map();
  const matByPhase = new Map();
  tickets.forEach(t=>{
    const h = safeNum(t.hours); const m = safeNum(t.totalMaterialCost);
    const key = t.phaseId || '__no_phase__';
    hoursByPhase.set(key, (hoursByPhase.get(key)||0)+h);
    matByPhase.set(key, (matByPhase.get(key)||0)+m);
  });
  return {hoursByPhase, matByPhase};
}
function showSiteDetail(siteId){
  const c = byId('site-detail'); const s = state.sites.find(x=>x.id===siteId); if(!c || !s){ c.innerHTML = `<div class="muted">Seleziona un cantiere.</div>`; return; }
  const tix = state.tickets.filter(t=> t.siteId===siteId);
  const hoursUsed = tix.reduce((sum,t)=> sum + safeNum(t.hours), 0);
  const materialsUsed = tix.reduce((sum,t)=> sum + safeNum(t.totalMaterialCost), 0);
  
  // IMPROVED: Calculate percentages accurately without capping at 100%
  const hoursProgress = s.estimatedHours>0 ? (hoursUsed/s.estimatedHours)*100 : 0;
  const materialProgress = s.materialBudget>0 ? (materialsUsed/s.materialBudget)*100 : 0;

  const {hoursByPhase, matByPhase} = sitePhaseProgressCalc(s);
  const phasesHtml = (s.phases||[]).map(p=>{
    const plannedH = safeNum(s.estimatedHours) * (safeNum(p.weight)/100);
    const hUsed = safeNum(hoursByPhase.get(p.id)||0);
    const mUsed = safeNum(matByPhase.get(p.id)||0);
    const hPerc = plannedH>0? (hUsed/plannedH)*100 : 0;
    return `
    <div style="display:grid; grid-template-columns:160px 1fr 100px; gap:.5rem; align-items:center; margin:.35rem 0">
      <div class="muted">${p.name} <span class="muted" style="font-size:.8rem">(${p.weight}%)</span></div>
      <div>
        <div class="progress" title="Ore: ${fmtNum(hUsed)}/${fmtNum(plannedH)}"><span style="width:${Math.min(hPerc, 100)}%"></span></div>
        <div class="muted" style="font-size:.8rem; margin-top:.15rem">Ore ${fmtNum(hUsed)} / ${fmtNum(plannedH)} · Materiali ${formatCurrency(mUsed)}</div>
      </div>
      <div class="right muted">${hPerc.toFixed(1)}%</div>
    </div>`;
  }).join('') || `<div class="muted">Nessuna fase definita</div>`;

  c.innerHTML = `
    <div class="detail-section">
      <h3 style="margin:0 0 .25rem; display:flex; justify-content:space-between; align-items:center">
        <span>${s.name}</span>
        <span class="site-badge ${s.status==='attivo'?'sb-active':'sb-ended'}">${s.status==='attivo'?'Attivo':'Terminato'}</span>
      </h3>
      <div class="row two" style="margin:.25rem 0">
        <div><span class="muted">Ore preventivate:</span> <b>${fmtNum(s.estimatedHours||0)}</b></div>
        <div><span class="muted">Ore lavorate:</span> <b>${fmtNum(hoursUsed)}</b></div>
        ${s.offerAmount? `<div><span class="muted">Importo offerta:</span> <b>${formatCurrency(s.offerAmount)}</b></div>`:''}
        ${s.materialBudget? `<div><span class="muted">Budget materiali:</span> <b>${formatCurrency(s.materialBudget)}</b></div>`:''}
      </div>

      <div style="margin-top:.5rem">
        <div class="muted">Avanzamento ore</div>
        <div class="progress-container">
          <div class="progress" style="flex:1; margin:.35rem 0 .15rem"><span style="width:${Math.min(hoursProgress, 100)}%"></span></div>
          <div class="progress-percentage">${hoursProgress.toFixed(1)}%</div>
        </div>
      </div>

      <div style="margin-top:.5rem">
        <div class="muted">Avanzamento materiali</div>
        <div class="progress-container">
          <div class="progress" style="flex:1; margin:.35rem 0 .15rem"><span style="width:${Math.min(materialProgress, 100)}%"></span></div>
          <div class="progress-percentage">${materialProgress.toFixed(1)}%</div>
        </div>
      </div>

      ${s.note? `<div style="margin-top:.5rem"><span class="muted">Note:</span> ${s.note}</div>`:''}

      <div style="margin-top:.75rem"><h3>Fasi</h3>${phasesHtml}</div>

      <div style="margin-top:1rem">
        <h3>Valorizzazione fasi</h3>
        <form id="phase-val-form">
          ${(s.phases||[]).map(p=>{
            const attrib = safeNum(p.attributedValue);
            const done = !!p.done;
            const when = p.attributedAt ? new Date(p.attributedAt).toISOString().slice(0,10) : '';
            return `<div class='material-row' data-phase-id='${p.id}'>
              <div><label class='muted'>${p.name}</label></div>
              <div><input type='number' class='phase-attr' min='0' step='0.01' placeholder='Valore attribuito' value='${attrib||''}'></div>
              <div><label style='display:flex; align-items:center; gap:.5rem'><input type='checkbox' class='phase-done' ${done?'checked':''}> Completata</label></div>
              <div><input type='date' class='phase-date' value='${when}'></div>
            </div>`;
          }).join('')||`<div class='muted'>Nessuna fase da valorizzare</div>`}
          <div style="display:flex; gap:.5rem; margin-top:.5rem">
            <button class="btn btn-primary" type="submit">Salva valorizzazioni</button>
          </div>
        </form>
        <div class="muted" style="margin-top:.35rem">Totale attribuito: <b id="phase-total-attrib">—</b></div>
      </div>

      <div class="detail-actions" style="margin-top:1rem; display:flex; gap:.5rem; flex-wrap:wrap">
        <button class="btn btn-primary" onclick="editSite('${s.id}')">Modifica</button>
        <button class="btn ${s.status==='attivo'?'btn-danger':'btn-success'}" onclick="toggleSiteStatus('${s.id}')">${s.status==='attivo'?'Termina Cantiere':'Riattiva Cantiere'}</button>
        <button class="btn btn-ghost" onclick="archiveSite('${s.id}')">Archivia</button>
        <button class="btn btn-ghost" onclick="deleteSite('${s.id}')">Elimina</button>
      </div>

      <div style="margin-top:1rem">
        <h3>Tutti i ticket del cantiere</h3>
        ${
          tix.length
            ? `<div style="max-height:400px; overflow:auto; border:1px solid var(--border); border-radius:10px">
                <table>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Collaboratori</th>
                      <th>Fase</th>
                      <th class="right">Ore</th>
                      <th class="right">Materiali</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tix
                      .slice()
                      .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')))
                      .map(t => {
                        const collabNames = (Array.isArray(t.collabIds)?t.collabIds:(t.collabId?[t.collabId]:[]))
                          .map(cid => state.collaborators.find(c=>c.id===cid)?.name || 'N/D')
                          .join(', ');
                        const s = state.sites.find(x=>x.id===t.siteId);
                        const phase = s?.phases?.find(p=>p.id===t.phaseId);
                        return `<tr data-tid="${t.id}">
                                  <td>${new Date(t.date).toLocaleDateString('it-CH')}</td>
                                  <td>${h(collabNames)}</td>
                                  <td>${h(phase?phase.name:'—')}</td>
                                  <td class="right">${fmtNum(t.hours)}</td>
                                  <td class="right">${formatCurrency(t.totalMaterialCost||0)}</td>
                                  <td class="right">
                                    <button class="btn btn-ghost js-open-ticket" data-tid="${t.id}">Modifica</button>
                                  </td>
                                </tr>`;
                      })
                      .join('')}
                  </tbody>
                </table>
              </div>`
            : `<div class="muted">Nessun ticket per questo cantiere</div>`
        }
      </div>
    </div>
  `;

  // 🔗 BIND: pulsanti "Modifica" ticket
  c.querySelectorAll('.js-open-ticket')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tId = btn.getAttribute('data-tid');
      if(!tId) return;
      openTicketEditorInModal(String(tId), {
        afterClose: ()=>{
          showSiteDetail(siteId);
        }
      });
    });
  });
      const allPhotos = [];
      (state.tickets||[]).forEach(t=>{
        if(t.siteId!==siteId || !Array.isArray(t.photos) || !t.photos.length) return;
        const by = (t.collabIds||[]).map(cid=> state.collaborators.find(c=>c.id===cid)?.name).filter(Boolean).join(', ');
        const date = t.date || '';
        t.photos.forEach(p=>{
          allPhotos.push({
            dataUrl: p.dataUrl,
            date,
            by
          });
        });
      });

      c.insertAdjacentHTML('beforeend', `
        <div style="margin-top:1rem">
          <h3>Foto cantiere</h3>
          ${allPhotos.length ? `
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.5rem">
              ${allPhotos.map(p=>`
                <figure class="card" style="padding:6px">
                  <img src="${h(p.dataUrl||'')}" alt="" style="width:100%;height:100px;object-fit:cover;border-radius:8px">
                  <figcaption class="muted" style="font-size:.8rem;margin-top:.25rem">${h(p.date||'')}<br>${h(p.by||'')}</figcaption>
                </figure>
              `).join('')}
            </div>
          ` : `<div class="muted">Nessuna foto caricata.</div>`}
        </div>
      `);
  // attach handlers for valuation
  const form = byId('phase-val-form');
  if(form){
    const recalcTotal = ()=>{
      const rows = form.querySelectorAll('[data-phase-id]');
      let tot = 0; rows.forEach(r=>{ const v = safeNum(r.querySelector('.phase-attr')?.value); tot += v; });
      const el = byId('phase-total-attrib'); if(el) el.textContent = formatCurrency(tot);
    };
    form.addEventListener('input', recalcTotal);
    recalcTotal();
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const rows = form.querySelectorAll('[data-phase-id]');
      const site = state.sites.find(x=> x.id===siteId); if(!site) return;
      rows.forEach(r=>{
        const pid = r.getAttribute('data-phase-id');
        const ph = (site.phases||[]).find(x=> x.id===pid); if(!ph) return;
        ph.attributedValue = safeNum(r.querySelector('.phase-attr')?.value);
        ph.done = !!r.querySelector('.phase-done')?.checked;
        const d = r.querySelector('.phase-date')?.value; ph.attributedAt = d || null;
      });
      site.updatedAt = new Date().toISOString();
      afterStateChange();
      showToast('Valorizzazioni fasi salvate ✅','success');
      updateDashboard();
    });
  }
}
function reconcileTicketsForRemovedPhases(siteId, removedPhaseIds, prevSite){
  const removedSet = new Set(removedPhaseIds);
  const removedNameById = new Map((prevSite?.phases||[]).map(p=> [p.id, p.name||'']));

  let touched = 0;
  (state.tickets||[]).forEach(t=>{
    if(t.siteId === siteId && t.phaseId && removedSet.has(t.phaseId)){
      const oldName = removedNameById.get(t.phaseId) || '';
      t.phaseId = '';
      const tag = oldName ? ` (fase rimossa: ${oldName})` : ` (fase rimossa)`;
      if(!String(t.note||'').includes('(fase rimossa')){
        t.note = (t.note ? t.note + ' ' : '') + tag;
      }
      t.updatedAt = new Date().toISOString();
      touched++;
    }
  });
  if(touched>0){
    showToast(`Aggiornati ${touched} ticket per fasi rimosse`, 'info');
  }
}
window.toggleSiteStatus = (siteId)=>{
  const s = state.sites.find(x=>x.id===siteId); if(!s) return;
  s.status = s.status==='attivo'? 'terminato':'attivo';
  s.updatedAt = new Date().toISOString();
  afterStateChange();
  renderSiteList();
  showSiteDetail(siteId);
  refreshSiteModal(siteId);
  showToast(`Cantiere ${s.status==='attivo'?'riattivato':'terminato'}`,'success');
};
window.deleteSite = (siteId)=>{
  if(!confirm('Eliminare il cantiere selezionato?')) return;
  state.sites = state.sites.filter(s=> s.id!==siteId);
  afterStateChange();
  closeSiteModalIfOpen(siteId);
  renderSiteList();
  byId('site-detail').innerHTML='<div class="muted">Seleziona un cantiere.</div>';
  showToast('Cantiere eliminato','success');
};
window.archiveSite = (siteId)=>{
  const site = state.sites.find(x=> x.id===siteId);
  if(!site) return;
  if(!confirm('Archiviare il cantiere selezionato?')) return;
  archiveItem('sites', site);
  state.sites = state.sites.filter(s=> s.id!==siteId);
  afterStateChange();
  closeSiteModalIfOpen(siteId);
  renderSiteList();
  byId('site-detail').innerHTML='<div class="muted">Seleziona un cantiere.</div>';
  if(window.currentRoute==='archive'){
    const active = document.querySelector('#page-archive [data-ar].active')?.getAttribute('data-ar') || 'sites';
    renderArchive(active);
  }
  showToast('Cantiere archiviato','success');
};

/* ===========================================================
   COLLABORATORI (create/edit)
   =========================================================== */
function setupCollaborators(){
  byId('collab-form')?.addEventListener('reset', ()=> byId('co-edit-id').value='');
  byId('collab-form')?.addEventListener('submit', e=>{
    e.preventDefault();
    const editId = byId('co-edit-id').value || null;
    const name = byId('co-nome').value.trim();
    const role = byId('co-ruolo').value.trim();
    const rate = safeNum(byId('co-rate').value);
    const note = byId('co-note').value;
    // >>> PATCH: netSalary dal form
    const netSalary = safeNum(byId('co-salary')?.value);
    const hireDate = byId('co-hire')?.value || null;
    const monthlyHoursInput = byId('co-monthly-hours');
    const monthlyHours = monthlyHoursInput && monthlyHoursInput.value.trim() !== ''
      ? safeNum(monthlyHoursInput.value)
      : null;
    if(editId){
      const idx = state.collaborators.findIndex(c=> c.id===editId);
      if(idx>-1){
        const prev = state.collaborators[idx];
        state.collaborators[idx] = { ...prev, name, role, rate, note, netSalary, hireDate, monthlyHours };
        showToast(`Collaboratore "${name}" aggiornato ✅`,'success');
      }
    }else{
      const maxOrder = Math.max(-1, ...(state.collaborators||[]).map(c => Number.isFinite(+c.order) ? +c.order : -1));
      const order = maxOrder + 1;
      state.collaborators.push({
        id:id(),
        name,
        role,
        rate,
        note,
        netSalary,
        hireDate,
        monthlyHours,
        order,
        createdAt:new Date().toISOString()
      });
      normalizeCollaboratorOrder();
      showToast(`Collaboratore "${name}" aggiunto ✅`,'success');
    }
    byId('collab-form').reset(); byId('co-edit-id').value='';
    afterStateChange(); renderCollaboratorList(); updateCollaboratorsDropdown();
  });
  byId('co-search')?.addEventListener('input', debounce(renderCollaboratorList,150));
  renderCollaboratorList();
}
function renderCollaboratorList(){
  const c = byId('co-list'); if(!c) return;
  const q = (byId('co-search')?.value||'').toLowerCase();
  const data = getCollaboratorsSorted().filter(co=> co.name.toLowerCase().includes(q) || (co.role||'').toLowerCase().includes(q));
  c.innerHTML = data.length ? data.map(co=>`
    <div class="card collab-item" data-id="${co.id}" style="padding:.8rem; display:grid; grid-template-columns:1fr auto; gap:.25rem">
      <div>
        <div style="font-weight:800">${h(co.name)}</div>
        <div class="muted" style="font-size:.85rem">${h(co.role)||'—'} • ${formatCurrency(co.rate)}/h</div>
        ${(function(){
          const hours = safeNum(co.monthlyHours);
          const net = safeNum(co.netSalary);
          const hasHours = hours > 0;
          const rate = getCollabCostRate(co.id);
          const grossMinor = hasHours ? Math.round(hours * rate * 100) : 0;
          const netMinor = net > 0 ? Math.round(net * 100) : 0;
          if(!hasHours && netMinor<=0) return '';
          const parts = [];
          if(hasHours) parts.push(`${fmtNum(hours)} h/mese`);
          if(grossMinor>0) parts.push(`Costo stimato ${Money.format(grossMinor)}`);
          if(netMinor>0) parts.push(`Netto ${Money.format(netMinor)}`);
          return `<div class="muted" style="font-size:.8rem">${parts.join(' • ')}</div>`;
        })()}
        ${co.note? `<div class="muted" style="font-size:.85rem; margin-top:.25rem">${h(co.note)}</div>`:''}
      </div>
      <div style="text-align:right">
        <div style="display:flex; gap:.3rem; justify-content:flex-end">
          <button class="btn btn-ghost" onclick="moveCo('${co.id}',-1)">↑</button>
          <button class="btn btn-ghost" onclick="moveCo('${co.id}',+1)">↓</button>
          <button class="btn btn-ghost" onclick="editCollaborator('${co.id}')">Modifica</button>
          <button class="btn btn-ghost" onclick="deleteCollaborator('${co.id}')">Elimina</button>
        </div>
      </div>
    </div>`).join('') : `<div class="empty">Nessun collaboratore</div>`;
  c.querySelectorAll('[data-id]')?.forEach(el=> el.addEventListener('click', (ev)=>{ if(ev.target.closest('button')) return; selectCollab(el.dataset.id); }));
  renderPageRecap('collab');
}
function selectCollab(id){
  document.querySelectorAll('#co-list [data-id]')?.forEach(el=> el.classList.toggle('active', el.dataset.id===id));
  showCollaboratorDetail(id);
}
function showCollaboratorDetail(id){
  const ctn = byId('collab-detail'); const co = state.collaborators.find(x=>x.id===id); if(!ctn||!co){ ctn.innerHTML='<div class="muted">Seleziona un collaboratore.</div>'; return; }
  const tickets = state.tickets.filter(t=> Array.isArray(t.collabIds) ? t.collabIds.includes(id) : t.collabId===id);
  const hours = tickets.reduce((s,t)=> s + safeNum(t.hours), 0);
  const cost = hours * (co.rate||state.settings.costHour||35);
  const monthlyHours = safeNum(co.monthlyHours);
  const monthlyGrossMinor = monthlyHours>0 ? Math.round(monthlyHours * getCollabCostRate(co.id) * 100) : 0;
  const monthlyNetMinor = Math.round(safeNum(co.netSalary||0) * 100);
  const rows = tickets
    .slice()
    .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')))
    .map(t=>{
      const s = state.sites.find(x=> x.id===t.siteId);
      const phase = s?.phases?.find(p=> p.id===t.phaseId);
      return `<tr>
        <td>${t.date ? new Date(t.date).toLocaleDateString('it-CH') : '—'}</td>
        <td>${h(s ? s.name : (t.siteName || (t.isRegia ? 'Regia' : '—')))}</td>
        <td>${h(phase ? phase.name : '—')}</td>
        <td class="right">${fmtNum(t.hours||0)}</td>
        <td class="right">${formatCurrency(t.totalMaterialCost||0)}</td>
        <td class="table-actions"><button class="btn btn-ghost js-open-ticket" data-tid="${t.id}">Modifica</button></td>
      </tr>`;
    }).join('');

  ctn.innerHTML = `
    <div class="detail-section">
      <h3>${h(co.name)}</h3>
      <div class="row two" style="margin:.5rem 0">
        <div><span class="muted">Ruolo:</span> <b>${h(co.role)||'—'}</b></div>
        <div><span class="muted">Tariffa oraria:</span> <b>${formatCurrency(co.rate)}</b></div>
        <div><span class="muted">Ore totali:</span> <b>${fmtNum(hours)}</b></div>
        <div><span class="muted">Costo totale:</span> <b>${formatCurrency(cost)}</b></div>
        ${monthlyHours>0 ? `<div><span class="muted">Ore mensili previste:</span> <b>${fmtNum(monthlyHours)}</b></div>` : ''}
        ${(monthlyGrossMinor>0 || monthlyNetMinor>0) ? `<div><span class="muted">Stipendio stimato:</span> <b>${monthlyGrossMinor>0 ? Money.format(monthlyGrossMinor) : '—'}</b>${monthlyNetMinor>0 ? ` <span class="muted">(Netto ${Money.format(monthlyNetMinor)})</span>` : ''}</div>` : ''}
      </div>
      ${co.note? `<div class="muted">Note: ${h(co.note)}</div>`:''}
      <div class="detail-actions" style="margin-top:1rem; display:flex; gap:.5rem">
        <button class="btn btn-primary" onclick="editCollaborator('${co.id}')">Modifica</button>
        <button class="btn btn-ghost" onclick="archiveCollaborator('${co.id}')">Archivia</button>
        <button class="btn btn-ghost" onclick="deleteCollaborator('${co.id}')">Elimina</button>
      </div>
      <div style="margin-top:.75rem">
        <h3>Tutte le attività</h3>
        ${tickets.length
          ? `<div class="table-scroll-lg">
               <table>
                 <thead><tr>
                   <th>Data</th><th>Cantiere</th><th>Fase</th><th class="right">Ore</th><th class="right">Materiali</th><th></th>
                 </tr></thead>
                 <tbody>${rows}</tbody>
               </table>
             </div>`
          : `<div class="muted">Nessuna attività</div>`}
      </div>
    </div>`;

  ctn.querySelectorAll('.js-open-ticket')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tid = btn.getAttribute('data-tid');
      if(tid) openTicketEditorInModal(String(tid), {
        afterClose: ()=>{
          showCollaboratorDetail(id);
        }
      });
    });
  });
}
window.editCollaborator = (id)=>{
  const co = state.collaborators.find(x=>x.id===id); if(!co) return; goTo('collab');
  byId('co-edit-id').value = co.id; byId('co-nome').value = co.name; byId('co-ruolo').value = co.role||''; byId('co-rate').value = co.rate||''; byId('co-note').value = co.note||'';
  // >>> PATCH: fill netSalary
  if(byId('co-salary')) byId('co-salary').value = co.netSalary || '';
  if(byId('co-monthly-hours')) byId('co-monthly-hours').value = co.monthlyHours ?? '';
  if(byId('co-hire'))   byId('co-hire').value   = co.hireDate || '';
  showToast(`Modifica collaboratore "${co.name}"`,'info');
}
window.deleteCollaborator = (id)=>{
  if(!confirm('Eliminare il collaboratore selezionato?')) return;
  if(state.tickets.some(t=> Array.isArray(t.collabIds) ? t.collabIds.includes(id) : t.collabId===id)){ showToast('Impossibile: sono presenti ticket associati','error'); return; }
  state.collaborators = state.collaborators.filter(c=> c.id!==id);
  afterStateChange(); renderCollaboratorList(); byId('collab-detail').innerHTML='<div class="muted">Seleziona un collaboratore.</div>'; showToast('Collaboratore eliminato','success');
}
window.archiveCollaborator = (id)=>{
  const co = state.collaborators.find(x=> x.id===id);
  if(!co) return;
  if(!confirm('Archiviare il collaboratore selezionato?')) return;
  archiveItem('collaborators', co);
  state.collaborators = state.collaborators.filter(c=> c.id!==id);
  normalizeCollaboratorOrder();
  afterStateChange();
  renderCollaboratorList();
  byId('collab-detail').innerHTML='<div class="muted">Seleziona un collaboratore.</div>';
  if(window.currentRoute==='archive'){
    const active = document.querySelector('#page-archive [data-ar].active')?.getAttribute('data-ar') || 'collaborators';
    renderArchive(active);
  }
  showToast('Collaboratore archiviato','success');
};
window.moveCo = (id, dir) => {
  normalizeCollaboratorOrder();

  const arr = getCollaboratorsSorted();
  const i = arr.findIndex(c => c.id === id);
  if (i < 0) return;

  const j = i + (dir < 0 ? -1 : 1);
  if (j < 0 || j >= arr.length) return;

  const A = arr[i], B = arr[j];
  const tmp = A.order; A.order = B.order; B.order = tmp;

  normalizeCollaboratorOrder();

  afterStateChange();
  renderCollaboratorList();
};

/* ===========================================================
   TICKETS - WITH EDIT FUNCTIONALITY
   =========================================================== */
function setupTickets(){
  const form = byId('ticket-form');
  if (form?.dataset.initialized === '1') { updateCollaboratorsDropdown(); updateSitesDropdown(); renderLastTickets(); renderTicketCalendarMonth(); renderTiPhotosPreview(); return; }
  if (form) form.dataset.initialized = '1';

  byId('btn-add-mat')?.addEventListener('click', addMaterialRow);
  byId('ti-site-manual-toggle')?.addEventListener('change', e=>{
    const manual = e.target.checked;
    const manualInput = byId('ti-site-manual'); const siteSelect = byId('ti-site');
    const regiaChk = byId('ti-regia');
    if(manual){
      manualInput.style.display='block'; manualInput.setAttribute('required','');
      siteSelect.style.display='none'; siteSelect.removeAttribute('required');
      if(regiaChk){ regiaChk.checked = true; regiaChk.disabled = true; regiaChk.title = 'Inserimento manuale: segnato come ore a regia'; }
      const ph = byId('ti-phase'); if(ph){ ph.innerHTML = `<option value="">—</option>`; ph.value = ''; }
    }else{
      manualInput.style.display='none'; manualInput.removeAttribute('required');
      siteSelect.style.display='block'; siteSelect.setAttribute('required','');
      if(regiaChk){ regiaChk.disabled = false; regiaChk.checked = false; regiaChk.title=''; }
  const site = (state.sites||[]).find(s=> s.id===siteSelect.value);
      populatePhases(site);
      const ph = byId('ti-phase'); if(ph) ph.value = '';
    }
  });
  byId('ti-site-search')?.addEventListener('input', debounce(handleSiteSuggest,150));
  byId('ticket-form')?.addEventListener('submit', e=>{
    e.preventDefault();
    const editId = byId('ti-edit-id').value || null;
    const date = byId('ti-data').value; const collabIds = collabPickerGet(); const manual = byId('ti-site-manual-toggle').checked;
    let siteId, siteName;
  if(manual){ siteName = byId('ti-site-manual').value.trim(); siteId = 'manual-'+id(); }
  else{ siteId = byId('ti-site').value; const s = state.sites.find(x=>x.id===siteId); siteName = s? s.name : 'N/A'; }
  const phaseId = byId('ti-phase').value || ''; const note = byId('ti-note').value;
    // >>> PATCH: isRegia nel ticket
    const isRegia = !!byId('ti-regia')?.checked;

    const hrsInputs = [...document.querySelectorAll('#ti-collab-hrs .ti-hrs')];
    const collabHours = {};
    const missingHours = new Set();
    let invalidHours = false;
    hrsInputs.forEach(inp=>{
      const cid = inp.dataset.cid;
      if(!cid) return;
      const raw = String(inp.value ?? '').trim();
      if(raw===''){
        missingHours.add(cid);
        return;
      }
      const val = safeNum(raw);
      const normalized = Math.round(val * 100) / 100;
      if(normalized < 0){
        invalidHours = true;
        return;
      }
      collabHours[cid] = normalized;
    });
    if(!collabIds.length){
      showToast('Seleziona almeno un collaboratore','error');
      return;
    }
    if(missingHours.size){
      showToast('Inserisci le ore per ciascun collaboratore selezionato','error');
      return;
    }
    if(invalidHours){
      showToast('Le ore non possono essere negative','error');
      return;
    }

    const hours = Object.values(collabHours).reduce((sum, h)=> sum + safeNum(h), 0);
    if(hours<=0){
      showToast('Le ore totali devono essere maggiori di zero','error');
      return;
    }
    const hoursField = byId('ti-ore');
    if(hoursField){
      hoursField.value = (Math.round(hours*100)/100).toFixed(2);
    }

    const materials = []; let totalMaterialCost = 0;
    document.querySelectorAll('#ti-mats .material-row').forEach(r=>{
      const desc = r.querySelector('.mat-desc').value.trim(); const qty  = safeNum(r.querySelector('.mat-qty').value); const cost = safeNum(r.querySelector('.mat-cost').value);
      if(desc && qty>0 && cost>=0){ const total = qty*cost; materials.push({id:id(), desc, qty, cost, total}); totalMaterialCost += total; }
    });

    const ticket = {id: editId || id(), date, collabIds, siteId, siteName, phaseId, hours, collabHours, materials, totalMaterialCost, note, isRegia, createdAt: editId ? state.tickets.find(t=>t.id===editId).createdAt : new Date().toISOString(), updatedAt: new Date().toISOString()};
    ticket.photos = (__tiPhotosBuffer || []).slice();
    
    if(editId){
      const idx = state.tickets.findIndex(t=> t.id===editId);
      if(idx>-1) state.tickets[idx] = ticket;
      showToast('Ticket aggiornato ✅','success');
    } else {
      state.tickets.push(ticket);
      showToast('Ticket salvato ✅','success');
    }
    
    afterStateChange();
    e.target.reset(); byId('ti-mats').innerHTML=''; byId('ti-edit-id').value = '';
    __tiPhotosBuffer = [];
    renderTiPhotosPreview();
    const photoInput = byId('ti-photos'); if(photoInput) photoInput.value = '';
    updateTicketHoursTotal();
    byId('ti-data').valueAsDate = new Date();
    collabPickerSet([]); // clear collab selection
    updateSitesDropdown(); updateCollaboratorsDropdown(); renderLastTickets();
    renderTicketCalendarMonth();
  });

  byId('btn-ticket-reset')?.addEventListener('click', ()=>{
    byId('ti-edit-id').value = '';
    byId('ti-mats').innerHTML = '';
    collabPickerSet([]);
    updateTicketHoursTotal();
    __tiPhotosBuffer = [];
    renderTiPhotosPreview();
    const photoInput = byId('ti-photos'); if(photoInput) photoInput.value = '';
  });

  updateCollaboratorsDropdown(); collabPickerInit(); updateSitesDropdown();
  const siteSel = byId('ti-site');
  siteSel?.addEventListener('change', ()=>{
    const site = (state.sites||[]).find(s=> s.id===siteSel.value);
    populatePhases(site);
    const ph = byId('ti-phase'); if(ph) ph.value = '';
  });

  byId('ti-data').valueAsDate = new Date();
  renderLastTickets();
  renderTicketCalendarMonth();
  initTicketCalendar();
  renderTiPhotosPreview();
}
function handleSiteSuggest(){
  const box = byId('ti-site-suggest'); const q = byId('ti-site-search').value.toLowerCase().trim();
  if(!q){ box.style.display='none'; return; }
  const res = state.sites.filter(s=> s.name.toLowerCase().includes(q)).slice(0,8);
  if(!res.length){ box.style.display='none'; return; }
  box.innerHTML = res.map(s=> `<div data-id="${s.id}">${s.name}</div>`).join('');
  box.style.display='block';
  box.querySelectorAll('[data-id]')?.forEach(d=> d.addEventListener('click', ()=>{
    byId('ti-site').value = d.dataset.id; box.style.display='none';
    const site = state.sites.find(x=>x.id===d.dataset.id); populatePhases(site);
  }));
  // Patch: chiudi suggerimenti cliccando fuori
  setTimeout(()=>{
    function closeSuggest(e){
      if(e.target!==byId('ti-site-search') && e.target!==box){ box.style.display='none'; document.removeEventListener('mousedown', closeSuggest); }
    }
    document.addEventListener('mousedown', closeSuggest);
  },0);
}
function addMaterialRow(){ const t=byId('tpl-mat'); const c=byId('ti-mats'); if(!t||!c) return; const clone=t.content.cloneNode(true); clone.querySelector('.remove-btn').addEventListener('click', e=> e.target.closest('.material-row').remove()); c.appendChild(clone); }
function updateCollaboratorsDropdown(){ const s = byId('ti-collab'); if(!s) return; s.innerHTML = getCollaboratorsSorted().map(c=> `<option value="${c.id}">${c.name} ${c.role? '('+c.role+')':''}</option>`).join(''); }
function updateSitesDropdown(){ const s = byId('ti-site'); if(!s) return; const active = state.sites.filter(x=> x.status==='attivo'); s.innerHTML = active.map(x=> `<option value="${x.id}">${x.name}</option>`).join(''); const sel = state.sites.find(x=> x.id === s.value); populatePhases(sel); }
/* ------------ Collaborator Picker ------------ */
let __tiCollabHoursPrefill = null;

function collabPickerInit(){
  const dd   = byId('ti-collab-dd');
  const box  = byId('ti-collab-picker');
  const inp  = byId('ti-collab-search');
  if(!dd || !box || !inp) return;
  box.dataset.selected = JSON.stringify([]); // ids

  function renderDropdown(q=''){
    const needle = q.trim().toLowerCase();
    const data = getCollaboratorsSorted()
      .filter(c => c.name.toLowerCase().includes(needle) || (c.role||'').toLowerCase().includes(needle));
    dd.innerHTML = data.length ? data.map(c=>`
      <div class="collab-row" data-id="${c.id}" style="display:grid;grid-template-columns:auto 1fr auto;gap:.5rem;align-items:center">
        <input type="checkbox">
        <span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px">${h(c.name)}</span>
        <span class="muted" style="font-size:.85rem">${h(c.role||'')}</span>
      </div>`).join('') : `<div class="muted" style="padding:.6rem">Nessun risultato</div>`;
    // spunta già selezionati
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    dd.querySelectorAll('.collab-row').forEach(r=>{
      r.querySelector('input').checked = sel.has(r.dataset.id);
      r.addEventListener('click', ()=> toggle(r.dataset.id));
    });
  }
  function paintChips(){
    // rimuovi chip
    box.querySelectorAll('.collab-chip').forEach(e=>e.remove());
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    [...sel].forEach(id=>{
      const c = state.collaborators.find(x=>x.id===id);
      const chip = document.createElement('span');
      chip.className='collab-chip';
      chip.innerHTML = `${h(c?c.name:'N/D')} <button title="Rimuovi">×</button>`;
      chip.querySelector('button').onclick = ()=> remove(id);
      box.insertBefore(chip, inp);
    });
  }
  function toggle(id){
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    sel.has(id) ? sel.delete(id) : sel.add(id);
    box.dataset.selected = JSON.stringify([...sel]);
    paintChips(); renderDropdown(inp.value); renderPerCollaboratorHours();
  }
  function remove(id){
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    sel.delete(id); box.dataset.selected = JSON.stringify([...sel]);
    paintChips(); renderDropdown(inp.value); renderPerCollaboratorHours();
  }
  inp.addEventListener('focus', ()=>{ dd.style.display='block'; renderDropdown(inp.value); });
  inp.addEventListener('input', ()=> renderDropdown(inp.value));
  document.addEventListener('mousedown', (e)=>{
    if(!box.contains(e.target)) dd.style.display='none';
  });

  // API sul DOM
  box.getSelectedIds = ()=> JSON.parse(box.dataset.selected||'[]');
  box.setSelectedIds = (ids=[])=>{
    box.dataset.selected = JSON.stringify(ids);
    paintChips();
    renderDropdown(inp.value);
    renderPerCollaboratorHours();
  };

  // prima render
  paintChips();
  renderPerCollaboratorHours();
}
// helper per leggere dal picker
function collabPickerGet(){ return byId('ti-collab-picker')?.getSelectedIds() || []; }
function collabPickerSet(ids, prefill=null){
  if(prefill) __tiCollabHoursPrefill = {...prefill};
  byId('ti-collab-picker')?.setSelectedIds(ids||[]);
  updateTicketHoursTotal();
}

// ===== Ticket Photos =====
let __tiPhotosBuffer = [];

function renderTiPhotosPreview(){
  const box = byId('ti-photos-prev'); if(!box) return;
  box.innerHTML = __tiPhotosBuffer.map((p,i)=>`
    <div style="position:relative;width:84px;height:84px;border:1px solid var(--border);border-radius:8px;overflow:hidden">
      <img src="${h(p.dataUrl||'')}" alt="" style="width:100%;height:100%;object-fit:cover">
      <button type="button" data-i="${i}" style="position:absolute;right:2px;top:2px;border:none;background:#0008;color:#fff;border-radius:6px;padding:0 6px;line-height:20px">×</button>
    </div>
  `).join('');
  box.querySelectorAll('button[data-i]')?.forEach(btn=>{
    btn.addEventListener('click', ()=>{ __tiPhotosBuffer.splice(+btn.dataset.i,1); renderTiPhotosPreview(); });
  });
}

byId('ti-photos')?.addEventListener('change', async (e)=>{
  const files = [...(e.target.files||[])].slice(0,20);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const dataUrl = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
    __tiPhotosBuffer.push({name:f.name, dataUrl});
  }
  renderTiPhotosPreview();
});

function renderPerCollaboratorHours(){
  const box = byId('ti-collab-hrs');
  const list = byId('ti-collab-hrs-list');
  if(!box || !list) return;

  // mantieni i valori digitati se stai ri-renderizzando
  const previousValues = {};
  list.querySelectorAll('.ti-hrs').forEach(inp=>{ previousValues[inp.dataset.cid] = inp.value; });

  const ids = collabPickerGet();
  if(!ids.length){
    box.style.display = 'none';
    list.innerHTML = '';
    updateTicketHoursTotal();
    return;
  }

  box.style.display = 'block';
  const prefill = __tiCollabHoursPrefill || {};
  list.innerHTML = ids.map(cid=>{
    const co = state.collaborators.find(c=> c.id===cid);
    const name = h(co?.name || '—');
    const role = h(co?.role || '');
    return `<label class="ti-hrs-row" style="display:contents">
      <div>${name}${role ? ` <span class="muted">(${role})</span>` : ''}</div>
      <input class="ti-hrs" data-cid="${cid}" type="number" min="0" step="0.25" placeholder="0.00" inputmode="decimal">
    </label>`;
  }).join('') + `<div class="ti-hrs-total muted" style="grid-column:1/-1;text-align:right">Totale: <span id="ti-hrs-total">0.00</span> h</div>`;

  // riempi: prima prefill da ticket, poi eventuale valore già digitato
  list.querySelectorAll('.ti-hrs').forEach(inp=>{
    const cid = inp.dataset.cid;
    if (Object.prototype.hasOwnProperty.call(prefill, cid)) {
      const v = safeNum(prefill[cid]);
      inp.value = Number.isFinite(v) && v>0 ? (Math.round(v*100)/100).toFixed(2) : '';
    } else if (previousValues[cid] !== undefined) {
      inp.value = previousValues[cid];
    }
  });

  __tiCollabHoursPrefill = null;
  updateTicketHoursTotal();
}

function updateTicketHoursTotal(){
  const inputs = [...document.querySelectorAll('#ti-collab-hrs .ti-hrs')];
  const total = inputs.reduce((sum, inp)=> sum + safeNum(inp.value), 0);
  const normalized = Math.round(total*100)/100;
  const totalEl = byId('ti-hrs-total');
  if(totalEl){
    totalEl.textContent = normalized.toFixed(2);
  }
  const hoursInput = byId('ti-ore');
  if(hoursInput){
    if(inputs.length){
      hoursInput.value = normalized.toFixed(2);
    }else{
      hoursInput.value = '';
    }
  }
}

document.addEventListener('input', e=>{
  if(e.target?.classList?.contains('ti-hrs')) updateTicketHoursTotal();
});
function populatePhases(site){ const ph = byId('ti-phase'); if(!ph) return; const opts = site?.phases?.length ? site.phases : []; ph.innerHTML = `<option value="">—</option>` + opts.map(p=> `<option value="${p.id}">${p.name}</option>`).join(''); }
function renderLastTickets(){
  const c = byId('ti-last'); if(!c) return;
  const rows = (state.tickets||[])
    .slice()
    .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||''))); // dal più recente
  c.innerHTML = rows.length ? rows.map(t=>{
    const ids = Array.isArray(t.collabIds) ? t.collabIds : (t.collabId ? [t.collabId] : []);
    const collabNames = ids
      .map(cid => state.collaborators.find(c=>c.id===cid)?.name || 'N/D')
      .map(h)
      .join(', ');
    const site = state.sites.find(s=> s.id===t.siteId);
    const phase = site?.phases?.find(p=> p.id===t.phaseId);

    const laborMinor = ticketLaborMinor(t);
    const materialMinor = Money.toMinor(safeNum(t.totalMaterialCost||0));
    const regia = safeNum(state.settings.regiaRate || 85);
    const markupPct = safeNum(state.settings.markup) || 0;
    const laborRevenueMinor = Math.round(safeNum(t.hours) * regia * 100);
    const markupMinor       = Money.mulPct(materialMinor, markupPct);
    const revenueMinor      = Money.add(laborRevenueMinor, materialMinor, markupMinor);
    const profitMinor       = Money.sub(revenueMinor, Money.add(laborMinor, materialMinor));

    return `<tr>
  <td>${t.date ? new Date(t.date).toLocaleDateString('it-CH') : '—'}</td>
  <td>${collabNames || 'N/A'}</td>
  <td>${h(site ? site.name : (t.siteName||'—'))}</td>
  <td>${h(phase ? phase.name : '—')}</td>
      <td class="right">${(Number(t.hours)||0).toFixed(2)}</td>
      <td class="right">${Money.format(materialMinor)}</td>
      <td class="right">${Money.format(profitMinor)}</td>
      <td class="right">
        <button class="btn btn-ghost" onclick="editTicket('${t.id}')">Modifica</button>
        <button class="btn btn-ghost" onclick="deleteTicket('${t.id}')">Elimina</button>
      </td>
    </tr>`;
  }).join('') : `<tr><td colspan="8" class="muted" style="text-align:center">Nessun ticket</td></tr>`;
  renderPageRecap('ticket');
}

// mapping robusto per ruolo collaboratore
function roleBucket(role=''){
  const r = String(role||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
  if (r.includes('apprend')) return 'Apprendista';
  if (r.includes('operai') || r.includes('operaio') || r.includes('operaia')) return 'Operaio';
  if (r.includes('dir') || r.includes('capo') || r.includes('direzione')) return 'Direzione';
  return 'Altro';
}

let __tiCalMonth = null; // Date primo giorno del mese corrente per la card
function tiFirstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function tiAddMonths(d, n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
function tiToISO(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

function renderTicketCalendarMonth(){
  const grid = byId('ti-cal-grid'); const title = byId('ti-cal-title'); if(!grid||!title) return;
  const m = __tiCalMonth || tiFirstOfMonth(new Date());
  __tiCalMonth = m;
  title.textContent = m.toLocaleDateString('it-CH',{month:'long',year:'numeric'});

  const start = new Date(m); start.setDate(1 - ((m.getDay()+6)%7)); // lun precedente
  const cells = []; for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(start.getDate()+i); cells.push(d); }

  // iso -> {Operaio, Direzione, Apprendista, Altro, uniq:Set, tickets:[]}
  const perDay = new Map();
  (state.tickets||[]).forEach(t=>{
    const iso = String(t.date||'').slice(0,10); if(!iso) return;
    const ids = Array.isArray(t.collabIds) ? t.collabIds.filter(Boolean) : (t.collabId?[t.collabId]:[]);
    const mapHours = (t.collabHours && typeof t.collabHours==='object') ? t.collabHours : null;
    const fallback = safeNum(t.hours) / Math.max(1, ids.length);
    const getH = cid => mapHours ? (Number(mapHours[cid])||0) : fallback;
    const rec = perDay.get(iso) || {Operaio:0, Direzione:0, Apprendista:0, Altro:0, uniq:new Set(), tickets:[]};
    ids.forEach(cid=>{
      const co = state.collaborators.find(c=> c.id===cid);
      const bucket = roleBucket(co?.role);
      const hours = getH(cid);
      if (bucket==='Operaio')     rec.Operaio     += hours;
      else if (bucket==='Direzione') rec.Direzione   += hours;
      else if (bucket==='Apprendista') rec.Apprendista += hours;
      else rec.Altro += hours;
      if (cid) rec.uniq.add(cid);
    });
    rec.tickets.push(t);
    perDay.set(iso, rec);
  });

  grid.innerHTML = cells.map(d=>{
    const iso = tiToISO(d);
    const D = perDay.get(iso) || {Operaio:0, Direzione:0, Apprendista:0, Altro:0, uniq:new Set(), tickets:[]};
    const uniqCount = D.uniq instanceof Set ? D.uniq.size : 0;
    const expected = uniqCount * 8; // 8h a persona
    const tot = D.Operaio + D.Direzione + D.Apprendista + D.Altro;
    const pct = expected>0 ? Math.min(100, (tot/expected)*100) : 0;
    const other = d.getMonth()!==m.getMonth();
    return `
      <div class="card ti-day" data-iso="${iso}" style="padding:.5rem;${other?'opacity:.45':''};cursor:pointer">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">${d.getDate()}</div>
          <div class="muted" title="persone uniche">${uniqCount||0} collab</div>
        </div>
        <div class="muted" style="font-size:.85rem">
          <div>Operai: <b>${D.Operaio.toFixed(2)}</b> h</div>
          <div>Direzione: <b>${D.Direzione.toFixed(2)}</b> h</div>
          <div>Appr.: <b>${D.Apprendista.toFixed(2)}</b> h</div>
        </div>
        <div class="progress" style="margin-top:.35rem"><span style="width:${pct.toFixed(0)}%"></span></div>
      </div>`;
  }).join('');

  grid.querySelectorAll('.ti-day[data-iso]')?.forEach(card=>{
    card.addEventListener('click', ()=> showTiDayDetails(card.getAttribute('data-iso')));
  });
}

function initTicketCalendar(){
  __tiCalMonth = tiFirstOfMonth(new Date());
  byId('ti-cal-prev')?.addEventListener('click', ()=>{ __tiCalMonth = tiAddMonths(__tiCalMonth, -1); renderTicketCalendarMonth(); });
  byId('ti-cal-next')?.addEventListener('click', ()=>{ __tiCalMonth = tiAddMonths(__tiCalMonth, +1); renderTicketCalendarMonth(); });
  renderTicketCalendarMonth();
}

function showTiDayDetails(iso){
  const ov = byId('ti-day-overlay'), body = byId('ti-day-body'), title = byId('ti-day-title'), kpis = byId('ti-day-kpis');
  if(!ov||!body||!title||!kpis) return;

  const list = (state.tickets||[]).filter(t=> String(t.date||'').slice(0,10)===iso);
  const uniq = new Set();
  const buckets = { Operai:0, Direzione:0, Apprendisti:0 };
  const perSite = new Map();

  list.forEach(t=>{
    const ids = Array.isArray(t.collabIds)? t.collabIds.filter(Boolean) : (t.collabId?[t.collabId]:[]);
    const mapHours = (t.collabHours && typeof t.collabHours==='object') ? t.collabHours : null;
    const fallback = safeNum(t.hours) / Math.max(1, ids.length);
    const getHoursFor = cid => mapHours ? (Number(mapHours[cid])||0) : fallback;
    ids.forEach(cid=>{
      uniq.add(cid);
      const hours = getHoursFor(cid);
      const co = state.collaborators.find(c=>c.id===cid);
      const rb = roleBucket(co?.role);
      if(rb==='Operaio') buckets.Operai += hours;
      else if(rb==='Direzione') buckets.Direzione += hours;
      else if(rb==='Apprendista') buckets.Apprendisti += hours;

      const s = state.sites.find(s=> s.id===t.siteId);
      const siteName = s? s.name : (t.siteName || (t.isRegia?'Regia':'—'));
      perSite.set(siteName, (perSite.get(siteName)||0) + hours);
    });
  });

  const expected = uniq.size * 8;
  const pct = v => expected>0 ? Math.min(100,(v/expected)*100) : 0;

  title.textContent = `Dettagli — ${iso}`;
  kpis.innerHTML = `
    <div class="kpi-mini">Persone: <b>${uniq.size}</b></div>
    <div class="kpi-mini">Ore attese: <b>${expected.toFixed(2)}</b></div>
    <div class="kpi-mini">Completamento: <b>${pct(buckets.Operai+buckets.Direzione+buckets.Apprendisti).toFixed(0)}%</b></div>
  `;

  const bar = (lbl,val)=>{
    const safeLbl = h(lbl);
    return `
    <div class="bar-row">
      <div class="hdr"><span class="lbl">${safeLbl}</span><span class="val">${val.toFixed(2)} h · ${pct(val).toFixed(0)}%</span></div>
      <div class="progress"><span style="width:${pct(val).toFixed(0)}%"></span></div>
    </div>`;
  };

  const roleBars = `
    ${bar('Operai', buckets.Operai)}
    ${bar('Direzione', buckets.Direzione)}
    ${bar('Apprendisti', buckets.Apprendisti)}
  `;

  const siteBars = [...perSite.entries()].sort((a,b)=> b[1]-a[1]).map(([name,h])=> bar(name, h)).join('') || `<div class="muted">Nessun cantiere</div>`;

  const table = list.length ? `
    <table class="tbl" style="margin-top:.5rem">
      <thead><tr><th>Collaboratori</th><th>Cantiere</th><th>Fase</th><th class="right">Ore</th><th class="right">Materiali</th></tr></thead>
      <tbody>
      ${list.map(t=>{
        const ids = Array.isArray(t.collabIds)? t.collabIds : (t.collabId?[t.collabId]:[]);
        const names = ids.map(cid => (state.collaborators.find(c=>c.id===cid)?.name)||'N/D').join(', ');
        const s = state.sites.find(x=> x.id===t.siteId);
        const phase = s?.phases?.find(p=> p.id===t.phaseId);
        const sumHours = t.collabHours ? Object.values(t.collabHours).reduce((a,b)=>a+(Number(b)||0),0) : (Number(t.hours)||0);
        return `<tr>
          <td>${h(names)}</td>
          <td>${s? h(s.name) : h(t.siteName|| (t.isRegia?'Regia':'—'))}</td>
          <td>${phase? h(phase.name) : '—'}</td>
          <td class="right">${sumHours.toFixed(2)}</td>
          <td class="right">${formatCurrency(t.totalMaterialCost||0)}</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>` : `<div class="muted">Nessun ticket</div>`;

  body.innerHTML = `<div class="grid-2">
      <section>
        <h3 style="margin:.2rem 0 .4rem">Composizione per ruolo</h3>
        ${roleBars}
        <h3 style="margin:.8rem 0 .4rem">Per cantiere</h3>
        ${siteBars}
      </section>
      <section>
        <h3 style="margin:.2rem 0 .4rem">Ticket del giorno</h3>
        ${table}
      </section>
    </div>`;
  ov.classList.add('show');
}

byId('ti-day-close')?.addEventListener('click', ()=> byId('ti-day-overlay')?.classList.remove('show'));

window.editTicket = (id)=>{
  const t = state.tickets.find(x=>x.id===id); if(!t) return;
  byId('ti-edit-id').value = t.id;
  byId('ti-data').value = t.date;
  // set multi-collaborators
  const ids = Array.isArray(t.collabIds) ? t.collabIds : (t.collabId ? [t.collabId] : []);
  collabPickerSet(ids, t.collabHours || null);
  if (t.collabHours && typeof t.collabHours==='object') {
    const sum = Object.values(t.collabHours).reduce((s,v)=> s + safeNum(v), 0);
    const totalEl = byId('ti-hrs-total');
    if (totalEl) totalEl.textContent = (Math.round(sum*100)/100).toFixed(2);
  }
  const hoursInput = byId('ti-ore');
  const hasPerCollabHours = t.collabHours && typeof t.collabHours === 'object' && Object.keys(t.collabHours).length;
  if(hoursInput){
    if(hasPerCollabHours){
      const sum = Object.values(t.collabHours).reduce((total, val)=> total + safeNum(val), 0);
      hoursInput.value = sum>0 ? (Math.round(sum*100)/100).toFixed(2) : '';
    }else{
      hoursInput.value = t.hours ?? '';
    }
  }

  const toggle = byId('ti-site-manual-toggle');
  const manualInput = byId('ti-site-manual');
  const siteSelect = byId('ti-site');
  const isManual = (t.siteId || '').startsWith('manual-');
  if(siteSelect && !isManual){ siteSelect.value = t.siteId; }
  if(toggle){
    toggle.checked = isManual;
    toggle.dispatchEvent(new Event('change'));
  }
  if(isManual){
    if(manualInput) manualInput.value = t.siteName;
  }else{
    if(siteSelect){
      const site = state.sites.find(s=> s.id===t.siteId);
      populatePhases(site);
    }
  }

  byId('ti-phase').value = t.phaseId || '';
  byId('ti-note').value = t.note || '';
  const regiaEl = byId('ti-regia');
  if(regiaEl){
    if(isManual){
      regiaEl.checked = true;
      regiaEl.disabled = true;
      regiaEl.title = 'Inserimento manuale: segnato come ore a regia';
    }else{
      regiaEl.checked = !!t.isRegia;
      regiaEl.disabled = false;
      regiaEl.title = '';
    }
  }

  __tiPhotosBuffer = Array.isArray(t.photos) ? t.photos.slice() : [];
  renderTiPhotosPreview();
  const photoInput = byId('ti-photos'); if(photoInput) photoInput.value = '';
  
  // Clear and repopulate materials
  const matsContainer = byId('ti-mats');
  matsContainer.innerHTML = '';
  (t.materials || []).forEach(mat => {
    addMaterialRow();
    const lastRow = matsContainer.lastElementChild;
    lastRow.querySelector('.mat-desc').value = mat.desc;
    lastRow.querySelector('.mat-qty').value = mat.qty;
    lastRow.querySelector('.mat-cost').value = mat.cost;
  });
  
  showToast(`Modifica ticket del ${new Date(t.date).toLocaleDateString('it-CH')}`,'info');
};
window.deleteTicket = (id)=>{ if(!confirm('Eliminare il ticket?')) return; state.tickets = state.tickets.filter(t=> t.id!==id); afterStateChange(); renderLastTickets(); renderTicketCalendarMonth(); showToast('Ticket eliminato','success'); }

/* ===========================================================
   INVOICES - WITH EDIT FUNCTIONALITY
   =========================================================== */
function setupInvoices(){
  byId('btn-new-invoice')?.addEventListener('click', ()=> showInvoiceForm());
  byId('btn-recalc-inv')?.addEventListener('click', ()=>{ recalcInvoiceStatuses(); renderInvoiceList(); showToast('Stati ricalcolati ✅'); });
  byId('inv-search')?.addEventListener('input', debounce(renderInvoiceList,150));
  ['inv-status','inv-date-from','inv-date-to'].forEach(id=> byId(id)?.addEventListener('change', renderInvoiceList));
  renderInvoiceList();
}
function showInvoiceForm(invoice=null){
  const c = byId('inv-detail'); const t = byId('tpl-invoice-form'); if(!c||!t) return;
  c.innerHTML=''; c.appendChild(t.content.cloneNode(true));
  byId('inv-date').valueAsDate = new Date(); byId('inv-due').valueAsDate = new Date(Date.now()+1000*60*60*24*30);
  // Populate site selector
  const siteSel = byId('inv-site-select');
  if (siteSel) {
    const opts = ['<option value="">Nessuno</option>', ...(state.sites||[]).map(s=> `<option value="${s.id}">${h(s.name)}</option>`)];
    siteSel.innerHTML = opts.join('');
  }
  if(invoice){
    byId('inv-number').value=invoice.number||''; byId('inv-date').value=invoice.date||''; byId('inv-due').value=invoice.dueDate||''; byId('inv-customer').value=invoice.customer||''; byId('inv-subject').value=invoice.subject||''; byId('inv-amount').value=invoice.amount||''; byId('inv-vat').value=invoice.vat||''; byId('inv-status-field').value=invoice.status||'draft';
    if(siteSel) siteSel.value = invoice.siteId || '';
  }else{
    const next = (state.invoices.length + 1).toString().padStart(3,'0'); byId('inv-number').value = `INV-${new Date().getFullYear()}-${next}`;
    if(!byId('inv-vat').value) byId('inv-vat').value = state.settings.vat || 8.1;
  }
  byId('invoice-form')?.addEventListener('submit', e=>{
    e.preventDefault();
    const inv = { id: invoice? invoice.id : id(), number: byId('inv-number').value.trim(), date: byId('inv-date').value, dueDate: byId('inv-due').value, customer: byId('inv-customer').value.trim(), subject: byId('inv-subject').value.trim(), amount: safeNum(byId('inv-amount').value), vat: safeNum(byId('inv-vat').value) || state.settings.vat, status: byId('inv-status-field').value, siteId: (byId('inv-site-select')?.value||'') || null, createdAt: invoice? invoice.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() };
    if(invoice){ const idx = state.invoices.findIndex(i=> i.id===invoice.id); if(idx>-1) state.invoices[idx]=inv; } else state.invoices.push(inv);
    afterStateChange(); renderInvoiceList(); showInvoiceDetail(inv.id); showToast(`Fattura ${invoice?'aggiornata':'creata'} ✅`,'success');
  });
  byId('btn-inv-cancel')?.addEventListener('click', ()=> invoice? showInvoiceDetail(invoice.id) : c.innerHTML='<div class="muted">Seleziona una fattura o creane una nuova.</div>');
  byId('btn-inv-duplicate')?.addEventListener('click', ()=>{ const clone = invoice? {...invoice, id:id(), number: invoice.number+'-COPY', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()} : null; if(clone){ state.invoices.push(clone); afterStateChange(); renderInvoiceList(); showInvoiceDetail(clone.id); showToast('Fattura duplicata ✅'); } });
}
function renderInvoiceList(){
  const c = byId('inv-list'); if(!c) return;

  const q = (byId('inv-search')?.value || '').toLowerCase();
  const status = byId('inv-status')?.value || '';
  const dateFrom = byId('inv-date-from')?.value || '';
  const dateTo = byId('inv-date-to')?.value || '';

  const items = (state.invoices||[]).filter(inv=>{
    const text = `${inv.number||''} ${inv.customer||''} ${inv.subject||''}`.toLowerCase();
    if(q && !text.includes(q)) return false;
    if(status && inv.status !== status) return false;
    if(dateFrom && (inv.date||'') < dateFrom) return false;
    if(dateTo && (inv.date||'') > dateTo) return false;
    return true;
  }).sort((a,b)=>{
    const da = a.date||''; const db = b.date||'';
    if(da !== db) return db.localeCompare(da);
    return (b.createdAt||'').localeCompare(a.createdAt||'');
  });

  const MAX_ROWS = 500;
  const visible = items.slice(0, MAX_ROWS);

  const statusLabel = (st)=>({draft:'Bozza', issued:'Emessa', partial:'Parziale', paid:'Pagata', overdue:'Scaduta', canceled:'Annullata'})[st] || st || '—';

  c.innerHTML = visible.length ? visible.map(inv=>{
    const netMinor = Money.toMinor(inv.amount);
    const vatMinor = Money.mulPct(netMinor, inv.vat ?? state.settings.vat ?? 0);
    const totalMinor = Money.add(netMinor, vatMinor);
    const paidMinor = (state.payments||[]).filter(p=> p.invoiceId===inv.id).reduce((s,p)=> Money.add(s, Money.toMinor(p.amount)), 0);
    const dueMinor = Math.max(0, Money.sub(totalMinor, paidMinor));
    const dueLabel = dueMinor>0 ? `Da incassare ${Money.format(dueMinor)}` : 'Saldo ok';
    const date = inv.date ? new Date(inv.date).toLocaleDateString('it-CH') : '—';
    return `<div class="card" data-id="${inv.id}" style="padding:.8rem; display:grid; grid-template-columns:1fr auto; gap:.35rem">
      <div>
        <div style="font-weight:800">${h(inv.number||'—')}</div>
        <div class="muted" style="font-size:.85rem">${date} · ${h(inv.customer||'Cliente')}</div>
        ${inv.subject ? `<div class="muted" style="font-size:.85rem">${h(inv.subject)}</div>` : ''}
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${Money.format(totalMinor)}</div>
        <div class="muted" style="font-size:.8rem">${dueLabel}</div>
        <div class="status st-${inv.status||'draft'}" style="margin-top:.25rem">${statusLabel(inv.status)}</div>
      </div>
    </div>`;
  }).join('') : `<div class="empty">Nessuna fattura</div>`;

  if (items.length > MAX_ROWS) {
    c.insertAdjacentHTML('beforeend', `<div class="muted" style="padding:.6rem">Mostrati ${MAX_ROWS} di ${items.length}. Raffina la ricerca.</div>`);
  }

  c.querySelectorAll('[data-id]')?.forEach(el=> el.addEventListener('click', ()=> showInvoiceDetail(el.dataset.id)));
  renderPageRecap('invoices');
}
function showInvoiceDetail(id){
  const c = byId('inv-detail'); const i = state.invoices.find(x=> x.id===id); if(!c||!i) return;
  // >>> PATCH: calcoli fattura in minor
  const net = Money.toMinor(i.amount);
  const taxMinor = Money.mulPct(net, i.vat);
  const totalMinor = Money.add(net, taxMinor);
  const linked = state.payments.filter(p => p.invoiceId === i.id);
  const paidMinor = linked.reduce((s, p) => Money.add(s, Money.toMinor(p.amount)), 0);
  const dueMinor = Math.max(0, Money.sub(totalMinor, paidMinor));
  c.innerHTML = `
    <div class="detail-section">
      <h3>${i.number}</h3>
      <div class="row two">
        <div><span class="muted">Cliente:</span> <b>${i.customer||'—'}</b></div>
        <div><span class="muted">Cantiere:</span> <b>${(i.siteId && (state.sites.find(s=>s.id===i.siteId)?.name || '—')) || '—'}</b></div>
        <div><span class="muted">Oggetto:</span> <b>${i.subject||'—'}</b></div>
        <div><span class="muted">Data:</span> <b>${new Date(i.date).toLocaleDateString('it-CH')}</b></div>
        <div><span class="muted">Scadenza:</span> <b>${new Date(i.dueDate).toLocaleDateString('it-CH')}</b></div>
        <div><span class="muted">Imponibile:</span> <b>${Money.format(net)}</b></div>
        <div><span class="muted">IVA:</span> <b>${Money.format(taxMinor)} (${(i.vat??0)}%)</b></div>
        <div><span class="muted">Totale:</span> <b>${Money.format(totalMinor)}</b></div>
        <div><span class="muted">Stato:</span> <span class="status st-${i.status}">${({draft:'Bozza', issued:'Emessa', partial:'Parziale', paid:'Pagata', overdue:'Scaduta', canceled:'Annullata'})[i.status]||i.status}</span></div>
      </div>
      <div style="margin-top:.5rem" class="${Money.fromMinor(dueMinor)>0?'':'muted'}"><span class="muted">Pagato:</span> <b>${Money.format(paidMinor)}</b> · <span class="muted">Residuo:</span> <b>${Money.format(dueMinor)}</b></div>
      <div class="detail-actions" style="margin-top:1rem; display:flex; gap:.5rem">
        <button class="btn btn-primary" onclick="showInvoiceFormById('${i.id}')">Modifica</button>
        <button class="btn btn-ghost" onclick="deleteInvoice('${i.id}')">Elimina</button>
        ${i.status!=='paid' ? `<button class="btn btn-success" onclick="registerInvoicePayment('${i.id}')">Registra incasso</button>` : ``}
      </div>
      <div style="margin-top:1rem">
  <h3>Incassi collegati</h3>
        ${linked.length? `<div style="max-height:200px; overflow:auto; border:1px solid var(--border); border-radius:10px">
          <table><thead><tr><th>Data</th><th>Metodo</th><th>Riferimento</th><th class="right">Importo</th></tr></thead><tbody>
            ${linked.map(p=> `<tr><td>${new Date(p.date).toLocaleDateString('it-CH')}</td><td>${({bank:'Bonifico',cash:'Contanti',card:'Carta',other:'Altro'})[p.method]||p.method}</td><td>${p.reference||'—'}</td><td class="right">${Money.format(Money.toMinor(p.amount))}</td></tr>`).join('')}
          </tbody></table>
  </div>` : `<div class="muted">Nessun incasso collegato</div>`}
      </div>
    </div>`;
}
function registerInvoicePayment(invId){
  const inv = state.invoices.find(x=> x.id===invId); if(!inv){ showToast('Fattura non trovata','error'); return; }
  const grossMinor = invoiceGrossMinor(inv);
  const alreadyMinor = (state.payments||[]).filter(p=> p.invoiceId===inv.id)
                        .reduce((s,p)=> Money.add(s, Money.toMinor(p.amount||0)),0);
  const residualMinor = Math.max(0, Money.sub(grossMinor, alreadyMinor));
  if(residualMinor<=0){ showToast('Niente da incassare','info'); return; }

  const pay = {
    id: id(),
    date: Dates.todayISO(),
    amount: Money.fromMinor(residualMinor),
    method: 'bank',
    reference: `AUTO ${inv.number||inv.id}`,
    note: 'Generato da fattura',
    invoiceId: inv.id,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  state.payments.push(pay);
  recalcInvoiceStatuses();
  afterStateChange();
  renderPaymentList();
  renderInvoiceList();
  showInvoiceDetail(inv.id);
  showToast('Incasso registrato ✅','success');
}
window.editInvoice = (id)=>{
  const i = state.invoices.find(x=>x.id===id); if(!i) return;
  showInvoiceForm(i);
};
function recalcInvoiceStatuses(){
  const nowISO = new Date().toISOString().slice(0,10);
  state.invoices.forEach(i=>{
    if(i.status==='canceled' || i.status==='draft') return;
    const total = i.amount*(1+(i.vat/100));
    const paid = state.payments.filter(p=> p.invoiceId===i.id).reduce((s,p)=> s + safeNum(p.amount), 0);
    const due = Math.max(0, total - paid);
    if(due<=0){ i.status='paid'; }
    else if(paid>0){ i.status='partial'; }
    else { i.status = (i.dueDate && i.dueDate < nowISO) ? 'overdue' : 'issued'; }
    i.updatedAt = new Date().toISOString();
  });
  afterStateChange();
}
window.deleteInvoice = (id)=>{ if(!confirm('Eliminare la fattura selezionata?')) return; if(state.payments.some(p=> p.invoiceId===id)){ showToast('Avviso: ci sono pagamenti collegati. Rimangono scollegati.','info'); } state.invoices = state.invoices.filter(i=> i.id!==id); state.payments = state.payments.map(p=> (p.invoiceId===id)? {...p, invoiceId:null}:p); afterStateChange(); renderInvoiceList(); byId('inv-detail').innerHTML='<div class="muted">Seleziona una fattura o creane una nuova.</div>'; showToast('Fattura eliminata','success'); }

/* ===========================================================
   PAYMENTS
   =========================================================== */
function setupPayments(){
  byId('btn-new-payment')?.addEventListener('click', ()=> showPaymentForm());
  byId('btn-match')?.addEventListener('click', ()=>{ autoMatchPayments(); renderPaymentList(); showToast('Tentativo di abbinamento completato ✅'); });
  byId('pay-search')?.addEventListener('input', debounce(renderPaymentList,150));
  ;['pay-method','pay-date-from','pay-date-to'].forEach(id=> byId(id)?.addEventListener('change', renderPaymentList));
  renderPaymentList();
}

function setupOverdue(){
  byId('btn-ovd-reminders')?.addEventListener('click', ()=>{
    const items = state.invoices.filter(i=> isInvoiceOverdue(i));
    if(!items.length){ showToast('Nessuna fattura scaduta','info'); return; }
    items.slice(0,5).forEach(i=>{ try{ window.open(`mailto:?subject=${encodeURIComponent('Richiamo pagamento fattura '+(i.number||i.id))}&body=${encodeURIComponent('Gentile cliente,\n\nriguardo la fattura '+(i.number||i.id)+' scaduta il '+(new Date(i.dueDate||i.due||i.scadenza).toLocaleDateString('it-CH'))+'.\nVi preghiamo di provvedere al pagamento.\n\nGrazie.')}`,'_blank'); }catch(_){} });
    showToast('Aperte bozze email per i primi elementi','success');
  });
  byId('btn-ovd-copy')?.addEventListener('click', ()=>{
    const items = state.invoices.filter(i=> isInvoiceOverdue(i));
    const lines = items.map(i=>{
      const due = new Date(i.dueDate||i.due||i.scadenza);
      const gross = safeNum(i.amount)*(1+(safeNum(i.vat)/100));
      return `${i.number||i.id} | ${i.customer||i.cliente||'Cliente'} | Scadenza ${isNaN(+due)?'—':due.toLocaleDateString('it-CH')} | ${formatCurrency(gross)}`;
    }).join('\n');
    navigator.clipboard?.writeText(lines).then(()=> showToast('Elenco copiato negli appunti ✅','success')).catch(()=> showToast('Impossibile copiare','error'));
  });
  byId('btn-send-reminders')?.addEventListener('click', ()=>{ goTo('overdue'); });
  renderOverdueInvoices();
  renderOverdueExpenses();
}

/* ===========================================================
   SPese (Expenses)
   =========================================================== */
function setupExpenses(){
  byId('btn-new-expense')?.addEventListener('click', ()=>{ goTo('expenses'); showExpenseForm(); });

  ['ex-search','ex-rec','ex-date-from','ex-date-to'].forEach(id=>{
    const el = byId(id);
    if(el){ el.addEventListener('input', renderExpenseList); el.addEventListener('change', renderExpenseList); }
  });
  byId('ex-list')?.addEventListener('click', (e)=>{
    const row = e.target.closest('[data-id]');
    if(row) showExpenseDetail(row.dataset.id);
  });

  renderExpenseForecast();
  renderExpenseList();
  renderExpensesTimeline();
  renderExpensePaidRegistered();
  renderExpensesSummary();
}

/* ===================== AGENDA (monthly) ===================== */
let __agMonth = null; // Date del primo giorno mese corrente agenda

function agendaInit(){
  updateAgendaSelectors();
  collabPickerInitForAgenda();
  byId('ag-save')?.addEventListener('click', saveAppointment);
  byId('ag-reset')?.addEventListener('click', resetEditor);
  initAgendaMatrix();
  initSlotsCard();
  resetEditor();
}

/* ---------- helpers ---------- */
function firstOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function addMonths(d, n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
function agAddDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function pad2(n){return String(n).padStart(2,'0');}
function toISODate(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
function toWeekNumber(d){ // ISO week
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date - yearStart) / 86400000) + 1)/7);
}
function shiftMonth(n){ __agMonth = addMonths(__agMonth, n); renderAgendaMonth(); }

function updateAgendaSelectors(){
  const siteSel = byId('ag-site');
  if(siteSel) siteSel.innerHTML = (state.sites||[]).map(s=>`<option value="${s.id}">${h(s.name)}</option>`).join('');
}

/* ---------- collab picker per agenda ---------- */
function collabPickerInitForAgenda(){
  const dd  = byId('ag-collab-dd');
  const box = byId('ag-collab-picker');
  const inp = byId('ag-collab-search');
  if(!box) return;
  box.dataset.selected = JSON.stringify([]);
  function renderDropdown(q=''){
    const needle = q.trim().toLowerCase();
  const data = getCollaboratorsSorted().filter(c => c.name.toLowerCase().includes(needle) || (c.role||'').toLowerCase().includes(needle));
    dd.innerHTML = data.length ? data.map(c=>`
      <div class="collab-row" data-id="${c.id}">
        <input type="checkbox"> <span>${h(c.name)}</span> <span class="muted">${h(c.role||'')}</span>
      </div>`).join('') : `<div class="muted" style="padding:.6rem">Nessun risultato</div>`;
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    dd.querySelectorAll('.collab-row').forEach(r=>{
      r.querySelector('input').checked = sel.has(r.dataset.id);
      r.addEventListener('click', ()=> toggle(r.dataset.id));
    });
  }
  function paintChips(){
    box.querySelectorAll('.collab-chip').forEach(e=>e.remove());
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    [...sel].forEach(id=>{
      const c = state.collaborators.find(x=>x.id===id);
      const chip = document.createElement('span');
      chip.className='collab-chip';
      chip.innerHTML = `${h(c?c.name:'N/D')} <button title="Rimuovi">×</button>`;
      chip.querySelector('button').onclick = ()=> remove(id);
      box.insertBefore(chip, inp);
    });
  }
  function toggle(id){
    const sel = new Set(JSON.parse(box.dataset.selected||'[]'));
    sel.has(id) ? sel.delete(id) : sel.add(id);
    box.dataset.selected = JSON.stringify([...sel]);
    paintChips(); renderDropdown(inp.value);
    debounceCheckConflict();
  }
  function remove(id){
    const sel = new Set(JSON.parse(box.dataset.selected||'[]')); sel.delete(id);
    box.dataset.selected = JSON.stringify([...sel]);
    paintChips(); renderDropdown(inp.value); debounceCheckConflict();
  }
  inp.addEventListener('focus', ()=>{ dd.style.display='block'; renderDropdown(inp.value); });
  inp.addEventListener('input', ()=> renderDropdown(inp.value));
  document.addEventListener('mousedown', (e)=>{ if(!box.contains(e.target)) dd.style.display='none'; });

  box.getSelectedIds = ()=> JSON.parse(box.dataset.selected||'[]');
  box.setSelectedIds = (ids=[])=>{ box.dataset.selected = JSON.stringify(ids); paintChips(); renderDropdown(inp.value); };

  paintChips();
}
function agPickerGet(){ return byId('ag-collab-picker')?.getSelectedIds()||[]; }

/* ---------- salvataggio e conflitti ---------- */
function saveAppointment(){
  const date = byId('ag-date').value;
  const from = byId('ag-from').value;
  const to   = byId('ag-to').value;
  const siteId = byId('ag-site').value;
  const desc = byId('ag-desc').value.trim();
  const color = byId('ag-color').value || '#4da3ff';
  const collabIds = agPickerGet();
  if(!date || !from || !to || !desc){ showToast('Compila data, orario e descrizione'); return; }

  const editId = byId('ag-edit-id').value || null;
  const nowIso = new Date().toISOString();

  state.agenda = state.agenda || [];
  const payload = { id: editId || id(), date, from, to, siteId, desc, color, collabIds, createdAt: nowIso };

  if (editId){
    const i = state.agenda.findIndex(x=> x.id===editId);
    if(i>-1){
      const prev = state.agenda[i];
      state.agenda[i] = { ...payload, createdAt: prev.createdAt || nowIso, updatedAt: nowIso };
      showToast('Appuntamento aggiornato ✅','success');
    }else{
      state.agenda.push(payload);
      showToast('Appuntamento salvato ✅','success');
    }
  } else {
    state.agenda.push(payload);
    showToast('Appuntamento salvato ✅','success');
  }

  afterStateChange();
  resetEditor();
  renderAgendaMatrixWeek();
}
function resetEditor(){
  byId('ag-edit-id').value = '';
  byId('ag-date').value = toISODate(new Date());
  byId('ag-from').value = '08:00';
  byId('ag-to').value   = '12:00';
  byId('ag-desc').value = '';
  if(byId('ag-color')) byId('ag-color').value = '#4da3ff';
  const siteSel = byId('ag-site');
  if(siteSel && siteSel.options.length){
    siteSel.value = siteSel.options[0].value;
  }
  byId('ag-collab-picker')?.setSelectedIds([]);
  const btnDel = byId('ag-delete');
  if(btnDel){
    btnDel.style.display = 'none';
    btnDel.onclick = null;
  }
  const conflictBox = byId('ag-conflict');
  if(conflictBox){
    conflictBox.style.display='none';
    conflictBox.textContent='';
  }
}
function conflictCheck(app, list){
  const sameDay = (list||[]).filter(x=> x.date===app.date);
  const o2n = (t)=> Number(t.replace(':',''));
  const A1=o2n(app.from), A2=o2n(app.to);
  const hits=[];
  sameDay.forEach(x=>{
    const B1=o2n(x.from), B2=o2n(x.to);
    const overlap = (A1 < B2) && (B1 < A2);
    if(!overlap) return;
    // se condividono almeno un collaboratore
    const inter = (x.collabIds||[]).filter(id=> (app.collabIds||[]).includes(id));
    if(inter.length) hits.push({with:x, collabs:inter});
  });
  return hits;
}
const debounceCheckConflict = debounce(()=> {
  const app = {
    date: byId('ag-date').value,
    from: byId('ag-from').value,
    to  : byId('ag-to').value,
    collabIds: agPickerGet()
  };
  const hits = conflictCheck(app, state.agenda||[]);
  showConflict(hits);
}, 150);

function showConflict(hits){
  const box=byId('ag-conflict');
  if(!hits || !hits.length){ box.style.display='none'; box.textContent=''; return; }
  const render = hits.map(h=>{
    const names = (h.collabs||[]).map(id=> (state.collaborators.find(c=>c.id===id)?.name)||'').join(', ');
    return `Sovrapposizione con: ${h.with.date} ${h.with.from}-${h.with.to} (${names})`;
  }).join('\n');
  box.textContent = render; box.style.display='block';
}

/* ---------- rendering calendario mensile ---------- */
function renderAgendaMonth(){
  const grid = byId('ag-grid'); if(!grid) return;
  const title = byId('ag-title');
  const filtersBox = byId('ag-filters');
  const month = __agMonth;

  const monthLabel = month.toLocaleDateString('it-CH',{month:'long', year:'numeric'});
  title.textContent = monthLabel.charAt(0).toUpperCase()+monthLabel.slice(1);

  // filtri collaboratori
  if(filtersBox){
    const selected = new Set(JSON.parse(localStorage.getItem('ag-filters')||'[]'));
    filtersBox.innerHTML = (state.collaborators||[]).map(c=>{
      const on = selected.has(c.id);
      return `<label class="pill" style="cursor:pointer">
        <input data-id="${c.id}" type="checkbox" ${on?'checked':''}> ${h(c.name)}
      </label>`;
    }).join('');
    filtersBox.querySelectorAll('input').forEach(i=>{
      i.addEventListener('change', ()=>{
        const s = new Set(JSON.parse(localStorage.getItem('ag-filters')||'[]'));
        i.checked ? s.add(i.dataset.id) : s.delete(i.dataset.id);
        localStorage.setItem('ag-filters', JSON.stringify([...s]));
        renderAgendaMonth();
        renderAgendaMatrixWeek();
      });
    });
  }
  const sel = new Set(JSON.parse(localStorage.getItem('ag-filters')||'[]'));
  const showAll = !sel.size;

  const first = firstOfMonth(month);
  const start = new Date(first); start.setDate(1 - ((first.getDay()+6)%7)); // lunedì precedente
  const cells = [];
  for(let i=0;i<42;i++){ // 6 settimane
    const d = new Date(start); d.setDate(start.getDate()+i); cells.push(d);
  }

  grid.innerHTML = cells.map(d=>{
    const iso = toISODate(d);
    const isOther = d.getMonth()!==month.getMonth();
    return `<div class="ag-day ${isOther?'muted':''}" data-date="${iso}">
      <div class="head"><span>${d.getDate()}</span><span>W${toWeekNumber(d)}</span></div>
      <div class="body"></div>
    </div>`;
  }).join('');

  const list = (state.agenda||[]).slice().sort((a,b)=> (a.date+a.from).localeCompare(b.date+b.from));
  list.forEach(ev=>{
    const cell = grid.querySelector(`.ag-day[data-date="${ev.date}"] .body`); if(!cell) return;
    // filtro collab
    if(!showAll && !(ev.collabIds||[]).some(id=> sel.has(id))) return;

    const collabNames = (ev.collabIds||[]).map(id=> (state.collaborators.find(c=>c.id===id)?.name)||'').join(', ');
    const siteName = state.sites.find(s=>s.id===ev.siteId)?.name || '';
    const div = document.createElement('div');
    div.className='ag-ev';
    div.style.background = hexToRGBA(ev.color||'#4da3ff', .12);
    div.style.borderColor = ev.color||'#4da3ff';
    div.innerHTML = `<span class="ag-tag" style="background:${ev.color||'#4da3ff'}"></span>
      <b>${ev.from}-${ev.to}</b> ${h(siteName)}<br><span class="muted">${h(collabNames)}</span>`;
    cell.appendChild(div);
  });

  // segnala conflitti nel mese (per i collab visibili)
  markOverlaps(grid, list, showAll?null:sel);
  renderAgendaMatrixWeek();
}
function markOverlaps(grid, list, sel){
  const byDay = {};
  list.forEach(e=>{ (byDay[e.date]=byDay[e.date]||[]).push(e); });
  Object.entries(byDay).forEach(([date,arr])=>{
    for(let i=0;i<arr.length;i++){
      for(let j=i+1;j<arr.length;j++){
        const A=arr[i], B=arr[j];
        const inter = (A.collabIds||[]).filter(id=> (B.collabIds||[]).includes(id));
        if(sel && !inter.some(id=> sel.has(id))) continue; // nessun collab visibile
        if(overlap(A.from,A.to,B.from,B.to)){
          // marca le card
          const cell = grid.querySelector(`.ag-day[data-date="${date}"] .body`);
          [...cell.children].forEach(div=>{
            const txt = div.textContent||'';
            if(txt.includes(`${A.from}-${A.to}`) || txt.includes(`${B.from}-${B.to}`)) div.classList.add('overlap');
          });
        }
      }
    }
  });
}
function overlap(a1,a2,b1,b2){
  const n=(t)=>Number(t.replace(':',''));
  return (n(a1)<n(b2)) && (n(b1)<n(a2));
}
function hexToRGBA(hex, a){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex||'#4da3ff');
  const r = parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
  return `rgba(${r},${g},${b},${a})`;
}

/* === Helpers settimana (lunedì-first) === */
function mxStartOfWeek(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const w = (x.getDay() + 6) % 7;
  x.setDate(x.getDate()-w);
  x.setHours(0,0,0,0);
  return x;
}
function mxDaysOfWeek(anchorDate){ const a = mxStartOfWeek(anchorDate); return Array.from({length:7},(_,i)=> new Date(a.getFullYear(), a.getMonth(), a.getDate()+i)); }
function mxIso(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

function mxSelectedCollaborators(){
  return getCollaboratorsSorted();
}

let __mxWeek = null;
function renderAgendaMatrixWeek(){
  const table = byId('ag-matrix'); const title = byId('mx-title');
  if(!table || !title) return;
  const now = new Date();
  const week = __mxWeek || mxStartOfWeek(now);
  __mxWeek = week;
  if(typeof __slWeek !== 'undefined'){ __slWeek = new Date(week); }

  const days = mxDaysOfWeek(week);
  const cols = mxSelectedCollaborators();
  title.textContent = `${days[0].toLocaleDateString('it-CH')} – ${days[6].toLocaleDateString('it-CH')}`;

  const idx = new Map();
  (state.agenda||[]).forEach(ev=>{
    const iso = String(ev.date||'').slice(0,10);
    if(!days.some(d=> mxIso(d)===iso)) return;
    const mapDay = idx.get(iso) || new Map();
    (ev.collabIds||[]).forEach(cid=>{
      const arr = mapDay.get(cid)||[];
      arr.push(ev); mapDay.set(cid, arr);
    });
    idx.set(iso, mapDay);
  });

  let html = `<thead><tr>
      <th class="ag-matrix-stickycol">Giorno</th>
      ${cols.map(c=> `<th class="ag-collab-head">${h(c.name)}</th>`).join('')}
    </tr></thead><tbody>`;

  days.forEach(d=>{
    const iso = mxIso(d);
    html += `<tr>
      <th class="ag-matrix-stickycol"><div><div style="font-weight:800">${d.toLocaleDateString('it-CH',{weekday:'short'})}</div><div class="muted">${d.getDate()}/${d.getMonth()+1}</div></div></th>
      ${cols.map(c=>{
        const evs = (idx.get(iso)?.get(c.id) || []).slice().sort((a,b)=> String(a.from).localeCompare(String(b.from)));
        const pills = evs.map(ev=>{
          const s = state.sites.find(x=> x.id===ev.siteId);
          const site = s ? s.name : '';
          const color = ev.color || '#4da3ff';
          const from = ev.from || '';
          const to   = ev.to   || '';
          const desc = ev.desc ? h(ev.desc) : '';

          return `<span class="ag-pill" data-eid="${h(ev.id)}"
               style="border-color:${color};background:${hexToRGBA(color,.10)}"
               title="${h(ev.desc||'')}">
            <div><span class="time">${from}${to?('–'+to):''}</span>
                 ${site? `<span class="site">${h(site)}</span>`:''}</div>
            ${desc ? `<div class="muted" style="font-size:.8rem;line-height:1.2;margin-top:2px">${desc}</div>` : ''}
          </span>`;
        }).join('') || `<span class="muted">—</span>`;
        return `<td class="daycell">${pills}</td>`;
      }).join('')}
    </tr>`;
  });

  html += `</tbody>`;
  table.innerHTML = html;

  table.querySelectorAll('.ag-pill[data-eid]').forEach(p=>{
    p.addEventListener('click', ()=> openAppointmentEditor(p.getAttribute('data-eid')));
  });
  renderPageRecap('agenda');
  renderSlotsCard();
}

function openAppointmentEditor(evId){
  const ev = (state.agenda||[]).find(x=> x.id === evId);
  if(!ev) return;

  byId('ag-edit-id').value = ev.id;
  byId('ag-date').value = ev.date || '';
  byId('ag-from').value = ev.from || '08:00';
  byId('ag-to').value   = ev.to   || '12:00';
  byId('ag-desc').value = ev.desc || '';
  if (byId('ag-color')) byId('ag-color').value = ev.color || '#4da3ff';

  const siteSel = byId('ag-site');
  if(siteSel){
    if(ev.siteId && [...siteSel.options].some(opt=> opt.value===ev.siteId)){
      siteSel.value = ev.siteId;
    }else if(siteSel.options.length){
      siteSel.value = siteSel.options[0].value;
    }
  }

  byId('ag-collab-picker')?.setSelectedIds(ev.collabIds||[]);

  const btnDel = byId('ag-delete');
  if(btnDel){
    btnDel.style.display = 'inline-block';
    btnDel.onclick = ()=> deleteAppointment(ev.id);
  }

  document.querySelector('.ag-form')?.scrollIntoView({behavior:'smooth', block:'start'});
}

function deleteAppointment(evId){
  if(!confirm('Eliminare questo appuntamento?')) return;
  state.agenda = (state.agenda||[]).filter(x=> x.id !== evId);
  afterStateChange();
  resetEditor();
  renderAgendaMatrixWeek();
  showToast('Appuntamento eliminato ✅','success');
}

function initAgendaMatrix(){
  __mxWeek = mxStartOfWeek(new Date());
  byId('mx-prev')?.addEventListener('click', ()=>{ __mxWeek.setDate(__mxWeek.getDate()-7); renderAgendaMatrixWeek(); });
  byId('mx-next')?.addEventListener('click', ()=>{ __mxWeek.setDate(__mxWeek.getDate()+7); renderAgendaMatrixWeek(); });
  byId('mx-today')?.addEventListener('click', ()=>{ __mxWeek = mxStartOfWeek(new Date()); renderAgendaMatrixWeek(); });
  byId('mx-toggle')?.addEventListener('change', renderAgendaMatrixWeek);
  byId('mx-switch')?.addEventListener('click', ()=>{
    document.getElementById('ag-grid')?.scrollIntoView({behavior:'smooth', block:'start'});
  });
  renderAgendaMatrixWeek();
}

/* ===== SLOT LIBERI (settimana) - PER RUOLO ===== */
const SESSIONS = [
  { key:'am', label:'08-12', from:'08:00', to:'12:00' },
  { key:'pm', label:'13-17', from:'13:00', to:'17:00' },
];
const WORK_DAYS = new Set([1,2,3,4,5]); // lun-ven

let __slWeek = null;
function hhmmToNum(t){ return Number(String(t||'00:00').replace(':','')); }
function timeOverlap(a1,a2,b1,b2){ const A1=hhmmToNum(a1), A2=hhmmToNum(a2), B1=hhmmToNum(b1), B2=hhmmToNum(b2); return (A1 < B2) && (B1 < A2); }

function renderSlotsCard(){
  const title = byId('sl-title'), line = byId('sl-line'), sub = byId('sl-sub'), table = byId('sl-table');
  if(!title || !line || !sub || !table) return;

  __slWeek = __slWeek || mxStartOfWeek(new Date());
  const allDays = mxDaysOfWeek(__slWeek);
  const days = allDays.filter(d => WORK_DAYS.has(d.getDay()));
  const collabs = getCollaboratorsSorted();

  const byDay = new Map();
  (state.agenda||[]).forEach(ev=>{
    const iso = String(ev.date||'').slice(0,10);
    if(!iso) return;
    const list = byDay.get(iso);
    if(list) list.push(ev); else byDay.set(iso, [ev]);
  });

  table.innerHTML = `
    <thead>
      <tr>
        <th>Sessione · Ruolo</th>
        ${days.map(d=>`<th>${d.toLocaleDateString('it-CH',{weekday:'short', day:'2-digit', month:'2-digit'})}</th>`).join('')}
      </tr>
    </thead>
    <tbody id="sl-tbody"></tbody>
  `;

  const roles = ['Operaio','Direzione','Apprendista','Altro']; // usa roleBucket()
  const body = table.querySelector('#sl-tbody');

  let totCap = 0, totUsed = 0;
  const collabsByRole = new Map();
  roles.forEach(role=>{
    collabsByRole.set(role, collabs.filter(c => roleBucket(c.role)===role));
  });

  SESSIONS.forEach(sess=>{
    roles.forEach(role=>{
      let cells = '';
      const group = collabsByRole.get(role) || [];
      days.forEach(d=>{
        const iso = mxIso(d);
        const items = byDay.get(iso) || [];
        const cap = group.length;
        let used = 0;
        group.forEach(c=>{
          const busy = items.some(ev=>{
            if(!Array.isArray(ev.collabIds) || !ev.collabIds.includes(c.id)) return false;
            return timeOverlap(sess.from, sess.to, ev.from||'00:00', ev.to||'00:00');
          });
          if(busy) used++;
        });
        const free = Math.max(0, cap - used);
        totCap += cap;
        totUsed += used;
        cells += `<td>${free} / ${cap}</td>`;
      });
      body.insertAdjacentHTML('beforeend',
        `<tr><td style="text-align:left"><b>${sess.label}</b> · ${role}</td>${cells}</tr>`
      );
    });
  });

  const totFree = Math.max(0, totCap - totUsed);
  const perc = totCap>0 ? (totFree/totCap*100).toFixed(1) : '0.0';

  if(days.length){
    const lastDay = days[days.length-1];
    title.textContent = `${days[0].toLocaleDateString('it-CH')} – ${lastDay.toLocaleDateString('it-CH')}`;
  }else{
    title.textContent = '—';
  }
  line.textContent = `Liberi: ${totFree} / ${totCap}`;
  sub.textContent = `Occupati: ${totUsed} · Capacità: ${totCap} · Libero: ${perc}%`;
}

function initSlotsCard(){
  const goToWeek = (base)=>{
    const next = mxStartOfWeek(base instanceof Date ? base : new Date(base));
    __slWeek = new Date(next);
    __mxWeek = new Date(next);
    renderAgendaMatrixWeek();
  };

  byId('sl-prev')?.addEventListener('click', ()=>{
    const ref = __slWeek instanceof Date ? new Date(__slWeek) : new Date();
    ref.setDate(ref.getDate()-7);
    goToWeek(ref);
  });
  byId('sl-next')?.addEventListener('click', ()=>{
    const ref = __slWeek instanceof Date ? new Date(__slWeek) : new Date();
    ref.setDate(ref.getDate()+7);
    goToWeek(ref);
  });
  byId('sl-today')?.addEventListener('click', ()=>{
    goToWeek(new Date());
  });

  const base = __mxWeek instanceof Date ? __mxWeek : mxStartOfWeek(new Date());
  __slWeek = new Date(base);
  renderSlotsCard();
}

const _saveAppointment_orig = window.saveAppointment;
if(typeof _saveAppointment_orig === 'function'){
  window.saveAppointment = function(...args){
    const r = _saveAppointment_orig.apply(this, args);
    try{ renderSlotsCard(); }catch(_){ }
    return r;
  };
}
const _deleteAppointment_orig = window.deleteAppointment;
if(typeof _deleteAppointment_orig === 'function'){
  window.deleteAppointment = function(...args){
    const r = _deleteAppointment_orig.apply(this, args);
    try{ renderSlotsCard(); }catch(_){ }
    return r;
  };
}

/* ---------- Export PDF settimanale ---------- */
function exportAgendaWeeklyPDF(){
  // settimana della cella selezionata o della data odierna
  const base = new Date(__agMonth);
  const now = new Date();
  const weekRef = (now.getMonth()===base.getMonth() ? now : base);
  const monday = new Date(weekRef); monday.setDate(weekRef.getDate() - ((weekRef.getDay()+6)%7));

  const rows=[];
  for(let i=0;i<7;i++){
    const d=new Date(monday); d.setDate(monday.getDate()+i);
    const iso=toISODate(d);
    const items=(state.agenda||[]).filter(x=>x.date===iso).sort((a,b)=>a.from.localeCompare(b.from));
    const line = [ d.toLocaleDateString('it-CH',{weekday:'short',day:'2-digit',month:'2-digit'}) ];
    items.forEach(ev=>{
      const names = (ev.collabIds||[]).map(id=> (state.collaborators.find(c=>c.id===id)?.name)||'').join(',');
      const site  = state.sites.find(s=>s.id===ev.siteId)?.name || '';
      line.push(`${ev.from}-${ev.to} ${site} [${names}] ${ev.desc}`);
    });
    rows.push(line.join('  •  '));
  }
  const header = `Programma settimanale — ${monday.toLocaleDateString('it-CH')} — ${toISODate(agAddDays(monday,6))}\n------------------------------------------------------------\n`;
  const blob = new Blob([header + rows.join('\n')], {type:'application/pdf'}); // testo -> PDF semplificato
  downloadBlob(blob, 'programma_settimanale.pdf');
}

function renderExpenseList(){
  const listEl = byId('ex-list'); if(!listEl) return;
  const q = (byId('ex-search')?.value||'').toLowerCase();
  const rec = byId('ex-rec')?.value||'';
  const df = byId('ex-date-from')?.value||''; const dt = byId('ex-date-to')?.value||'';
  const inRange = (d)=>{
    if(!d) return true; const x = d.slice(0,10);
    if(df && x<df) return false; if(dt && x>dt) return false; return true;
  };
  const rowsAll = (state.expenses||[]).filter(e=>{
    const text = ((e.desc||'')+' '+(e.category||'')).toLowerCase();
    const recOk = !rec || rec===(e.recurring||'none');
    return (!q || text.includes(q)) && recOk && inRange(e.date||'');
  }).sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
  const MAX_ROWS = 500;
  const rows = rowsAll.slice(0, MAX_ROWS);
  listEl.innerHTML = rows.map(e=>{
    const s = e.status||'planned';
    return `<div class="row-list" data-id="${e.id}">
      <div>
        <div><b>${h(e.category)||'Senza categoria'}</b> <span class="muted">${h(e.desc)||''}</span></div>
        <div class="muted">${e.date||''} · ${e.recurring==='none'||!e.recurring?'una tantum':e.recurring}</div>
      </div>
      <div style="text-align:right">
        <div>${Money.format(Money.toMinor(e.amount||0))}</div>
        <div class="muted">${s==='paid'?'Pagato':s==='canceled'?'Annullato':'Programmato'}</div>
      </div>
    </div>`;
  }).join('') || `<div class="muted">Nessuna spesa</div>`;
  if(rowsAll.length>MAX_ROWS){
    listEl.insertAdjacentHTML('beforeend', `<div class="muted" style="padding:.6rem">Mostrati ${MAX_ROWS} di ${rowsAll.length}. Raffina la ricerca.</div>`);
  }
  renderPageRecap('expenses');
}

function renderExpensesTimeline(){
  const box = byId('ex-timeline'); if(!box) return;
  const rows = (state.expenses||[]).slice().sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
  const row = (e)=>`<div class="row-list" data-id="${e.id}">
    <div style="display:grid;grid-template-columns:110px 1fr 140px 140px auto;gap:.5rem;align-items:center">
      <div class="muted">${(e.date||'').slice(0,10)}</div>
      <div><b>${h(e.category||'Senza categoria')}</b> <span class="muted">${h(e.desc||'')}</span></div>
      <div class="muted">${e.recurring && e.recurring!=='none'? e.recurring : 'una tantum'}</div>
      <div class="right"><b>${formatCurrency(e.amount||0)}</b></div>
      <div style="text-align:right;display:flex;gap:.4rem;justify-content:flex-end">
        <button class="btn btn-ghost" data-act="paid">${e.status==='paid'?'Segna non pagata':'Segna pagata'}</button>
        <button class="btn btn-ghost" data-act="cancel">${e.status==='canceled'?'Ripristina':'Annulla'}</button>
      </div>
    </div>
  </div>`;
  box.innerHTML = rows.length? rows.map(row).join('') : `<div class="muted">Nessuna spesa</div>`;
  box.querySelectorAll('[data-id]').forEach(el=>{
    el.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-act]'); if(!btn) return;
      const id = el.dataset.id; const it = (state.expenses||[]).find(x=> String(x.id)===String(id)); if(!it) return;
      const act = btn.dataset.act;
      if(act==='paid'){ it.status = (it.status==='paid' ? 'planned' : 'paid'); }
      if(act==='cancel'){ it.status = (it.status==='canceled' ? 'planned' : 'canceled'); }
      it.updatedAt = new Date().toISOString();
      afterStateChange(); renderExpensesTimeline();
    });
  });
}

function showExpenseForm(expenseId){
  const container = byId('ex-detail'); if(!container) return;
  const tpl = byId('tpl-expense-form');
  if(!tpl){ container.textContent = 'Modulo spesa non disponibile'; return; }
  container.innerHTML = '';
  container.appendChild(tpl.content.cloneNode(true));
  const existing = (expenseId ? state.expenses.find(e=> String(e.id)===String(expenseId)) : null);
  const form = byId('expense-form');
  const dateEl=byId('ex-date'), amountEl=byId('ex-amount'), catEl=byId('ex-category'), statusEl=byId('ex-status'), descEl=byId('ex-desc'), recEl=byId('ex-recurring'), recEndEl=byId('ex-rec-end');
  const anchorEl = byId('ex-anchor'); const domWrap = byId('ex-dom-wrap'); const domEl = byId('ex-day-of-month');
  const occWrap = byId('ex-occ-paid-wrap'); const occChk = byId('ex-occ-paid'); const instEl = byId('ex-instance-date');
  if(existing){
    dateEl.value = existing.date||''; amountEl.value = existing.amount||''; catEl.value = existing.category||''; statusEl.value = existing.status||'planned'; descEl.value = existing.desc||''; recEl.value = existing.recurring||'none'; recEndEl.value = existing.recEnd||'';
    anchorEl.value = existing.anchorDate||existing.date||'';
    domEl.value = existing.dayOfMonth || '';
  }else{
    recEl.value = 'none';
  }
  // toggle day-of-month
  const toggleDOM = ()=>{ domWrap.style.display = (recEl.value==='monthly') ? 'block' : 'none'; };
  toggleDOM();
  recEl.addEventListener('change', toggleDOM);
  // >>> FIX: inizializza anchor coerente con data o oggi
  if(!anchorEl.value) anchorEl.value = (dateEl.value || Dates.todayISO());
  byId('btn-ex-cancel')?.addEventListener('click', ()=>{ container.innerHTML = '<div class="muted">Seleziona o crea una spesa.</div>'; });
  form?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const nowIso = new Date().toISOString();
    const recurring = recEl.value||'none';
    // Build payload
    const payload = {
      id: existing?.id || String(Date.now()),
      date: dateEl.value||'',
      amount: safeNum(amountEl.value),
      category: catEl.value||'',
      status: statusEl.value||'planned',
      desc: descEl.value||'',
      recurring,
      recEnd: recEndEl.value||'',
      createdAt: existing?.createdAt || nowIso,
      updatedAt: nowIso
    };
    if(recurring !== 'none'){
      // Save as series only
      payload.anchorDate = anchorEl.value || payload.date || Dates.todayISO();
      payload.seriesId = existing?.seriesId || payload.id;
      payload.dayOfMonth = safeNum(domEl.value) || (payload.anchorDate ? new Date(payload.anchorDate).getDate() : undefined);
      const prevPaid = Array.isArray(existing?.occurrencesPaid) ? existing.occurrencesPaid : [];
      let paidSet = new Set(prevPaid);
      const instanceDate = instEl.value || '';
      if(occWrap && occWrap.style.display!=='none' && occChk?.checked && instanceDate){
        paidSet.add(String(instanceDate).slice(0,10));
      }
      payload.occurrencesPaid = Array.from(paidSet);
    } else {
      // one-off safety
      payload.seriesId = undefined; payload.anchorDate = undefined; payload.dayOfMonth = undefined; payload.occurrencesPaid = [];
    }
    if(existing){
      const idx = state.expenses.findIndex(e=> String(e.id)===String(existing.id));
      if(idx>=0) state.expenses[idx] = payload;
    }else{
      state.expenses.push(payload);
    }
    afterStateChange();
    renderExpenseList();
    showExpenseDetail(payload.id);
    showToast('Spesa salvata ✅','success');
    try{ renderExpenseForecast(); renderExpensePaidRegistered(); renderExpensesSummary(); renderPageRecap('expenses'); }
    catch(_){ }
  });
}

function showExpenseDetail(id){
  const container = byId('ex-detail'); if(!container) return;
  const e = state.expenses.find(x=> String(x.id)===String(id));
  if(!e){ container.innerHTML = '<div class="muted">Spesa non trovata</div>'; return; }
  container.innerHTML = `
    <div class="row two" style="margin-bottom:.5rem">
      <div><b>${h(e.category)||'Senza categoria'}</b><div class="muted">${h(e.desc)||''}</div></div>
      <div style="text-align:right"><div>${formatCurrency(e.amount||0)}</div><div class="muted">${e.date||''}</div></div>
    </div>
    <div class="muted" style="margin-bottom:.5rem">Stato: ${e.status||'planned'} · Ricorrenza: ${e.recurring||'none'}${e.recEnd?(' fino al '+e.recEnd):''}</div>
    <div style="display:flex; gap:.5rem">
      <button id="btn-ex-edit" class="btn btn-ghost" type="button">Modifica</button>
    </div>
  `;
  byId('btn-ex-edit')?.addEventListener('click', ()=> showExpenseForm(id));
}
// >>> PATCH: Recurring expenses expansion & forecast
function expandRecurringExpenses(startISO, endISO){
  const out = [];
  if(!startISO || !endISO) return out;
  const start = String(startISO).slice(0,10); const end = String(endISO).slice(0,10);
  (state.expenses||[]).forEach(e=>{
    const rec = e.recurring||'none';
    if(rec==='none') return;
    if((e.status||'planned')==='canceled') return; // series canceled
    const seriesId = e.seriesId || e.id;
    const anchor = (e.anchorDate||e.date||'').slice(0,10);
    if(!anchor) return;
    const paidSet = new Set(Array.isArray(e.occurrencesPaid)? e.occurrencesPaid.map(x=> String(x).slice(0,10)) : []);
    const until = (e.recEnd||'').slice(0,10) || null;
    const amount = safeNum(e.amount);
    const category = e.category||'';
    // start from the first occurrence >= start
    let cur = anchor;
    const advance = (iso)=>{
      if(rec==='weekly') return addDaysISO(iso, 7);
      if(rec==='monthly') return addMonthsClamp(iso, 1, e.dayOfMonth || new Date(anchor+'T00:00:00Z').getUTCDate());
      if(rec==='yearly') return addYears(iso, 1);
      return '';
    };
    // fast-forward to >= start
    while(cur < start){
      const next = advance(cur); if(!next) break; cur = next;
      if(until && cur>until) break;
    }
    while(cur && cur <= end){
      if(!until || cur <= until){
        out.push({ seriesId, baseId:e.id, date:cur, amount, category, statusComputed: paidSet.has(cur)? 'paid':'planned', recurring:rec, desc:e.desc||'' });
        const next = advance(cur); if(!next) break; cur = next;
      } else break;
    }
  });
  return out;
}
function upcomingExpensesRange(startISO, endISO){
  const expanded = expandRecurringExpenses(startISO, endISO);
  const singles = (state.expenses||[]).filter(e=> (e.recurring||'none')==='none' && (e.status||'planned')==='planned')
    .filter(e=> { const d=(e.date||'').slice(0,10); return d && d>=startISO && d<=endISO; })
    .map(e=> ({ seriesId:null, baseId:e.id, date:e.date.slice(0,10), amount:safeNum(e.amount), category:e.category||'', statusComputed:'planned', recurring:'none', desc:e.desc||'' }));
  return [...expanded, ...singles].sort((a,b)=> a.date.localeCompare(b.date));
}
function expenseStatusLabel(status){
  const val = String(status||'planned').toLowerCase();
  if(val==='paid') return 'Pagata';
  if(val==='canceled') return 'Annullata';
  return 'Programmato';
}
function expenseRecurringLabel(rec){
  const val = String(rec||'none').toLowerCase();
  switch(val){
    case 'weekly': return 'Settimanale';
    case 'monthly': return 'Mensile';
    case 'yearly': return 'Annuale';
    case 'daily': return 'Giornaliera';
    case 'quarterly': return 'Trimestrale';
    case 'none':
    case '': return '—';
    default: return val.charAt(0).toUpperCase() + val.slice(1);
  }
}
function normalizeExpenseItem(item){
  if(!item) return null;
  const raw = item;
  const dateISO = String(raw.date || raw.anchorDate || '').slice(0,10) || '—';
  const statusRaw = raw.statusComputed || raw.status || 'planned';
  const amountMinor = safeMinor(Number.isFinite(raw.amountMinor) ? raw.amountMinor : Money.toMinor(raw.amount||0));
  const baseId = raw.id || raw.baseId || '';
  const seriesId = raw.seriesId || (raw.recurring && raw.recurring!=='none' ? baseId : null);
  const isOccurrence = !!seriesId && !!raw.baseId && raw.baseId !== seriesId;
  const sourceLabel = isOccurrence ? 'Occorrenza' : ((raw.recurring && raw.recurring!=='none') ? 'Serie' : 'Singola');
  return {
    dateISO,
    category: raw.category || '',
    desc: raw.desc || raw.note || '',
    recurring: raw.recurring || 'none',
    statusRaw,
    amountMinor,
    sourceLabel,
    baseId,
    seriesId,
    isOccurrence,
    raw
  };
}
function buildExpensesTable(items=[], { includeSource=true }={}){
  if(!Array.isArray(items) || !items.length){
    return '<div class="muted" style="padding:.75rem">Nessuna voce disponibile</div>';
  }
  const rows = items.map(obj=>{
    const it = normalizeExpenseItem(obj);
    if(!it) return '';
    const actions = [];
    if(it.isOccurrence && it.seriesId && it.dateISO !== '—'){
      const paid = String(it.statusRaw).toLowerCase()==='paid';
      if(!paid){
        actions.push(`<button class="btn btn-ghost" type="button" onclick="markOccurrencePaid('${it.seriesId}','${it.dateISO}')">Segna pagata</button>`);
      }
      actions.push(`<button class="btn btn-ghost" type="button" onclick="openSeriesForOccurrence('${it.seriesId}','${it.dateISO}')">Apri serie</button>`);
    }else if(it.baseId){
      actions.push(`<button class="btn btn-ghost" type="button" onclick="showExpenseForm('${it.baseId}')">Apri</button>`);
    }
    const actionHtml = actions.length ? actions.join(' ') : '<span class="muted">—</span>';
    const cells = [
      `<td>${h(it.dateISO)}</td>`,
      `<td>${h(it.category||'—')}</td>`,
      `<td>${h(it.desc||'—')}</td>`,
      `<td>${h(expenseRecurringLabel(it.recurring))}</td>`,
      `<td>${h(expenseStatusLabel(it.statusRaw))}</td>`
    ];
    if(includeSource){ cells.push(`<td>${h(it.sourceLabel)}</td>`); }
    cells.push(`<td class="right">${Money.format(it.amountMinor)}</td>`);
    cells.push(`<td class="table-actions">${actionHtml}</td>`);
    return `<tr>${cells.join('')}</tr>`;
  }).join('');
  const headers = ['<th>Data</th>','<th>Categoria</th>','<th>Descrizione</th>','<th>Ricorrenza</th>','<th>Stato</th>'];
  if(includeSource){ headers.push('<th>Origine</th>'); }
  headers.push('<th class="right">Importo</th>');
  headers.push('<th>Azioni</th>');
  return `<div class="table-scroll-lg"><table class="tbl"><thead><tr>${headers.join('')}</tr></thead><tbody>${rows}</tbody></table></div>`;
}
function openExpensesDetailModal({title, items, subtitle='', includeSource=true}={}){
  const payload = Array.isArray(items) ? items : [];
  const normalized = payload.map(normalizeExpenseItem).filter(Boolean);
  const { body } = openFloatingModal(title||'Dettaglio spese', '<div></div>');
  if(!body) return;
  const paidItems = normalized.filter(x=> String(x.statusRaw).toLowerCase()==='paid');
  const plannedItems = normalized.filter(x=>{
    const st = String(x.statusRaw).toLowerCase();
    return st!=='paid' && st!=='canceled';
  });
  const totalMinor = normalized.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const paidMinor = paidItems.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const plannedMinor = plannedItems.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  body.innerHTML = `
    ${subtitle ? `<p class="muted" style="margin-bottom:.5rem">${subtitle}</p>` : ''}
    <div class="kpi-inline" style="margin-bottom:.75rem">
      <div class="card kpi"><div class="kpi-label">Totale</div><div class="value">${Money.format(totalMinor)}</div><div class="kpi-sub">${payload.length} movimenti</div></div>
      <div class="card kpi"><div class="kpi-label">Pagate</div><div class="value">${Money.format(paidMinor)}</div><div class="kpi-sub">${paidItems.length} mov.</div></div>
      <div class="card kpi"><div class="kpi-label">Programmate</div><div class="value">${Money.format(plannedMinor)}</div><div class="kpi-sub">${plannedItems.length} mov.</div></div>
    </div>
    ${buildExpensesTable(payload, { includeSource })}
  `;
}
function openForecastDetailModal({title, items, range=null, subtitle=''}={}){
  const payload = Array.isArray(items) ? items : [];
  const normalized = payload.map(normalizeExpenseItem).filter(Boolean);
  const { body } = openFloatingModal(title||'Dettaglio proiezione', '<div></div>');
  if(!body) return;
  const paidItems = normalized.filter(x=> String(x.statusRaw).toLowerCase()==='paid');
  const pendingItems = normalized.filter(x=>{
    const st = String(x.statusRaw).toLowerCase();
    return st!=='paid' && st!=='canceled';
  });
  const totalMinor = normalized.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const paidMinor = paidItems.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const pendingMinor = pendingItems.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const rangeInfo = range && range.from && range.to ? `<p class="muted" style="margin-bottom:.5rem">Intervallo ${range.from} → ${range.to}</p>` : '';
  body.innerHTML = `
    ${subtitle ? `<p class="muted" style="margin-bottom:.5rem">${subtitle}</p>` : ''}
    ${rangeInfo}
    <div class="kpi-inline" style="margin-bottom:.75rem">
      <div class="card kpi"><div class="kpi-label">Totale intervallo</div><div class="value">${Money.format(totalMinor)}</div><div class="kpi-sub">${payload.length} occorrenze</div></div>
      <div class="card kpi"><div class="kpi-label">Pagate</div><div class="value">${Money.format(paidMinor)}</div><div class="kpi-sub">${paidItems.length} occ.</div></div>
      <div class="card kpi"><div class="kpi-label">Da pagare</div><div class="value">${Money.format(pendingMinor)}</div><div class="kpi-sub">${pendingItems.length} occ.</div></div>
    </div>
    ${buildExpensesTable(payload, { includeSource:true })}
  `;
}
function renderExpenseForecast(){
  const host = byId('ex-forecast-list');
  if(!host) return;

  const todayISO = Dates.todayISO();
  const saved = renderExpenseForecast.__state || { from: todayISO, to: addDaysISO(todayISO, 30) };
  let start = (byId('ex-forecast-from')?.value || saved.from || todayISO).slice(0,10);
  if(!start) start = todayISO;
  let end = (byId('ex-forecast-to')?.value || saved.to || addDaysISO(start, 30)).slice(0,10);
  if(!end || end < start) end = addDaysISO(start, 30);
  const range = renderExpenseForecast.__state = { from: start, to: end };

  const occurrences = upcomingExpensesRange(start, end);
  const normalized = occurrences.map(normalizeExpenseItem).filter(Boolean);
  const totalMinor = normalized.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const paidItems = normalized.filter(x=> String(x.statusRaw).toLowerCase()==='paid');
  const pendingItems = normalized.filter(x=>{
    const st = String(x.statusRaw).toLowerCase();
    return st!=='paid' && st!=='canceled';
  });
  const paidMinor = paidItems.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const pendingMinor = pendingItems.reduce((s,x)=> Money.add(s, x.amountMinor), 0);
  const paidRaw = paidItems.map(x=> x.raw);
  const pendingRaw = pendingItems.map(x=> x.raw);

  const monthBuckets = new Map();
  normalized.forEach(x=>{
    const key = (x.dateISO && x.dateISO.length>=7) ? x.dateISO.slice(0,7) : '—';
    if(!monthBuckets.has(key)) monthBuckets.set(key, { items: [], totalMinor:0, paidMinor:0, pendingMinor:0 });
    const bucket = monthBuckets.get(key);
    bucket.items.push(x.raw);
    bucket.totalMinor = Money.add(bucket.totalMinor, x.amountMinor);
    const st = String(x.statusRaw).toLowerCase();
    if(st==='paid') bucket.paidMinor = Money.add(bucket.paidMinor, x.amountMinor);
    else if(st!=='canceled') bucket.pendingMinor = Money.add(bucket.pendingMinor, x.amountMinor);
  });
  const sortedMonths = [...monthBuckets.entries()].filter(([key])=> key && key.includes('-')).sort((a,b)=> a[0].localeCompare(b[0]));
  const monthChips = sortedMonths.length
    ? sortedMonths.map(([key,bucket])=> `<span class="pill clickable-pill" data-forecast-month="${key}">${h(monthKeyLabel(key))} · <strong>${Money.format(bucket.totalMinor)}</strong></span>`).join('')
    : '<span class="muted">Nessun andamento mensile nel range</span>';

  const quickDays = [15,30,60,90];
  const quickHtml = quickDays.map(days=>{
    const targetTo = addDaysISO(todayISO, days);
    const active = range.from===todayISO && range.to===targetTo;
    return `<span class="chip${active?' active':''}" data-range-days="${days}">${days} gg</span>`;
  }).join('');

  const MAX_ROWS = 500;
  const visibleRows = occurrences.slice(0, MAX_ROWS).map(item=>{
    const norm = normalizeExpenseItem(item);
    if(!norm) return '';
    const paid = String(norm.statusRaw).toLowerCase()==='paid';
    const pill = paid
      ? '<span class="status-pill status-paid">Pagata</span>'
      : '<span class="status-pill status-plan">Programmato</span>';
    const actions = [];
    if(norm.isOccurrence && norm.seriesId && norm.dateISO !== '—'){
      if(!paid) actions.push(`<button class="btn-icon" onclick="markOccurrencePaid('${norm.seriesId}','${norm.dateISO}')" title="Segna pagata">✓</button>`);
      actions.push(`<button class="btn-icon" onclick="openSeriesForOccurrence('${norm.seriesId}','${norm.dateISO}')" title="Apri serie">&gt;</button>`);
    }else if(norm.baseId){
      actions.push(`<button class="btn-icon" onclick="showExpenseForm('${norm.baseId}')" title="Apri">&gt;</button>`);
    }
    return `<div class="fx-row">
      <div class="muted">${h(norm.dateISO)}</div>
      <div>${h(norm.category||'—')}</div>
      <div class="muted">${h(norm.desc||'')}</div>
      <div class="muted">${h(expenseRecurringLabel(norm.recurring))}</div>
      <div class="right"><b>${Money.format(norm.amountMinor)}</b></div>
      <div style="display:flex;gap:.35rem;align-items:center">${pill}${actions.join('')}</div>
    </div>`;
  }).join('') || '<div class="muted" style="padding:.6rem">Nessuna spesa nell\'intervallo</div>';

  const now = new Date();
  const nowKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
  const nextKey = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}`;
  const currentBucket = monthBuckets.get(nowKey) || { items: [], totalMinor:0 };
  const nextBucket = monthBuckets.get(nextKey) || { items: [], totalMinor:0 };

  const cards = [
    { action:'range', label:'Totale intervallo', value: Money.format(totalMinor), sub: `${normalized.length} occorrenze` },
    { action: paidRaw.length ? 'paid' : null, label:'Pagate', value: Money.format(paidMinor), sub: `${paidRaw.length} occ.` },
    { action: pendingRaw.length ? 'pending' : null, label:'Da pagare', value: Money.format(pendingMinor), sub: `${pendingRaw.length} occ.` },
    { action: currentBucket.items.length ? `month:${nowKey}` : null, label: monthKeyLabel(nowKey), value: Money.format(currentBucket.totalMinor), sub: `${currentBucket.items.length} occ.` },
    { action: nextBucket.items.length ? `month:${nextKey}` : null, label: monthKeyLabel(nextKey), value: Money.format(nextBucket.totalMinor), sub: `${nextBucket.items.length} occ.` }
  ];

  host.innerHTML = `
    <div class="fx-toolbar">
      <div class="chips">${quickHtml}</div>
      <span class="muted">Da</span><input id="ex-forecast-from" type="date" value="${start}">
      <span class="muted">a</span><input id="ex-forecast-to" type="date" value="${end}">
      <button id="ex-forecast-apply" class="btn btn-primary" type="button">Applica</button>
    </div>
    <div class="kpi-inline" id="ex-forecast-kpi">
      ${cards.map(card=>`
        <div class="card kpi${card.action ? ' buttonlike' : ''}" ${card.action ? `data-forecast-action="${card.action}"` : ''}>
          <div class="kpi-label">${card.label}</div>
          <div class="value">${card.value}</div>
          <div class="kpi-sub">${card.sub}</div>
        </div>`).join('')}
    </div>
    <div id="ex-forecast-monthly">${monthChips}</div>
    <div class="fx-list">${visibleRows}</div>
    ${occurrences.length>MAX_ROWS ? `<div class="muted" style="padding:.6rem">Mostrati ${MAX_ROWS} di ${occurrences.length}. Raffina i filtri.</div>` : ''}
  `;

  renderExpenseForecast.__lastForecastList = occurrences;
  renderExpenseForecast.__lastForecastRange = { ...range };
  renderExpenseForecast.__lastMonthly = sortedMonths.map(([key,bucket])=> ({
    key,
    totalMinor: bucket.totalMinor,
    paidMinor: bucket.paidMinor,
    pendingMinor: bucket.pendingMinor,
    count: bucket.items.length
  }));

  const fromInput = byId('ex-forecast-from');
  const toInput = byId('ex-forecast-to');
  if(fromInput && !fromInput.dataset.bound){
    fromInput.dataset.bound = '1';
    fromInput.addEventListener('change', ()=>{
      renderExpenseForecast.__state.from = fromInput.value;
      renderExpenseForecast();
    });
  }
  if(toInput && !toInput.dataset.bound){
    toInput.dataset.bound = '1';
    toInput.addEventListener('change', ()=>{
      renderExpenseForecast.__state.to = toInput.value;
      renderExpenseForecast();
    });
  }
  const applyBtn = byId('ex-forecast-apply');
  if(applyBtn && !applyBtn.dataset.bound){
    applyBtn.dataset.bound = '1';
    applyBtn.addEventListener('click', renderExpenseForecast);
  }

  host.querySelectorAll('[data-range-days]')?.forEach(ch=>{
    ch.addEventListener('click', ()=>{
      const days = Number(ch.getAttribute('data-range-days'))||0;
      renderExpenseForecast.__state = { from: todayISO, to: addDaysISO(todayISO, days) };
      renderExpenseForecast();
    });
  });

  host.querySelectorAll('[data-forecast-action]')?.forEach(card=>{
    const action = card.getAttribute('data-forecast-action');
    if(!action) return;
    card.addEventListener('click', ()=>{
      if(action==='range'){
        openForecastDetailModal({
          title: 'Proiezione spese',
          items: occurrences,
          range,
          subtitle: `${normalized.length} occorrenze · ${Money.format(totalMinor)}`
        });
      } else if(action==='paid' && paidRaw.length){
        openForecastDetailModal({
          title: 'Occorrenze pagate',
          items: paidRaw,
          range,
          subtitle: `${paidRaw.length} occorrenze · ${Money.format(paidMinor)}`
        });
      } else if(action==='pending' && pendingRaw.length){
        openForecastDetailModal({
          title: 'Occorrenze da pagare',
          items: pendingRaw,
          range,
          subtitle: `${pendingRaw.length} occorrenze · ${Money.format(pendingMinor)}`
        });
      } else if(action.startsWith('month:')){
        const key = action.split(':')[1];
        const bucket = monthBuckets.get(key);
        if(bucket){
          const keyRange = monthKeyRange(key) || range;
          openForecastDetailModal({
            title: `Dettaglio ${monthKeyLabel(key)}`,
            items: bucket.items,
            range: keyRange,
            subtitle: `${bucket.items.length} occorrenze · ${Money.format(bucket.totalMinor)}`
          });
        }
      }
    });
  });

  host.querySelectorAll('[data-forecast-month]')?.forEach(el=>{
    const key = el.getAttribute('data-forecast-month');
    el.addEventListener('click', ()=>{
      const bucket = monthBuckets.get(key);
      if(!bucket) return;
      const keyRange = monthKeyRange(key) || range;
      openForecastDetailModal({
        title: `Dettaglio ${monthKeyLabel(key)}`,
        items: bucket.items,
        range: keyRange,
        subtitle: `${bucket.items.length} occorrenze · ${Money.format(bucket.totalMinor)}`
      });
    });
  });
}
function renderExpensePaidRegistered(){
  const host = byId('ex-paid-registered');
  if(!host) return;
  const expenses = state.expenses || [];
  const active = expenses.filter(e=> (e.status||'planned')!=='canceled');
  const paid = active.filter(e=> (e.status||'planned')==='paid');
  const pending = active.filter(e=> (e.status||'planned')!=='paid');
  const paidMinor = paid.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);
  const pendingMinor = pending.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);
  const totalMinor = Money.add(paidMinor, pendingMinor);

  host.innerHTML = `
    <div class="kpi-inline">
      <div class="card kpi buttonlike" data-paid-registered="paid">
        <div class="kpi-label">Pagate</div>
        <div class="value">${Money.format(paidMinor)}</div>
        <div class="kpi-sub">${paid.length} mov.</div>
      </div>
      <div class="card kpi buttonlike" data-paid-registered="pending">
        <div class="kpi-label">Registrate da pagare</div>
        <div class="value">${Money.format(pendingMinor)}</div>
        <div class="kpi-sub">${pending.length} mov.</div>
      </div>
      <div class="card kpi">
        <div class="kpi-label">Totale attivo</div>
        <div class="value">${Money.format(totalMinor)}</div>
        <div class="kpi-sub">${active.length} mov.</div>
      </div>
    </div>`;

  host.querySelectorAll('[data-paid-registered]')?.forEach(card=>{
    const kind = card.getAttribute('data-paid-registered');
    card.addEventListener('click', ()=>{
      if(kind==='paid' && paid.length){
        openExpensesDetailModal({
          title: 'Spese pagate',
          items: paid,
          subtitle: `${paid.length} movimenti · ${Money.format(paidMinor)}`,
          includeSource: false
        });
      } else if(kind==='pending' && pending.length){
        openExpensesDetailModal({
          title: 'Spese da pagare',
          items: pending,
          subtitle: `${pending.length} movimenti · ${Money.format(pendingMinor)}`,
          includeSource: false
        });
      }
    });
  });
}
function renderExpensesSummary(){
  const card = byId('ex-summary-card');
  if(!card) return;

  const expenses = state.expenses || [];
  const recurringSeries = expenses.filter(e=> (e.recurring||'none')!=='none' && (e.status||'planned')!=='canceled');
  const singles = expenses.filter(e=> (e.recurring||'none')==='none');
  const todayISO = Dates.todayISO();
  const now = new Date();
  const { from: monthStart, to: monthEnd } = monthISORange(now.getFullYear(), now.getMonth());
  const yearStart = `${now.getFullYear()}-01-01`;
  const yearEnd = `${now.getFullYear()}-12-31`;
  const isoInRange = (iso, from, to)=>{
    if(!iso) return false;
    const val = String(iso).slice(0,10);
    if(from && val < from) return false;
    if(to && val > to) return false;
    return true;
  };

  const manualPaidMonth = singles.filter(e=> (e.status||'planned')==='paid' && isoInRange(e.date, monthStart, monthEnd));
  const manualPaidMonthMinor = manualPaidMonth.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);

  const recurringMonth = expandRecurringExpenses(monthStart, monthEnd);
  const recurringPaidMonth = recurringMonth.filter(x=> x.statusComputed==='paid');
  const recurringPaidMonthMinor = recurringPaidMonth.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);

  const paidMonthMinor = Money.add(manualPaidMonthMinor, recurringPaidMonthMinor);
  const paidMonthCount = manualPaidMonth.length + recurringPaidMonth.length;

  const manualPlannedMonth = singles.filter(e=> (e.status||'planned')!=='paid' && (e.status||'planned')!=='canceled' && isoInRange(e.date, monthStart, monthEnd));
  const manualPlannedMonthMinor = manualPlannedMonth.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);
  const recurringPlannedMonth = recurringMonth.filter(x=> x.statusComputed!=='paid');
  const recurringPlannedMonthMinor = recurringPlannedMonth.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
  const plannedMonthMinor = Money.add(manualPlannedMonthMinor, recurringPlannedMonthMinor);
  const plannedMonthCount = manualPlannedMonth.length + recurringPlannedMonth.length;

  const upcomingRange = upcomingExpensesRange(todayISO, addDaysISO(todayISO, 30));
  const upcomingPlanned = upcomingRange.filter(x=> x.statusComputed!=='paid');
  const upcomingMinor = upcomingPlanned.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
  const upcomingCount = upcomingPlanned.length;

  const singlesOverdue = singles.filter(e=> (e.status||'planned')!=='paid' && (e.status||'planned')!=='canceled' && String(e.date||'').slice(0,10) < todayISO);
  const singlesOverdueMinor = singlesOverdue.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);

  let recurringOverdueMinor = 0;
  let recurringOverdueCount = 0;
  if(recurringSeries.length){
    const earliest = recurringSeries.reduce((min, e)=>{
      const anchor = String(e.anchorDate||e.date||'').slice(0,10);
      if(!anchor) return min;
      return (!min || anchor < min) ? anchor : min;
    }, null);
    const overdueEnd = addDaysISO(todayISO, -1);
    if(earliest && overdueEnd && earliest <= overdueEnd){
      const overList = expandRecurringExpenses(earliest, overdueEnd).filter(x=> x.statusComputed!=='paid' && x.date < todayISO);
      recurringOverdueCount = overList.length;
      recurringOverdueMinor = overList.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
    }
  }
  const overdueMinor = Money.add(singlesOverdueMinor, recurringOverdueMinor);
  const overdueCount = singlesOverdue.length + recurringOverdueCount;

  const manualPaidYear = singles.filter(e=> (e.status||'planned')==='paid' && isoInRange(e.date, yearStart, yearEnd));
  const manualPaidYearMinor = manualPaidYear.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);
  const recurringYear = expandRecurringExpenses(yearStart, yearEnd);
  const recurringPaidYear = recurringYear.filter(x=> x.statusComputed==='paid');
  const recurringPaidYearMinor = recurringPaidYear.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
  const paidYearMinor = Money.add(manualPaidYearMinor, recurringPaidYearMinor);

  const activeRecurring = recurringSeries.filter(e=>{
    const end = String(e.recEnd||'').slice(0,10);
    return !end || end >= todayISO;
  }).length;

  const metrics = [
    { label:'Pagate (mese)', value: Money.format(paidMonthMinor), sub: `${paidMonthCount} mov.` },
    { label:'Programmate (mese)', value: Money.format(plannedMonthMinor), sub: `${plannedMonthCount} mov.` },
    { label:'Scadute', value: Money.format(overdueMinor), sub: `${overdueCount} mov.` },
    { label:'Prossimi 30 giorni', value: Money.format(upcomingMinor), sub: `${upcomingCount} mov.` }
  ];

  const tiles = metrics.map(m=>`
    <div class="kpi" style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:.85rem">
      <div class="label">${m.label}</div>
      <div class="value">${m.value}</div>
      <div class="kpi-sub">${m.sub}</div>
    </div>`).join('');

  card.innerHTML = `
    <div class="card-header">
      <h2>Riepilogo spese</h2>
      <div class="fx-totals">
        <span class="badge">Pagato YTD: <b>${Money.format(paidYearMinor)}</b></span>
        <span class="badge">Ricorrenze attive: <b>${activeRecurring}</b></span>
      </div>
    </div>
    <div class="card-content">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.75rem">${tiles}</div>
    </div>`;
}
window.markOccurrencePaid = (seriesId, dateISO)=>{
  const ser = (state.expenses||[]).find(e=> (e.seriesId||e.id)===seriesId);
  if(!ser) return;
  if(!Array.isArray(ser.occurrencesPaid)) ser.occurrencesPaid = [];
  const set = new Set(ser.occurrencesPaid.map(x=> String(x).slice(0,10)));
  const d = String(dateISO).slice(0,10);
  const already = set.has(d);
  if(!already){
    set.add(d);
    state.archive = state.archive||{};
    state.archive.expensesPaid = state.archive.expensesPaid||[];
    state.archive.expensesPaid.push({
      id: id(), kind:'recurrence', seriesId, date:d,
      amount: +ser.amount||0, category: ser.category||'', desc: ser.desc||'',
      archivedAt: new Date().toISOString()
    });
  }
  ser.occurrencesPaid = Array.from(set);
  ser.updatedAt = new Date().toISOString();
  afterStateChange();
  renderExpenseForecast();
  renderExpensePaidRegistered();
  renderExpensesSummary();
  renderPageRecap('expenses');
  showToast('Occorrenza segnata come pagata ✅','success');
};
// >>> FIX: openSeriesForOccurrence pre-check e focus su checkbox
window.openSeriesForOccurrence = (seriesId, dateISO)=>{
  const ser = (state.expenses||[]).find(e=> (e.seriesId||e.id)===seriesId);
  if(!ser) return;
  showExpenseForm(ser.id);
  const instEl = byId('ex-instance-date');
  const occWrap = byId('ex-occ-paid-wrap');
  const occChk = byId('ex-occ-paid');
  if(instEl){ instEl.value = String(dateISO).slice(0,10); }
  if(occWrap){ occWrap.style.display='block'; }
  if(occChk){ occChk.checked = !!(ser.occurrencesPaid||[]).includes(String(dateISO).slice(0,10)); }
  byId('ex-occ-paid')?.focus();
};
function showPaymentForm(payment=null){
  const c = byId('pay-detail'); const t = byId('tpl-payment-form'); if(!c||!t) return;
  c.innerHTML=''; c.appendChild(t.content.cloneNode(true));
  byId('pay-date').valueAsDate = new Date();
  const sel = byId('pay-invoice-select'); sel.innerHTML = '<option value="">Nessuna</option>' + state.invoices.map(inv=> `<option value="${inv.id}">${inv.number} — ${inv.customer||''}</option>`).join('');
  if(payment){
    byId('pay-date').value = payment.date||''; byId('pay-amount').value=payment.amount||''; byId('pay-method-field').value = payment.method||'bank'; byId('pay-ref').value=payment.reference||''; byId('pay-note').value=payment.note||''; byId('pay-invoice-select').value = payment.invoiceId||'';
  }
  byId('payment-form')?.addEventListener('submit', e=>{
    e.preventDefault();
    const obj = { id: payment? payment.id:id(), date: byId('pay-date').value, amount: safeNum(byId('pay-amount').value), method: byId('pay-method-field').value, reference: byId('pay-ref').value.trim(), note: byId('pay-note').value.trim(), invoiceId: byId('pay-invoice-select').value || null, createdAt: payment? payment.createdAt : new Date().toISOString(), updatedAt:new Date().toISOString() };
    if(payment){ const idx = state.payments.findIndex(p=> p.id===payment.id); if(idx>-1) state.payments[idx]=obj; } else state.payments.push(obj);
  recalcInvoiceStatuses(); afterStateChange(); renderPaymentList(); showPaymentDetail(obj.id); showToast(`Incasso ${payment?'aggiornato':'creato'} ✅`,'success');
  });
  byId('btn-pay-cancel')?.addEventListener('click', ()=> payment? showPaymentDetail(payment.id) : c.innerHTML='<div class="muted">Seleziona un incasso o creane uno nuovo.</div>');
}
function renderPaymentList(){
  const c = byId('pay-list'); if(!c) return;
  const q = (byId('pay-search')?.value||'').toLowerCase();
  const method = byId('pay-method')?.value || '';
  const d1 = byId('pay-date-from')?.value || ''; const d2 = byId('pay-date-to')?.value || '';
  const items = state.payments.filter(p=> (p.reference||'').toLowerCase().includes(q) && (method? p.method===method : true) && (!d1 || p.date>=d1) && (!d2 || p.date<=d2)).sort((a,b)=> (b.date||'').localeCompare(a.date||''));
  c.innerHTML = items.length? items.map(p=>`
    <div class="card payment-item" data-id="${p.id}" style="padding:.8rem; cursor:pointer; display:grid; grid-template-columns:1fr auto; gap:.25rem">
      <div>
        <div style="font-weight:800">${p.reference||'N/D'}</div>
        <div class="muted" style="font-size:.85rem">${new Date(p.date).toLocaleDateString('it-CH')} • ${({bank:'Bonifico',cash:'Contanti',card:'Carta',other:'Altro'})[p.method]||p.method}</div>
        ${p.note? `<div class="muted" style="font-size:.85rem; margin-top:.25rem">${p.note}</div>`:''}
      </div>
      <div style="text-align:right"><div><b>${formatCurrency(p.amount)}</b></div></div>
  </div>`).join('') : `<div class="empty">Nessun incasso</div>`;
  c.querySelectorAll('[data-id]')?.forEach(el=> el.addEventListener('click', ()=> showPaymentDetail(el.dataset.id)));
  renderPageRecap('payments');
}
function showPaymentDetail(id){
  const c = byId('pay-detail'); const p = state.payments.find(x=> x.id===id); if(!c||!p) return;
  const inv = p.invoiceId? state.invoices.find(i=> i.id===p.invoiceId) : null;
  c.innerHTML = `
    <div class="detail-section">
  <h3>Incasso</h3>
      <div class="row two">
        <div><span class="muted">Riferimento:</span> <b>${p.reference||'N/D'}</b></div>
        <div><span class="muted">Data:</span> <b>${new Date(p.date).toLocaleDateString('it-CH')}</b></div>
        <div><span class="muted">Importo:</span> <b>${formatCurrency(p.amount)}</b></div>
  <div><span class="muted">Metodo di incasso:</span> <b>${({bank:'Bonifico',cash:'Contanti',card:'Carta',other:'Altro'})[p.method]||p.method}</b></div>
        ${p.note? `<div style="grid-column:1/-1"><span class="muted">Nota:</span> ${p.note}</div>`:''}
        ${inv? `<div style="grid-column:1/-1"><span class="muted">Fattura collegata:</span> <b>${inv.number}</b> – ${inv.customer||''}</div>`:''}
      </div>
      <div class="detail-actions" style="margin-top:1rem; display:flex; gap:.5rem">
        <button class="btn btn-primary" onclick="showPaymentFormById('${p.id}')">Modifica</button>
        <button class="btn btn-ghost" onclick="deletePayment('${p.id}')">Elimina</button>
        ${p.invoiceId? `<button class="btn btn-danger" onclick="revertPayment('${p.id}')">Segna non pagata</button>`:''}
      </div>
    </div>`;
}
function revertPayment(payId){
  const p = state.payments.find(x=> x.id===payId);
  if(!p){ showToast('Incasso non trovato','error'); return; }
  const invId = p.invoiceId || null;
  if(!confirm('Annullare e rimuovere questo incasso?')) return;
  state.payments = state.payments.filter(x=> x.id!==payId);
  recalcInvoiceStatuses(); afterStateChange();
  renderPaymentList();
  if(invId) showInvoiceDetail(invId);
  showToast('Incasso annullato ✅','success');
}
window.deletePayment = (id)=>{ if(!confirm("Eliminare l'incasso?")) return; state.payments = state.payments.filter(p=> p.id!==id); recalcInvoiceStatuses(); afterStateChange(); renderPaymentList(); byId('pay-detail').innerHTML='<div class="muted">Seleziona un incasso o creane uno nuovo.</div>'; showToast('Incasso eliminato','success'); }
window.showInvoiceFormById = (id) => {
  const inv = state.invoices.find(x => x.id === id);
  if (inv) showInvoiceForm(inv);
};
window.showPaymentFormById = (id) => {
  const pay = state.payments.find(x => x.id === id);
  if (pay) showPaymentForm(pay);
};
function autoMatchPayments(){
  const mapByNumber = new Map(state.invoices.map(i=> [i.number, i]));
  state.payments.forEach(p=>{
    if(p.invoiceId) return;
    const ref = (p.reference||'').toUpperCase();
    for(const num of mapByNumber.keys()){
      if(ref.includes(String(num).toUpperCase())){ p.invoiceId = mapByNumber.get(num).id; p.updatedAt = new Date().toISOString(); break; }
    }
  });
  recalcInvoiceStatuses(); afterStateChange({silentSave:true});
}

/* ===========================================================
   BILANCI + DASHBOARD + LIVE
   =========================================================== */
// >>> PATCH: revenue mese coerente con metodo contabile
function invoiceGrossMinor(inv) {
  const net = Money.toMinor(inv.amount);
  const vat = (inv.vat ?? state.settings.vat) || 0;
  const tax = Money.mulPct(net, vat);
  return Money.add(net, tax);
}
function invoiceRemainingMinor(inv){
  const gross = invoiceGrossMinor(inv);
  const paidMinor = (state.payments||[])
    .filter(p => p.invoiceId === inv.id)
    .reduce((s,p)=> Money.add(s, Money.toMinor(p.amount||0)), 0);
  return Math.max(0, Money.sub(gross, paidMinor));
}
// Helpers: site cash-in and budget remaining (offer - received)
function siteReceivedMinor(siteId){
  if(!siteId) return 0;
  // payments linked to invoices that belong to siteId
  const invIds = new Set((state.invoices||[]).filter(inv=> inv.siteId===siteId).map(inv=> inv.id));
  return (state.payments||[])
    .filter(p=> p.invoiceId && invIds.has(p.invoiceId))
    .reduce((s,p)=> Money.add(s, Money.toMinor(p.amount)), 0);
}
function siteBudgetRemainingMinor(site){
  if(!site) return 0;
  const offerMinor = Money.toMinor(site.offerAmount||0);
  const received = siteReceivedMinor(site.id);
  const rem = Money.sub(offerMinor, received);
  return rem>0 ? rem : 0;
}
function revenueMonthMinor(y, m) {
  const mode = state.settings.accountingMethod || 'cash';
  if (mode === 'cash') {
    return state.payments
      .filter(p => { const d = new Date(p.date); return d.getFullYear() === y && d.getMonth() === m; })
      .reduce((s, p) => Money.add(s, Money.toMinor(p.amount)), 0);
  } else {
    return state.invoices
      .filter(inv => { const d = new Date(inv.date); return d.getFullYear() === y && d.getMonth() === m; })
      .reduce((s, inv) => Money.add(s, invoiceGrossMinor(inv)), 0);
  }
}

// >>> PATCH: costi mese in minor (poi usa Money.format al render)
function sumTicketCostsMonthMinor(y, m) {
  const tt = state.tickets.filter(t => { const d = new Date(t.date); return d.getFullYear() === y && d.getMonth() === m; });
  const labor = tt.reduce((s, t) => s + ticketLaborMinor(t), 0);
  const mats  = tt.reduce((s, t) => s + Money.toMinor(t.totalMaterialCost||0), 0);
  return { laborMinor: labor, materialMinor: mats };
}

function collaboratorActiveInMonth(collaborator, y, m){
  if(!collaborator) return false;
  const hire = collaborator.hireDate ? new Date(collaborator.hireDate) : null;
  if(hire && !isNaN(+hire)){
    if(hire.getFullYear() > y) return false;
    if(hire.getFullYear() === y && hire.getMonth() > m) return false;
  }
  return true;
}

function salariesNetMonthMinor(y, m){
  return (state.collaborators||[]).reduce((sum, collab)=>{
    if(!collaboratorActiveInMonth(collab, y, m)) return sum;
    const net = safeNum(collab.netSalary);
    if(net<=0) return sum;
    return Money.add(sum, Math.round(net * 100));
  }, 0);
}

function salariesGrossMonthMinor(y, m){
  return (state.collaborators||[]).reduce((sum, collab)=>{
    if(!collaboratorActiveInMonth(collab, y, m)) return sum;
    const hours = safeNum(collab.monthlyHours);
    const rate = getCollabCostRate(collab.id);
    let grossMinor = 0;
    if(hours > 0 && rate > 0){
      grossMinor = Math.round(hours * rate * 100);
    }
    const netMinor = Math.round(safeNum(collab.netSalary) * 100);
    if(grossMinor <= 0 && netMinor > 0){
      grossMinor = netMinor;
    }
    return Money.add(sum, Math.max(0, grossMinor));
  }, 0);
}

// FIX: compatibilità per dashboard
function salariesMonthMinor(y, m) {
  const netMinor = salariesNetMonthMinor(y, m);
  const grossMinor = salariesGrossMonthMinor(y, m);
  return grossMinor > 0 ? grossMinor : netMinor;
}

function salariesNetYTDMinor(year){
  const now = new Date();
  if(year > now.getFullYear()) return 0;
  let limitMonth = 11;
  if(year === now.getFullYear()) limitMonth = now.getMonth();
  let acc = 0;
  for(let m=0; m<=limitMonth; m++){
    acc = Money.add(acc, salariesNetMonthMinor(year, m));
  }
  return acc;
}

function salariesGrossYTDMinor(year){
  const now = new Date();
  if(year > now.getFullYear()) return 0;
  let limitMonth = 11;
  if(year === now.getFullYear()) limitMonth = now.getMonth();
  let acc = 0;
  for(let m=0; m<=limitMonth; m++){
    acc = Money.add(acc, salariesGrossMonthMinor(year, m));
  }
  return acc;
}

// >>> PATCH: spese manuali (single + ricorrenti paid)
function manualExpensesMonthMinor(y, m){
  const br = manualExpensesBreakdownMonth(y, m);
  return br.totalMinor;
}

// >>> PATCH: breakdown ticket mese (manodopera + materiali) in minor
function ticketBreakdownMonthMinor(y, m){
  const tt=(state.tickets||[]).filter(t=>{ const d=new Date(t.date||''); return d.getFullYear()===y && d.getMonth()===m; });
  const laborMinor = tt.reduce((s,t)=> s + ticketLaborMinor(t), 0);
  const matsMinor  = tt.reduce((s,t)=> Money.add(s, Money.toMinor(t.totalMaterialCost||0)), 0);
  return { laborMinor, matsMinor };
}

function recapKV(k, v){ return `<div class="recap-item"><div class="k">${k}</div><div class="v">${v}</div></div>`; }
function recapMoney(n){ return formatCurrency(n); }
function recapMinor(n){ return Money.format(n); }

function renderPageRecap(route){
  try{
    switch(route){
      case 'invoices':{
        const all = state.invoices||[];
        const grossMinor = all.reduce((s,i)=> Money.add(s, invoiceGrossMinor(i)), 0);
        const paidMinor  = (state.payments||[]).reduce((s,p)=> Money.add(s, Money.toMinor(p.amount||0)),0);
        const dueMinor   = Math.max(0, Money.sub(grossMinor, paidMinor));
        const byStatus = (st)=> all.filter(i=> i.status===st).length;
        const host = byId('recap-invoices'); if(!host) break;
        host.innerHTML = [
          recapKV('Fatture totali', all.length),
          recapKV('Emesse', byStatus('issued')),
          recapKV('Parziali', byStatus('partial')),
          recapKV('Pagate', byStatus('paid')),
          recapKV('Scadute', byStatus('overdue')),
          recapKV('Lordo', recapMinor(grossMinor)),
          recapKV('Incassato', recapMinor(paidMinor)),
          recapKV('Residuo', recapMinor(dueMinor)),
        ].join('');
      } break;

      case 'offers':{
        const off = state.offers||[];
        const sum = off.reduce((s,o)=> s + (Number(o.importo)||0), 0);
        const inCorso = off.filter(o=> o.stato==='in_corso').length;
        const vinte = off.filter(o=> o.stato==='vinta').length;
        const perse = off.filter(o=> o.stato==='persa').length;
        const ann = off.filter(o=> o.stato==='annullata').length;
        const fotov = off.filter(o=> o.tipo==='fotovoltaico').length;
        const elet  = off.filter(o=> o.tipo==='elettrico').length;
        const host = byId('recap-offers'); if(!host) break;
        host.innerHTML = [
          recapKV('Offerte totali', off.length),
          recapKV('In corso', inCorso),
          recapKV('Vinte', vinte),
          recapKV('Perse', perse),
          recapKV('Annullate', ann),
          recapKV('Fotovoltaico', fotov),
          recapKV('Elettrico', elet),
          recapKV('Importo complessivo', recapMoney(sum)),
        ].join('');
      } break;

      case 'collab':{
        const coll = state.collaborators||[];
        const avgRate = coll.length ? (coll.reduce((s,c)=> s+(Number(c.rate)||0),0)/coll.length) : 0;
        const now = new Date();
        const totSalary = coll.reduce((s,c)=>{
          const hire = c.hireDate ? new Date(c.hireDate) : null;
          if(hire && !isNaN(hire) && hire>now) return s;
          return s + (Number(c.netSalary)||0);
        },0);
        const month = now.getMonth(), year=now.getFullYear();
        const ticketsMonth = (state.tickets||[]).filter(t=>{ const d=new Date(t.date||''); return d.getMonth()===month && d.getFullYear()===year; });
        const hours = ticketsMonth.reduce((s,t)=> s + (Number(t.hours)||0), 0);
        const host = byId('recap-collab'); if(!host) break;
        host.innerHTML = [
          recapKV('Collaboratori', coll.length),
          recapKV('Tariffa media', recapMoney(avgRate)),
          recapKV('Stipendi/mese', recapMoney(totSalary)),
          recapKV('Ore registrate (mese)', hours.toFixed(2)),
        ].join('');
      } break;

      case 'ticket':{
        const t = state.tickets||[];
        const todayISO = new Date().toISOString().slice(0,10);
        const month = new Date().getMonth(), year=new Date().getFullYear();
        const tToday = t.filter(x=> String(x.date||'').slice(0,10)===todayISO);
        const tMonth = t.filter(x=>{ const d=new Date(x.date||''); return d.getMonth()===month && d.getFullYear()===year; });
        const hours = tMonth.reduce((s,x)=> s+(Number(x.hours)||0),0);
        const matsMinor = tMonth.reduce((s,x)=> Money.add(s, Money.toMinor(x.totalMaterialCost||0)),0);
        const host = byId('recap-ticket'); if(!host) break;
        host.innerHTML = [
          recapKV('Ticket totali', t.length),
          recapKV('Oggi', tToday.length),
          recapKV('Questo mese', tMonth.length),
          recapKV('Ore mese', hours.toFixed(2)),
          recapKV('Materiali mese', recapMinor(matsMinor)),
        ].join('');
      } break;

      case 'overdue':{
        const items = (state.invoices||[]).filter(i=> isInvoiceOverdue(i));
        const totalMinor = items.reduce((s,i)=> Money.add(s, invoiceGrossMinor(i)),0);
        const host = byId('recap-overdue'); if(!host) break;
        host.innerHTML = [
          recapKV('Fatture scadute', items.length),
          recapKV('Importo totale', recapMinor(totalMinor)),
        ].join('');
      } break;

      case 'payments':{
        const p = state.payments||[];
        const sumMinor = p.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)),0);
        const by = (m)=> p.filter(x=> x.method===m).length;
        const host = byId('recap-payments'); if(!host) break;
        host.innerHTML = [
          recapKV('Incassi totali', p.length),
          recapKV('Bonifico', by('bank')),
          recapKV('Contanti', by('cash')),
          recapKV('Carta', by('card')),
          recapKV('Totale incassato', recapMinor(sumMinor)),
        ].join('');
      } break;

      case 'expenses':{
        const expenses = state.expenses||[];
        const host = byId('recap-expenses'); if(!host) break;
        const active = expenses.filter(x=> (x.status||'planned')!=='canceled');
        const paid = active.filter(x=> (x.status||'planned')==='paid');
        const planned = active.filter(x=> (x.status||'planned')!=='paid');
        const totalMinor = active.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
        const paidMinor = paid.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
        const plannedMinor = planned.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);

        const todayISO = Dates.todayISO();
        const next30ISO = addDaysISO(todayISO, 30);
        const upcoming = upcomingExpensesRange(todayISO, next30ISO);
        const upcomingMinor = upcoming.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);

        const recapButton = ({label, value, sub, action})=>`
          <div class="recap-item buttonlike" data-expenses-action="${action}">
            <div class="k">${label}</div>
            <div class="v">${value}</div>
            ${sub ? `<div class="muted">${sub}</div>` : ''}
          </div>`;

        host.innerHTML = [
          recapButton({ label:'Registrate attive', value: active.length, sub: Money.format(totalMinor), action:'all' }),
          recapButton({ label:'Pagate', value: paid.length, sub: Money.format(paidMinor), action:'paid' }),
          recapButton({ label:'Da pagare · 30 giorni', value: upcoming.length, sub: Money.format(upcomingMinor), action:'upcoming' }),
          recapButton({ label:'Programmato residuo', value: planned.length, sub: Money.format(plannedMinor), action:'planned' })
        ].join('');

        host.querySelectorAll('[data-expenses-action]')?.forEach(el=>{
          const act = el.getAttribute('data-expenses-action');
          el.addEventListener('click', ()=>{
            if(act==='all'){
              openExpensesDetailModal({
                title: 'Spese registrate',
                items: active,
                subtitle: `${active.length} movimenti attivi · ${Money.format(totalMinor)}`
              });
            }else if(act==='paid'){
              openExpensesDetailModal({
                title: 'Spese pagate',
                items: paid,
                subtitle: `${paid.length} pagamenti registrati · ${Money.format(paidMinor)}`
              });
            }else if(act==='planned'){
              openExpensesDetailModal({
                title: 'Spese programmate',
                items: planned,
                subtitle: `${planned.length} movimenti futuri · ${Money.format(plannedMinor)}`
              });
            }else if(act==='upcoming'){
              openForecastDetailModal({
                title: 'Spese prossimi 30 giorni',
                items: upcoming,
                range: { from: todayISO, to: next30ISO },
                subtitle: `${upcoming.length} occorrenze previste · ${Money.format(upcomingMinor)}`
              });
            }
          });
        });
      } break;

      case 'agenda':{
        const weekStart = (d=>{ const x=new Date(d); const w=(x.getDay()+6)%7; x.setDate(x.getDate()-w); return x; })(new Date());
        const days = Array.from({length:7}, (_,i)=>{const d=new Date(weekStart); d.setDate(d.getDate()+i); return d.toISOString().slice(0,10);});
        const ev = (state.agenda||[]).filter(a=> days.includes(String(a.date||'')));
        const collUniq = new Set(ev.flatMap(a=> a.collabIds||[]));
        const host = byId('recap-agenda'); if(!host) break;
        host.innerHTML = [
          recapKV('Appuntamenti settimana', ev.length),
          recapKV('Collaboratori coinvolti', collUniq.size),
          recapKV('Giorni coperti', new Set(ev.map(a=>a.date)).size),
        ].join('');
      } break;

      case 'cantieri':{
        const s = state.sites||[];
        const att = s.filter(x=> x.status==='attivo').length;
        const fin = s.filter(x=> x.status==='terminato').length;
        const orePrev = s.reduce((a,b)=> a + (Number(b.estimatedHours)||0),0);
        const cashMinor = s.reduce((sum,site)=> Money.add(sum, siteReceivedMinor(site.id)),0);
        const host = byId('recap-cantieri'); if(!host) break;
        host.innerHTML = [
          recapKV('Cantieri totali', s.length),
          recapKV('Attivi', att),
          recapKV('Terminati', fin),
          recapKV('Ore preventivate', orePrev.toFixed(1)),
          recapKV('Incassato (da cantieri)', recapMinor(cashMinor)),
        ].join('');
      } break;

      case 'home':{
        const host = byId('recap-home'); if(!host) break;
        const {rev, cost} = marketSeries12m();
        const sumR = rev.reduce((a,b)=>a+b,0), sumC = cost.reduce((a,b)=>a+b,0);
        host.innerHTML = [
          recapKV('Ricavi 12m', recapMoney(sumR)),
          recapKV('Costi 12m', recapMoney(sumC)),
          recapKV('Utile 12m', recapMoney(sumR-sumC)),
          recapKV('Ticket totali', (state.tickets||[]).length),
        ].join('');
      } break;
    }
  }catch(_){ /* no-op */ }
}

// >>> Helper: spese in un intervallo [fromISO..toISO] in minor
function expensesInRange(fromISO, toISO){
  const from = String(fromISO||'').slice(0,10);
  const to   = String(toISO||'').slice(0,10);
  if(!from || !to || from>to) return { laborMinor:0, matsMinor:0, manualMinor:0, totalMinor:0 };
  const inRange = (iso)=> iso && iso>=from && iso<=to;
  const tt = (state.tickets||[]).filter(t=> inRange(String(t.date||'').slice(0,10)));
  const laborMinor = tt.reduce((s,t)=>{
    return s + ticketLaborMinor(t);
  }, 0);
  const matsMinor  = tt.reduce((s,t)=> s + Money.toMinor(t.totalMaterialCost), 0);
  const manualMinor= (state.expenses||[])
    .filter(e=> String(e.status||'')==='paid' && inRange(String(e.date||'').slice(0,10)))
    .reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);
  const totalMinor = Money.add(laborMinor, matsMinor, manualMinor);
  return { laborMinor, matsMinor, manualMinor, totalMinor };
}

function renderBilanci(){
  const canvas = byId('bilanci-chart'); const table = byId('bilanci-table'); if(!canvas || !table) return;

  const months = lastNMonths(12);

  const rows = months.map(m=>{
    const revM = revenueMonthMinor(m.y, m.m);
    const matsMinor  = (state.tickets||[])
      .filter(t=>{ const d=new Date(t.date||''); return d.getFullYear()===m.y && d.getMonth()===m.m; })
      .reduce((s,t)=> Money.add(s, Money.toMinor(t.totalMaterialCost||0)), 0);

    const manualMinor   = manualExpensesMonthMinor(m.y, m.m);
    const salariesNetMinor = salariesNetMonthMinor(m.y, m.m);
    const salariesGrossMinor = salariesGrossMonthMinor(m.y, m.m);

    const costMinor   = Money.add(matsMinor, manualMinor, salariesGrossMinor);
    const profitMinor = Money.sub(revM, costMinor);

    return {
      label: m.label, y:m.y, m:m.m,
      revM, matsMinor, manualMinor, salariesNetMinor, salariesGrossMinor, costMinor, profitMinor
    };
  });

  drawLines(
    canvas,
    months.map(({y,m}) => Money.fromMinor(revenueMonthMinor(y,m))),
    months.map(({y,m}) => {
      const mats = (state.tickets||[])
        .filter(t=>{ const d=new Date(t.date||''); return d.getFullYear()===y && d.getMonth()===m; })
        .reduce((s,t)=> Money.add(s, Money.toMinor(t.totalMaterialCost||0)), 0);
      const manual = manualExpensesMonthMinor(y,m);
      const salaries = salariesGrossMonthMinor(y,m);
      return Money.fromMinor(Money.add(mats, manual, salaries));
    }),
    months.map(x=> x.label)
  );

  table.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Mese</th>
          <th class="right">Ricavi</th>
          <th class="right">Materiali ticket</th>
          <th class="right">Spese manuali</th>
          <th class="right">Stipendi netti</th>
          <th class="right">Stipendi stimati (lordo)</th>
          <th class="right">Costo totale</th>
          <th class="right">Utile</th>
          <th class="right">Margine</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const margin = r.revM>0 ? (Money.fromMinor(r.profitMinor)/Money.fromMinor(r.revM))*100 : 0;
          return `<tr data-ym="${r.y}-${r.m}">
            <td class="link-cell" style="cursor:pointer">${r.label}</td>
            <td class="right">${Money.format(r.revM)}</td>
            <td class="right">${Money.format(r.matsMinor)}</td>
            <td class="right">${Money.format(r.manualMinor)}</td>
            <td class="right">${Money.format(r.salariesNetMinor)}</td>
            <td class="right">${Money.format(r.salariesGrossMinor)}</td>
            <td class="right">${Money.format(r.costMinor)}</td>
            <td class="right">${Money.format(r.profitMinor)}</td>
            <td class="right">${margin.toFixed(1)}%</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;

  table.querySelectorAll('tbody tr[data-ym]')?.forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const [yy,mm] = tr.getAttribute('data-ym').split('-').map(n=> +n);
      showMonthBreakdown(yy, mm);
    });
  });
}

function breakdownMonth(y,m){
  const {from, to} = monthISORange(y,m);
  const inRange = (iso)=> iso && iso>=from && iso<=to;

  const useCash = (state.settings.accountingMethod||'cash')==='cash';
  let revenues = [];
  let revenueMinor = 0;
  if(useCash){
    revenues = (state.payments||[]).filter(p=> inRange(String(p.date||'').slice(0,10)));
    revenueMinor = revenues.reduce((s,p)=> Money.add(s, Money.toMinor(p.amount||0)), 0);
  }else{
    revenues = (state.invoices||[]).filter(i=> inRange(String(i.date||'').slice(0,10)));
    revenueMinor = revenues.reduce((s,i)=> Money.add(s, invoiceGrossMinor(i)), 0);
  }

  const tix = (state.tickets||[]).filter(t=>{
    const d = new Date(t.date||''); return d.getFullYear()===y && d.getMonth()===m;
  });
  const matsMinor = tix.reduce((s,t)=> Money.add(s, Money.toMinor(t.totalMaterialCost||0)), 0);

  const salariesNetMinor = salariesNetMonthMinor(y, m);
  const salariesGrossMinor = salariesGrossMonthMinor(y, m);

  const manualBreak = manualExpensesBreakdownMonth(y,m);
  const manualMinor = manualBreak.totalMinor;

  const costsMinor = Money.add(matsMinor, manualMinor, salariesGrossMinor);
  const profitMinor = Money.sub(revenueMinor, costsMinor);

  const revList = useCash
    ? revenues.slice().sort((a,b)=> (b.amount||0)-(a.amount||0))
    : revenues.slice().sort((a,b)=> Money.fromMinor(invoiceGrossMinor(b)) - Money.fromMinor(invoiceGrossMinor(a)));

  const matsList = tix
    .filter(t=> (t.totalMaterialCost||0)>0)
    .slice().sort((a,b)=> (b.totalMaterialCost||0) - (a.totalMaterialCost||0));

  return {
    revenueMinor, revList, useCash,
    matsMinor, matsList,
  salariesNetMinor,
  salariesGrossMinor,
    manualMinor, manualList: manualBreak.items,
    costsMinor, profitMinor
  };
}

function manualExpensesBreakdownMonth(y,m){
  const {from,to} = monthISORange(y,m);
  const inRange = (iso)=> iso && iso>=from && iso<=to;

  const singles = (state.expenses||[]).filter(e=>{
    return String(e.status||'planned')==='paid' && inRange(String(e.date||'').slice(0,10));
  }).map(e=> ({ kind:'single', date:String(e.date||'').slice(0,10), amount: +e.amount||0, category: e.category||'', desc:e.desc||'' }));

  const occ = expandRecurringExpenses(from, to).filter(x=> x.statusComputed==='paid');

  const items = [
    ...singles,
    ...occ.map(o => ({ kind:'rec', date:o.date, amount:+o.amount||0, category:o.category||'', desc:o.desc||'' }))
  ].sort((a,b)=> a.date.localeCompare(b.date));

  const totalMinor = items.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
  return { items, totalMinor };
}

function showMonthBreakdown(y,m){
  const out = breakdownMonth(y,m);
  const title = document.getElementById('month-title');
  const body  = document.getElementById('month-body');
  if(!title || !body) return;

  const ym = new Date(y, m, 1).toLocaleDateString('it-CH',{month:'long', year:'numeric'});
  title.textContent = `Dettaglio • ${ym}`;

  const money = (minor)=> Money.format(minor);

  const revRows = out.useCash
    ? out.revList.map(p=> `<tr><td>${p.date||''}</td><td>${h(p.method||'')}</td><td class="right">${formatCurrency(p.amount||0)}</td><td class="muted">${h(p.reference||'')}</td></tr>`).join('')
    : out.revList.map(i=> `<tr><td>${i.date||''}</td><td>${h(i.number||'')}</td><td class="right">${money(invoiceGrossMinor(i))}</td><td class="muted">${h(i.customer||'')}</td></tr>`).join('');

  const matsRows = out.matsList.map(t=>{
    const s = state.sites.find(x=> x.id===t.siteId);
    return `<tr><td>${t.date||''}</td><td>${h(s? s.name : (t.siteName||'—'))}</td><td class="right">${formatCurrency(t.totalMaterialCost||0)}</td><td class="muted">${h(t.note||'')}</td></tr>`;
  }).join('');

  const manRows = out.manualList.map(x=> `<tr><td>${x.date}</td><td>${h(x.category||'')}</td><td class="right">${formatCurrency(x.amount||0)}</td><td class="muted">${h(x.desc||'')}</td></tr>`).join('');

  body.innerHTML = `
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:1rem">
      <section class="card"><div class="card-header"><h3>Ricavi</h3><div class="muted">${out.useCash?'(pagamenti del mese)':'(fatture del mese)'}</div></div>
        <div class="card-content">
          <div class="kpi" style="margin-bottom:.5rem"><div class="label">Totale ricavi</div><div class="value">${money(out.revenueMinor)}</div></div>
          <div style="max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:10px">
            <table><thead><tr>${out.useCash?'<th>Data</th><th>Metodo</th><th class="right">Importo</th><th>Rif.</th>':'<th>Data</th><th>Numero</th><th class="right">Totale</th><th>Cliente</th>'}</tr></thead><tbody>${revRows||'<tr><td colspan="4" class="muted">Nessun dato</td></tr>'}</tbody></table>
          </div>
        </div>
      </section>

      <section class="card"><div class="card-header"><h3>Materiali (ticket)</h3></div>
        <div class="card-content">
          <div class="kpi" style="margin-bottom:.5rem"><div class="label">Totale materiali</div><div class="value">${money(out.matsMinor)}</div></div>
          <div style="max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:10px">
            <table><thead><tr><th>Data</th><th>Cantiere</th><th class="right">Importo</th><th>Note</th></tr></thead><tbody>${matsRows||'<tr><td colspan="4" class="muted">Nessun dato</td></tr>'}</tbody></table>
          </div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1"><div class="card-header"><h3>Spese manuali + Ricorrenti (pagate)</h3></div>
        <div class="card-content">
          <div class="kpi" style="margin-bottom:.5rem"><div class="label">Totale spese manuali</div><div class="value">${money(out.manualMinor)}</div></div>
          <div style="max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:10px">
            <table><thead><tr><th>Data</th><th>Categoria</th><th class="right">Importo</th><th>Note</th></tr></thead><tbody>${manRows||'<tr><td colspan="4" class="muted">Nessuna spesa</td></tr>'}</tbody></table>
          </div>
        </div>
      </section>

      <section class="card"><div class="card-header"><h3>Stipendi</h3></div>
        <div class="card-content">
          <div class="kpi"><div class="label">Netti (mese)</div><div class="value">${money(out.salariesNetMinor)}</div></div>
          <div class="kpi" style="margin-top:.5rem"><div class="label">Costo stimato (lordo)</div><div class="value">${money(out.salariesGrossMinor)}</div></div>
          <div class="muted" style="margin-top:.35rem">Netto dai dati collaboratore · Lordo da ore mensili previste × tariffa</div>
        </div>
      </section>

      <section class="card"><div class="card-header"><h3>Risultato</h3></div>
        <div class="card-content">
          <div class="kpi"><div class="label">Costi totali</div><div class="value">${money(out.costsMinor)}</div></div>
          <div class="kpi" style="margin-top:.5rem"><div class="label">Utile</div><div class="value">${money(out.profitMinor)}</div></div>
        </div>
      </section>
    </div>
  `;
  openMonthModal();
}
  // --- EXPORT per gli onclick inline ---
  window.registerInvoicePayment = registerInvoicePayment;
  window.revertPayment          = revertPayment;
  window.showMonthBreakdown     = showMonthBreakdown;
function lastNMonths(n){ const res=[]; const now=new Date(); for(let i=n-1;i>=0;i--){ const d = new Date(now.getFullYear(), now.getMonth()-i, 1); res.push({y:d.getFullYear(), m:d.getMonth(), label: d.toLocaleDateString('it-CH',{month:'short',year:'numeric'})}); } return res; }
function monthsOfCurrentYear(){
  const y = new Date().getFullYear();
  const out = [];
  for(let m=0; m<12; m++){
    const label = new Date(y, m, 1).toLocaleDateString('it-CH', { month:'short' });
    out.push({y, m, label});
  }
  return out;
}
function sumInvoicesMonth(y,m){ return state.invoices.filter(inv=>{ const d=new Date(inv.date); return d.getFullYear()===y && d.getMonth()===m; }).reduce((s,i)=> s+safeNum(i.amount),0); }
function drawBars(canvas, seriesA, seriesB, labels){
  // Patch: retina support
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.clientWidth, H = canvas.clientHeight;
  canvas.width = W*dpr; canvas.height = H*dpr;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);
  const max = Math.max(...seriesA, ...seriesB, 1)*1.15;
  const n = labels.length; const pad = 28; const gap = 10; const barW = (W - pad*2 - gap*(n-1)) / n;
  for(let i=0;i<n;i++){
    const x = pad + i*(barW+gap);
    const aH = (seriesA[i]/max)*(H-50);
    const bH = (seriesB[i]/max)*(H-50);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent'); ctx.fillRect(x, H-20-aH, barW*0.48, aH);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--danger'); ctx.fillRect(x+barW*0.52, H-20-bH, barW*0.48, bH);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted'); ctx.font = '12px Inter, system-ui'; ctx.textAlign='center';
    ctx.fillText(labels[i], x+barW/2, H-6);
  }
}

function drawBarsWithAxes(cvs, seriesA, seriesB, labels, {yLabelFmt=(v)=>new Intl.NumberFormat('it-CH').format(Math.round(v))}={}){
  const dpr = window.devicePixelRatio || 1;
  const W = cvs.clientWidth, H = cvs.clientHeight;
  cvs.width = W*dpr; cvs.height = H*dpr;
  const ctx = cvs.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);

  // margini plot
  const padL=56, padR=16, padT=20, padB=36;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const maxVal = Math.max(1, ...seriesA, ...seriesB) * 1.15;
  const x = (i)=> padL + (plotW * i / Math.max(1, labels.length-1));
  const h = (v)=> (v/maxVal) * plotH;

  // colori
  const cs = getComputedStyle(document.documentElement);
  const colAxis  = cs.getPropertyValue('--border') || '#334155';
  const colGrid  = 'rgba(148,163,184,.22)';
  const colText  = cs.getPropertyValue('--muted') || '#94a3b8';
  const colA     = cs.getPropertyValue('--accent').trim() || '#4da3ff';
  const colB     = cs.getPropertyValue('--danger').trim() || '#ef4444';

  // assi
  ctx.strokeStyle = colAxis; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, H-padB); ctx.lineTo(W-padR, H-padB); ctx.stroke();

  // griglia + tacche Y
  ctx.fillStyle = colText; ctx.font = '12px Inter, system-ui'; ctx.textAlign = 'right';
  const yTicks = 5;
  for(let i=0;i<=yTicks;i++){
    const val = (maxVal * i / yTicks);
    const y = H - padB - (plotH * i / yTicks);
    ctx.strokeStyle = colGrid;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W-padR, y); ctx.stroke();
    ctx.fillText(yLabelFmt(val), padL - 6, y + 4);
  }

  // tacche X (mesi)
  ctx.fillStyle = colText; ctx.textAlign='center';
  labels.forEach((lab,i)=> ctx.fillText(lab, x(i), H - 12));

  // barre
  const n = labels.length;
  const colW = Math.max(10, plotW / n * 0.8);
  const gap  = Math.max(4, (plotW/n - colW));
  const subW = colW * 0.48;

  // hitbox per click
  const hits = [];

  for(let i=0;i<n;i++){
    const baseX = padL + i*(colW+gap);
    const yBase = H - padB;

    const aH = h(seriesA[i]||0);
    const bH = h(seriesB[i]||0);

    // A (ricavi previsti)
    ctx.fillStyle = colA;
    ctx.fillRect(baseX, yBase - aH, subW, aH);
    hits.push({x:baseX, y:yBase-aH, w:subW, h:aH, idx:i, kind:'income'});

    // B (costi previsti)
    ctx.fillStyle = colB;
    ctx.fillRect(baseX + colW - subW, yBase - bH, subW, bH);
    hits.push({x:baseX + colW - subW, y:yBase-bH, w:subW, h:bH, idx:i, kind:'expense'});
  }

  // salva hitbox sul canvas
  cvs._fcHits = hits;
}

function drawLines(canvas, seriesA, seriesB, labels){
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.clientWidth, H = canvas.clientHeight;
  canvas.width = W*dpr; canvas.height = H*dpr;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);

  const padL = 48, padR = 14, padT = 22, padB = 28;
  const plotW = W - padL - padR;
  const plotH = H - padT - padB;

  const maxY = Math.max(...seriesA, ...seriesB, 1) * 1.15;
  const minY = 0;

  const x = (i)=> padL + (plotW * i / Math.max(1, labels.length-1));
  const y = (v)=> padT + plotH * (1 - (v - minY) / (maxY - minY));

  const cs = getComputedStyle(document.documentElement);
  ctx.strokeStyle = cs.getPropertyValue('--border');
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, H-padB); ctx.lineTo(W-padR, H-padB); ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(padL, padT); ctx.lineTo(padL, H-padB); ctx.stroke();

  ctx.fillStyle = cs.getPropertyValue('--muted');
  ctx.font = '12px Inter, system-ui';
  for(let i=0;i<=5;i++){
    const val = minY + (maxY-minY)*i/5;
    const yy = y(val);
    ctx.strokeStyle = 'rgba(148,163,184,.25)';
    ctx.beginPath(); ctx.moveTo(padL, yy); ctx.lineTo(W-padR, yy); ctx.stroke();
    ctx.fillText(new Intl.NumberFormat('it-CH').format(Math.round(val)), 6, yy+4);
  }

  labels.forEach((lab,i)=>{
    const xx = x(i);
    ctx.fillText(lab, xx-12, H-8);
  });

  ctx.strokeStyle = cs.getPropertyValue('--accent').trim() || '#4da3ff';
  ctx.lineWidth = 2;
  ctx.beginPath();
  seriesA.forEach((v,i)=>{ const xx=x(i), yy=y(v); i? ctx.lineTo(xx,yy): ctx.moveTo(xx,yy); });
  ctx.stroke();

  ctx.strokeStyle = cs.getPropertyValue('--danger').trim() || '#ef4444';
  ctx.lineWidth = 2;
  ctx.beginPath();
  seriesB.forEach((v,i)=>{ const xx=x(i), yy=y(v); i? ctx.lineTo(xx,yy): ctx.moveTo(xx,yy); });
  ctx.stroke();
}
function renderYearlyGraphs(){
  const canvas = byId('home-chart'); if(!canvas) return;
  const months = lastNMonths(12);
  const revenues = months.map(m=> Money.fromMinor(safeMinor(revenueMonthMinor(m.y, m.m))));
  const costs = months.map(m=>{
    const { laborMinor, matsMinor } = ticketBreakdownMonthMinor(m.y, m.m);
    return Money.fromMinor(Money.add(safeMinor(laborMinor), safeMinor(matsMinor)));
  });
  if(!revenues.length || !costs.length){
    console.warn('Dati grafico mancanti o errati');
    return;
  }
  drawBars(canvas, revenues, costs, months.map(m=> m.label));
}
// === serie 12 mesi ricavi/costi/utile
function marketSeries12m(){
  const months = lastNMonths(12);
  const labels = months.map(m => m.label);
  const rev = months.map(m => Money.fromMinor(safeMinor(revenueMonthMinor(m.y, m.m))));
  const cost = months.map(m => {
    const { laborMinor, matsMinor } = ticketBreakdownMonthMinor(m.y, m.m);
    const manual = manualExpensesMonthMinor(m.y, m.m);
    const salaries = salariesMonthMinor(m.y, m.m);
    return Money.fromMinor(Money.add(safeMinor(laborMinor), safeMinor(matsMinor), safeMinor(manual), safeMinor(salaries)));
  });
  const profit = rev.map((v,i)=> v - cost[i]);
  return {labels, rev, cost, profit};
}

// === disegno con assi e tacche, solo linee
function drawMarket(canvas, series){
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.clientWidth, H = canvas.clientHeight;
  canvas.width = W*dpr; canvas.height = H*dpr;
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);

  const padL=56, padR=18, padT=18, padB=30;
  const all = [...series.rev, ...series.cost, ...series.profit];
  const max = Math.max(...all,1), min = Math.min(...all,0);
  const span = Math.max(1e-6, max-min);
  const n = series.labels.length;
  const X = i => padL + (n<=1?0:i*(W-padL-padR)/(n-1));
  const Y = v => H-padB - ((v-min)/span)*(H-padT-padB);

  const cs = getComputedStyle(document.documentElement);
  const colAx = cs.getPropertyValue('--border');
  const colTxt= cs.getPropertyValue('--muted');
  const cRev  = cs.getPropertyValue('--accent').trim()  || '#4da3ff';
  const cCost = cs.getPropertyValue('--danger').trim()  || '#ef4444';
  const cProf = cs.getPropertyValue('--success').trim() || '#22c55e';

  // assi
  ctx.strokeStyle = colAx; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke();

  // tacche Y (5)
  ctx.fillStyle = colTxt; ctx.font = '12px Inter, system-ui'; ctx.textAlign='right';
  for(let k=0;k<=5;k++){
    const v = min + (span*k/5);
    const y = Y(v);
    ctx.strokeStyle = 'rgba(148,163,184,.15)'; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    ctx.fillText(formatCurrency(v), padL-6, y+4);
  }

  // tacche X (mesi)
  ctx.textAlign='center';
  for(let i=0;i<n;i++){
    const x = X(i);
    if(i%2===0){
      ctx.fillStyle = colTxt;
      ctx.fillText(series.labels[i], x, H-10);
    }
  }

  // disegna linea
  function line(values, color){
    ctx.beginPath();
    values.forEach((v,i)=> i?ctx.lineTo(X(i),Y(v)):ctx.moveTo(X(i),Y(v)));
    ctx.lineWidth = 2; ctx.strokeStyle = color; ctx.stroke();
  }
  line(series.cost, cCost);
  line(series.rev,  cRev);
  line(series.profit, cProf);

  // puntino ultimo
  function dot(values, color){
    const x = X(values.length-1), y = Y(values[values.length-1]);
    ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x,y,3.5,0,Math.PI*2); ctx.fill();
  }
  dot(series.cost, cCost); dot(series.rev, cRev); dot(series.profit, cProf);
}

// === mount + tracer live (avanza dentro l'ultimo mese)
let __marketTimer = null;
function renderMarketCard(){
  const cvs = document.getElementById('market-chart'); if(!cvs) return;
  const S = marketSeries12m();
  drawMarket(cvs, S);
  const sub = document.getElementById('mk-sub');
  if(sub){
    const sr = S.rev.reduce((a,b)=>a+b,0), sc = S.cost.reduce((a,b)=>a+b,0);
    sub.textContent = `Totali 12m — Ricavi ${formatCurrency(sr)} · Costi ${formatCurrency(sc)} · Utile ${formatCurrency(sr-sc)}`;
  }

  // tracer live (posizione = progressione del mese corrente)
  const tracer = document.getElementById('market-tracer');
  if(tracer){
    const monthProgress = (()=>{ const d=new Date(); const e=new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); return (d.getDate()-1)/(e-1||1); })();
    const n = S.labels.length;
    const padL=56, padR=18; const W = cvs.clientWidth;
    const idxPrev = Math.max(0, n-2);
    const idxCurr = Math.max(0, n-1);
    const spanX = (W-padL-padR)/(n<=1?1:(n-1));
    const x0 = padL + idxPrev*spanX;
    const x1 = padL + idxCurr*spanX;
    const progress = Math.max(0, Math.min(1, monthProgress));
    tracer.style.left = `${x0 + (x1-x0)*progress}px`;
  }
}

function renderMarketChart(){ renderMarketCard(); }

function startMarketLive(){
  stopMarketLive();
  renderMarketCard();
  __marketTimer = setInterval(()=>{ renderMarketCard(); }, 1000*30);
}
function stopMarketLive(){ if(__marketTimer){ clearInterval(__marketTimer); __marketTimer=null; }}

// redisegna su resize/visibilità
window.addEventListener('resize', ()=> renderMarketCard());
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) renderMarketCard(); });

function renderHomeChart(){ renderYearlyGraphs(); }
window.renderYearlyGraphs = renderYearlyGraphs;
// >>> PATCH: unifica getCollabCostRate
function getCollabCostRate(collabId) {
  const c = state.collaborators.find(x => x.id === collabId);
  const fallback = Number(state.settings.costHour) || 35;
  const rate = Number(c?.rate) > 0 ? Number(c.rate) : fallback;
  return rate > 0 ? rate : 35;
}

// Normalizza sempre i campi "order" a 0..n-1 in base all'ordinamento corrente
function normalizeCollaboratorOrder(){
  const arr = state.collaborators || [];
  const sorted = arr.slice().sort((a,b)=>{
    const ao = Number.isFinite(+a.order) ? +a.order : Number.POSITIVE_INFINITY;
    const bo = Number.isFinite(+b.order) ? +b.order : Number.POSITIVE_INFINITY;
    if (ao !== bo) return ao - bo;
    return (a.name||'').localeCompare(b.name||'');
  });
  sorted.forEach((c,i)=> { c.order = i; });
}

function getCollaboratorsSorted(){
  return (state.collaborators||[]).slice().sort((a,b)=>{
    const ao = Number.isFinite(+a.order)? +a.order : Number.POSITIVE_INFINITY;
    const bo = Number.isFinite(+b.order)? +b.order : Number.POSITIVE_INFINITY;
    if(ao!==bo) return ao - bo;
    return (a.name||'').localeCompare(b.name||'');
  });
}

function ticketLaborMinor(t){
  const ids = Array.isArray(t?.collabIds)? t.collabIds.filter(Boolean) : (t?.collabId?[t.collabId]:[]);
  if(!ids.length) return 0;
  if(t?.collabHours && typeof t.collabHours==='object'){
    return ids.reduce((s,cid)=>{
      const hours = safeNum(t.collabHours[cid]||0);
      if(hours<=0) return s;
      return s + Math.round(hours * getCollabCostRate(cid) * 100);
    }, 0);
  }
  const portion = safeNum(t?.hours) / Math.max(1, ids.length);
  return ids.reduce((s,cid)=> s + Math.round(portion * getCollabCostRate(cid) * 100), 0);
}

function getDashboardFinancialSnapshot(){
  const year = new Date().getFullYear();
  const tickets = (state.tickets||[]).filter(t=>{
    const d = new Date(t.date||'');
    return !isNaN(+d) && d.getFullYear()===year;
  });
  const regiaRate = safeNum(state.settings?.regiaRate) || 85;
  const markupPct = safeNum(state.settings?.markup) || 10;

  const hoursRegia = tickets.filter(t=> !!t.isRegia).reduce((sum,t)=> sum + safeNum(t.hours), 0);
  const hoursCantieri = tickets.filter(t=> !t.isRegia).reduce((sum,t)=> sum + safeNum(t.hours), 0);

  const revenueHoursMinor = tickets.reduce((sum,t)=>{
    const hrs = safeNum(t.hours);
    if(hrs<=0) return sum;
    return Money.add(sum, Math.round(hrs * regiaRate * 100));
  }, 0);
  const revenueMatMinor = tickets.reduce((sum,t)=>{
    const base = safeNum(t.totalMaterialCost);
    if(!base) return sum;
    const val = base * (1 + markupPct/100);
    return Money.add(sum, Money.toMinor(val));
  }, 0);

  const laborMinor = tickets.reduce((sum,t)=> Money.add(sum, ticketLaborMinor(t)), 0);
  const matsMinor = tickets.reduce((sum,t)=> Money.add(sum, Money.toMinor(safeNum(t.totalMaterialCost))), 0);
  const manualMinor = (state.expenses||[])
    .filter(e=> String(e.status||'').toLowerCase()==='paid')
    .filter(e=>{ const d=new Date(e.date||''); return !isNaN(+d) && d.getFullYear()===year; })
    .reduce((sum,e)=> Money.add(sum, Money.toMinor(e.amount||0)), 0);
  const salariesNetMinor = salariesNetYTDMinor(year);
  const salariesGrossMinor = salariesGrossYTDMinor(year);

  const revenueMinor = Money.add(revenueHoursMinor, revenueMatMinor);
  const costsMinor = Money.add(laborMinor, matsMinor, manualMinor, salariesGrossMinor);
  const profitMinor = Money.sub(revenueMinor, costsMinor);

  return {
    year,
    tickets,
    regiaRate,
    markupPct,
    revenue: {
      totalMinor: revenueMinor,
      hoursMinor: revenueHoursMinor,
      matsMinor: revenueMatMinor,
      hoursRegia,
      hoursCantieri
    },
    costs: {
      totalMinor: costsMinor,
      laborMinor,
      matsMinor,
      manualMinor,
      salariesNetMinor,
      salariesGrossMinor
    },
    profitMinor
  };
}

function openDashboardDetail(type){
  const fmtDate = (iso)=>{
    if(!iso) return '—';
    const d = new Date(iso);
    return isNaN(+d) ? '—' : d.toLocaleDateString('it-CH');
  };
  const fmtHours = (val)=>{
    const num = Number(val||0);
    return Number.isFinite(num) ? num.toFixed(2) : '0.00';
  };
  const siteName = (ticket)=>{
    if(!ticket) return '—';
    const site = (state.sites||[]).find(s=> s.id===ticket.siteId);
    if(site) return site.name;
    if(ticket.siteName) return ticket.siteName;
    return ticket.isRegia ? 'Regia' : '—';
  };

  const handlers = {
    'revenue-live': ()=>{
      const snap = getDashboardFinancialSnapshot();
      const totalHours = snap.revenue.hoursRegia + snap.revenue.hoursCantieri;
      const markupMinor = Math.max(0, Money.sub(snap.revenue.matsMinor, snap.costs.matsMinor));
      const regiaValueMinor = Math.max(0, Math.round(snap.revenue.hoursRegia * snap.regiaRate * 100));
      const cantieriValueMinor = Math.max(0, Money.sub(snap.revenue.hoursMinor, regiaValueMinor));
      const top = snap.tickets.map(ticket=>{
        const hours = safeNum(ticket.hours);
        const hoursValMinor = Math.round(hours * snap.regiaRate * 100);
        const matsValMinor = Money.toMinor(safeNum(ticket.totalMaterialCost) * (1 + snap.markupPct/100));
        const totalMinor = Money.add(hoursValMinor, matsValMinor);
        return { ticket, hours, hoursValMinor, matsValMinor, totalMinor };
      }).filter(x=> x.totalMinor>0)
        .sort((a,b)=> b.totalMinor - a.totalMinor)
        .slice(0, 12);
      const note = top.length ? `<div class="muted" style="margin-bottom:.5rem">Prime ${top.length} voci ordinate per ricavo stimato.</div>` : '';
      const rows = top.map(entry=>{
        const {ticket, hours, hoursValMinor, matsValMinor, totalMinor} = entry;
        return `<tr>
          <td>${fmtDate(ticket.date)}</td>
          <td>${h(siteName(ticket))}</td>
          <td class="right">${fmtHours(hours)}</td>
          <td class="right">${Money.format(hoursValMinor)}</td>
          <td class="right">${Money.format(matsValMinor)}</td>
          <td class="right">${Money.format(totalMinor)}</td>
        </tr>`;
      }).join('');
      const table = top.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Cantiere</th>
                <th class="right">Ore</th>
                <th class="right">Valore ore</th>
                <th class="right">Materiali</th>
                <th class="right">Totale stimato</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessun ticket registrato nel ${snap.year}.</div>`;

      const html = `
        <div class="detail-grid">
          <div class="kpi"><div class="label">Ricavi ${snap.year}</div><div class="value">${Money.format(snap.revenue.totalMinor)}</div><div class="kpi-sub">Ore totali ${fmtHours(totalHours)} h</div></div>
          <div class="kpi"><div class="label">Ore a regia</div><div class="value">${fmtHours(snap.revenue.hoursRegia)} h</div><div class="kpi-sub">Tariffa ${formatCurrency(snap.regiaRate)}</div></div>
          <div class="kpi"><div class="label">Ore cantieri</div><div class="value">${fmtHours(snap.revenue.hoursCantieri)} h</div><div class="kpi-sub">Valore stimato ${Money.format(cantieriValueMinor)}</div></div>
          <div class="kpi"><div class="label">Materiali + markup (${Number(snap.markupPct||0).toFixed(1)}%)</div><div class="value">${Money.format(snap.revenue.matsMinor)}</div><div class="kpi-sub">Markup stimato ${Money.format(markupMinor)}</div></div>
        </div>
        <h4 style="margin:1rem 0 .5rem">Ticket principali</h4>
        ${note}
        ${table}`;
      return { title: 'Guadagni live · dettaglio', html };
    },

    'costs-live': ()=>{
      const snap = getDashboardFinancialSnapshot();
      const top = snap.tickets.map(ticket=>{
        const laborMinor = ticketLaborMinor(ticket);
        const matsMinor = Money.toMinor(safeNum(ticket.totalMaterialCost));
        const totalMinor = Money.add(laborMinor, matsMinor);
        return { ticket, laborMinor, matsMinor, totalMinor, hours: safeNum(ticket.hours) };
      }).filter(x=> x.totalMinor>0)
        .sort((a,b)=> b.totalMinor - a.totalMinor)
        .slice(0, 12);
      const rows = top.map(entry=>{
        const {ticket, laborMinor, matsMinor, totalMinor, hours} = entry;
        return `<tr>
          <td>${fmtDate(ticket.date)}</td>
          <td>${h(siteName(ticket))}</td>
          <td class="right">${fmtHours(hours)}</td>
          <td class="right">${Money.format(laborMinor)}</td>
          <td class="right">${Money.format(matsMinor)}</td>
          <td class="right">${Money.format(totalMinor)}</td>
        </tr>`;
      }).join('');
      const table = top.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Cantiere</th>
                <th class="right">Ore</th>
                <th class="right">Costo manodopera</th>
                <th class="right">Materiali</th>
                <th class="right">Totale costo</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessun costo registrato nel ${snap.year}.</div>`;

      const expenses = (state.expenses||[])
        .filter(e=> String(e.status||'').toLowerCase()==='paid')
        .filter(e=>{ const d=new Date(e.date||''); return !isNaN(+d) && d.getFullYear()===snap.year; })
        .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
      const expRows = expenses.map(e=>{
        return `<tr>
          <td>${fmtDate(e.date)}</td>
          <td>${h(e.category||'Senza categoria')}</td>
          <td>${h(e.desc||'—')}</td>
          <td class="right">${Money.format(Money.toMinor(e.amount||0))}</td>
        </tr>`;
      }).join('');
      const expTable = expenses.length ? `
        <div class="table-scroll-lg" style="max-height:240px;margin-top:.5rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Categoria</th>
                <th>Descrizione</th>
                <th class="right">Importo</th>
              </tr>
            </thead>
            <tbody>${expRows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:.5rem">Nessuna spesa manuale registrata nel ${snap.year}.</div>`;

      const html = `
        <div class="detail-grid">
          <div class="kpi"><div class="label">Costi ${snap.year}</div><div class="value">${Money.format(snap.costs.totalMinor)}</div><div class="kpi-sub">Include ticket, spese e stipendi</div></div>
          <div class="kpi"><div class="label">Manodopera ticket</div><div class="value">${Money.format(snap.costs.laborMinor)}</div><div class="kpi-sub">Costo orario collaboratori</div></div>
          <div class="kpi"><div class="label">Materiali ticket</div><div class="value">${Money.format(snap.costs.matsMinor)}</div><div class="kpi-sub">Valore effettivo acquisti</div></div>
          <div class="kpi"><div class="label">Spese manuali</div><div class="value">${Money.format(snap.costs.manualMinor)}</div><div class="kpi-sub">Pagate nel ${snap.year}</div></div>
          <div class="kpi"><div class="label">Stipendi netti YTD</div><div class="value">${Money.format(snap.costs.salariesNetMinor)}</div><div class="kpi-sub">Somma netti dichiarati</div></div>
          <div class="kpi"><div class="label">Stipendi stimati (lordo)</div><div class="value">${Money.format(snap.costs.salariesGrossMinor)}</div><div class="kpi-sub">Ore mensili previste × tariffa</div></div>
        </div>
        <h4 style="margin:1rem 0 .5rem">Ticket più onerosi</h4>
        ${table}
        <h4 style="margin:1.2rem 0 .5rem">Spese manuali registrate</h4>
        ${expTable}`;
      return { title: 'Costi live · dettaglio', html };
    },

    'profit-live': ()=>{
      const snap = getDashboardFinancialSnapshot();
      const revenueMajor = Money.fromMinor(snap.revenue.totalMinor);
      const profitMajor = Money.fromMinor(snap.profitMinor);
      const marginPct = revenueMajor>0 ? (profitMajor/revenueMajor)*100 : 0;
      const regiaValueMinor = Math.max(0, Math.round(snap.revenue.hoursRegia * snap.regiaRate * 100));
      const cantieriValueMinor = Math.max(0, Money.sub(snap.revenue.hoursMinor, regiaValueMinor));

      const html = `
        <div class="detail-grid">
          <div class="kpi"><div class="label">Ricavi YTD</div><div class="value">${Money.format(snap.revenue.totalMinor)}</div><div class="kpi-sub">Valore ore ${Money.format(snap.revenue.hoursMinor)} · Materiali ${Money.format(snap.revenue.matsMinor)}</div></div>
          <div class="kpi"><div class="label">Costi YTD</div><div class="value">${Money.format(snap.costs.totalMinor)}</div><div class="kpi-sub">Manodopera ${Money.format(snap.costs.laborMinor)} · Materiali ${Money.format(snap.costs.matsMinor)} · Stipendi ${Money.format(snap.costs.salariesGrossMinor)}</div></div>
          <div class="kpi"><div class="label">Utile stimato</div><div class="value">${Money.format(snap.profitMinor)}</div><div class="kpi-sub">Margine ${marginPct.toFixed(1)}%</div></div>
        </div>
        <div style="margin-top:1rem">
          <h4>Breakdown rapido</h4>
          <ul style="line-height:1.6; margin:.6rem 0 0; padding-left:1.1rem">
            <li>Ore a regia: ${fmtHours(snap.revenue.hoursRegia)} h · ${Money.format(regiaValueMinor)}</li>
            <li>Ore cantieri: ${fmtHours(snap.revenue.hoursCantieri)} h · ${Money.format(cantieriValueMinor)}</li>
            <li>Materiali (base): ${Money.format(snap.costs.matsMinor)}</li>
            <li>Markup previsto: ${Money.format(Math.max(0, Money.sub(snap.revenue.matsMinor, snap.costs.matsMinor)))}</li>
            <li>Spese manuali: ${Money.format(snap.costs.manualMinor)}</li>
            <li>Stipendi netti YTD: ${Money.format(snap.costs.salariesNetMinor)}</li>
            <li>Stipendi stimati (lordo): ${Money.format(snap.costs.salariesGrossMinor)}</li>
          </ul>
        </div>`;
      return { title: 'Utile live · dettaglio', html };
    },

    'cash-actual': ()=>{
      const st = CardWindow.load('cash-ultimi-7', {days:7});
      const today = Dates.todayISO();
      const daySpan = Math.max(1, Number(st.days||7));
      const from = addDaysISO(today, -daySpan);
      const payments = (state.payments||[])
        .filter(p=>{
          const d = String(p.date||'').slice(0,10);
          return d && d>=from && d<=today;
        })
        .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));
      const totalMinor = payments.reduce((sum,p)=> Money.add(sum, Money.toMinor(p.amount||0)), 0);
      const rows = payments.map(p=>{
        const invoice = (state.invoices||[]).find(inv=> inv.id===p.invoiceId);
        const customer = invoice?.customer || p.customer || '—';
        const ref = p.reference || invoice?.number || '—';
        return `<tr>
          <td>${fmtDate(p.date)}</td>
          <td>${h(customer)}</td>
          <td>${h(ref)}</td>
          <td class="right">${Money.format(Money.toMinor(p.amount||0))}</td>
        </tr>`;
      }).join('');
      const table = payments.length ? `
        <div class="table-scroll-lg" style="max-height:360px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Cliente</th>
                <th>Riferimento</th>
                <th class="right">Importo</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessun incasso nell'intervallo selezionato.</div>`;

      const html = `
        <div class="kpi"><div class="label">Totale incassi ultimi ${daySpan} giorni</div><div class="value">${Money.format(totalMinor)}</div><div class="kpi-sub">${fmtDate(from)} → ${fmtDate(today)}</div></div>
        ${table}`;
      return { title: 'Incassi avvenuti · dettaglio', html };
    },

    'expenses-actual': ()=>{
      const st = CardWindow.load('spese-ultimi', 15);
      const today = Dates.todayISO();
      const daySpan = Math.max(1, Number(st.days||15));
      const from = addDaysISO(today, -daySpan);
      const range = expensesInRange(from, today);
      const tickets = (state.tickets||[]).filter(t=>{
        const d = String(t.date||'').slice(0,10);
        return d && d>=from && d<=today;
      });
      const expenses = (state.expenses||[])
        .filter(e=> String(e.status||'').toLowerCase()==='paid')
        .filter(e=>{ const d=String(e.date||'').slice(0,10); return d && d>=from && d<=today; })
        .sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));

      const ticketRows = tickets.map(t=>{
        const labor = ticketLaborMinor(t);
        const mats = Money.toMinor(safeNum(t.totalMaterialCost));
        return `<tr>
          <td>${fmtDate(t.date)}</td>
          <td>${h(siteName(t))}</td>
          <td class="right">${fmtHours(safeNum(t.hours))}</td>
          <td class="right">${Money.format(labor)}</td>
          <td class="right">${Money.format(mats)}</td>
        </tr>`;
      }).join('');
      const ticketTable = tickets.length ? `
        <div class="table-scroll-lg" style="max-height:220px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Cantiere</th>
                <th class="right">Ore</th>
                <th class="right">Costo manodopera</th>
                <th class="right">Materiali</th>
              </tr>
            </thead>
            <tbody>${ticketRows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:.75rem">Nessun ticket nell'intervallo.</div>`;

      const expRows = expenses.map(e=>`
        <tr>
          <td>${fmtDate(e.date)}</td>
          <td>${h(e.category||'Senza categoria')}</td>
          <td>${h(e.desc||'—')}</td>
          <td class="right">${Money.format(Money.toMinor(e.amount||0))}</td>
        </tr>`).join('');
      const expTable = expenses.length ? `
        <div class="table-scroll-lg" style="max-height:220px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Categoria</th>
                <th>Descrizione</th>
                <th class="right">Importo</th>
              </tr>
            </thead>
            <tbody>${expRows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:.75rem">Nessuna spesa manuale nell'intervallo.</div>`;

      const html = `
        <div class="detail-grid">
          <div class="kpi"><div class="label">Totale spese</div><div class="value">${Money.format(range.totalMinor)}</div><div class="kpi-sub">${fmtDate(from)} → ${fmtDate(today)}</div></div>
          <div class="kpi"><div class="label">Manodopera ticket</div><div class="value">${Money.format(range.laborMinor)}</div></div>
          <div class="kpi"><div class="label">Materiali ticket</div><div class="value">${Money.format(range.matsMinor)}</div></div>
          <div class="kpi"><div class="label">Spese manuali</div><div class="value">${Money.format(range.manualMinor)}</div></div>
        </div>
        <h4 style="margin:1rem 0 .3rem">Ticket coinvolti</h4>
        ${ticketTable}
        <h4 style="margin:1.2rem 0 .3rem">Spese registrate</h4>
        ${expTable}`;
      return { title: 'Spese effettuate · dettaglio', html };
    },

    'cash-planned': ()=>{
      const st = CardWindow.load('incassi-programmati', 15);
      const defDays = Math.max(1, Number(st.days||15));
      const today = Dates.todayISO();
      const from = (st.from && st.from<=st.to) ? st.from : today;
      const to = st.to ? st.to : addDaysISO(today, defDays);
      const upcoming = (state.invoices||[])
        .filter(inv=>{
          const status = String(inv.status||'').toLowerCase();
          if(status==='paid' || status==='canceled') return false;
          const due = String(inv.dueDate || inv.due || inv.scadenza || '').slice(0,10);
          return due && due>=from && due<=to;
        })
        .sort((a,b)=> String(a.dueDate||a.due||a.scadenza||'').localeCompare(String(b.dueDate||b.due||b.scadenza||'')));
      const totalMinor = upcoming.reduce((sum,inv)=> Money.add(sum, invoiceRemainingMinor(inv)), 0);
      const rows = upcoming.map(inv=>{
        const due = String(inv.dueDate || inv.due || inv.scadenza || '').slice(0,10);
        return `<tr>
          <td>${h(inv.number||'')}</td>
          <td>${h(inv.customer||'—')}</td>
          <td>${fmtDate(due)}</td>
          <td class="right">${Money.format(invoiceRemainingMinor(inv))}</td>
        </tr>`;
      }).join('');
      const table = upcoming.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Fattura</th>
                <th>Cliente</th>
                <th>Scadenza</th>
                <th class="right">Residuo</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessun incasso programmato nell'intervallo.</div>`;

      const html = `
        <div class="kpi"><div class="label">Residuo previsto</div><div class="value">${Money.format(totalMinor)}</div><div class="kpi-sub">${fmtDate(from)} → ${fmtDate(to)}</div></div>
        ${table}`;
      return { title: 'Incassi programmati · dettaglio', html };
    },

    'expenses-planned': ()=>{
      const st = CardWindow.load('spese-programmate', 15);
      const defDays = Math.max(1, Number(st.days||15));
      const today = Dates.todayISO();
      const from = (st.from && st.from<= (st.to||st.from)) ? st.from : today;
      const to = st.to ? st.to : addDaysISO(today, defDays);
      const items = upcomingExpensesRange(from, to);
      const totalMinor = items.reduce((sum,x)=> Money.add(sum, Money.toMinor(x.amount||0)), 0);
      const rows = items.map(x=>{
        const status = x.statusComputed==='paid' ? 'Pagata' : 'Planned';
        return `<tr>
          <td>${fmtDate(x.date)}</td>
          <td>${h(x.category||'—')}</td>
          <td>${h(x.desc||'')}</td>
          <td class="right">${Money.format(Money.toMinor(x.amount||0))}</td>
          <td>${status}</td>
        </tr>`;
      }).join('');
      const table = items.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Categoria</th>
                <th>Descrizione</th>
                <th class="right">Importo</th>
                <th>Stato</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessuna spesa programmata nell'intervallo.</div>`;

      const html = `
        <div class="kpi"><div class="label">Spese previste</div><div class="value">${Money.format(totalMinor)}</div><div class="kpi-sub">${fmtDate(from)} → ${fmtDate(to)}</div></div>
        ${table}`;
      return { title: 'Spese programmate · dettaglio', html };
    },

    'offers-active': ()=>{
      const items = (state.offers||[])
        .filter(o=> String(o.stato||'').toLowerCase()==='in_corso')
        .sort((a,b)=> String(a.scadenza||'').localeCompare(String(b.scadenza||'')));
      const total = items.reduce((sum,o)=> sum + safeNum(o.importo), 0);
      const rows = items.map(o=>{
        return `<tr>
          <td>${h(o.nome||'—')}</td>
          <td>${h(o.cliente||'—')}</td>
          <td class="right">${formatCurrency(o.importo||0)}</td>
          <td class="right">${o.probabilita ? `${safeNum(o.probabilita).toFixed(0)}%` : '—'}</td>
          <td>${fmtDate(o.scadenza)}</td>
        </tr>`;
      }).join('');
      const table = items.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Progetto</th>
                <th>Cliente</th>
                <th class="right">Importo</th>
                <th class="right">Prob.</th>
                <th>Scadenza</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessuna offerta attiva.</div>`;

      const html = `
        <div class="kpi"><div class="label">Offerte in corso</div><div class="value">${items.length}</div><div class="kpi-sub">Potenziale ${formatCurrency(total)}</div></div>
        ${table}`;
      return { title: 'Offerte attive · dettaglio', html };
    },

    'sites-active': ()=>{
      const sites = (state.sites||[]).filter(s=> String(s.status||'').toLowerCase()==='attivo');
      const rows = sites.map(site=>{
        const est = safeNum(site.estimatedHours);
        const tickets = (state.tickets||[]).filter(t=> t.siteId===site.id);
        const worked = tickets.reduce((sum,t)=> sum + safeNum(t.hours), 0);
        const remaining = Math.max(0, est - worked);
        const progress = est>0 ? (worked/est)*100 : 0;
        const budgetMinor = siteBudgetRemainingMinor(site);
        return { site, est, worked, remaining, progress, budgetMinor };
      }).sort((a,b)=> b.remaining - a.remaining);
      const tableRows = rows.map(entry=>{
        const {site, est, worked, remaining, progress, budgetMinor} = entry;
        return `<tr>
          <td>${h(site.name||'—')}</td>
          <td class="right">${fmtHours(worked)}</td>
          <td class="right">${fmtHours(est)}</td>
          <td class="right">${fmtHours(remaining)}</td>
          <td class="right">${progress.toFixed(1)}%</td>
          <td class="right">${Money.format(budgetMinor)}</td>
        </tr>`;
      }).join('');
      const table = rows.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Cantiere</th>
                <th class="right">Ore lavorate</th>
                <th class="right">Ore previste</th>
                <th class="right">Residuo</th>
                <th class="right">Avanzamento</th>
                <th class="right">Budget residuo</th>
              </tr>
            </thead>
            <tbody>${tableRows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessun cantiere attivo.</div>`;

      const totalRemaining = rows.reduce((sum,x)=> sum + x.remaining, 0);
      const totalBudget = rows.reduce((sum,x)=> Money.add(sum, x.budgetMinor), 0);
      const html = `
        <div class="detail-grid">
          <div class="kpi"><div class="label">Cantieri attivi</div><div class="value">${rows.length}</div></div>
          <div class="kpi"><div class="label">Ore residue complessive</div><div class="value">${fmtHours(totalRemaining)}</div></div>
          <div class="kpi"><div class="label">Budget residuo</div><div class="value">${Money.format(totalBudget)}</div></div>
        </div>
        ${table}`;
      return { title: 'Cantieri attivi · dettaglio', html };
    },

    'invoices-overdue': ()=>{
      const items = (state.invoices||[])
        .filter(inv=> isInvoiceOverdue(inv))
        .sort((a,b)=> String(a.dueDate||a.due||a.scadenza||'').localeCompare(String(b.dueDate||b.due||b.scadenza||'')));
      const totalMinor = items.reduce((sum,inv)=> Money.add(sum, invoiceRemainingMinor(inv)), 0);
      const rows = items.map(inv=>{
        const due = String(inv.dueDate||inv.due||inv.scadenza||'').slice(0,10);
        return `<tr>
          <td>${h(inv.number||'—')}</td>
          <td>${h(inv.customer||'—')}</td>
          <td>${fmtDate(due)}</td>
          <td class="right">${Money.format(invoiceRemainingMinor(inv))}</td>
        </tr>`;
      }).join('');
      const table = items.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Fattura</th>
                <th>Cliente</th>
                <th>Scadenza</th>
                <th class="right">Residuo</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessuna fattura scaduta. 🎉</div>`;

      const html = `
        <div class="kpi"><div class="label">Fatture scadute</div><div class="value">${items.length}</div><div class="kpi-sub">Totale ${Money.format(totalMinor)}</div></div>
        ${table}`;
      return { title: 'Fatture scadute · dettaglio', html };
    },

    'budget-remaining': ()=>{
      const entries = (state.sites||[])
        .map(site=>({ site, rem: siteBudgetRemainingMinor(site) }))
        .filter(x=> x.rem>0)
        .sort((a,b)=> b.rem - a.rem);
      const totalMinor = entries.reduce((sum,x)=> Money.add(sum, x.rem), 0);
      const rows = entries.map(({site, rem})=>{
        return `<tr>
          <td>${h(site.name||'—')}</td>
          <td class="right">${Money.format(rem)}</td>
          <td class="right">${site.offerAmount ? formatCurrency(site.offerAmount) : '—'}</td>
        </tr>`;
      }).join('');
      const table = entries.length ? `
        <div class="table-scroll-lg" style="max-height:320px;margin-top:.75rem">
          <table>
            <thead>
              <tr>
                <th>Cantiere</th>
                <th class="right">Budget residuo</th>
                <th class="right">Offerta</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : `<div class="muted" style="margin-top:1rem">Nessun budget residuo positivo.</div>`;

      const html = `
        <div class="kpi"><div class="label">Budget residuo</div><div class="value">${Money.format(totalMinor)}</div><div class="kpi-sub">${entries.length} cantieri con margine</div></div>
        ${table}`;
      return { title: 'Budget residuo cantieri · dettaglio', html };
    }
  };

  const render = handlers[type];
  if(!render) return;
  const { title, html } = render();
  openFloatingModal(title, html);
}

/* ===========================================================
   DASHBOARD IMPROVEMENTS - EXPANDABLE CARDS
   =========================================================== */
function setupDashboardCards() {
  const kpiCards = document.querySelectorAll('.card.kpi[data-detail]');
  kpiCards.forEach(card=>{
    const detail = card.getAttribute('data-detail');
    if(!detail || card.dataset.kpiBound==='1') return;
    card.dataset.kpiBound = '1';
    card.classList.add('kpi-clickable');
    card.setAttribute('role','button');
    card.setAttribute('tabindex','0');
    const label = card.querySelector('.kpi-label, .label');
    if(label && !card.getAttribute('aria-label')){
      card.setAttribute('aria-label', `Apri dettaglio ${label.textContent.trim()}`);
    }
    const activate = ()=> openDashboardDetail(detail);
    card.addEventListener('click', activate);
    card.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); activate(); }
    });
  });

  // Set up expandable cards
  const cards = document.querySelectorAll('.dashboard-card');
  cards.forEach(card => {
    const header = card.querySelector('.dashboard-card-header');
    if (!header) return;
    const content = card.querySelector('.dashboard-card-content');
    const mode = (card.getAttribute('data-expand') || 'no').toLowerCase();
    const expandIcon = header.querySelector('.expand-icon');

    const enableToggle = () => {
      header.setAttribute('role', 'button');
      header.setAttribute('tabindex', '0');
      header.setAttribute('aria-expanded', 'false');
      if (expandIcon) expandIcon.style.display = 'inline-block';
      const collapse = () => {
        if (content) content.style.maxHeight = '0px';
        card.classList.remove('expanded');
        header.setAttribute('aria-expanded', 'false');
      };
      const expand = () => {
        card.classList.add('expanded');
        if (content) content.style.maxHeight = content.scrollHeight + 'px';
        header.setAttribute('aria-expanded', 'true');
      };
      const toggle = () => {
        if (card.classList.contains('expanded')) collapse(); else expand();
      };
      header.addEventListener('click', toggle);
      header.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
    };

    if (mode === 'no') {
      if (expandIcon) expandIcon.style.display = 'none';
      header.style.cursor = 'default';
      return;
    }

    // Force expandable behavior for phases card to allow user-triggered expansion even if content isn't long yet
    if (card.id === 'card-phases') {
      if (expandIcon) expandIcon.style.display = 'inline-block';
      enableToggle();
      return;
    }

    if (mode === 'auto') {
      requestAnimationFrame(() => {
        const longEnough = content && content.scrollHeight > 240;
        if (longEnough) enableToggle(); else {
          if (expandIcon) expandIcon.style.display = 'none';
          header.style.cursor = 'default';
        }
      });
    }
  });
}

/* ===========================================================
   CASH WINDOW (persistente) per incassi programmati
   =========================================================== */
function loadCashWindow(){
  try{
    const raw = localStorage.getItem('cashWindow');
    const today = Dates.todayISO();
    const def = { from: today, to: addDaysISO(today, 15) };
    const cw = raw ? JSON.parse(raw) : def;
    window.__cashWindowState = { from: (cw.from||def.from).slice(0,10), to: (cw.to||def.to).slice(0,10) };
    const f = byId('cw-from'), t = byId('cw-to');
    if(f) f.value = window.__cashWindowState.from;
    if(t) t.value = window.__cashWindowState.to;
  }catch(_){ /* no-op */ }
}
function saveCashWindow(){
  try{
    localStorage.setItem('cashWindow', JSON.stringify(window.__cashWindowState||{}));
  }catch(_){ /* no-op */ }
}
function setupCashWindowControls(){
  const f = byId('cw-from'), t = byId('cw-to'), btn = byId('cw-apply');
  const apply = ()=>{
    const from = (f?.value||'').slice(0,10);
    const to   = (t?.value||'').slice(0,10);
    window.__cashWindowState = { from, to };
    saveCashWindow();
    updateDashboard();
  };
  f?.addEventListener('change', apply);
  t?.addEventListener('change', apply);
  btn?.addEventListener('click', apply);
}

// >>> HEAD-FILTER: chip 7/15/30 nel titolo
function renderHeaderChips({containerId, key, def, onChange}){
  const host = document.getElementById(containerId); if(!host) return;
  let st = CardWindow.load(key, def);
  host.innerHTML = `
    <div class="kpi-chips" role="group" aria-label="Finestra">
      <button class="kpi-chip" data-d="7">7 gg</button>
      <button class="kpi-chip" data-d="15">15 gg</button>
      <button class="kpi-chip" data-d="30">30 gg</button>
    </div>`;
  const chips = [...host.querySelectorAll('.kpi-chip')];
  const paint = () => chips.forEach(c=> c.classList.toggle('active', Number(c.dataset.d)===Number(st.days||def)));
  chips.forEach(c=> c.addEventListener('click', ()=>{
    st={days:Number(c.dataset.d)||def}; CardWindow.save(key, st); paint(); onChange(st);
  }));
  paint();
  onChange(st);
}

/* ===========================================================
   // >>> CARD-FILTER: stato per-card
   =========================================================== */
// >>> CARD-FILTER: stato per-card
const CardWindow = {
  load(key, defDays){
    try{
      const j = JSON.parse(localStorage.getItem('cw:'+key) || 'null');
      if (j && (j.days || (j.from && j.to))) return j;
    }catch(_){}
    const t = Dates.todayISO();
    return {from:null, to:null, days:defDays, _t:t};
  },
  save(key, v){
    try{ localStorage.setItem('cw:'+key, JSON.stringify(v)); }catch(_){ }
  }
};

// >>> CARD-FILTER: util per finestra da stato
function windowFromState(st, fallbackDays){
  const today = Dates.todayISO();
  const from = (st?.from) || today;
  const to   = (st?.to)   || addDaysISO(today, Number(st?.days || fallbackDays || 15));
  return {from, to};
}

// >>> CARD-FILTER: attach controlli a un anchor
function attachWindowControls({anchorId, stateKey, defaultDays, onChange}){
  const a = byId(anchorId); if(!a) return;
  // stato
  let st = CardWindow.load(stateKey, defaultDays);
  const today = Dates.todayISO();

  // UI
  a.innerHTML = `
    <div class="kpi-controls" role="group" aria-label="Filtro finestra">
      <span class="muted">Finestra:</span>
      <button class="btn btn-ghost" data-win="7"  type="button">7 gg</button>
      <button class="btn btn-ghost" data-win="15" type="button">15 gg</button>
      <button class="btn btn-ghost" data-win="30" type="button">30 gg</button>
      <button class="btn btn-ghost" data-win="60" type="button">60 gg</button>
      <span class="muted" style="margin-left:.4rem">Da</span>
      <input type="date" id="${anchorId}-from">
      <span class="muted">a</span>
      <input type="date" id="${anchorId}-to">
      <button class="btn btn-primary" id="${anchorId}-apply" type="button">Applica</button>
    </div>
  `;

  const fromEl = byId(`${anchorId}-from`);
  const toEl   = byId(`${anchorId}-to`);
  const apply  = byId(`${anchorId}-apply`);
  [7,15,30,60].forEach(d=>{
    a.querySelector(`[data-win="${d}"]`).addEventListener('click', ()=>{
      st = {from: today, to: addDaysISO(today, d), days: d};
      CardWindow.save(stateKey, st);
      onChange(st);
    });
  });
  apply.addEventListener('click', ()=>{
    const f = (fromEl.value||'').slice(0,10);
    const t = (toEl.value||'').slice(0,10);
    if(!f || !t || f>t) { showToast('Intervallo non valido','error'); return; }
    st = {from:f, to:t, days:null};
    CardWindow.save(stateKey, st);
    onChange(st);
  });

  // prefill input se custom già salvato
  if (st.from) fromEl.value = st.from;
  if (st.to)   toEl.value   = st.to;

  // callback iniziale
  onChange(st);
}

/* ===========================================================
   BOOTSTRAP
   =========================================================== */
function setupTopbar(){
  const annoEl = byId('anno'); if(annoEl) annoEl.textContent = new Date().getFullYear();
  byId('btn-export')?.addEventListener('click', exportCSV);
  byId('btn-backup')?.addEventListener('click', backupData);
  byId('btn-restore')?.addEventListener('click', restoreData);
  byId('btn-reset')?.addEventListener('click', ()=>{
    if(!confirm('Azzera tutti i dati? Operazione irreversibile.')) return;
    const theme = document.documentElement.getAttribute('data-theme')||'dark';
    state = ensureStateShape(null); saveState(); updateAll(); document.documentElement.setAttribute('data-theme', theme);
    showToast('Dati azzerati ✅','success');
  });
  const logoutBtn = byId('btn-logout');
  if(logoutBtn && !logoutBtn.dataset.bound){
    logoutBtn.dataset.bound = '1';
    logoutBtn.addEventListener('click', ()=> performLogout());
  }
  // Invio richiami fatture scadute
  byId('btn-send-reminders')?.addEventListener('click', ()=>{
    const overdue = state.invoices.filter(i=> isInvoiceOverdue(i));
    if(!overdue.length){ showToast('Nessuna fattura scaduta','info'); return; }
    // Simulazione invio richiami (da integrare con email/sms)
    overdue.forEach(i=>{
      // Qui puoi integrare invio email/sms
      // >>> FIX: format importi con Money anche nei log
      const net = Money.toMinor(i.amount||0);
      const tax = Money.mulPct(net, (i.vat ?? state.settings.vat)||0);
      console.log(`Richiamo inviato per fattura ${i.number} (${Money.format(Money.add(net, tax))}) a ${i.customer}`);
    });
    showToast(`Richiami inviati per ${overdue.length} fatture scadute`,'success');
  });
  
  // Mobile menu toggle
  const mobileToggle = byId('mobile-menu-toggle');
  if(mobileToggle) {
    mobileToggle.addEventListener('click', () => {
      document.body.classList.toggle('mobile-menu-open');
    });
    
    // Check screen size and show/hide mobile menu toggle
    const checkScreenSize = () => {
      if(window.innerWidth <= 768) {
        mobileToggle.style.display = 'block';
      } else {
        mobileToggle.style.display = 'none';
        document.body.classList.remove('mobile-menu-open');
      }
    };
    
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);
  }
}
function updateAll(){
  updateFileVersion();
  // >>> FIX: ricarica form impostazioni per riflettere lo stato corrente
  loadSettingsForm();
  updateCollaboratorsDropdown();
  updateSitesDropdown();
  renderSiteList(); renderCollaboratorList(); renderLastTickets(); renderTicketCalendarMonth(); renderInvoiceList(); renderPaymentList();
  renderExpenseList(); renderExpensesTimeline(); renderExpenseForecast(); renderExpensePaidRegistered(); renderExpensesSummary();
  renderOfferList();
  updateDashboard(); renderBilanci();
  renderAppsGrid();
  renderAppsSettings();
  renderReports();
  setupDashboardCards();
  renderSlotsCard();
}
// Evidenziazione colori KPI (positivo/negativo)
function applyKpiColors(){
  try{
    const greenIds = ['h-live-revenue','h-cash-7d','h-cash-next15-sum'];
    const redIds   = ['h-live-costs','h-expenses-range','h-exp-next15-sum'];
    greenIds.forEach(id=>{ const el = byId(id); if(el){ el.classList.add('kpi-positive'); el.classList.remove('kpi-negative'); }});
    redIds.forEach(id=>{ const el = byId(id); if(el){ el.classList.add('kpi-negative'); el.classList.remove('kpi-positive'); }});
    const profitEl = byId('h-live-profit');
    if(profitEl){ const t = profitEl.textContent||''; const neg = t.includes('-'); profitEl.classList.toggle('kpi-negative', neg); profitEl.classList.toggle('kpi-positive', !neg); }
  }catch(_){ /* no-op */ }
}
function updateDashboard(){
  // Keep live snapshot in sync with latest data
  try{ recomputeLiveSnapshot && recomputeLiveSnapshot(); }catch(_){}
  try {
    renderYearlyGraphs();
    renderBilanci();
    renderPageRecap('home');
  } catch (err) {
    console.error('Dashboard update error:', err);
  }
  const now = new Date(); const y = now.getFullYear(); const m = now.getMonth();
  const tYTD = state.tickets.filter(t=> (new Date(t.date)).getFullYear()===y);
  const regiaRate = safeNum(state.settings.regiaRate)||85; const markup = safeNum(state.settings.markup)||10;
  const revenueOre = tYTD.reduce((s,t)=> s + safeNum(t.hours)*regiaRate, 0);
  const revenueMat = tYTD.reduce((s,t)=> s + safeNum(t.totalMaterialCost)*(1+markup/100), 0);
  const cmY = tYTD.reduce((s,t)=> s + Money.fromMinor(ticketLaborMinor(t)), 0);
  const mmY = tYTD.reduce((s,t)=> s + safeNum(t.totalMaterialCost), 0);
  const set = (id,val)=>{ const el=byId(id); if(el) el.textContent = val; };
  // >>> PATCH: Incassi dinamici con chip
  try{
    const todayISO = Dates.todayISO();
    const st7  = CardWindow.load('cash-ultimi-7',  {days:7});
    const st30 = CardWindow.load('cash-ultimi-30', {days:30});
    const sumRange = (days)=> (state.payments||[])
      .filter(p=>{ const d=(p.date||'').slice(0,10); return d && d>=addDaysISO(todayISO, -days) && d<=todayISO; })
      .reduce((s,p)=> Money.add(s, Money.toMinor(p.amount||0)), 0);
    set('h-cash-7d',  Money.format(sumRange(st7.days||7)));
    set('h-cash-30d', Money.format(sumRange(st30.days||30)));
  }catch(_){ }
  // >>> HEAD-FILTER: Spese ultimi X giorni (per card)
  try{
    const todayISO = new Date().toISOString().slice(0,10);
    const stS = CardWindow.load('spese-ultimi', 15);
    const fromS = addDaysISO(todayISO, -(stS.days||15));
    const ex = expensesInRange(fromS, todayISO);
    const el = byId('h-expenses-range'); if(el) el.textContent = Money.format(ex.totalMinor);
  }catch(_){ }
  // >>> PATCH: ore mese regia vs cantieri
  const tMonth = (state.tickets||[]).filter(t => { const d=new Date(t.date||''); return d.getFullYear()===y && d.getMonth()===m; });
  const hoursRegia = tMonth.filter(t=> !!t.isRegia).reduce((s,t)=> s + safeNum(t.hours), 0);
  const hoursCant  = tMonth.filter(t=> !t.isRegia).reduce((s,t)=> s + safeNum(t.hours), 0);
  const hoursTot   = hoursRegia + hoursCant;
  const revenueRegiaMinor = Math.round(hoursRegia * (safeNum(state.settings.regiaRate)||85) * 100);
  const collabCostMonthMinor = tMonth.filter(t=> !t.isRegia)
    .reduce((s,t)=> s + ticketLaborMinor(t),0);
  { const el = byId('h-regia-month'); if(el) el.textContent = hoursRegia.toFixed(1); }
  { const el = byId('h-regia-value'); if(el) el.textContent = Money.format(revenueRegiaMinor); }
  { const el = byId('h-collab-hours-month'); if(el) el.textContent = hoursCant.toFixed(1); }
  { const el = byId('h-collab-cost-month'); if(el) el.textContent = Money.format(collabCostMonthMinor); }
  const totEl = byId('h-total-hours-month'); if(totEl) totEl.textContent = hoursTot.toFixed(1);
  // aggiorna anche il totale costi collab se presente
  const collabTotEl = byId('h-collab-total-cost'); if (collabTotEl) collabTotEl.textContent = Money.format(collabCostMonthMinor);
  // >>> PATCH: Spese YTD coerenti al breakdown Bilanci
  try{
    const yNow = new Date().getFullYear();
    const isYear = iso => (new Date(iso||'')).getFullYear()===yNow;

    const ttY = (state.tickets||[]).filter(t => isYear(t.date));
    const laborYMinor = ttY.reduce((s,t)=> s + ticketLaborMinor(t), 0);
    const matsYMinor  = ttY.reduce((s,t)=> Money.add(s, Money.toMinor(t.totalMaterialCost||0)), 0);

    const manualYMinor = (state.expenses||[])
      .filter(e=> String(e.status||'')==='paid' && isYear(e.date))
      .reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);

    const salariesYMinor = (state.collaborators||[])
      .reduce((s,c)=> s + Math.round(Number(c.netSalary||0)*100), 0) * 12; // se vuoi YTD pro-rata: moltiplica per mesi trascorsi

    const totalYMinor = Money.add(laborYMinor, matsYMinor, manualYMinor, salariesYMinor);

    { const el = byId('h-cost-year'); if(el) el.textContent = Money.format(totalYMinor); }
    { const el = byId('h-break-year'); if(el) el.textContent = `Ticket: ${Money.format(Money.add(laborYMinor, matsYMinor))} · Manuali: ${Money.format(manualYMinor)} · Stipendi: ${Money.format(salariesYMinor)}`; }
  }catch(_){ }
  // Patch: costi totali all-time
  const allTickets = state.tickets;
  const cmALL = allTickets.reduce((s,t)=> s + Money.fromMinor(ticketLaborMinor(t)), 0);
  const mmALL = allTickets.reduce((s,t)=> s + safeNum(t.totalMaterialCost), 0);
  set('h-cost-all', formatCurrency(cmALL + mmALL));
  set('h-break-all', `Manodopera ${formatCurrency(cmALL)} · Materiali ${formatCurrency(mmALL)}`);
  set('h-cant-attivi', state.sites.filter(s=> s.status==='attivo').length);
  set('h-cant-term',  state.sites.filter(s=> s.status==='terminato').length);
  set('h-total-collab', state.collaborators.length);
  set('h-tickets-month', tMonth.length);
  set('h-offers-active', state.offers.filter(o=> o.stato==='in_corso').length);
  
  // --- KPI: Progetti in offerta (conteggio + somma importi)
  try {
    const offAttive = (state.offers || []).filter(o => o.stato === 'in_corso');
    const count = offAttive.length;
    const sum = offAttive.reduce((s, o) => s + (Number(o.importo) || 0), 0);
    const setText = (id, val) => { const el = byId(id); if (el) el.textContent = val; };
    setText('h-offers-active-count', String(count));
    setText('h-offers-active-sum', formatCurrency(sum));
  } catch(_) { /* no-op */ }

  // --- KPI: Progetti attivi · ore rimanenti
  try {
    const act = (state.sites || []).filter(s => s.status === 'attivo');
    const remaining = act.reduce((acc, s) => {
      const used = (state.tickets || []).filter(t => t.siteId === s.id)
        .reduce((s2, t) => s2 + (Number(t.hours) || 0), 0);
      const rem = Math.max(0, (Number(s.estimatedHours) || 0) - used);
      return acc + rem;
    }, 0);
    const setText = (id, val) => { const el = byId(id); if (el) el.textContent = val; };
    setText('h-sites-active-count', String(act.length));
    setText('h-sites-remaining-hours', fmtNum(remaining));
  } catch(_) { /* no-op */ }

  // >>> HEAD-FILTER: Incassi programmati (per card)
  try{
    const todayISO = new Date().toISOString().slice(0,10);
    const stC = CardWindow.load('incassi-programmati', 15);
    const to = addDaysISO(todayISO, stC.days||15);

    const upcoming = (state.invoices||[]).filter(inv=>{
      const st = String(inv.status||'').toLowerCase();
      if (st==='paid' || st==='canceled') return false;
      const due = (inv.dueDate || inv.due || inv.scadenza || '').slice(0,10);
      return due && due>=todayISO && due<=to;
    });

    // SOMMA SOLO IL RESIDUO (gross - pagato)
    const sumMinor = upcoming.reduce((s,inv)=> Money.add(s, invoiceRemainingMinor(inv)), 0);

    set('h-cash-next15-sum', Money.format(sumMinor));
    const cntEl = byId('h-cash-next15-count'); if (cntEl) cntEl.textContent = String(upcoming.length);
  }catch(_){ }

  // --- KPI: Budget residuo cantieri (sum + count) and list
  try {
    const entries = (state.sites||[]).map(s=>({ site:s, rem: siteBudgetRemainingMinor(s) }))
      .filter(x=> x.rem>0)
      .sort((a,b)=> b.rem - a.rem);
    const totalRem = entries.reduce((s,x)=> Money.add(s, x.rem), 0);
    const setText = (id, val) => { const el = byId(id); if (el) el.textContent = val; };
    setText('h-budrem-sum', Money.format(totalRem));
    setText('h-budrem-count', String(entries.length));
    const list = byId('home-budrem-list');
    if(list){
      list.innerHTML = entries.slice(0,6).map(({site,rem})=>{
        const offerM = Money.toMinor(site.offerAmount||0);
        const pct = offerM>0 ? (Money.fromMinor(rem)/Money.fromMinor(offerM))*100 : 0;
        return `<div class="card" style="padding:.6rem; display:flex; align-items:center; justify-content:space-between">
          <div>
            <div style="font-weight:800">${h(site.name)}</div>
            <div class="muted" style="font-size:.85rem">Offerta: ${formatCurrency(site.offerAmount||0)}</div>
          </div>
          <div style="text-align:right">
            <div>${Money.format(rem)}</div>
            <div class="muted" style="font-size:.8rem">${pct.toFixed(1)}% residuo</div>
          </div>
        </div>`;
      }).join('') || `<div class="muted">Nessun budget residuo</div>`;
    }
  } catch(_) { /* no-op */ }

  updateHomeCollaborators(); updateTopSites(); updateActiveOffers(); renderHomeChart(); renderMarketChart();
  // Fatture scadute dashboard (robust: per stato o per data)
  const overdue = state.invoices.filter(i=> isInvoiceOverdue(i));
  const overdueCount = overdue.length;
  const overdueAmount = overdue.reduce((sum,i)=> sum + safeNum(i.amount)*(1+(safeNum(i.vat)/100)), 0);
  set('h-overdue-invoices-count', overdueCount);
  set('h-overdue-invoices-amount', formatCurrency(overdueAmount));
  // Box fasi cantieri attivi
  const fasiBox = document.getElementById('h-cantieri-fasi-box');
  if(fasiBox){
    const attivi = state.sites.filter(s=> s.status==='attivo');
    if(attivi.length){
      fasiBox.innerHTML = attivi.map(site=>{
        const totOre = safeNum(site.estimatedHours);
        const tix = state.tickets.filter(t=> t.siteId===site.id);
        const oreLavorate = tix.reduce((sum,t)=> sum+safeNum(t.hours),0);
        // IMPROVED: Show accurate percentage without capping at 100%
        const perc = totOre>0 ? (oreLavorate/totOre)*100 : 0;
        // Fasi
        const fasi = (site.phases||[]).map(f=>{
          const plannedH = totOre * (safeNum(f.weight)/100);
          const hUsed = tix.filter(t=> t.phaseId===f.id).reduce((s,t)=>s+safeNum(t.hours),0);
          const hPerc = plannedH>0? (hUsed/plannedH)*100 : 0;
          return `<div style='margin-bottom:2px'><span class='muted'>${f.name}</span>: <b>${hPerc.toFixed(1)}%</b></div>`;
        }).join('');
        return `<div style='margin-bottom:.5rem'><b>${site.name}</b> <span class='muted'>(${perc.toFixed(1)}% completato)</span><div>${fasi||'<span class=muted>Nessuna fase</span>'}</div></div>`;
      }).join('');
    }else{
      fasiBox.innerHTML = '<span class="muted">Nessun cantiere attivo</span>';
    }
  }
  // >>> HEAD-FILTER: Spese programmate (per card)
  try{
    const todayISO = new Date().toISOString().slice(0,10);
    const stE = CardWindow.load('spese-programmate', 15);
    const to = addDaysISO(todayISO, stE.days||15);
    const fut = upcomingExpensesRange(todayISO, to);
    const sumMinor = fut.reduce((s,x)=> Money.add(s, Money.toMinor(x.amount||0)), 0);
    const sumEl = byId('h-exp-next15-sum'); if(sumEl) sumEl.textContent = Money.format(sumMinor);
    const cntEl = byId('h-exp-next15-count'); if(cntEl) cntEl.textContent = String(fut.length);
  }catch(_){ }
  
  // Colorizzazione KPI principali
  applyKpiColors();
}
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    updateDashboard();
  }catch(err){
    console.error('Dashboard update error:', err);
  }
});
// >>> FIX: unica definizione attiva di renderOverdueInvoices (Money + h + isInvoiceOverdue)
// >>> HOTFIX: unica definizione attiva di renderOverdueInvoices
function renderOverdueInvoices(){
  const list = byId('ovd-list'); const sumEl=byId('ovd-total'); const cntEl=byId('ovd-count');
  if(!list||!sumEl||!cntEl) return;
  const items = (state.invoices||[])
    .filter(i => isInvoiceOverdue(i))
    .sort((a,b)=> new Date(a.dueDate||a.due||a.scadenza) - new Date(b.dueDate||b.due||b.scadenza));

  const totalMinor = items.reduce((s,i)=>{
    const net = Money.toMinor(i.amount||0);
    const vat = Money.mulPct(net, (i.vat ?? state.settings.vat) || 0);
    return Money.add(s, Money.add(net, vat));
  }, 0);

  cntEl.textContent = String(items.length);
  sumEl.textContent = Money.format(totalMinor);

  list.innerHTML = items.length ? items.map(i=>{
    const due = new Date(i.dueDate||i.due||i.scadenza);
    const days = isNaN(+due) ? 0 : Math.ceil((Date.now() - +due)/86400000);
    const grossMinor = (()=>{ const n=Money.toMinor(i.amount||0); return Money.add(n, Money.mulPct(n, (i.vat ?? state.settings.vat)||0)); })();
    return `
      <div class="card" style="padding:.8rem; display:grid; grid-template-columns:1fr auto; gap:.25rem">
        <div>
          <div style="font-weight:800">${h(i.number||i.id||'Fattura')}</div>
          <div class="muted" style="font-size:.85rem">
            ${h(i.customer||i.cliente||'Cliente')}
            • Scadenza ${isNaN(+due)?'—':due.toLocaleDateString('it-CH')}
            • ${days>0? (days===1?'1 giorno scaduto':days+' giorni scaduti') : (days===0?'Scade oggi':'—')}
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800">${Money.format(grossMinor)}</div>
          <div style="margin-top:.25rem; display:flex; gap:.3rem; justify-content:flex-end">
            <button class="btn btn-ghost" onclick="sendReminder('${i.id}')">Invia richiamo</button>
            <button class="btn btn-ghost" onclick="showInvoiceDetail('${i.id}')">Apri</button>
          </div>
        </div>
      </div>`;
  }).join('') : `<div class="empty">Nessuna fattura scaduta 🎉</div>`;
}

function renderOverdueExpenses(){
  const listEl = byId('ovd-exp-list');
  const totalEl = byId('ovd-exp-total');
  const countEl = byId('ovd-exp-count');
  if(!listEl || !totalEl || !countEl) return;

  const today = Dates.todayISO();
  const items = (state.expenses||[])
    .filter(e => String(e.status||'planned')==='planned' && (String(e.date||'').slice(0,10) || '') < today)
    .sort((a,b)=> String(a.date||'').localeCompare(String(b.date||'')));

  const totalMinor = items.reduce((s,e)=> Money.add(s, Money.toMinor(e.amount||0)), 0);
  countEl.textContent = String(items.length);
  totalEl.textContent = Money.format(totalMinor);

  listEl.innerHTML = items.length ? items.map(e=>{
    return `
      <div class="card" style="padding:.8rem; display:grid; grid-template-columns:1fr auto; gap:.25rem">
        <div>
          <div style="font-weight:800">${h(e.category||'Senza categoria')}</div>
          <div class="muted" style="font-size:.85rem">
            ${h(e.desc||'')} • Scadenza ${h(e.date||'—')}
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800">${formatCurrency(e.amount||0)}</div>
          <div style="margin-top:.25rem; display:flex; gap:.3rem; justify-content:flex-end">
            <button class="btn btn-ghost" onclick="markExpensePaid('${e.id}')">Segna pagata</button>
          </div>
        </div>
      </div>`;
  }).join('') : `<div class="empty">Nessuna spesa scaduta 🎉</div>`;
}

window.markExpensePaid = (expId)=>{
  const e = (state.expenses||[]).find(x=> String(x.id)===String(expId));
  if(!e) return;
  e.status = 'paid';
  e.updatedAt = new Date().toISOString();
  afterStateChange();
  renderOverdueExpenses();
  showToast('Spesa segnata pagata ✅','success');
};

function archiveItem(kind, obj, reason=''){
  if(!state.archive) state.archive = { sites:[], offers:[], collaborators:[], expenses:[], invoices:[], tickets:[], payments:[] };
  const safeObj = JSON.parse(JSON.stringify(obj));
  safeObj.archivedAt = new Date().toISOString();
  safeObj.archiveReason = reason || '';
  (state.archive[kind] = state.archive[kind] || []).push(safeObj);
}

function unarchiveItem(kind, id){
  const arr = state.archive?.[kind] || [];
  const idx = arr.findIndex(x=> String(x.id)===String(id));
  if(idx<0) return;
  const item = arr[idx];
  arr.splice(idx,1);
  if(kind==='sites') state.sites.push({...item, status:'attivo'});
  if(kind==='offers') state.offers.push({...item});
  if(kind==='collaborators') state.collaborators.push({...item});
  if(kind==='expenses') state.expenses.push({...item});
  if(kind==='invoices') state.invoices.push({...item});
  if(kind==='payments') state.payments.push({...item});
  if(kind==='tickets') state.tickets.push({...item});
  afterStateChange();
  renderArchive(kind);
}

function renderArchive(kind='sites'){
  const host = byId('ar-list'); if(!host) return;
  const q = (byId('ar-search')?.value||'').toLowerCase();
  const arr = (state.archive?.[kind] || []).slice().reverse();
  const filtered = arr.filter(x=> JSON.stringify(x).toLowerCase().includes(q));

  const money = v => Money.format(Money.toMinor(Number(v||0)));
  const head = (lab,val) => val? `<div class="muted" style="font-size:.85rem">${lab}: <b>${h(val)}</b></div>` : '';

  const rows = filtered.map(x=>{
    if(kind==='sites'){
      return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
        <div>
          <div style="font-weight:800">${h(x.name||'Cantiere')}</div>
          ${head('Ore preventivate', x.estimatedHours)}${head('Offerta', x.offerAmount? money(x.offerAmount):'')}
          ${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
        </div>
        <div style="text-align:right">
          <button class="btn btn-ghost" onclick="unarchiveItem('sites','${x.id}')">Ripristina</button>
        </div>
      </div>`;
    }
    if(kind==='offers'){
      return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
        <div>
          <div style="font-weight:800">${h(x.nome||'Offerta')}</div>
          ${head('Cliente', x.cliente)}${head('Importo', x.importo? money(x.importo):'')}
          ${head('Stato', x.stato)}${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
        </div>
        <div style="text-align:right"><button class="btn btn-ghost" onclick="unarchiveItem('offers','${x.id}')">Ripristina</button></div>
      </div>`;
    }
    if(kind==='collaborators'){
      return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
        <div>
          <div style="font-weight:800">${h(x.name||'Collaboratore')}</div>
          ${head('Ruolo', x.role)}${head('Stipendio', money(x.netSalary||0))}
          ${head('Assunzione', x.hireDate||'—')} ${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
        </div>
        <div style="text-align:right"><button class="btn btn-ghost" onclick="unarchiveItem('collaborators','${x.id}')">Ripristina</button></div>
      </div>`;
    }
    if(kind==='expenses'){
      return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
        <div>
          <div style="font-weight:800">${h(x.category||'Spesa')}</div>
          ${head('Data', x.date)}${head('Importo', money(x.amount))}
          ${head('Stato', x.status)}${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
        </div>
        <div style="text-align:right"><button class="btn btn-ghost" onclick="unarchiveItem('expenses','${x.id}')">Ripristina</button></div>
      </div>`;
    }
    if(kind==='invoices'){
      return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
        <div>
          <div style="font-weight:800">${h(x.number||'Fattura')}</div>
          ${head('Cliente', x.customer)}${head('Importo', money(x.amount))}
          ${head('Stato', x.status)}${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
        </div>
        <div style="text-align:right"><button class="btn btn-ghost" onclick="unarchiveItem('invoices','${x.id}')">Ripristina</button></div>
      </div>`;
    }
    if(kind==='payments'){
      return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
        <div>
          <div style="font-weight:800">Incasso ${h(x.reference||'')}</div>
          ${head('Data', x.date)}${head('Importo', money(x.amount))}
          ${head('Metodo', x.method)}${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
        </div>
        <div style="text-align:right"><button class="btn btn-ghost" onclick="unarchiveItem('payments','${x.id}')">Ripristina</button></div>
      </div>`;
    }
    return `<div class="card" style="padding:.7rem;display:grid;grid-template-columns:1fr auto;gap:.5rem">
      <div>
        <div style="font-weight:800">Ticket del ${h(x.date||'')}</div>
        ${head('Ore', x.hours)}${head('Cantiere', x.siteName||'')}
        ${head('Archiviato', new Date(x.archivedAt).toLocaleString('it-CH'))}
      </div>
      <div style="text-align:right"><button class="btn btn-ghost" onclick="unarchiveItem('tickets','${x.id}')">Ripristina</button></div>
    </div>`;
  });

  host.innerHTML = rows.length ? rows.join('') : `<div class="empty">Nessun elemento archiviato</div>`;
}

function bindArchivePage(){
  const container = document.querySelector('#page-archive');
  if(!container || container.dataset.bound==='1') return;
  container.dataset.bound = '1';
  const buttons = container.querySelectorAll('[data-ar]');
  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      buttons.forEach(b=> b.classList.toggle('active', b===btn));
      renderArchive(btn.getAttribute('data-ar'));
    });
  });
  const search = byId('ar-search');
  if(search){
    search.addEventListener('input', ()=>{
      const current = container.querySelector('[data-ar].active')?.getAttribute('data-ar') || 'sites';
      renderArchive(current);
    });
  }
  if(buttons.length){ buttons[0].classList.add('active'); }
}

window.unarchiveItem = unarchiveItem;
function bindKpiCardClicks(){
  // Qualunque KPI con data-detail apre un modal con un "drill-down"
  document.querySelectorAll('.card.kpi[data-detail]').forEach(card=>{
    if(card.dataset.bound === '1') return;
    card.dataset.bound = '1';
    card.addEventListener('click', ()=>{
      const kind = card.getAttribute('data-detail');
      let html = '';
      switch(kind){
        case 'cash-actual': {
          const today = Dates.todayISO();
          const last30 = addDaysISO(today, -30);
          const items = (state.payments||[]).filter(p=> (p.date||'')>=last30 && (p.date||'')<=today)
            .sort((a,b)=> String(b.date).localeCompare(String(a.date)));
          html = items.length ? `
            <div class="table-scroll-lg"><table>
              <thead><tr><th>Data</th><th>Rif.</th><th>Metodo</th><th class="right">Importo</th></tr></thead>
              <tbody>${items.map(p=>`<tr>
                <td>${p.date}</td><td>${h(p.reference||'')}</td>
                <td>${({bank:'Bonifico',cash:'Contanti',card:'Carta',other:'Altro'})[p.method]||p.method}</td>
                <td class="right">${formatCurrency(p.amount)}</td>
              </tr>`).join('')}</tbody></table></div>` : `<div class="muted">Nessun incasso negli ultimi 30 giorni</div>`;
          openModal('Incassi avvenuti · ultimi 30 giorni', html);
        } break;

        case 'expenses-actual': {
          const today = Dates.todayISO();
          const last30 = addDaysISO(today, -30);
          const items = (state.expenses||[]).filter(e=> e.status==='paid' && (e.date||'')>=last30 && (e.date||'')<=today)
            .sort((a,b)=> String(b.date).localeCompare(String(a.date)));
          html = items.length ? `
            <div class="table-scroll-lg"><table>
              <thead><tr><th>Data</th><th>Categoria</th><th>Descrizione</th><th class="right">Importo</th></tr></thead>
              <tbody>${items.map(e=>`<tr>
                <td>${e.date||''}</td><td>${h(e.category||'')}</td><td>${h(e.desc||'')}</td>
                <td class="right">${formatCurrency(e.amount||0)}</td>
              </tr>`).join('')}</tbody></table></div>` : `<div class="muted">Nessuna spesa pagata negli ultimi 30 giorni</div>`;
          openModal('Spese effettuate · ultimi 30 giorni', html);
        } break;

        case 'cash-planned': {
          const today = Dates.todayISO();
          const to = addDaysISO(today, 15);
          const upcoming = (state.invoices||[]).filter(inv=>{
            const st = String(inv.status||'').toLowerCase();
            if (st==='paid' || st==='canceled') return false;
            const due = (inv.dueDate || inv.due || inv.scadenza || '').slice(0,10);
            return due && due>=today && due<=to;
          });
          html = upcoming.length ? `
            <div class="table-scroll-lg"><table>
              <thead><tr><th>Scadenza</th><th>Numero</th><th>Cliente</th><th class="right">Residuo</th></tr></thead>
              <tbody>${upcoming.map(inv=>`<tr>
                <td>${(inv.dueDate||inv.due||inv.scadenza||'').slice(0,10)}</td>
                <td>${h(inv.number||'')}</td><td>${h(inv.customer||'')}</td>
                <td class="right">${Money.format(invoiceRemainingMinor(inv))}</td>
              </tr>`).join('')}</tbody></table></div>` : `<div class="muted">Nessun incasso programmato nei prossimi 15 giorni</div>`;
          openModal('Incassi programmati · prossimi 15 giorni', html);
        } break;

        case 'expenses-planned': {
          const today = Dates.todayISO();
          const to = addDaysISO(today, 15);
          const items = upcomingExpensesRange(today, to).filter(x=> x.statusComputed!=='paid');
          html = items.length ? `
            <div class="table-scroll-lg"><table>
              <thead><tr><th>Data</th><th>Categoria</th><th>Descrizione</th><th class="right">Importo</th></tr></thead>
              <tbody>${items.map(x=>`<tr>
                <td>${x.date}</td><td>${h(x.category||'')}</td><td>${h(x.desc||'')}</td>
                <td class="right">${formatCurrency(x.amount||0)}</td>
              </tr>`).join('')}</tbody></table></div>` : `<div class="muted">Nessuna spesa programmata nei prossimi 15 giorni</div>`;
          openModal('Spese programmate · prossimi 15 giorni', html);
        } break;

        default:
          openModal('Dettaglio', `<div class="muted">Nessun dettaglio specifico per ${h(kind)}</div>`);
      }
    });
  });
}
// >>> FIX: Home helpers attivi fuori dal blocco duplicato
function updateHomeCollaborators(){
  const c = byId('home-collab'); if(!c) return;
  const top = [...state.collaborators].sort((a,b)=> (b.rate||0)-(a.rate||0)).slice(0,6);
  c.innerHTML = top.length? top.map(x=> `<div class="card" style="padding:.8rem"><div style="font-weight:800">${x.name}</div><div class="muted" style="font-size:.85rem">${x.role||'—'}</div><div class="muted" style="font-size:.85rem">${formatCurrency(x.rate)}/h</div></div>`).join('') : `<div class="empty">Nessun collaboratore</div>`;
}
function updateTopSites(){
  const c = byId('home-top-sites'); if(!c) return;
  const arr = state.sites.map(s=>{ const hours = state.tickets.filter(t=> t.siteId===s.id).reduce((sum,t)=> sum + safeNum(t.hours), 0); return {...s, hours}; }).sort((a,b)=> b.hours-a.hours).slice(0,5);
  c.innerHTML = arr.length? arr.map(s=> `<div class="card" style="padding:.8rem; display:flex; align-items:center; justify-content:space-between"><div><div style="font-weight:800">${s.name}</div><div class="muted" style="font-size:.85rem">${fmtNum(s.hours)} ore</div></div><div class="site-badge ${s.status==='attivo'?'sb-active':'sb-ended'}">${s.status==='attivo'?'Attivo':'Terminato'}</div></div>`).join('') : `<div class="empty">Nessun cantiere con ore registrate</div>`;
}
window.sendReminder = (invoiceId)=>{
  const i = state.invoices.find(x=> x.id===invoiceId); if(!i) return;
  const due = i.dueDate||i.due||i.scadenza; const gross = safeNum(i.amount)*(1+(safeNum(i.vat)/100));
  const subject = encodeURIComponent(`Richiamo pagamento fattura ${i.number||invoiceId}`);
  const body = encodeURIComponent(`Gentile cliente,\n\nrisulta scaduta la fattura ${i.number||invoiceId} del ${i.date? new Date(i.date).toLocaleDateString('it-CH'):'—'} per ${gross.toFixed(2)} ${state.settings.currency}.\nScadenza: ${due? new Date(due).toLocaleDateString('it-CH'):'—'}.\nVi chiediamo gentilmente di provvedere al pagamento quanto prima.\n\nGrazie e cordiali saluti.`);
  const link = `mailto:?subject=${subject}&body=${body}`;
  try{ window.open(link,'_blank'); }catch(_){ }
};
function updateActiveOffers(){
  const c = byId('home-active-offers'); if(!c) return;
  const active = state.offers.filter(o=> o.stato==='in_corso').slice(0,5);
  c.innerHTML = active.length? active.map(o=> `<div class="card" style="padding:.8rem; display:flex; align-items:center; justify-content:space-between"><div><div style="font-weight:800">${h(o.nome)}</div><div class="muted" style="font-size:.85rem">${h(o.cliente)||'—'} • ${formatCurrency(o.importo)}</div></div><div class="offer-badge ${getProbabilityClass(o.probabilita)}">${o.probabilita}%</div></div>`).join('') : `<div class="empty">Nessuna offerta in corso</div>`;
}
/* duplicate of renderOverdueInvoices (commented out) — REMOVED */
/*
function renderOverdueInvoices(){
  const list = byId('ovd-list'); const sumEl=byId('ovd-total'); const cntEl=byId('ovd-count');
  if(!list||!sumEl||!cntEl) return;
  const items = state.invoices.filter(i=> isInvoiceOverdue(i)).sort((a,b)=> new Date(a.dueDate||a.due||a.scadenza) - new Date(b.dueDate||b.due||b.scadenza));
  const total = items.reduce((s,i)=> s + safeNum(i.amount)*(1+(safeNum(i.vat)/100)), 0);

  cntEl.textContent = String(items.length);
  sumEl.textContent = formatCurrency(total);
  list.innerHTML = items.length ? items.map(i=>{
    const due = new Date(i.dueDate||i.due||i.scadenza);
    const days = Math.ceil((Date.now() - +due)/86400000);
    const gross = safeNum(i.amount)*(1+(safeNum(i.vat)/100));
    return `<div class="card" style="padding:.8rem; display:grid; grid-template-columns:1fr auto; gap:.25rem">
      <div>
        <div style="font-weight:800">${i.number||i.id||'Fattura'}</div>
        <div class="muted" style="font-size:.85rem">${i.customer||i.cliente||'Cliente'} • Scadenza ${isNaN(+due)?'—':due.toLocaleDateString('it-CH')} • ${days>0? (days===1?'1 giorno scaduto':days+ ' giorni scaduti') : 'Scade oggi'}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:800">${formatCurrency(gross)}</div>
        <div style="margin-top:.25rem; display:flex; gap:.3rem; justify-content:flex-end">
          <button class="btn btn-ghost" onclick="sendReminder('${i.id}')">Invia richiamo</button>
          <button class="btn btn-ghost" onclick="showInvoiceDetail('${i.id}')">Apri</button>
        </div>
      </div>
    </div>`;
  }).join('') : `<div class="empty">Nessuna fattura scaduta 🎉</div>`;
}
function updateHomeCollaborators(){
  const c = byId('home-collab'); if(!c) return;
  const top = [...state.collaborators].sort((a,b)=> (b.rate||0)-(a.rate||0)).slice(0,6);
  c.innerHTML = top.length? top.map(x=> `<div class="card" style="padding:.8rem"><div style="font-weight:800">${x.name}</div><div class="muted" style="font-size:.85rem">${x.role||'—'}</div><div class="muted" style="font-size:.85rem">${formatCurrency(x.rate)}/h</div></div>`).join('') : `<div class="empty">Nessun collaboratore</div>`;
}
function updateTopSites(){
  const c = byId('home-top-sites'); if(!c) return;
  const arr = state.sites.map(s=>{ const hours = state.tickets.filter(t=> t.siteId===s.id).reduce((sum,t)=> sum + safeNum(t.hours), 0); return {...s, hours}; }).sort((a,b)=> b.hours-a.hours).slice(0,5);
  c.innerHTML = arr.length? arr.map(s=> `<div class="card" style="padding:.8rem; display:flex; align-items:center; justify-content:space-between"><div><div style="font-weight:800">${s.name}</div><div class="muted" style="font-size:.85rem">${fmtNum(s.hours)} ore</div></div><div class="site-badge ${s.status==='attivo'?'sb-active':'sb-ended'}">${s.status==='attivo'?'Attivo':'Terminato'}</div></div>`).join('') : `<div class="empty">Nessun cantiere con ore registrate</div>`;
}
window.sendReminder = (invoiceId)=>{
  const i = state.invoices.find(x=> x.id===invoiceId); if(!i) return;
  const due = i.dueDate||i.due||i.scadenza; const gross = safeNum(i.amount)*(1+(safeNum(i.vat)/100));
  const subject = encodeURIComponent(`Richiamo pagamento fattura ${i.number||invoiceId}`);
  const body = encodeURIComponent(`Gentile cliente,\n\nrisulta scaduta la fattura ${i.number||invoiceId} del ${i.date? new Date(i.date).toLocaleDateString('it-CH'):'—'} per ${gross.toFixed(2)} ${state.settings.currency}.\nScadenza: ${due? new Date(due).toLocaleDateString('it-CH'):'—'}.\nVi chiediamo gentilmente di provvedere al pagamento quanto prima.\n\nGrazie e cordiali saluti.`);
  const link = `mailto:?subject=${subject}&body=${body}`;
  try{ window.open(link,'_blank'); }catch(_){}
}
function updateActiveOffers(){
  const c = byId('home-active-offers'); if(!c) return;
  const active = state.offers.filter(o=> o.stato==='in_corso').slice(0,5);
  c.innerHTML = active.length? active.map(o=> `<div class="card" style="padding:.8rem; display:flex; align-items:center; justify-content:space-between"><div><div style="font-weight:800">${h(o.nome)}</div><div class="muted" style="font-size:.85rem">${h(o.cliente)||'—'} • ${formatCurrency(o.importo)}</div></div><div class="offer-badge ${getProbabilityClass(o.probabilita)}">${o.probabilita}%</div></div>`).join('') : `<div class="empty">Nessuna offerta in corso</div>`;
}

function renderOverdueInvoices(){
  const list = byId('ovd-list'); const sumEl=byId('ovd-total'); const cntEl=byId('ovd-count');
  if(!list||!sumEl||!cntEl) return;
  const items = state.invoices.filter(i=> isInvoiceOverdue(i)).sort((a,b)=> new Date(a.dueDate||a.due||a.scadenza) - new Date(b.dueDate||b.due||b.scadenza));
  const total = items.reduce((s,i)=> s + safeNum(i.amount)*(1+(safeNum(i.vat)/100)), 0);
  cntEl.textContent = String(items.length);
  sumEl.textContent = formatCurrency(total);
  list.innerHTML = items.length ? items.map(i=>{
    const due = new Date(i.dueDate||i.due||i.scadenza);
    const days = Math.ceil((Date.now() - +due)/86400000);
    const gross = safeNum(i.amount)*(1+(safeNum(i.vat)/100));
    return `<div class=\"card\" style=\"padding:.8rem; display:grid; grid-template-columns:1fr auto; gap:.25rem\">
      <div>
        <div style=\"font-weight:800\">${i.number||i.id||'Fattura'}</div>
        <div class=\"muted\" style=\"font-size:.85rem\">${i.customer||i.cliente||'Cliente'} • Scadenza ${isNaN(+due)?'—':due.toLocaleDateString('it-CH')} • ${days>0? (days===1?'1 giorno scaduto':days+ ' giorni scaduti') : 'Scade oggi'}</div>
      </div>
      <div style=\"text-align:right\">
        <div style=\"font-weight:800\">${formatCurrency(gross)}</div>
        <div style=\"margin-top:.25rem; display:flex; gap:.3rem; justify-content:flex-end\">
          <button class=\"btn btn-ghost\" onclick=\"sendReminder('${i.id}')\">Invia richiamo</button>
          <button class=\"btn btn-ghost\" onclick=\"showInvoiceDetail('${i.id}')\">Apri</button>
        </div>
      </div>
    </div>`;
  }).join('') : `<div class=\"empty\">Nessuna fattura scaduta 🎉</div>`;
}

/* ===========================================================
   INIT
   =========================================================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  setupTheme();
  await loadState();
  setupTopbar();
  setupNavigation();
  setupShortcuts();
  setupSettings();
  setupOffers();
  setupSites();
  setupCollaborators();
  setupTickets();
  setupInvoices();
  setupPayments();
  agendaInit();
  setupOverdue();
  setupExpenses();
  updateDashboard();
  renderBilanci();
  if (typeof startLiveCounters === 'function') startLiveCounters();
  setupDashboardCards();
  bindKpiCardClicks();
  // >>> HEAD-FILTER: mount chip nei titoli e trigger update
  renderHeaderChips({containerId:'hf-cash',   key:'incassi-programmati', def:15, onChange:()=>updateDashboard()});
  renderHeaderChips({containerId:'hf-exp',    key:'spese-programmate',   def:15, onChange:()=>updateDashboard()});
  // >>> PATCH: chip Incassi (default 7 / 30)
  renderHeaderChips({containerId:'hf-cash7',  key:'cash-ultimi-7',    def:7,  onChange:()=>updateDashboard()});
  renderHeaderChips({containerId:'hf-cash30', key:'cash-ultimi-30',   def:30, onChange:()=>updateDashboard()});
  renderHeaderChips({containerId:'hf-spese',  key:'spese-ultimi',        def:15, onChange:()=>updateDashboard()});
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ try{ if(typeof recomputeLiveSnapshot==='function') recomputeLiveSnapshot(); updateDashboard(); if(typeof updateLiveCounters==='function') updateLiveCounters(); }catch(e){} } });
  // side meta refresh
  updateFileVersion();
  // Runtime guard: keep phases card at the very bottom of the home page
  try {
    const home = document.getElementById('page-home');
    const card = document.getElementById('card-phases');
    if (home && card) home.appendChild(card);
  } catch(_) { /* no-op */ }
});

// === PATCH: rende visibile globalmente showExpenseForm ===
if (typeof showExpenseForm === 'function') {
  window.showExpenseForm = showExpenseForm;
} else {
  console.warn('showExpenseForm non trovato nello scope locale');
}

})();
</script>
<script>
(function(){
  const TICKET_INBOX_KEY = 'gc_ticket_inbox_v1';
  const AUDIT_KEY = 'gc_audit_v1';
  const $ = (id)=> document.getElementById(id);

  function readInbox(){ try{ return JSON.parse(localStorage.getItem(TICKET_INBOX_KEY)||'[]'); }catch{return []} }
  function writeInbox(a){ localStorage.setItem(TICKET_INBOX_KEY, JSON.stringify(a)); }

  // TODO: collega questa a come salvi i ticket "ufficiali" nell’app
  function addToOfficialTickets(t){
    // Esempio: se hai un array globale state.tickets, spingi e salva
    try{
      if(window.state && Array.isArray(window.state.tickets)){
        window.state.tickets.unshift({
          id: t.id,
          title: t.title,
          priority: t.priority,
          customer: t.customer,
          site: t.site,
          category: t.category,
          due: t.due,
          eta: t.eta,
          desc: t.desc,
          createdBy: t.createdBy,
          createdAt: t.ts,
          source: 'collaboratore'
        });
        if (typeof window.saveState === 'function') window.saveState();
      }
    }catch(_){ }
    try{
      const list = JSON.parse(localStorage.getItem(AUDIT_KEY)||'[]');
      list.unshift({ ts:new Date().toISOString(), user: (JSON.parse(localStorage.getItem('gc_auth_user')||'null')||{}).username||'operatore', type:'create', detail:'ticket da collaboratore: '+t.title });
      localStorage.setItem(AUDIT_KEY, JSON.stringify(list));
    }catch(_){ }
  }

  function render(){
    const box = $('collab-inbox-list');
    const arr = readInbox();
    if(!box) return;
    if(!arr.length){ box.innerHTML = '<div class="muted">Nessun ticket in arrivo</div>'; return; }
    box.innerHTML = arr.map((t,i)=>`
      <div class="item">
        <div style="display:flex;justify-content:space-between;gap:.5rem;align-items:center">
          <div><b>${t.title}</b> · <span class="pill">${t.priority}</span></div>
          <small class="muted">${new Date(t.ts).toLocaleString()}</small>
        </div>
        <div class="muted" style="margin:.2rem 0">Da: ${t.createdBy} ${t.site? '· '+t.site:''} ${t.customer? '· '+t.customer:''}</div>
        <div>${(t.desc||'').replace(/\n/g,'<br>')}</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" data-i="${i}" data-act="accept">Aggiungi ai ticket</button>
          <button class="btn btn-ghost" data-i="${i}" data-act="reject">Scarta</button>
        </div>
      </div>
    `).join('');

    box.querySelectorAll('[data-act="accept"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = +b.dataset.i; const arr = readInbox(); const t = arr[i];
        addToOfficialTickets(t);
        arr.splice(i,1); writeInbox(arr); render();
      });
    });
    box.querySelectorAll('[data-act="reject"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = +b.dataset.i; const arr = readInbox(); arr.splice(i,1); writeInbox(arr); render();
      });
    });
  }

  render();

  window.addEventListener('storage', (e)=>{
    if(e.key === TICKET_INBOX_KEY) render();
  });

  setInterval(render, 5000);
})();
</script>
<script>
  (function(){
    const AUDIT_KEY = 'gc_audit_v1';
    function getAudit(){ try{ return JSON.parse(localStorage.getItem(AUDIT_KEY)||'[]'); }catch{return []} }
    function setAudit(list){ localStorage.setItem(AUDIT_KEY, JSON.stringify(list)); }
    window.gcAudit = function(type, detail){
      try{
        const sess = JSON.parse(localStorage.getItem('gc_auth_user')||'null');
        const entry = {
          ts: new Date().toISOString(),
          user: sess?.username || 'sconosciuto',
          type: type || 'other',
          detail: detail || ''
        };
        const list = getAudit(); list.unshift(entry); setAudit(list);
      }catch(_){ }
    };
    window.addEventListener('beforeunload', function(){
      try{
        if(sessionStorage.getItem('gc_manual_logout')==='1'){
          sessionStorage.removeItem('gc_manual_logout');
          return;
        }
      }catch(_){ }
      try{
        const sess = JSON.parse(localStorage.getItem('gc_auth_user')||'null');
        if(sess){
          const list = getAudit();
          list.unshift({ ts:new Date().toISOString(), user:sess.username, type:'logout', detail:'uscita pagina' });
          setAudit(list);
        }
      }catch(_){ }
    });
  })();
</script>
<script>
/* === AUDIT BRIDGE · registra azioni dell'app senza toccare la logica === */
(function(){
  if (!window.gcAudit) { window.gcAudit = function(){}; } // failsafe

  // Utility sicure
  const $ = (id)=> document.getElementById(id);
  const getState = ()=> window.state || {};

  // 1) FATTURE: crea/aggiorna + duplica
  document.addEventListener('submit', function onSubmit(e){
    const f = e.target;
    // Esegui il logging poco dopo il salvataggio per avere numero/campi definitivi
    setTimeout(()=> {
      try{
        // --- Invoice form ---
        if (f && f.id === 'invoice-form') {
          const num = $('inv-number')?.value || '';
          const customer = $('inv-customer')?.value || $('inv-customer-name')?.value || '';
          const exists = (getState().invoices||[]).some(x => (x.number||'') === num);
          // Se esiste già dopo il submit => update, altrimenti create
          window.gcAudit(exists ? 'update' : 'create', `fattura ${num} – ${customer}`);
        }

        // --- Payment form ---
        if (f && f.id === 'payment-form') {
          const amount = $('pay-amount')?.value || '';
          const invSel = $('pay-invoice'); // select collegamento fattura
          const invId = invSel?.value || '';
          let invNum = '';
          if (invId) {
            const inv = (getState().invoices||[]).find(i => i.id === invId);
            invNum = inv?.number || invId;
          }
          // Heuristica: se esiste già un pagamento con stesso id/numero+importo subito dopo il submit => update
          // (Molto semplice: per i nostri scopi va bene etichettare come create/update indistintamente)
          window.gcAudit('create', `incasso ${amount}€ ${invNum ? '→ ' + invNum : ''}`);
        }

        // --- Offerte/Preventivi (form id="offer-form") ---
        if (f && f.id === 'offer-form') {
          const nome = $('of-nome')?.value || '';
          const cliente = $('of-cliente')?.value || '';
          window.gcAudit('create', `offerta ${nome} – ${cliente}`);
        }

        // --- Spese (form id="expense-form") ---
        if (f && f.id === 'expense-form') {
          const amount = $('ex-amount')?.value || '';
          const cat = $('ex-category')?.value || '';
          window.gcAudit('create', `spesa ${amount}€ – ${cat}`);
        }
      }catch(_){ }
    }, 0);
  }, true);

  // 2) DUPLICA FATTURA (bottone già presente)
  document.addEventListener('click', function(e){
    const el = e.target;
    if (!el) return;

    // Duplica fattura
    if (el.id === 'btn-inv-duplicate') {
      setTimeout(()=> {
        try{
          const num = $('inv-number')?.value || '';
          window.gcAudit('create', `fattura duplicata → ${num}`);
        }catch(_){ }
      }, 0);
    }
  }, true);

  // 3) Ricalcolo stati fatture (opzionale)
  const btnRecalc = document.getElementById('btn-recalc-inv');
  if (btnRecalc && !btnRecalc.dataset.auditBound) {
    btnRecalc.dataset.auditBound = '1';
    btnRecalc.addEventListener('click', ()=>{
      setTimeout(()=> window.gcAudit('update', 'ricalcolo stati fatture'), 0);
    }, true);
  }

  // 4) Agenda: salva/elimina (se vuoi tracciare anche qui)
  const agSave = document.getElementById('ag-save');
  if (agSave && !agSave.dataset.auditBound){
    agSave.dataset.auditBound = '1';
    agSave.addEventListener('click', ()=>{
      setTimeout(()=> window.gcAudit('create', 'agenda: salva attività'), 0);
    }, true);
  }
  const agDelete = document.getElementById('ag-delete');
  if (agDelete && !agDelete.dataset.auditBound){
    agDelete.dataset.auditBound = '1';
    agDelete.addEventListener('click', ()=>{
      setTimeout(()=> window.gcAudit('delete', 'agenda: elimina attività'), 0);
    }, true);
  }
})();
</script>
</body>
</html>