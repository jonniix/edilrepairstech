<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://cvmniyociytwlagyfwed.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2bW5peW9jaXl0d2xhZ3lmd2VkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDg4NjMsImV4cCI6MjA3ODM4NDg2M30.gy90vkwY2UV3QYpk1OL9s_9XumfLW1nSTqKiglpc9UA";

  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Area Collaboratori · Gestione Cantieri</title>
  <link id="dynamic-favicon" rel="icon" href="">
  <style>
    :root{
      --bg:#0b1320; --panel:#0f1a2c; --card:#111d31; --muted:#a8b8cc; --text:#e8eef6;
      --border:#1e2b45; --accent:#4da3ff; --success:#22c55e; --danger:#ef4444; --radius:16px;
      --shadow:0 12px 28px rgba(0,0,0,.35); --input-bg:#0f1a2c; --input-border:#223353; --input-focus:#4da3ff33;
    }
    html[data-theme="light"]{
      --bg:#f3f6fb; --panel:#fff; --card:#fff; --text:#0b1220; --muted:#475569;
      --border:#c7d2e2; --accent:#1d4ed8; --success:#15803d; --danger:#dc2626; --shadow:0 10px 28px rgba(2,6,23,.08);
      --input-bg:#fff; --input-border:#c7d2e2; --input-focus:#1d4ed822;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:.8rem}
    .logo{width:40px;height:40px;border-radius:10px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-size:1.05rem;font-weight:900;margin:0}
    .muted{color:var(--muted)}
    .wrap{padding:16px;display:grid;gap:16px;max-width:1100px;margin:0 auto}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:.6rem .9rem;border-radius:999px;cursor:pointer;font-weight:800}
    .tabbtn.active{background:linear-gradient(135deg,var(--accent),#3b82d2);color:#fff}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    label{font-size:.9rem;color:var(--muted);font-weight:700;display:block;margin:.35rem 0}
    input,select,textarea{width:100%;padding:.85rem 1rem;border-radius:12px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);outline:none;transition:.15s}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--input-focus);border-color:var(--accent)}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:860px){ .row.two{grid-template-columns:1fr 1fr} .row.three{grid-template-columns:1fr 1fr 1fr} }
    .btn{border:none;cursor:pointer;font-weight:800;padding:.85rem 1rem;border-radius:12px}
    .btn-primary{background:linear-gradient(135deg,var(--accent),#3b82d2);color:#fff}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#e14242);color:#fff}
    .list{display:grid;gap:8px}
    .item{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:.7rem .8rem}
    .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--border);background:var(--panel);border-radius:999px;padding:.15rem .55rem;font-weight:700}
    .right{display:flex;gap:8px;align-items:center}
    .switch{width:52px;height:28px;border-radius:999px;background:var(--panel);border:1px solid var(--border);position:relative;cursor:pointer}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:999px;background:var(--card);border:1px solid var(--border);transition:left .2s}
    html[data-theme="light"] .switch::after{left:27px}
    .toast{position:fixed;right:16px;bottom:16px;padding:.8rem 1rem;border:1px solid var(--border);background:var(--panel);border-radius:12px;opacity:0;transform:translateY(8px);transition:.2s;z-index:9999}
    .toast.show{opacity:1;transform:none}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:.5rem .4rem;text-align:left}
    .table th{font-size:.85rem;color:var(--muted);font-weight:800}
    .sep{height:1px;background:var(--border);margin:10px 0}
    /* user menu (coerente con app) */
    .user-menu{position:relative;display:inline-block}
    .user-chip{display:flex;align-items:center;gap:.6rem;border:1px solid var(--border);
      background:var(--panel);padding:.45rem .7rem;border-radius:999px;cursor:pointer}
    .user-chip .avatar{width:26px;height:26px;border-radius:999px;background:var(--card);
      display:grid;place-items:center;border:1px solid var(--border)}
    .user-chip .user-label{display:flex;flex-direction:column;line-height:1}
    .user-chip .user-label b{font-size:.92rem}
    .user-chip .user-label small{font-size:.72rem;color:var(--muted)}
    .user-chip .chev{font-size:.9rem;opacity:.8}
    .menu{position:absolute;right:0;top:calc(100% + 8px);min-width:220px;background:var(--card);
      border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:.35rem;display:none;z-index:30}
    .menu.show{display:block}
    .menu .item{width:100%;text-align:left;border:none;background:transparent;color:var(--text);
      padding:.6rem .7rem;border-radius:10px;cursor:pointer}
    .menu .item:hover{background:var(--panel)}
    .menu .item.danger{color:#fff;background:linear-gradient(135deg,var(--danger),#e14242)}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <div class="logo"><img id="logo" alt="logo"></div>
      <script>
      const PROFILES_TABLE = 'profiles';
      const TICKETS_INBOX_TABLE = 'tickets_inbox';
      const SCHEDULES_TABLE = 'schedules';
      const NOTES_TABLE = 'notes';
      const AUDIT_TABLE = 'audit_log';

      const $ = (id)=> document.getElementById(id);
      const showToast = (m)=>{ const t=$('toast'); if(!t) return; t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };

      /* ===== Tema + Logo da settings ===== */
      (function theme(){
        try{
          const saved = localStorage.getItem('theme') || 'dark';
          document.documentElement.setAttribute('data-theme', saved);
          $('theme-switch')?.addEventListener('click', ()=>{
            const t = document.documentElement.getAttribute('data-theme');
            const next = t==='light'?'dark':'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
          });
        }catch(_){ }
      })();

      const IDB_DB='gc_store', IDB_STORE='state', IDB_KEY='gestione-cantieri';
      function idbOpen(){
        return new Promise((res,rej)=>{
          const rq = indexedDB.open(IDB_DB,1);
          rq.onupgradeneeded = ()=>{ const db=rq.result; if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE); };
          rq.onsuccess = ()=> res(rq.result);
          rq.onerror = ()=> rej(rq.error);
        });
      }
      async function idbGet(key){
        try{
          const db = await idbOpen();
          return await new Promise((res,rej)=>{
            const tx = db.transaction(IDB_STORE,'readonly');
            const rq = tx.objectStore(IDB_STORE).get(key);
            rq.onsuccess = ()=> res(rq.result ?? null);
            rq.onerror = ()=> rej(rq.error);
          });
        }catch{ return null; }
      }
      async function loadLogo(){
        try{
          const state = await idbGet(IDB_KEY);
          const dataUrl = state?.settings?.logoDataUrl || '';
          if(dataUrl){ $('logo').src = dataUrl; $('dynamic-favicon').href = dataUrl; }
        }catch(_){ }
      }

      /* ===== Supabase context ===== */
      let sessionData = null;
      let profileData = null;
      let ticketsCache = [];
      let scheduleCache = [];
      let notesCache = [];

      function resolveName(){
        return profileData?.username || profileData?.email || sessionData?.user?.email || 'collaboratore';
      }

      async function fetchProfile(userId){
        try{
          const { data, error } = await supabase
            .from(PROFILES_TABLE)
            .select('id,user_id,username,email,role')
            .eq('user_id', userId)
            .maybeSingle();
          if(error){ console.warn('fetchProfile', error); return null; }
          return data || null;
        }catch(err){ console.warn('fetchProfile', err); return null; }
      }

      async function requireCollaborator(){
        const { data:{ session } } = await supabase.auth.getSession();
        if(!session?.user){ location.replace('login.html'); return false; }
        sessionData = session;
        profileData = await fetchProfile(session.user.id);
        if(!profileData){ location.replace('login.html'); return false; }
        if(profileData.role !== 'collaboratore'){
          if(profileData.role === 'admin'){ location.replace('login.html'); }
          else { location.replace('index.html'); }
          return false;
        }
        return true;
      }

      async function logAudit(detail, type='other'){
        try{
          await supabase.from(AUDIT_TABLE).insert({
            user_id: sessionData?.user?.id || null,
            user: resolveName(),
            type,
            detail,
            created_at: new Date().toISOString()
          });
        }catch(err){ console.warn('audit', err); }
      }

      /* ===== Tabs ===== */
      function bindTabs(){
        document.querySelectorAll('.tabbtn').forEach(b=>{
          b.addEventListener('click', ()=>{
            document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('section.card').forEach(x=>x.style.display='none');
            b.classList.add('active');
            $(b.dataset.tab).style.display='';
          });
        });
      }

      /* ===== Tickets ===== */
      async function loadMyTickets(){
        if(!sessionData?.user) return;
        const box = $('my-tickets');
        box.innerHTML = '<div class="muted">Caricamento…</div>';
        try{
          const { data, error } = await supabase
            .from(TICKETS_INBOX_TABLE)
            .select('id,title,priority,customer,site,category,due,eta,description,created_at,status')
            .eq('created_by_id', sessionData.user.id)
            .order('created_at',{ ascending:false });
          if(error){ console.warn('loadMyTickets', error); box.innerHTML = '<div class="muted">Errore caricamento ticket</div>'; return; }
          ticketsCache = data || [];
          renderMyTickets();
        }catch(err){
          console.warn('loadMyTickets', err);
          box.innerHTML = '<div class="muted">Errore caricamento ticket</div>';
        }
      }

      function renderMyTickets(){
        const box = $('my-tickets');
        if(!ticketsCache.length){ box.innerHTML = '<div class="muted">Nessun ticket inviato</div>'; return; }
        box.innerHTML = ticketsCache.map(t=>`
          <div class="item">
            <div style="display:flex;justify-content:space-between;gap:.5rem;align-items:center">
              <div><b>${t.title}</b> · <span class="pill">${t.priority||'media'}</span></div>
              <small class="muted">${t.created_at? new Date(t.created_at).toLocaleString():'—'}</small>
            </div>
            <div class="muted" style="margin:.2rem 0">${t.customer||''} ${t.site? '· '+t.site:''} ${t.category? '· '+t.category:''}</div>
            <div>${(t.description||'').replace(/\n/g,'<br>')}</div>
            ${t.due? `<div class="muted">Scadenza: ${t.due}</div>`:''}
            <div class="muted">Stato: ${t.status||'inbox'}</div>
          </div>
        `).join('');
      }

      function bindTicketActions(){
        $('btn-send-ticket')?.addEventListener('click', async ()=>{
          if(!sessionData?.user) return;
          const title = $('tk-title').value.trim();
          if(!title){ showToast('Inserisci un titolo'); return; }
          const payload = {
            title,
            priority: $('tk-priority').value,
            customer: $('tk-customer').value.trim() || null,
            site: $('tk-site').value.trim() || null,
            category: $('tk-category').value.trim() || null,
            due: $('tk-due').value || null,
            eta: $('tk-eta').value ? Number($('tk-eta').value) : null,
            description: $('tk-desc').value.trim() || null,
            created_by: resolveName(),
            created_by_id: sessionData.user.id,
            status: 'inbox'
          };
          $('btn-send-ticket').setAttribute('disabled','disabled');
          try{
            const { error } = await supabase.from(TICKETS_INBOX_TABLE).insert(payload);
            if(error){ showToast('Errore invio ticket'); console.warn('ticket insert', error); return; }
            await logAudit('collaboratore: nuovo ticket inviato – '+title, 'create');
            ['tk-title','tk-customer','tk-site','tk-category','tk-due','tk-eta','tk-desc'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
            showToast('Ticket inviato');
            await loadMyTickets();
          }catch(err){
            console.warn('ticket insert', err);
            showToast('Errore invio ticket');
          }finally{
            $('btn-send-ticket').removeAttribute('disabled');
          }
        });

        $('btn-clear-ticket')?.addEventListener('click', ()=>{
          ['tk-title','tk-customer','tk-site','tk-category','tk-due','tk-eta','tk-desc'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
        });
      }

      /* ===== Schedules ===== */
      async function loadSchedule(){
        if(!sessionData?.user) return;
        const tbody = $('schedule-table').querySelector('tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="muted">Caricamento…</td></tr>';
        try{
          const { data, error } = await supabase
            .from(SCHEDULES_TABLE)
            .select('id,date,time,duration,task')
            .eq('user_id', sessionData.user.id)
            .order('date',{ ascending:true })
            .order('time',{ ascending:true });
          if(error){ console.warn('loadSchedule', error); tbody.innerHTML = '<tr><td colspan="5" class="muted">Errore</td></tr>'; return; }
          scheduleCache = data || [];
          renderSchedule();
        }catch(err){
          console.warn('loadSchedule', err);
          tbody.innerHTML = '<tr><td colspan="5" class="muted">Errore</td></tr>';
        }
      }

      function renderSchedule(){
        const tbody = $('schedule-table').querySelector('tbody');
        if(!scheduleCache.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted">Nessuna voce</td></tr>'; return; }
        tbody.innerHTML = scheduleCache.map(row=>`
          <tr>
            <td>${row.date||''}</td>
            <td>${row.time||''}</td>
            <td>${row.duration ?? ''}</td>
            <td>${row.task||''}</td>
            <td style="text-align:right"><button class="btn btn-ghost" data-id="${row.id}" data-act="rm">Elimina</button></td>
          </tr>
        `).join('');
        tbody.querySelectorAll('[data-act="rm"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.dataset.id;
            const { error } = await supabase.from(SCHEDULES_TABLE).delete().eq('id', id).eq('user_id', sessionData.user.id);
            if(error){ showToast('Errore eliminazione'); console.warn('schedule delete', error); return; }
            await logAudit('collaboratore: eliminato slot agenda', 'delete');
            await loadSchedule();
          });
        });
      }

      function bindScheduleActions(){
        $('btn-add-slot')?.addEventListener('click', async ()=>{
          if(!sessionData?.user) return;
          const payload = {
            user_id: sessionData.user.id,
            date: $('sc-date').value || null,
            time: $('sc-time').value || null,
            duration: $('sc-dur').value ? Number($('sc-dur').value) : null,
            task: $('sc-task').value.trim() || null,
            created_by: resolveName()
          };
          const { error } = await supabase.from(SCHEDULES_TABLE).insert(payload);
          if(error){ showToast('Errore salvataggio'); console.warn('schedule insert', error); return; }
          await logAudit('collaboratore: aggiunto slot agenda', 'create');
          ['sc-date','sc-time','sc-dur','sc-task'].forEach(id=>$(id).value='');
          await loadSchedule();
        });

        $('btn-clear-slots')?.addEventListener('click', async ()=>{
          if(!sessionData?.user) return;
          if(!confirm('Svuotare il programma di lavoro?')) return;
          const { error } = await supabase.from(SCHEDULES_TABLE).delete().eq('user_id', sessionData.user.id);
          if(error){ showToast('Errore svuotamento'); console.warn('schedule clear', error); return; }
          await logAudit('collaboratore: svuotata agenda', 'delete');
          await loadSchedule();
        });
      }

      /* ===== Notes ===== */
      async function loadNotes(){
        if(!sessionData?.user) return;
        const box = $('notes-list');
        box.innerHTML = '<div class="muted">Caricamento…</div>';
        try{
          const { data, error } = await supabase
            .from(NOTES_TABLE)
            .select('id,title,tags,body,created_at')
            .eq('user_id', sessionData.user.id)
            .order('created_at',{ ascending:false });
          if(error){ console.warn('loadNotes', error); box.innerHTML = '<div class="muted">Errore caricamento</div>'; return; }
          notesCache = data || [];
          renderNotes();
        }catch(err){
          console.warn('loadNotes', err);
          box.innerHTML = '<div class="muted">Errore caricamento</div>';
        }
      }

      function renderNotes(){
        const box = $('notes-list');
        if(!notesCache.length){ box.innerHTML = '<div class="muted">Nessuna nota</div>'; return; }
        box.innerHTML = notesCache.map(n=>`
          <div class="item" data-id="${n.id}">
            <div style="display:flex;justify-content:space-between;gap:.5rem;align-items:center">
              <div><b>${n.title||'Senza titolo'}</b> ${n.tags?`<span class="pill">${n.tags}</span>`:''}</div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-ghost" data-act="edit">Modifica</button>
                <button class="btn btn-danger" data-act="del">Elimina</button>
              </div>
            </div>
            <div class="muted" style="margin:.2rem 0">${n.created_at? new Date(n.created_at).toLocaleString():'—'}</div>
            <div>${(n.body||'').replace(/\n/g,'<br>')}</div>
          </div>
        `).join('');

        box.querySelectorAll('[data-act="del"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const card = btn.closest('.item');
            const id = card?.dataset.id;
            const { error } = await supabase.from(NOTES_TABLE).delete().eq('id', id).eq('user_id', sessionData.user.id);
            if(error){ showToast('Errore eliminazione'); console.warn('note delete', error); return; }
            await logAudit('collaboratore: eliminata nota personale', 'delete');
            await loadNotes();
          });
        });

        box.querySelectorAll('[data-act="edit"]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const card = btn.closest('.item');
            const id = card?.dataset.id;
            const note = notesCache.find(n=> String(n.id) === String(id));
            if(!note) return;
            $('ar-title').value = note.title || '';
            $('ar-tags').value = note.tags || '';
            $('ar-body').value = note.body || '';
            supabase.from(NOTES_TABLE).delete().eq('id', id).eq('user_id', sessionData.user.id).then(()=>{
              logAudit('collaboratore: modifica nota personale', 'update');
              loadNotes();
            });
          });
        });
      }

      function bindNotesActions(){
        $('btn-add-note')?.addEventListener('click', async ()=>{
          if(!sessionData?.user) return;
          const payload = {
            user_id: sessionData.user.id,
            title: $('ar-title').value.trim() || null,
            tags: $('ar-tags').value.trim() || null,
            body: $('ar-body').value.trim() || null,
            created_by: resolveName()
          };
          const { error } = await supabase.from(NOTES_TABLE).insert(payload);
          if(error){ showToast('Errore salvataggio'); console.warn('note insert', error); return; }
          await logAudit('collaboratore: aggiunta nota personale', 'create');
          ['ar-title','ar-tags','ar-body'].forEach(id=>$(id).value='');
          await loadNotes();
        });

        $('btn-clear-notes')?.addEventListener('click', async ()=>{
          if(!sessionData?.user) return;
          if(!confirm('Svuotare tutte le note personali?')) return;
          const { error } = await supabase.from(NOTES_TABLE).delete().eq('user_id', sessionData.user.id);
          if(error){ showToast('Errore svuotamento'); console.warn('notes clear', error); return; }
          await logAudit('collaboratore: svuotate note personali', 'delete');
          await loadNotes();
        });
      }

      /* ===== User menu + Logout ===== */
      function bindUserMenu(){
        const btn = $('user-menu-btn');
        const pop = $('user-menu-pop');
        const uName=$('um-username');
        const uRole=$('um-role');
        const btnLogout=$('btn-logout');
        if(!btn || !pop) return;
        uName.textContent = resolveName();
        uRole.textContent = 'collaboratore';
        const avatar = document.querySelector('.avatar');
        if(avatar){ avatar.textContent = resolveName().slice(0,1).toUpperCase(); }
        btn.addEventListener('click', (e)=>{ e.stopPropagation(); pop.classList.toggle('show'); });
        document.addEventListener('click', ()=> pop.classList.remove('show'));
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') pop.classList.remove('show'); });
        btnLogout.addEventListener('click', async ()=>{
          await logAudit('collaboratore logout', 'logout');
          await supabase.auth.signOut();
          location.href='login.html';
        });
      }

      async function boot(){
        await loadLogo();
        const ok = await requireCollaborator();
        if(!ok) return;
        bindTabs();
        bindTicketActions();
        bindScheduleActions();
        bindNotesActions();
        bindUserMenu();
        await Promise.all([loadMyTickets(), loadSchedule(), loadNotes()]);
      }

      document.addEventListener('DOMContentLoaded', boot);
      </script>
      <div class="muted" style="margin:.2rem 0">${t.customer||''} ${t.site? '· '+t.site:''} ${t.category? '· '+t.category:''}</div>
      <div>${(t.desc||'').replace(/\n/g,'<br>')}</div>
      ${t.due? `<div class="muted">Scadenza: ${t.due}</div>`:''}
    </div>
  `).join('');
}

$('btn-send-ticket').addEventListener('click', ()=>{
  const s = getSession(); if(!s) return;
  const t = {
    id: 'tk_' + Math.random().toString(36).slice(2),
    title: $('tk-title').value.trim(),
    priority: $('tk-priority').value,
    customer: $('tk-customer').value.trim(),
    site: $('tk-site').value.trim(),
    category: $('tk-category').value.trim(),
    due: $('tk-due').value || null,
    eta: parseFloat($('tk-eta').value || '0') || 0,
    desc: $('tk-desc').value.trim(),
    createdBy: s.username,
    role: s.role,
    ts: new Date().toISOString(),
    status: 'inbox' // da approvare dall’operatore
  };
  if(!t.title){ showToast('Inserisci un titolo'); return; }

  // Scrive nella coda condivisa (visibile all’app)
  const inbox = readInbox(); inbox.unshift(t); writeInbox(inbox);

  // Copia anche nel proprio archivio ticket (solo consultazione)
  const my = readMyTk(s.username); my.unshift(t); writeMyTk(s.username, my);

  // Audit
  audit('collaboratore: nuovo ticket inviato – '+t.title);

  // Pulizia form + UI
  $('tk-title').value=''; $('tk-customer').value=''; $('tk-site').value='';
  $('tk-category').value=''; $('tk-due').value=''; $('tk-eta').value=''; $('tk-desc').value='';
  renderMyTickets(s.username);
  showToast('Ticket inviato. L’operatore lo vedrà nella Inbox.');
});

$('btn-clear-ticket').addEventListener('click', ()=>{
  ['tk-title','tk-customer','tk-site','tk-category','tk-due','tk-eta','tk-desc'].forEach(id=>{ const el=$(id); if(el) el.value=''; });
});

/* ===== Programma di lavoro ===== */
function readSchedule(u){ try{ return JSON.parse(localStorage.getItem(SC_KEY(u))||'[]'); }catch{return []} }
function writeSchedule(u,a){ localStorage.setItem(SC_KEY(u), JSON.stringify(a)); }
function renderSchedule(u){
  const tb = $('schedule-table').querySelector('tbody');
  const arr = readSchedule(u);
  tb.innerHTML = arr.map((r,i)=>`
    <tr>
      <td>${r.date||''}</td><td>${r.time||''}</td><td>${r.dur||''}</td><td>${r.task||''}</td>
      <td style="text-align:right"><button class="btn btn-ghost" data-i="${i}" data-act="rm">Elimina</button></td>
    </tr>
  `).join('') || '<tr><td colspan="5" class="muted">Nessuna voce</td></tr>';
  tb.querySelectorAll('[data-act="rm"]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const i = +b.dataset.i; const a = readSchedule(u); a.splice(i,1); writeSchedule(u,a); renderSchedule(u);
    });
  });
}
$('btn-add-slot').addEventListener('click', ()=>{
  const s=getSession(); if(!s) return;
  const rec = { date:$('sc-date').value, time:$('sc-time').value, dur:$('sc-dur').value, task:$('sc-task').value.trim() };
  const a = readSchedule(s.username); a.unshift(rec); writeSchedule(s.username,a); renderSchedule(s.username);
  ['sc-date','sc-time','sc-dur','sc-task'].forEach(id=>$(id).value='');
});
$('btn-clear-slots').addEventListener('click', ()=>{
  const s=getSession(); if(!s) return;
  if(!confirm('Svuotare il programma di lavoro?')) return;
  writeSchedule(s.username,[]); renderSchedule(s.username);
});

/* ===== Archivio personale ===== */
function readNotes(u){ try{ return JSON.parse(localStorage.getItem(AR_KEY(u))||'[]'); }catch{return []} }
function writeNotes(u,a){ localStorage.setItem(AR_KEY(u), JSON.stringify(a)); }
function renderNotes(u){
  const box = $('notes-list');
  const arr = readNotes(u);
  if(!arr.length){ box.innerHTML='<div class="muted">Nessuna nota</div>'; return; }
  box.innerHTML = arr.map((n,i)=>`
    <div class="item">
      <div style="display:flex;justify-content:space-between;gap:.5rem;align-items:center">
        <div><b>${n.title||'Senza titolo'}</b> ${n.tags?'<span class="pill">'+n.tags+'</span>':''}</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost" data-i="${i}" data-act="edit">Modifica</button>
          <button class="btn btn-danger" data-i="${i}" data-act="del">Elimina</button>
        </div>
      </div>
      <div class="muted" style="margin:.2rem 0">${new Date(n.ts).toLocaleString()}</div>
      <div>${(n.body||'').replace(/\n/g,'<br>')}</div>
    </div>
  `).join('');
  box.querySelectorAll('[data-act="del"]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const s=getSession(); const i=+b.dataset.i; const a=readNotes(s.username); a.splice(i,1); writeNotes(s.username,a); renderNotes(s.username);
    });
  });
  box.querySelectorAll('[data-act="edit"]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const s=getSession(); const i=+b.dataset.i; const a=readNotes(s.username); const n=a[i];
      $('ar-title').value=n.title||''; $('ar-tags').value=n.tags||''; $('ar-body').value=n.body||'';
      a.splice(i,1); writeNotes(s.username,a); renderNotes(s.username);
    });
  });
}
$('btn-add-note').addEventListener('click', ()=>{
  const s=getSession(); if(!s) return;
  const n={ title:$('ar-title').value.trim(), tags:$('ar-tags').value.trim(), body:$('ar-body').value.trim(), ts:new Date().toISOString() };
  const a=readNotes(s.username); a.unshift(n); writeNotes(s.username,a); renderNotes(s.username);
  ['ar-title','ar-tags','ar-body'].forEach(id=>$(id).value='');
});
$('btn-clear-notes').addEventListener('click', ()=>{
  const s=getSession(); if(!s) return;
  if(!confirm('Svuotare tutte le note personali?')) return;
  writeNotes(s.username,[]); renderNotes(s.username);
});

/* ===== User menu + Logout ===== */
(function userMenu(){
  const btn = $('user-menu-btn'), pop=$('user-menu-pop'), uName=$('um-username'), uRole=$('um-role'), btnLogout=$('btn-logout');
  function getSess(){ try{return JSON.parse(localStorage.getItem(AUTH_KEY)||'null')}catch{return null} }
  function auditLogout(){
    try{
      const s=getSess(); if(!s) return;
      const list = JSON.parse(localStorage.getItem(AUDIT_KEY)||'[]');
      list.unshift({ ts:new Date().toISOString(), user:s.username, type:'logout', detail:'uscita manuale' });
      localStorage.setItem(AUDIT_KEY, JSON.stringify(list));
    }catch(_){}
  }
  const s = ensureRole(); if(!s) return;
  uName.textContent = s.username||'utente';
  uRole.textContent = 'collaboratore';
  document.querySelector('.avatar').textContent = (s.username||'?').slice(0,1).toUpperCase();
  btn.addEventListener('click', (e)=>{e.stopPropagation(); pop.classList.toggle('show');});
  document.addEventListener('click', ()=> pop.classList.remove('show'));
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') pop.classList.remove('show'); });
  btnLogout.addEventListener('click', ()=>{ auditLogout(); localStorage.removeItem(AUTH_KEY); location.href='login.html'; });
})();

/* ===== Boot ===== */
(function boot(){
  loadLogo();
  const s = ensureRole(); if(!s) return;
  renderMyTickets(s.username);
  renderSchedule(s.username);
  renderNotes(s.username);
})();
<div id="sb-selfcheck" style="position:fixed;right:10px;bottom:10px;font:12px system-ui;background:#0f1a2c;color:#e8eef6;border:1px solid #1e2b45;border-radius:10px;padding:6px 10px;opacity:.85;z-index:9999"></div>
<script>
  (async()=>{
    const el=document.getElementById('sb-selfcheck');
    if(!el) return;
    try{
      if(typeof supabase==='undefined'){ el.textContent='Supabase ❌'; return; }
      const { error } = await supabase.from('profiles').select('id').limit(1);
      el.textContent = error ? 'Supabase ❌ connessione' : 'Supabase ✅ connesso';
    }catch(_){
      el.textContent='Supabase ❌ connessione';
    }
  })();
</script>
</body>
</html>
